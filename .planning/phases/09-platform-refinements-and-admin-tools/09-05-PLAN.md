---
phase: 09-platform-refinements-and-admin-tools
plan: 05
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - src/app/(admin)/admin/activation-codes/page.tsx
  - src/components/admin/AdminNav.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view paginated table of activation codes at /admin/activation-codes"
    - "Admin can generate codes in batches by specifying a quantity"
    - "Table shows code, status (unused/used), source (generated/imported), created date, and redeemer info"
    - "Admin can filter by status: All / Unused / Used"
    - "Summary stats cards show total generated, used count, unused count"
    - "Admin can export codes as CSV with optional URL prefix"
    - "Pagination shows 50 codes per page with prev/next controls"
    - "Activation Codes link appears in admin navigation"
  artifacts:
    - path: "src/app/(admin)/admin/activation-codes/page.tsx"
      provides: "Full activation code management admin page"
      min_lines: 200
    - path: "src/components/admin/AdminNav.tsx"
      provides: "Activation Codes nav item added"
      contains: "activation-codes"
  key_links:
    - from: "src/app/(admin)/admin/activation-codes/page.tsx"
      to: "src/app/api/admin/activation-codes/route.ts"
      via: "fetch GET and POST for listing and generation"
      pattern: "/api/admin/activation-codes"
---

<objective>
Build the activation code management admin page with batch generation, paginated table with status/source indicators, CSV export with URL prefix, and summary stats.

Purpose: Gives admin full visibility and control over activation codes, including imported legacy codes and newly generated ones.
Output: New admin page component, updated admin navigation.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-platform-refinements-and-admin-tools/09-RESEARCH.md
@.planning/phases/09-platform-refinements-and-admin-tools/09-02-SUMMARY.md

@src/app/api/admin/activation-codes/route.ts
@src/components/admin/AdminNav.tsx
@src/app/(admin)/admin/videos/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activation code admin page</name>
  <files>
    src/app/(admin)/admin/activation-codes/page.tsx
  </files>
  <action>
Create `src/app/(admin)/admin/activation-codes/page.tsx` -- a comprehensive admin page for managing activation codes.

**Page Structure:**

1. **Page Header:**
   - Title: "Activation Codes"
   - Subtitle: "Generate, track, and export activation codes"
   - "Generate Codes" button (top-right) that opens an inline form or modal

2. **Summary Stats Cards** (3 cards in a row):
   - Total Codes (total generated + imported) -- with Key icon
   - Used -- with CheckCircle icon, green accent
   - Unused -- with Clock icon, amber accent
   - Fetch stats from GET /api/admin/activation-codes response (used_count, unused_count)

3. **Status Filter Tabs:**
   - All / Unused / Used -- segmented control matching existing admin page patterns
   - Switching tab refetches with `?used=true` or `?used=false` query param

4. **Batch Generation Section:**
   - When "Generate Codes" is clicked, show inline form (not a separate modal):
     - Number input for quantity (1-100, default 10)
     - Optional mode_hint selector: None / Bible / Positivity
     - "Generate" button with loading state
   - On success: show toast "Generated X codes", refetch the table
   - On error: show error toast

5. **Codes Table:**
   - Columns: Code | Status | Source | Created | Redeemed By | Redeemed At
   - Code column: monospace font, copyable (click-to-copy with small copy icon)
   - Status column: "Unused" (green badge) or "Used" (gray badge)
   - Source column: "Generated" (blue badge) or "Imported" (amber badge)
   - Created column: formatted date
   - Redeemed By: username (link to /admin/users?search=username) or "--" if unused
   - Redeemed At: formatted date from used_at or "--"
   - 50 rows per page (GET API already supports limit=50)

6. **Pagination:**
   - Show current page and total pages
   - Previous / Next buttons
   - Disabled states for first/last page
   - Format: "Page X of Y"

7. **CSV Export:**
   - Export button below the table (Download icon)
   - On click: show a small inline form with optional URL prefix input
     - Placeholder: "https://freeluma.com/signup?code="
     - Default: empty (exports just code values)
   - "Export CSV" button generates and downloads
   - CSV format: If prefix provided: `URL,Code` with each row being `{prefix}{code},{code}`. If no prefix: just `Code` column with each code.
   - Use browser-native Blob + URL.createObjectURL for download (no library)
   - Export ALL codes matching current filter (not just current page) -- for this, fetch with limit=99999 or paginate through all

**Styling:**
- Match existing admin page patterns (rounded-2xl cards, border-border, etc.)
- Use the same cn() utility, Button, Input components
- Icons from lucide-react: Key, CheckCircle, Clock, Copy, Download, Plus, Search

**State Management:**
- `codes`: array of code objects from API
- `stats`: { total, used_count, unused_count }
- `page`: current page number (1-based)
- `totalPages`: from API response
- `filter`: 'all' | 'unused' | 'used'
- `generating`: boolean loading state for generation
- `showGenerate`: boolean to toggle generation form
- `generateCount`: number input for batch size
- `generateModeHint`: optional mode hint
  </action>
  <verify>
    - Page renders at /admin/activation-codes
    - Stats cards show correct counts from API
    - Table shows codes with all columns
    - Filter tabs switch between all/unused/used
    - Generate creates new codes and refreshes table
    - Pagination works (next/prev, page count)
    - CSV export downloads file
    - `npx next build` compiles successfully
  </verify>
  <done>Activation code admin page provides full code management: stats, filtering, generation, pagination, and CSV export with optional URL prefix.</done>
</task>

<task type="auto">
  <name>Task 2: Add Activation Codes to admin navigation</name>
  <files>
    src/components/admin/AdminNav.tsx
  </files>
  <action>
1. Import the `Key` icon from lucide-react (or `Ticket` if Key is already used)

2. Add a new nav item to the `navItems` array, positioned after "Users" and before "Videos":
   ```
   {
     label: 'Activation Codes',
     href: '/admin/activation-codes',
     icon: Key,
   },
   ```

3. The existing active state logic (`pathname.startsWith(item.href)`) will automatically highlight this item when on the activation codes page.
  </action>
  <verify>
    - AdminNav shows "Activation Codes" link with Key icon
    - Clicking navigates to /admin/activation-codes
    - Active state highlights correctly when on the page
    - No layout shift or style issues with 8 nav items
  </verify>
  <done>Admin navigation includes Activation Codes link between Users and Videos.</done>
</task>

</tasks>

<verification>
- /admin/activation-codes page loads with stats, table, and controls
- Admin nav shows Activation Codes link
- Codes can be generated in batches
- Table shows source (generated/imported) and redeemer info
- Pagination works with 50 per page
- CSV export works with and without URL prefix
- Status filter tabs work
- `npx next build` succeeds
</verification>

<success_criteria>
1. Dedicated admin page at /admin/activation-codes
2. Summary stats cards: total, used, unused
3. Batch generation with quantity input
4. Paginated table (50/page) with code, status, source, dates, redeemer
5. Status filter tabs: All / Unused / Used
6. CSV export with optional URL prefix
7. Nav link in admin sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-refinements-and-admin-tools/09-05-SUMMARY.md`
</output>
