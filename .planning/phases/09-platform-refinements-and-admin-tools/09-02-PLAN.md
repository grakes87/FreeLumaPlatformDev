---
phase: 09-platform-refinements-and-admin-tools
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/072-activation-code-source-and-used-at.cjs
  - src/lib/db/models/ActivationCode.ts
  - src/app/api/admin/activation-codes/route.ts
  - scripts/import-old-data.mjs
autonomous: true

must_haves:
  truths:
    - "Activation codes have a source field distinguishing imported from generated codes"
    - "Activation codes have a used_at timestamp tracking when they were redeemed"
    - "Admin API returns activation codes with user who redeemed them and when"
    - "Old activation codes from text file are imported via import script with source=imported"
    - "Newly generated codes have expires_at set to year 9999 (effectively never expire)"
  artifacts:
    - path: "src/lib/db/migrations/072-activation-code-source-and-used-at.cjs"
      provides: "Schema changes for source column, used_at column on activation_codes"
    - path: "src/lib/db/models/ActivationCode.ts"
      provides: "Updated model with source and used_at fields"
      contains: "source"
    - path: "src/app/api/admin/activation-codes/route.ts"
      provides: "Enhanced API with user association, updated generation to never-expire"
      contains: "usedByUser"
    - path: "scripts/import-old-data.mjs"
      provides: "Import step for old activation codes from text file"
      contains: "activation_codes.txt"
  key_links:
    - from: "src/app/api/admin/activation-codes/route.ts"
      to: "src/lib/db/models/ActivationCode.ts"
      via: "Model import for queries"
      pattern: "ActivationCode"
    - from: "scripts/import-old-data.mjs"
      to: "Old Code/FreeLumaDev-new/free-luma-api/public/uploads/activation_codes.txt"
      via: "File read for import"
      pattern: "activation_codes.txt"
---

<objective>
Enhance the activation code schema with source tracking and used_at timestamps, update the API to include redeemer info and never-expire behavior, and import old activation codes from the legacy text file.

Purpose: Foundation for the activation code admin UI -- schema and API must be ready before the UI can display and manage codes.
Output: Migration, updated model, enhanced API, import script addition.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-platform-refinements-and-admin-tools/09-RESEARCH.md

@src/lib/db/models/ActivationCode.ts
@src/app/api/admin/activation-codes/route.ts
@scripts/import-old-data.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration, model update, and API enhancement</name>
  <files>
    src/lib/db/migrations/072-activation-code-source-and-used-at.cjs
    src/lib/db/models/ActivationCode.ts
    src/app/api/admin/activation-codes/route.ts
  </files>
  <action>
1. Create migration `src/lib/db/migrations/072-activation-code-source-and-used-at.cjs`:
   - Add `source` column: ENUM('generated', 'imported'), defaultValue 'generated', allowNull false
   - Add `used_at` column: DATE, allowNull true
   - Increase `code` column from STRING(12) to STRING(16) to accommodate imported codes with dashes (XXXX-XXXX-XXXX = 14 chars, give buffer to 16)
   - In `down`: remove source, used_at columns, resize code back to STRING(12)

2. Update `src/lib/db/models/ActivationCode.ts`:
   - Add to ActivationCodeAttributes interface:
     - `source: 'generated' | 'imported'`
     - `used_at: Date | null`
   - Add `source` and `used_at` to the Optional list in ActivationCodeCreationAttributes
   - Add `declare source: 'generated' | 'imported'` and `declare used_at: Date | null` to class
   - In init(), add:
     - `source: { type: DataTypes.ENUM('generated', 'imported'), defaultValue: 'generated', allowNull: false }`
     - `used_at: { type: DataTypes.DATE, allowNull: true }`
   - Change `code` field from STRING(12) to STRING(16)

3. Update `src/app/api/admin/activation-codes/route.ts`:
   **POST handler changes:**
   - Change `expires_in_days` default from 365 to a very large number. Instead of computing expiresAt from days, set it to `new Date('9999-12-31')` to effectively never expire. Remove the expires_in_days parameter entirely since all codes never expire per CONTEXT decision.
   - Add `source: 'generated'` to each record in the bulkCreate call (explicit, even though default)
   - Keep the existing count, mode_hint parameters

   **GET handler changes:**
   - Change default limit from 20 to 50 (CONTEXT: 50 codes per page)
   - Add User model include to findAndCountAll:
     ```
     include: [{
       model: User,
       as: 'usedByUser',
       attributes: ['id', 'username', 'display_name'],
       required: false,
     }]
     ```
   - This requires importing User model. Use lazy import: `const { User } = await import('@/lib/db/models')`
   - IMPORTANT: The ActivationCode model needs a belongsTo association for 'usedByUser'. Check if it exists in `src/lib/db/models/index.ts`. If not, add: `ActivationCode.belongsTo(User, { foreignKey: 'used_by', as: 'usedByUser' })`

   **Also add to GET response:**
   - Include `source` field in the code listing (already returned by findAndCountAll, just verify it's not excluded by attributes)

4. Run migration: `npx sequelize-cli db:migrate --env development`
  </action>
  <verify>
    - Migration 072 runs without errors
    - `DESCRIBE activation_codes` shows source ENUM column, used_at DATE column, code VARCHAR(16)
    - `curl -b cookies.txt http://localhost:3000/api/admin/activation-codes?limit=5` returns codes with source field
    - POST generates codes with expires_at = 9999-12-31 and source = 'generated'
  </verify>
  <done>Activation code model has source and used_at columns. API returns codes with user association. Newly generated codes never expire. Code column accommodates 14+ char imported codes.</done>
</task>

<task type="auto">
  <name>Task 2: Import old activation codes from legacy text file</name>
  <files>
    scripts/import-old-data.mjs
  </files>
  <action>
Add a new import step to `scripts/import-old-data.mjs` for activation codes. This should run AFTER the main data import steps.

1. Add a new function `importActivationCodes(conn)`:
   - Read the file at: `Old Code/FreeLumaDev-new/free-luma-api/public/uploads/activation_codes.txt`
   - Parse each line: format is `ID - XXXX-XXXX-XXXX` (e.g., `19401 - 7216-7538-2454`)
   - Extract just the code portion (after " - "), which is XXXX-XXXX-XXXX (14 chars with dashes)
   - Keep dashes in the code (the code column is now STRING(16), fits 14 chars with dashes)
   - For each parsed code, insert into activation_codes table:
     - `code`: the XXXX-XXXX-XXXX string
     - `used`: false (0)
     - `used_by`: null
     - `mode_hint`: null
     - `expires_at`: '9999-12-31 00:00:00' (never expire)
     - `source`: 'imported'
     - `created_by`: null
   - Use INSERT IGNORE to skip any duplicates (in case of re-runs)
   - Batch insert in groups of BATCH_SIZE (500, already defined in script)
   - Track stats: total parsed, inserted, skipped (duplicates)

2. Call `importActivationCodes(conn)` from the main import flow, after the existing import steps but before seeding admin/test users. Add a check: if `--table=activation_codes` is specified, only run this step. If no --table filter, run it as part of the full import.

3. The import should NOT wipe existing activation_codes (unlike other tables which get wiped). Use INSERT IGNORE only -- preserve any existing generated codes.

4. Log progress: "Importing activation codes from legacy text file..."
   Log completion: "Imported X activation codes (Y skipped as duplicates)"

IMPORTANT: The file path relative to project root is `Old Code/FreeLumaDev-new/free-luma-api/public/uploads/activation_codes.txt`. Check if the file exists before attempting import; skip gracefully with a warning if missing.
  </action>
  <verify>
    - `node scripts/import-old-data.mjs --table=activation_codes` runs and reports imported count
    - `SELECT COUNT(*) FROM activation_codes WHERE source = 'imported'` returns the count of imported codes (should be ~12,214)
    - `SELECT code FROM activation_codes WHERE source = 'imported' LIMIT 5` shows codes with dashes (XXXX-XXXX-XXXX format)
    - Re-running the import does not create duplicates (INSERT IGNORE)
  </verify>
  <done>Old activation codes imported from legacy text file with source='imported'. ~12,214 codes imported. Safe to re-run without duplicates.</done>
</task>

</tasks>

<verification>
- Migration 072 applied
- ActivationCode model has source and used_at fields
- API GET returns codes with usedByUser association and source field
- API POST creates codes with never-expire date and source='generated'
- Old codes imported with source='imported' and dashes preserved
- `npx next build` succeeds
</verification>

<success_criteria>
1. activation_codes table has source and used_at columns
2. Code column accepts 14+ char codes (for dashed imported format)
3. GET API returns each code's redeemer (username, display_name) and source
4. POST API generates codes that never expire
5. ~12,214 old codes imported with source='imported'
6. Import is idempotent (safe to re-run)
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-refinements-and-admin-tools/09-02-SUMMARY.md`
</output>
