---
phase: 09-platform-refinements-and-admin-tools
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/073-add-created-by-admin-to-workshops.cjs
  - src/lib/db/models/Workshop.ts
  - src/lib/db/models/index.ts
  - src/app/api/admin/workshops/route.ts
  - src/app/(admin)/admin/workshops/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create a workshop on behalf of any user from admin workshops page"
    - "Admin selects host user via search by name/username"
    - "Host receives in-app notification about the workshop created for them"
    - "Admin-created workshops show 'Created by admin' badge in admin view only"
    - "Host has full edit rights to the workshop as if they created it"
    - "If selected host has can_host=false, it is automatically set to true"
  artifacts:
    - path: "src/lib/db/migrations/073-add-created-by-admin-to-workshops.cjs"
      provides: "Nullable created_by_admin_id FK column on workshops"
    - path: "src/lib/db/models/Workshop.ts"
      provides: "created_by_admin_id field in model"
      contains: "created_by_admin_id"
    - path: "src/app/api/admin/workshops/route.ts"
      provides: "create_on_behalf action in PUT endpoint"
      contains: "create_on_behalf"
    - path: "src/app/(admin)/admin/workshops/page.tsx"
      provides: "Create on behalf button, host picker, admin badge"
      contains: "Create on Behalf"
  key_links:
    - from: "src/app/(admin)/admin/workshops/page.tsx"
      to: "src/app/api/admin/workshops/route.ts"
      via: "fetch PUT with action create_on_behalf"
      pattern: "create_on_behalf"
    - from: "src/app/api/admin/workshops/route.ts"
      to: "src/lib/notifications/create"
      via: "createNotification for host"
      pattern: "createNotification"
---

<objective>
Enable admin to create workshops on behalf of any user, with host search, automatic can_host enablement, host notification, and admin attribution tracking.

Purpose: Allows admin to set up workshops for users who may not be familiar with the process, while keeping the host as the public face.
Output: Migration, updated model, enhanced API, updated admin workshops page with "Create on Behalf" flow.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-platform-refinements-and-admin-tools/09-RESEARCH.md

@src/lib/db/models/Workshop.ts
@src/lib/db/models/index.ts
@src/app/api/admin/workshops/route.ts
@src/app/(admin)/admin/workshops/page.tsx
@src/components/workshop/CreateWorkshopForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration, model update, and API endpoint for proxy creation</name>
  <files>
    src/lib/db/migrations/073-add-created-by-admin-to-workshops.cjs
    src/lib/db/models/Workshop.ts
    src/lib/db/models/index.ts
    src/app/api/admin/workshops/route.ts
  </files>
  <action>
1. Create migration `src/lib/db/migrations/073-add-created-by-admin-to-workshops.cjs`:
   - Add `created_by_admin_id` column to workshops table: INTEGER, allowNull true, references users(id), ON DELETE SET NULL
   - In `down`: remove created_by_admin_id column

2. Update `src/lib/db/models/Workshop.ts`:
   - Add `created_by_admin_id: number | null` to WorkshopAttributes
   - Add `created_by_admin_id` to the Optional list in WorkshopCreationAttributes
   - Add `declare created_by_admin_id: number | null` to class
   - In init(), add:
     ```
     created_by_admin_id: {
       type: DataTypes.INTEGER,
       allowNull: true,
       references: { model: 'users', key: 'id' },
     },
     ```

3. In `src/lib/db/models/index.ts`:
   - Add association: `Workshop.belongsTo(User, { foreignKey: 'created_by_admin_id', as: 'createdByAdmin' })`
   - This allows eager loading the admin user who created the workshop

4. Update `src/app/api/admin/workshops/route.ts`:

   **Extend the adminActionSchema** to include 'create_on_behalf' in the action enum. Add optional fields for workshop creation:
   - host_id: z.number().int().positive().optional()
   - title: z.string().min(3).max(200).optional()
   - description: z.string().max(2000).optional()
   - category_id: z.number().int().positive().nullable().optional()
   - scheduled_at: z.string().optional() (ISO date string)
   - duration_minutes: z.number().int().min(15).max(480).optional()
   - is_private: z.boolean().optional()

   **Add create_on_behalf handler in PUT:**
   ```
   if (action === 'create_on_behalf') {
     const { host_id, title, description, category_id, scheduled_at, duration_minutes, is_private } = parsed.data;

     if (!host_id || !title || !scheduled_at) {
       return errorResponse('host_id, title, and scheduled_at are required');
     }

     const { User, Workshop } = await import('@/lib/db/models');

     // Validate host exists and is active
     const hostUser = await User.findByPk(host_id, { attributes: ['id', 'can_host', 'status', 'display_name'] });
     if (!hostUser) return errorResponse('Host user not found', 404);
     if (hostUser.status !== 'active') return errorResponse('Host user is not active');

     // Auto-enable can_host
     if (!hostUser.can_host) {
       await hostUser.update({ can_host: true });
     }

     // Create workshop
     const workshop = await Workshop.create({
       host_id,
       title,
       description: description || null,
       category_id: category_id || null,
       scheduled_at: new Date(scheduled_at),
       duration_minutes: duration_minutes || null,
       is_private: is_private || false,
       created_by_admin_id: context.user.id,
     });

     // Notify host (non-fatal)
     try {
       const { createNotification } = await import('@/lib/notifications/create');
       const { NotificationType, NotificationEntityType } = await import('@/lib/notifications/types');
       await createNotification({
         recipient_id: host_id,
         actor_id: context.user.id,
         type: NotificationType.WORKSHOP_UPDATED,
         entity_type: NotificationEntityType.WORKSHOP,
         entity_id: workshop.id,
         preview_text: `Admin created a workshop for you: ${title}`,
       });
     } catch {
       console.error('[Admin] Failed to send workshop creation notification');
     }

     return successResponse({ workshop, action: 'create_on_behalf' }, 201);
   }
   ```

   **Update GET handler** to include created_by_admin_id in the attributes list and add createdByAdmin association:
   - Add 'created_by_admin_id' to the attributes array
   - Add to the include array:
     ```
     {
       model: User,
       as: 'createdByAdmin',
       attributes: ['id', 'display_name', 'username'],
       required: false,
     }
     ```

5. Run migration: `npx sequelize-cli db:migrate --env development`
  </action>
  <verify>
    - Migration 073 runs without errors
    - `DESCRIBE workshops` shows created_by_admin_id column
    - The admin workshop API GET returns createdByAdmin field (null for user-created workshops)
    - TypeScript compiles without errors for the workshop model changes
  </verify>
  <done>Workshop model has created_by_admin_id tracking. API supports create_on_behalf action that creates workshops, auto-enables can_host, and sends notification to host.</done>
</task>

<task type="auto">
  <name>Task 2: Admin workshops page UI for proxy creation</name>
  <files>
    src/app/(admin)/admin/workshops/page.tsx
  </files>
  <action>
Update the admin workshops page to add a "Create on Behalf" button and workflow:

1. **Add "Create on Behalf" button** in the page header next to the title area:
   - Button with UserPlus icon (import from lucide-react) and text "Create on Behalf"
   - Opens a modal with the workshop creation flow

2. **Add host search picker** inside the modal, above the CreateWorkshopForm:
   - Text input with Search icon for typing name/username
   - Debounced search (300ms) hitting `GET /api/admin/users?search={query}&limit=10`
   - Display search results as a list of user cards (avatar, display_name, username)
   - Clicking a user selects them as the host (show selected user with a "Change" button)
   - Only show the CreateWorkshopForm AFTER a host is selected

3. **Workshop creation flow:**
   - Once host is selected, render the existing CreateWorkshopForm component in 'create' mode
   - Override the form's onSuccess handler: when the form would normally POST to /api/workshops, instead call the admin endpoint:
     - Actually, the simpler approach: build a mini form directly in the modal that collects title, description, category, date, time, duration, is_private
     - On submit, POST to `/api/admin/workshops` with action: 'create_on_behalf' and host_id
   - Alternatively, pass a custom `onSubmit` prop to CreateWorkshopForm if it supports one. Check the component's interface.
   - The simplest approach given the existing form: Build a lightweight inline form in the modal with the same fields (title, description, category selector, date, time, duration, privacy toggle), then submit via the admin API.

4. **Admin-created badge** on workshop cards:
   - In the workshop card render, check if `workshop.createdByAdmin` (or `created_by_admin_id`) is non-null
   - If so, show a small badge: "Created by admin" (indigo-100 bg, indigo-700 text) next to the status badge
   - This is admin-view only -- public workshop views don't show this

5. **Update Workshop type interface** at top of file:
   - Add `created_by_admin_id: number | null` to Workshop interface
   - Add `createdByAdmin: { id: number; display_name: string; username: string } | null` to Workshop interface

6. **After successful creation:**
   - Close the modal
   - Show success toast: "Workshop created for @{username}"
   - Refetch workshops list

7. **Fetch categories** for the creation form:
   - Fetch `/api/workshops/categories` on modal open to populate category dropdown
  </action>
  <verify>
    - "Create on Behalf" button visible on admin workshops page
    - Clicking it opens modal with host search
    - Searching shows user results from admin users API
    - Selecting a host shows the creation form
    - Submitting creates workshop and shows success toast
    - New workshop appears in the list with "Created by admin" badge
    - `npx next build` compiles without errors
  </verify>
  <done>Admin can create workshops on behalf of any user via the admin workshops page. Host search works. Admin attribution badge shows on admin-created workshops. Host receives notification.</done>
</task>

</tasks>

<verification>
- Migration 073 applied (created_by_admin_id on workshops)
- Admin workshops API supports create_on_behalf action
- Admin workshops page has "Create on Behalf" button and workflow
- Created workshops show admin attribution badge in admin view
- Host notification sent on creation
- can_host auto-enabled for target user
- `npx next build` succeeds
</verification>

<success_criteria>
1. Admin can create workshops on behalf of any user
2. Host is searchable by name/username
3. Host receives notification about the workshop
4. Admin-created workshops show "Created by admin" badge in admin view only
5. Host has full edit rights (normal workshop ownership)
6. can_host auto-enabled if target user has it disabled
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-refinements-and-admin-tools/09-03-SUMMARY.md`
</output>
