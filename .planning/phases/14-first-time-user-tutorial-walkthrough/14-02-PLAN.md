---
phase: 14-first-time-user-tutorial-walkthrough
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/tutorial/TutorialProvider.tsx
  - src/components/tutorial/TutorialSlideshow.tsx
  - src/components/tutorial/TutorialCoachMarks.tsx
  - src/components/tutorial/tutorialSteps.ts
autonomous: true

must_haves:
  truths:
    - "TutorialProvider checks has_seen_tutorial and orchestrates slideshow then coach marks flow"
    - "TutorialSlideshow renders 4-card Swiper carousel with mode-specific content"
    - "TutorialCoachMarks renders spotlight cutout overlays targeting data-tutorial elements"
    - "User can skip at any point during slideshow or coach marks"
    - "Bible mode users see verse toggle and prayer wall content; positivity users do not"
    - "Tutorial phases transition: slideshow -> coach-marks -> done"
  artifacts:
    - path: "src/components/tutorial/TutorialProvider.tsx"
      provides: "Tutorial state machine and context provider"
      min_lines: 60
    - path: "src/components/tutorial/TutorialSlideshow.tsx"
      provides: "4-card Swiper slideshow overlay"
      min_lines: 80
    - path: "src/components/tutorial/TutorialCoachMarks.tsx"
      provides: "Spotlight cutout coach mark overlay system"
      min_lines: 80
    - path: "src/components/tutorial/tutorialSteps.ts"
      provides: "Step definitions for slideshow cards and coach mark targets"
      min_lines: 40
  key_links:
    - from: "src/components/tutorial/TutorialProvider.tsx"
      to: "/api/tutorial"
      via: "fetch to check and update has_seen_tutorial"
      pattern: "fetch.*api/tutorial"
    - from: "src/components/tutorial/TutorialProvider.tsx"
      to: "src/components/tutorial/TutorialSlideshow.tsx"
      via: "conditional render when phase is slideshow"
      pattern: "TutorialSlideshow"
    - from: "src/components/tutorial/TutorialProvider.tsx"
      to: "src/components/tutorial/TutorialCoachMarks.tsx"
      via: "conditional render when phase is coach-marks"
      pattern: "TutorialCoachMarks"
    - from: "src/components/tutorial/TutorialCoachMarks.tsx"
      to: "DOM elements"
      via: "document.querySelector('[data-tutorial=...]')"
      pattern: "data-tutorial"
---

<objective>
Build the complete tutorial UI component system -- TutorialProvider context, 4-card slideshow with Swiper, and spotlight coach mark overlay.

Purpose: These components implement the two-phase tutorial flow (slideshow then coach marks) that introduces new users to the FreeLuma app.
Output: Four new files in src/components/tutorial/ -- the provider, slideshow, coach marks, and step definitions.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-first-time-user-tutorial-walkthrough/14-CONTEXT.md
@.planning/phases/14-first-time-user-tutorial-walkthrough/14-RESEARCH.md
@.planning/phases/14-first-time-user-tutorial-walkthrough/14-01-SUMMARY.md

@src/context/AuthContext.tsx
@src/components/daily/DailyPostCarousel.tsx
@src/components/daily/VerseModeToggle.tsx
@src/components/layout/BottomNav.tsx
@src/components/daily/ReactionBar.tsx
@src/components/ui/Modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TutorialProvider context and tutorialSteps config</name>
  <files>
    src/components/tutorial/TutorialProvider.tsx
    src/components/tutorial/tutorialSteps.ts
  </files>
  <action>
    1. Create `src/components/tutorial/tutorialSteps.ts` with step definitions:

       **Slideshow steps** (array of objects):
       Each step: `{ id: string, title: string, description: string, bibleDescription?: string, positivityDescription?: string, icon: string }`
       - Step 1 (daily-feed): Daily content feed + swipe gesture explanation
       - Step 2 (modes): Bible vs Positivity modes explanation
       - Step 3 (social): Social features (reactions, comments, sharing, prayer wall for bible)
       - Step 4 (navigation): Bottom navigation tabs overview
       Use warm, encouraging tone. Bible-specific descriptions stored in `bibleDescription` field; if present, override `description` for bible mode users.

       **Coach mark steps** (array of objects):
       Each step: `{ id: string, target: string, title: string, description: string, bibleOnly?: boolean, position: 'top' | 'bottom' | 'left' | 'right' }`
       - Step 1: target `[data-tutorial="daily-card"]`, title "Swipe Up", description about swiping to see next day's content, position "bottom"
       - Step 2: target `[data-tutorial="verse-toggle"]`, title "Verse Mode", description about switching between daily verse and verse-by-category, position "bottom", bibleOnly: true
       - Step 3: target `[data-tutorial="bottom-nav"]`, title "Navigation", description about the 5 nav tabs, position "top"
       - Step 4: target `[data-tutorial="reactions-area"]`, title "React & Comment", description about reactions and comments on daily content, position "top"

    2. Create `src/components/tutorial/TutorialProvider.tsx`:

       **Context interface:**
       ```typescript
       interface TutorialContextValue {
         showTutorial: boolean;
         phase: 'idle' | 'slideshow' | 'coach-marks' | 'done';
         currentStep: number;
         advance: () => void;
         skip: () => void;
         replay: () => void;
       }
       ```

       **Provider logic:**
       - Wraps children and conditionally renders TutorialSlideshow or TutorialCoachMarks via createPortal to document.body
       - On mount, check `user.has_seen_tutorial` from useAuth(). If false, set phase to 'slideshow' after a 1-second delay (let feed load first)
       - `advance()`: If in slideshow and on last slide, transition to 'coach-marks'. If in coach-marks and on last step, call `completeTutorial()`. Otherwise increment currentStep.
       - `skip()`: Call `completeTutorial()` immediately regardless of phase
       - `completeTutorial()`: PUT /api/tutorial to mark complete, set phase to 'done', call refreshUser() from AuthContext to sync has_seen_tutorial
       - `replay()`: PUT /api/tutorial with `{ reset: true }`, call refreshUser(), set phase to 'slideshow', currentStep to 0
       - Export both TutorialProvider and useTutorial hook (throws if used outside provider)
       - Filter coach mark steps by user mode (exclude bibleOnly steps for positivity users)
       - Lock body scroll when tutorial is active (phase !== 'idle' && phase !== 'done')

       **Important patterns:**
       - Use `createPortal(overlay, document.body)` for both slideshow and coach marks (same as Modal.tsx pattern)
       - Use z-[60] for tutorial overlays (above everything else; z-50 is used by modals)
       - Get user mode from useAuth() `user.mode` field
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit --pretty 2>&1 | head -20`
    - tutorialSteps.ts exports slideshowSteps (4 items) and coachMarkSteps (4 items)
    - TutorialProvider exports TutorialProvider component and useTutorial hook
  </verify>
  <done>TutorialProvider manages tutorial state machine (idle -> slideshow -> coach-marks -> done) with skip/advance/replay controls, tutorialSteps.ts defines all 4 slideshow cards and 4 coach mark targets</done>
</task>

<task type="auto">
  <name>Task 2: TutorialSlideshow and TutorialCoachMarks components</name>
  <files>
    src/components/tutorial/TutorialSlideshow.tsx
    src/components/tutorial/TutorialCoachMarks.tsx
  </files>
  <action>
    1. Create `src/components/tutorial/TutorialSlideshow.tsx`:

       **Structure:**
       - Full-screen overlay via createPortal to document.body with z-[60]
       - Semi-transparent dark backdrop (`bg-black/70`)
       - Centered card container (max-w-sm, mx-auto, vertically centered)
       - Swiper carousel with horizontal slides, pagination dots, no navigation arrows
       - Each slide card: white/dark background (use `bg-white dark:bg-gray-900`), rounded-2xl, p-6, min-h-[400px]
       - Card content: Icon at top (use lucide-react icons -- Sparkles, BookOpen/Sun, Heart, Navigation2), title (text-xl font-bold), description (text-sm text-gray-600 dark:text-gray-300), and a small illustrative preview area
       - The "illustrative preview" for each card should be a simple styled div that visually represents the concept (e.g., a mini phone frame with colored blocks representing the feed layout). Keep it CSS-only, no images.
       - Bottom of overlay: "Skip" button (text-white/60, always visible) and "Next" / "Get Started" button (primary, full-width inside card)
       - On last slide, button text changes from "Next" to "Get Started"
       - "Next" calls advance() from useTutorial; "Skip" calls skip(); "Get Started" calls advance() (which transitions to coach marks)

       **Swiper config:**
       - modules: [Pagination, Keyboard]
       - slidesPerView: 1
       - pagination: { clickable: true } with custom bullet styling (white dots)
       - keyboard: { enabled: true }
       - onSlideChange: sync currentStep with swiper activeIndex
       - allowTouchMove: true (horizontal swipe between cards)

       **Mode-specific content:**
       - Get user mode from useTutorial context or useAuth
       - For each slideshowStep, use `bibleDescription` if user is bible mode and field exists, otherwise use `description`
       - Step 3 (social): For bible users mention prayer wall; for positivity users omit it

    2. Create `src/components/tutorial/TutorialCoachMarks.tsx`:

       **Structure:**
       - Full-screen overlay via createPortal to document.body with z-[60]
       - On mount and on step change, find target element via `document.querySelector(step.target)`
       - If target not found, use polling (requestAnimationFrame loop, max 3 seconds) to wait for element mount
       - If still not found after timeout, skip to next step
       - Get target bounding rect via `getBoundingClientRect()`
       - Render spotlight cutout using CSS box-shadow technique:
         ```
         position: fixed
         top: targetRect.top - 8
         left: targetRect.left - 8
         width: targetRect.width + 16
         height: targetRect.height + 16
         borderRadius: 12px
         boxShadow: 0 0 0 9999px rgba(0, 0, 0, 0.75)
         ```
       - Add a subtle white/primary ring border (2px solid white/30) around the spotlight cutout for visibility against the dark daily feed background
       - Tooltip card positioned relative to the spotlight based on step.position:
         - position "top": tooltip above the spotlight with arrow pointing down
         - position "bottom": tooltip below the spotlight with arrow pointing up
         - Use absolute/fixed positioning calculated from targetRect
         - Tooltip content: title (font-semibold text-white), description (text-sm text-white/80)
       - Bottom controls: step counter ("1 of 4"), "Skip" and "Next" / "Done" buttons
       - On last coach mark step, button text changes to "Done"
       - "Next" / "Done" calls advance(); "Skip" calls skip()
       - Add recalculation on window resize (debounced) to reposition spotlight
       - Animate spotlight position changes with CSS transition (0.3s ease)

       **Swipe gesture hint (first coach mark only):**
       - When highlighting `[data-tutorial="daily-card"]`, add an animated swipe-up hand icon/arrow
       - Use CSS animation: translateY(0) -> translateY(-20px) repeating every 1.5s
       - Small upward arrow (ChevronUp from lucide) with "Swipe up" text

       **Important:**
       - Coach mark steps filtered by user mode already in TutorialProvider (bibleOnly steps excluded for positivity)
       - Scroll locking already handled by TutorialProvider
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit --pretty 2>&1 | head -20`
    - TutorialSlideshow renders Swiper with 4 slides
    - TutorialCoachMarks handles missing target elements gracefully (polling + timeout skip)
    - Both components use createPortal to document.body with z-[60]
  </verify>
  <done>TutorialSlideshow renders 4-card Swiper carousel with mode-specific content over dimmed backdrop; TutorialCoachMarks renders spotlight cutout overlays with tooltips targeting data-tutorial elements, with polling for element readiness and animated swipe hint</done>
</task>

</tasks>

<verification>
- All 4 files created in src/components/tutorial/
- TutorialProvider exports provider component and useTutorial hook
- TutorialSlideshow uses Swiper (already installed) for horizontal card carousel
- TutorialCoachMarks uses box-shadow spotlight technique
- Both overlay components render via createPortal at z-[60]
- Mode-specific content handled (bible vs positivity)
- Skip always available on every step
- TypeScript compiles without errors
</verification>

<success_criteria>
- TutorialProvider manages idle/slideshow/coach-marks/done state machine
- 4-card slideshow with Swiper horizontal swipe and dot indicators
- Coach mark spotlight overlays position correctly around target elements
- Skip button dismisses tutorial at any point
- Bible users see prayer wall and verse toggle content; positivity users do not
- All components render via createPortal with z-[60]
</success_criteria>

<output>
After completion, create `.planning/phases/14-first-time-user-tutorial-walkthrough/14-02-SUMMARY.md`
</output>
