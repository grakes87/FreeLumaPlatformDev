---
phase: 14-first-time-user-tutorial-walkthrough
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/100-add-has-seen-tutorial-to-users.cjs
  - src/lib/db/models/User.ts
  - src/context/AuthContext.tsx
  - src/app/api/tutorial/route.ts
autonomous: true

must_haves:
  truths:
    - "has_seen_tutorial column exists on users table with default false"
    - "AuthContext exposes has_seen_tutorial boolean on UserData"
    - "GET /api/tutorial returns current has_seen_tutorial status"
    - "PUT /api/tutorial sets has_seen_tutorial to true"
    - "PUT /api/tutorial with reset=true sets has_seen_tutorial to false"
  artifacts:
    - path: "src/lib/db/migrations/100-add-has-seen-tutorial-to-users.cjs"
      provides: "Database column for tutorial tracking"
      contains: "has_seen_tutorial"
    - path: "src/app/api/tutorial/route.ts"
      provides: "Tutorial status API"
      exports: ["GET", "PUT"]
  key_links:
    - from: "src/app/api/tutorial/route.ts"
      to: "src/lib/db/models/User.ts"
      via: "User.update({ has_seen_tutorial })"
      pattern: "has_seen_tutorial"
    - from: "src/context/AuthContext.tsx"
      to: "UserData interface"
      via: "has_seen_tutorial field"
      pattern: "has_seen_tutorial.*boolean"
---

<objective>
Add database column, User model field, AuthContext field, and API route for tutorial tracking.

Purpose: Backend foundation for the tutorial system -- without this, the tutorial cannot check whether a user has seen it or persist completion state.
Output: Migration file, updated User model, updated AuthContext UserData, and /api/tutorial route with GET/PUT.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-first-time-user-tutorial-walkthrough/14-CONTEXT.md
@.planning/phases/14-first-time-user-tutorial-walkthrough/14-RESEARCH.md

@src/lib/db/models/User.ts
@src/context/AuthContext.tsx
@src/app/api/auth/me/route.ts
@src/lib/auth/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and User model update</name>
  <files>
    src/lib/db/migrations/100-add-has-seen-tutorial-to-users.cjs
    src/lib/db/models/User.ts
  </files>
  <action>
    1. Create migration `100-add-has-seen-tutorial-to-users.cjs` that adds `has_seen_tutorial` BOOLEAN column to `users` table with defaultValue false, allowNull false. Follow the established .cjs migration pattern (module.exports with up/down using queryInterface.addColumn/removeColumn).

    2. Update `src/lib/db/models/User.ts`:
       - Add `has_seen_tutorial: boolean` to UserAttributes interface
       - Add `has_seen_tutorial` to the Optional list in UserCreationAttributes
       - Add `declare has_seen_tutorial: boolean` to the User class
       - Add `has_seen_tutorial` field to User.init() with `type: DataTypes.BOOLEAN, defaultValue: false, allowNull: false`

    3. Run the migration: `npx sequelize-cli db:migrate`
  </action>
  <verify>
    - `npx sequelize-cli db:migrate` succeeds
    - Run: `mysql -u root -p"Luma!2026#R9vK3pT7xQ2mZ5sN8cH1yW4" -h 127.0.0.1 freeluma_dev -e "DESCRIBE users" | grep has_seen_tutorial` shows the column
  </verify>
  <done>has_seen_tutorial BOOLEAN DEFAULT false column exists on users table, User model includes the field in all type definitions</done>
</task>

<task type="auto">
  <name>Task 2: AuthContext update and tutorial API route</name>
  <files>
    src/context/AuthContext.tsx
    src/app/api/tutorial/route.ts
  </files>
  <action>
    1. Update `src/context/AuthContext.tsx`:
       - Add `has_seen_tutorial: boolean` to the UserData interface (after `can_host: boolean`)
       - The /api/auth/me endpoint already returns all user fields (excluding password_hash and email_verification_token), so has_seen_tutorial will be automatically included in the response -- no changes needed to the me route.

    2. Create `src/app/api/tutorial/route.ts` with two handlers:

       **GET handler** (wrapped with withAuth):
       - Fetch user by context.user.id, select only `has_seen_tutorial`
       - Return `successResponse({ has_seen_tutorial: user.has_seen_tutorial })`

       **PUT handler** (wrapped with withAuth):
       - Parse request body as JSON
       - If body contains `reset: true`, set `has_seen_tutorial` to false (for replay from settings)
       - Otherwise, set `has_seen_tutorial` to true (for marking tutorial complete)
       - Update user via `User.update({ has_seen_tutorial: value }, { where: { id: context.user.id } })`
       - Return `successResponse({ has_seen_tutorial: value })`

       Use the established import pattern:
       ```typescript
       import { withAuth, type AuthContext } from '@/lib/auth/middleware';
       import { User } from '@/lib/db/models';
       import { successResponse, serverError } from '@/lib/utils/api';
       ```
  </action>
  <verify>
    - `curl -b cookies.txt http://localhost:3000/api/tutorial` returns `{ data: { has_seen_tutorial: false } }`
    - `curl -X PUT -b cookies.txt -H 'Content-Type: application/json' -d '{}' http://localhost:3000/api/tutorial` returns `{ data: { has_seen_tutorial: true } }`
    - `curl -X PUT -b cookies.txt -H 'Content-Type: application/json' -d '{"reset":true}' http://localhost:3000/api/tutorial` returns `{ data: { has_seen_tutorial: false } }`
    - TypeScript compiles without errors: `npx tsc --noEmit --pretty 2>&1 | head -20`
  </verify>
  <done>AuthContext UserData includes has_seen_tutorial, API route supports GET (check status) and PUT (mark complete / reset for replay)</done>
</task>

</tasks>

<verification>
- Migration 100 applied successfully
- User model has has_seen_tutorial in all type interfaces
- AuthContext UserData interface includes has_seen_tutorial: boolean
- GET /api/tutorial returns current status
- PUT /api/tutorial marks complete or resets
- No TypeScript errors
</verification>

<success_criteria>
- has_seen_tutorial column exists on users table with BOOLEAN type and false default
- User model type definitions include has_seen_tutorial
- AuthContext UserData exposes has_seen_tutorial to client components
- Tutorial API route works for both completion marking and replay reset
</success_criteria>

<output>
After completion, create `.planning/phases/14-first-time-user-tutorial-walkthrough/14-01-SUMMARY.md`
</output>
