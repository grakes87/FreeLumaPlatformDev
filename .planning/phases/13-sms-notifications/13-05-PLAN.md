---
phase: 13-sms-notifications
plan: 05
type: execute
wave: 3
depends_on: ["13-03", "13-04"]
files_modified:
  - src/components/settings/PhoneNumberSection.tsx
  - src/app/(app)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter phone number with international country code selector"
    - "User can send OTP to entered phone number"
    - "User can enter 6-digit OTP code and verify their phone"
    - "Verified phone number displayed with green checkmark"
    - "SMS notification toggles appear only when phone is verified"
    - "SMS toggles use same ToggleRow component as email toggles"
    - "Phone number change clears verified status"
  artifacts:
    - path: "src/components/settings/PhoneNumberSection.tsx"
      provides: "Phone input + OTP verification UI component"
    - path: "src/app/(app)/settings/page.tsx"
      provides: "Settings page with phone section + SMS toggles"
  key_links:
    - from: "src/components/settings/PhoneNumberSection.tsx"
      to: "/api/sms/verify"
      via: "fetch POST/PUT"
      pattern: "fetch.*api/sms/verify"
    - from: "src/app/(app)/settings/page.tsx"
      to: "src/components/settings/PhoneNumberSection.tsx"
      via: "import"
      pattern: "import.*PhoneNumberSection"
---

<objective>
Build settings UI for phone number input, OTP verification, and SMS notification toggles.

Purpose: User-facing interface for phone management and SMS preferences â€” the primary interaction point for the SMS feature.
Output: PhoneNumberSection component with OTP flow, SMS toggles integrated into settings page.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-sms-notifications/13-RESEARCH.md
@src/app/(app)/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhoneNumberSection component with OTP verification flow</name>
  <files>src/components/settings/PhoneNumberSection.tsx</files>
  <action>
    Create `src/components/settings/PhoneNumberSection.tsx` as a 'use client' component.

    **Props:**
    ```typescript
    interface PhoneNumberSectionProps {
      currentPhone: string | null;
      phoneVerified: boolean;
      onPhoneVerified: () => void;  // callback to refresh settings
    }
    ```

    **State:**
    - phone: string (from currentPhone or empty)
    - otpSent: boolean
    - otp: string (6 digit input)
    - loading: boolean
    - error: string | null
    - cooldown: number (seconds remaining before resend allowed, starts at 0)

    **Import:**
    - `import PhoneInput from 'react-phone-number-input'`
    - `import 'react-phone-number-input/style.css'`
    - Import lucide-react icons: Phone, CheckCircle, Send, Loader2

    **UI Layout:**
    The component renders inside a Card-like section on the settings page.

    **States:**

    1. **No phone / not verified:** Show PhoneInput component (international, defaultCountry="US") + "Send Verification Code" button.
    2. **OTP sent:** Show PhoneInput (disabled) + 6-digit text input + "Verify" button + "Resend Code" link with cooldown timer (60s).
    3. **Phone verified:** Show formatted phone number with green CheckCircle icon + "Change Number" link that resets to state 1.

    **Handlers:**

    `handleSendOTP()`:
    - Set loading=true, error=null.
    - POST to `/api/sms/verify` with `{ phone }`.
    - On success: setOtpSent(true), start 60s cooldown timer via setInterval.
    - On error: set error from response.
    - Set loading=false.

    `handleVerifyOTP()`:
    - Set loading=true, error=null.
    - PUT to `/api/sms/verify` with `{ phone, code: otp }`.
    - On success: call onPhoneVerified() callback to refresh parent settings, show toast.
    - On error: set error from response.
    - Set loading=false.

    `handleChangeNumber()`:
    - Reset: setOtpSent(false), setOtp(''), setPhone(''), setCooldown(0).

    **Styling:**
    - Use Tailwind classes matching existing settings sections.
    - PhoneInput uses dark mode compatible styling: override default input styles with Tailwind classes via className prop.
    - For the PhoneInput CSS override, add custom CSS classes to make it match the app's theme (bg-background, text-text, border-border, with dark: variants).
    - Error text in text-red-500 text-sm.
    - Cooldown timer in text-text-muted text-xs.
    - Loading states use Loader2 with animate-spin.

    **Important:** The react-phone-number-input default CSS needs overrides for dark mode. Use a wrapper div with className that targets the library's CSS classes using Tailwind's dark: variant and the app's CSS variables.
  </action>
  <verify>
    Component file exists and exports PhoneNumberSection.
    TypeScript compiles.
    Component uses react-phone-number-input with PhoneInput.
    Three visual states: input, OTP entry, verified display.
  </verify>
  <done>PhoneNumberSection component with full OTP verification flow: enter phone, send code, verify, change number.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate phone section and SMS toggles into settings page</name>
  <files>src/app/(app)/settings/page.tsx</files>
  <action>
    Modify `src/app/(app)/settings/page.tsx`:

    **1. Update Settings interface:**
    Add to the Settings type:
    - phone: string | null
    - phone_verified: boolean
    - sms_notifications_enabled: boolean
    - sms_dm_notifications: boolean
    - sms_follow_notifications: boolean
    - sms_prayer_notifications: boolean
    - sms_daily_reminder: boolean
    - sms_workshop_notifications: boolean

    **2. Import PhoneNumberSection:**
    ```typescript
    import { PhoneNumberSection } from '@/components/settings/PhoneNumberSection';
    ```
    Also import the Smartphone icon from lucide-react.

    **3. Add Phone Number section BEFORE the Notifications section:**
    ```tsx
    <SectionHeader title="Phone Number" />
    <Card padding="sm" className="mb-6">
      <PhoneNumberSection
        currentPhone={settings?.phone ?? null}
        phoneVerified={settings?.phone_verified ?? false}
        onPhoneVerified={() => {
          // Refresh settings to get updated phone_verified status
          fetchSettings();
        }}
      />
    </Card>
    ```

    Note: fetchSettings should be extracted as a reusable function (currently the settings fetch logic is in a useEffect). Extract it as a useCallback so PhoneNumberSection can trigger a re-fetch.

    **4. Add SMS Notifications section AFTER the existing Email Notifications section:**
    Inside the Notifications Card, after the email toggles and quiet hours, add:

    ```tsx
    {/* SMS Notifications (per-category) */}
    {settings?.phone_verified && (
      <>
        <Divider />
        <div className="px-4 py-3.5">
          <p className="text-sm font-medium text-text dark:text-text-dark mb-1">
            SMS Notifications
          </p>
          <p className="text-[10px] text-text-muted dark:text-text-muted-dark mb-3">
            Text message alerts (standard rates may apply)
          </p>
        </div>

        <ToggleRow
          icon={Smartphone}
          label="Enable SMS"
          checked={settings?.sms_notifications_enabled ?? false}
          onChange={(val) => saveSettings({ sms_notifications_enabled: val })}
        />

        {settings?.sms_notifications_enabled && (
          <>
            <Divider />
            <ToggleRow icon={MessageCircle} label="Direct Messages" checked={settings?.sms_dm_notifications ?? true} onChange={(val) => saveSettings({ sms_dm_notifications: val })} />
            <Divider />
            <ToggleRow icon={UserPlus} label="Follow Requests" checked={settings?.sms_follow_notifications ?? true} onChange={(val) => saveSettings({ sms_follow_notifications: val })} />
            <Divider />
            <ToggleRow icon={Heart} label="Prayer Notifications" checked={settings?.sms_prayer_notifications ?? true} onChange={(val) => saveSettings({ sms_prayer_notifications: val })} />
            <Divider />
            <ToggleRow icon={Send} label="Daily Content Reminder" checked={settings?.sms_daily_reminder ?? true} onChange={(val) => saveSettings({ sms_daily_reminder: val })} />
            <Divider />
            <ToggleRow icon={Presentation} label={`${wl.singular} Events`} checked={settings?.sms_workshop_notifications ?? true} onChange={(val) => saveSettings({ sms_workshop_notifications: val })} />
          </>
        )}
      </>
    )}
    ```

    Key points:
    - SMS section only visible when phone_verified is true.
    - Global SMS toggle (sms_notifications_enabled) is the master switch.
    - Per-category toggles only show when global SMS is enabled.
    - Uses the same ToggleRow component and icon pattern as email toggles.
    - Uses same Divider component between toggles.
    - Uses the debounced auto-save saveSettings pattern (already exists).
  </action>
  <verify>
    Settings page compiles without errors.
    Phone Number section renders above Notifications.
    SMS toggles appear only when phone_verified is true.
    Per-category SMS toggles appear only when global SMS is enabled.
    Debounced auto-save works for SMS toggles.
  </verify>
  <done>Settings page has phone number input with OTP verification and conditional SMS notification toggles.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. PhoneNumberSection component renders 3 states (input, OTP, verified)
3. Settings page shows phone section and SMS toggles
4. SMS toggles only visible when phone verified
5. Per-category SMS toggles only visible when global SMS enabled
6. Auto-save persists SMS toggle changes
</verification>

<success_criteria>
- PhoneNumberSection handles full OTP flow (enter number, send code, verify, change)
- Settings page displays phone section above notifications
- SMS toggles conditionally render based on phone_verified and sms_notifications_enabled
- react-phone-number-input renders with dark mode support
- All settings changes auto-save with debounce
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-sms-notifications/13-05-SUMMARY.md`
</output>
