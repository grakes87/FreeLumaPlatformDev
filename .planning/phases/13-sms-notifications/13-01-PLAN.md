---
phase: 13-sms-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/094-add-phone-verified-to-users.cjs
  - src/lib/db/migrations/095-add-sms-toggles-to-user-settings.cjs
  - src/lib/db/migrations/096-create-sms-logs.cjs
  - src/lib/db/models/User.ts
  - src/lib/db/models/UserSetting.ts
  - src/lib/db/models/SmsLog.ts
  - src/lib/db/models/index.ts
autonomous: true

must_haves:
  truths:
    - "phone_verified column exists on users table with BOOLEAN DEFAULT FALSE"
    - "6 SMS toggle columns exist on user_settings table"
    - "sms_logs table stores delivery records with status tracking"
    - "SmsLog model is importable from @/lib/db/models"
    - "User model includes phone and phone_verified attributes"
    - "UserSetting model includes all 6 SMS toggle columns"
  artifacts:
    - path: "src/lib/db/migrations/094-add-phone-verified-to-users.cjs"
      provides: "phone_verified column on users"
    - path: "src/lib/db/migrations/095-add-sms-toggles-to-user-settings.cjs"
      provides: "6 SMS toggle columns on user_settings"
    - path: "src/lib/db/migrations/096-create-sms-logs.cjs"
      provides: "sms_logs table"
    - path: "src/lib/db/models/SmsLog.ts"
      provides: "SmsLog Sequelize model"
  key_links:
    - from: "src/lib/db/models/SmsLog.ts"
      to: "src/lib/db/models/index.ts"
      via: "import + export + associations"
      pattern: "SmsLog"
---

<objective>
Create database schema for SMS notification system and update all Sequelize models.

Purpose: Foundation layer — all SMS features depend on these columns and tables existing.
Output: 3 migrations, 1 new model (SmsLog), 2 updated models (User, UserSetting), npm dependencies installed.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-sms-notifications/13-RESEARCH.md
@src/lib/db/models/User.ts
@src/lib/db/models/UserSetting.ts
@src/lib/db/models/index.ts
@src/lib/db/migrations/069-add-phone-to-users.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 3 database migrations and install npm dependencies</name>
  <files>
    src/lib/db/migrations/094-add-phone-verified-to-users.cjs
    src/lib/db/migrations/095-add-sms-toggles-to-user-settings.cjs
    src/lib/db/migrations/096-create-sms-logs.cjs
  </files>
  <action>
    Install npm dependencies:
    ```
    npm install twilio libphonenumber-js react-phone-number-input
    ```

    Create migration 094 — Add phone_verified BOOLEAN DEFAULT FALSE to users table, AFTER the phone column:
    ```sql
    ALTER TABLE users ADD COLUMN phone_verified BOOLEAN NOT NULL DEFAULT FALSE AFTER phone;
    ```

    Create migration 095 — Add 6 SMS toggle columns to user_settings:
    - sms_notifications_enabled BOOLEAN NOT NULL DEFAULT FALSE (global SMS toggle — off by default; user must opt in after phone verification)
    - sms_dm_notifications BOOLEAN NOT NULL DEFAULT TRUE
    - sms_follow_notifications BOOLEAN NOT NULL DEFAULT TRUE
    - sms_prayer_notifications BOOLEAN NOT NULL DEFAULT TRUE
    - sms_daily_reminder BOOLEAN NOT NULL DEFAULT TRUE
    - sms_workshop_notifications BOOLEAN NOT NULL DEFAULT TRUE

    Create migration 096 — Create sms_logs table:
    ```sql
    CREATE TABLE sms_logs (
      id INT AUTO_INCREMENT PRIMARY KEY,
      recipient_id INT NOT NULL,
      sms_type VARCHAR(50) NOT NULL,
      body VARCHAR(320) NOT NULL,
      status ENUM('queued','sent','delivered','failed') NOT NULL DEFAULT 'queued',
      twilio_sid VARCHAR(50) NULL,
      sent_at DATETIME NULL,
      delivered_at DATETIME NULL,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      FOREIGN KEY (recipient_id) REFERENCES users(id),
      INDEX idx_sms_logs_recipient (recipient_id),
      INDEX idx_sms_logs_status (status),
      INDEX idx_sms_logs_type (sms_type)
    );
    ```

    All migrations use standard .cjs format matching existing project convention (module.exports with up/down using queryInterface).

    Run migrations:
    ```
    npx sequelize-cli db:migrate
    ```
  </action>
  <verify>
    Run `npx sequelize-cli db:migrate` — should succeed with no errors.
    Check DB: `SELECT phone_verified FROM users LIMIT 1` should return 0.
    Check DB: `DESCRIBE user_settings` should show sms_* columns.
    Check DB: `DESCRIBE sms_logs` should show all columns.
  </verify>
  <done>All 3 migrations applied. phone_verified exists on users, 6 SMS toggles exist on user_settings, sms_logs table created.</done>
</task>

<task type="auto">
  <name>Task 2: Create SmsLog model and update User + UserSetting models</name>
  <files>
    src/lib/db/models/SmsLog.ts
    src/lib/db/models/User.ts
    src/lib/db/models/UserSetting.ts
    src/lib/db/models/index.ts
  </files>
  <action>
    Create `src/lib/db/models/SmsLog.ts`:
    - Attributes interface: id, recipient_id, sms_type, body, status (enum), twilio_sid, sent_at, delivered_at, created_at, updated_at
    - Model class with init() matching the migration schema
    - tableName: 'sms_logs', timestamps: true, underscored: true

    Update `src/lib/db/models/User.ts`:
    - Add `phone: string | null` to UserAttributes interface (column exists from migration 069 but was never added to model)
    - Add `phone_verified: boolean` to UserAttributes interface
    - Add both to Optional creation attributes
    - Add `declare phone: string | null;` and `declare phone_verified: boolean;` class declarations
    - Add both to init() column definitions: phone as STRING(20) nullable, phone_verified as BOOLEAN default false

    Update `src/lib/db/models/UserSetting.ts`:
    - Add 6 new attributes to interface: sms_notifications_enabled, sms_dm_notifications, sms_follow_notifications, sms_prayer_notifications, sms_daily_reminder, sms_workshop_notifications (all boolean)
    - Add to Optional creation attributes
    - Add declare statements
    - Add to init() column definitions: all BOOLEAN, sms_notifications_enabled defaults to false, rest default to true

    Update `src/lib/db/models/index.ts`:
    - Import SmsLog
    - Add SmsLog to associations: SmsLog.belongsTo(User, { foreignKey: 'recipient_id', as: 'recipient' }); User.hasMany(SmsLog, { foreignKey: 'recipient_id', as: 'smsLogs' });
    - Export SmsLog in the default export object
  </action>
  <verify>
    Run `npx tsc --noEmit` or `npx next build` — no TypeScript errors related to SmsLog, User.phone, or UserSetting.sms_* fields.
    Verify SmsLog is importable: `import { SmsLog } from '@/lib/db/models';`
  </verify>
  <done>SmsLog model exists and is registered. User model has phone + phone_verified. UserSetting has all 6 SMS toggle columns. All models compile without errors.</done>
</task>

</tasks>

<verification>
1. `npx sequelize-cli db:migrate:status` shows 094, 095, 096 as up
2. `npx tsc --noEmit` passes (or `npx next build` succeeds)
3. SmsLog, User.phone, User.phone_verified, and all UserSetting.sms_* fields are accessible
</verification>

<success_criteria>
- 3 migrations applied successfully
- SmsLog model created and exported from models/index.ts
- User model includes phone and phone_verified attributes
- UserSetting model includes 6 SMS toggle attributes
- npm packages twilio, libphonenumber-js, react-phone-number-input installed
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-sms-notifications/13-01-SUMMARY.md`
</output>
