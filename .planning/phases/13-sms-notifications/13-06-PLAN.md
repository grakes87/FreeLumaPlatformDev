---
phase: 13-sms-notifications
plan: 06
type: execute
wave: 3
depends_on: ["13-03", "13-04"]
files_modified:
  - src/lib/email/queue.ts
  - src/app/api/admin/analytics/route.ts
autonomous: true

must_haves:
  truths:
    - "Daily reminder cron also dispatches SMS to users with sms_daily_reminder enabled"
    - "SMS dispatch in daily reminder respects phone_verified and quiet hours"
    - "Admin analytics endpoint returns SMS delivery stats"
    - "SMS stats include total sent, delivered, failed counts and daily trend"
  artifacts:
    - path: "src/lib/email/queue.ts"
      provides: "Extended processDailyReminders with SMS dispatch"
    - path: "src/app/api/admin/analytics/route.ts"
      provides: "SMS delivery stats in admin analytics"
  key_links:
    - from: "src/lib/email/queue.ts"
      to: "src/lib/sms/queue.ts"
      via: "dynamic import dispatchSMSNotification"
      pattern: "import.*sms/queue"
    - from: "src/app/api/admin/analytics/route.ts"
      to: "sms_logs"
      via: "SQL query"
      pattern: "sms_logs"
---

<objective>
Add SMS dispatch to daily reminder cron and SMS delivery stats to admin analytics.

Purpose: Completes the SMS notification loop â€” daily reminders reach users via SMS, and admin can monitor delivery health.
Output: Daily reminder sends SMS alongside email; admin dashboard shows SMS metrics.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-sms-notifications/13-RESEARCH.md
@src/lib/email/queue.ts
@src/app/api/admin/analytics/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SMS dispatch to daily reminder processor</name>
  <files>src/lib/email/queue.ts</files>
  <action>
    Modify the `processDailyReminders()` function in `src/lib/email/queue.ts`:

    After the existing email send block for each user (after the `sendNotificationEmail` call), add an SMS dispatch block. This goes inside the for-loop, after the email is sent for each user.

    ```typescript
    // ---- SMS daily reminder dispatch (fire-and-forget) ----
    try {
      const { dispatchSMSNotification } = await import('@/lib/sms/queue');
      await dispatchSMSNotification(
        user.id,
        'daily_reminder',
        'daily_content',
        0, // no specific entity
        null
      );
    } catch (smsErr) {
      console.error(`[Email Queue] Daily SMS error for user ${user.id}:`, smsErr);
    }
    ```

    Note: `dispatchSMSNotification` internally handles ALL checks:
    - Phone exists and is verified
    - sms_notifications_enabled is true
    - sms_daily_reminder is true
    - Quiet hours
    - Rate limiting

    So calling it unconditionally is safe. The function is a no-op for users without SMS enabled.

    Also add SMS log cleanup to `cleanupOldNotifications()`:
    After the existing email log cleanup, add:
    ```typescript
    // Also clean up old SMS logs
    const { SmsLog } = await import('@/lib/db/models');
    const smsCount = await SmsLog.destroy({
      where: { created_at: { [Op.lt]: ninetyDaysAgo } },
    });
    ```
    And update the log message to include smsCount.

    The SmsLog import needs to be dynamically imported (same pattern as EmailLog in this file).
  </action>
  <verify>
    processDailyReminders has SMS dispatch block inside the user loop.
    cleanupOldNotifications cleans up sms_logs alongside email_logs.
    TypeScript compiles.
  </verify>
  <done>Daily reminder cron sends SMS alongside email. Old SMS logs cleaned up in daily cleanup cron.</done>
</task>

<task type="auto">
  <name>Task 2: Add SMS delivery stats to admin analytics endpoint</name>
  <files>src/app/api/admin/analytics/route.ts</files>
  <action>
    Modify `src/app/api/admin/analytics/route.ts`:

    Add SMS stats queries alongside existing analytics queries. Add after the existing queries but before the response.

    **1. SMS summary stats (total sent, delivered, failed):**
    ```sql
    SELECT
      COUNT(*) AS total,
      SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) AS sent,
      SUM(CASE WHEN status = 'delivered' THEN 1 ELSE 0 END) AS delivered,
      SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) AS failed
    FROM sms_logs
    WHERE created_at >= DATE_SUB(NOW(), INTERVAL :days DAY)
    ```

    **2. SMS daily volume:**
    ```sql
    SELECT DATE(created_at) AS date, COUNT(*) AS count
    FROM sms_logs
    WHERE created_at >= DATE_SUB(NOW(), INTERVAL :days DAY)
    GROUP BY DATE(created_at)
    ORDER BY date ASC
    ```

    **3. SMS by type breakdown:**
    ```sql
    SELECT sms_type, COUNT(*) AS count
    FROM sms_logs
    WHERE created_at >= DATE_SUB(NOW(), INTERVAL :days DAY)
    GROUP BY sms_type
    ORDER BY count DESC
    ```

    **4. SMS opt-in stats (how many users have SMS enabled):**
    ```sql
    SELECT
      COUNT(*) AS total_verified_phones,
      SUM(CASE WHEN us.sms_notifications_enabled = TRUE THEN 1 ELSE 0 END) AS sms_opted_in
    FROM users u
    JOIN user_settings us ON us.user_id = u.id
    WHERE u.phone IS NOT NULL AND u.phone_verified = TRUE AND u.status = 'active'
    ```

    Add all 4 SMS stat results to the response object under an `sms` key:
    ```typescript
    return successResponse({
      // ...existing fields...
      sms: {
        summary: smsStats[0] || { total: 0, sent: 0, delivered: 0, failed: 0 },
        dailyVolume: smsDailyVolume,
        byType: smsByType,
        optInStats: smsOptIn[0] || { total_verified_phones: 0, sms_opted_in: 0 },
      },
    });
    ```

    Note: Use the same `days` variable from the existing period parameter. Use `QueryTypes.SELECT` for all queries (matching existing pattern).
  </action>
  <verify>
    GET /api/admin/analytics response includes `sms` object with summary, dailyVolume, byType, optInStats.
    TypeScript compiles.
    Queries use parameterized replacements (no SQL injection).
  </verify>
  <done>Admin analytics returns SMS delivery stats: totals, daily volume, type breakdown, opt-in counts.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. processDailyReminders dispatches SMS for each user
3. cleanupOldNotifications cleans sms_logs
4. Admin analytics returns sms.summary, sms.dailyVolume, sms.byType, sms.optInStats
</verification>

<success_criteria>
- Daily reminder cron dispatches SMS alongside email (fire-and-forget, non-fatal)
- SMS log cleanup runs in daily 3am cron
- Admin analytics shows SMS delivery summary (total/sent/delivered/failed)
- Admin analytics shows SMS daily volume trend
- Admin analytics shows SMS type breakdown
- Admin analytics shows SMS opt-in stats
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-sms-notifications/13-06-SUMMARY.md`
</output>
