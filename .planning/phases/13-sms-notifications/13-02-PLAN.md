---
phase: 13-sms-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/sms/index.ts
  - src/lib/sms/verify.ts
  - src/lib/utils/phone.ts
autonomous: true

must_haves:
  truths:
    - "sendSMS() logs to console when Twilio credentials are missing"
    - "sendSMS() respects SMS_DEV_WHITELIST env var"
    - "sendOTP() sends OTP via Twilio Verify API"
    - "checkOTP() validates OTP code via Twilio Verify API"
    - "normalizePhone() returns E.164 format or null for invalid numbers"
    - "formatPhoneDisplay() returns national format for display"
  artifacts:
    - path: "src/lib/sms/index.ts"
      provides: "Twilio client singleton + sendSMS()"
      exports: ["sendSMS"]
    - path: "src/lib/sms/verify.ts"
      provides: "OTP verification via Twilio Verify"
      exports: ["sendOTP", "checkOTP"]
    - path: "src/lib/utils/phone.ts"
      provides: "Phone number parsing and validation"
      exports: ["normalizePhone", "formatPhoneDisplay"]
  key_links:
    - from: "src/lib/sms/index.ts"
      to: "twilio"
      via: "npm import"
      pattern: "import twilio from 'twilio'"
    - from: "src/lib/utils/phone.ts"
      to: "libphonenumber-js"
      via: "npm import"
      pattern: "import.*libphonenumber-js"
---

<objective>
Create SMS library core: Twilio client with console fallback, OTP verification, and phone number utility.

Purpose: Infrastructure layer providing sendSMS(), OTP functions, and phone validation that all other SMS plans depend on.
Output: 3 library files ready for consumption by API routes and dispatch queue.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-sms-notifications/13-RESEARCH.md
@src/lib/email/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Twilio SMS client with console fallback and dev whitelist</name>
  <files>src/lib/sms/index.ts</files>
  <action>
    Create `src/lib/sms/index.ts` following the exact same pattern as `src/lib/email/index.ts`:

    1. Twilio client singleton via `getClient()` â€” returns null when TWILIO_ACCOUNT_SID or TWILIO_AUTH_TOKEN env vars are missing.

    2. `sendSMS(to: string, body: string): Promise<{ success: boolean; sid?: string }>`:
       - If getClient() returns null: log to console with formatted block (matching email console fallback style), return `{ success: false }`.
       - SMS_DEV_WHITELIST env var check (comma-separated E.164 numbers): if set and `to` is not in whitelist, log skip and return `{ success: false }`.
       - Call `twilioClient.messages.create({ body, to, messagingServiceSid: process.env.TWILIO_MESSAGING_SERVICE_SID })`.
       - Return `{ success: true, sid: message.sid }` on success.
       - Catch errors, log them, return `{ success: false }`.

    Env vars used:
    - TWILIO_ACCOUNT_SID
    - TWILIO_AUTH_TOKEN
    - TWILIO_MESSAGING_SERVICE_SID
    - SMS_DEV_WHITELIST (optional)
  </action>
  <verify>
    File exists and exports sendSMS. TypeScript compiles.
    Without Twilio env vars set, calling sendSMS would log to console (verified by code review).
  </verify>
  <done>sendSMS() exported with console fallback and dev whitelist guard.</done>
</task>

<task type="auto">
  <name>Task 2: Create OTP verification module and phone number utility</name>
  <files>
    src/lib/sms/verify.ts
    src/lib/utils/phone.ts
  </files>
  <action>
    Create `src/lib/sms/verify.ts`:

    1. `sendOTP(phoneNumber: string): Promise<{ success: boolean; error?: string }>`:
       - If TWILIO_ACCOUNT_SID or TWILIO_AUTH_TOKEN or TWILIO_VERIFY_SERVICE_SID missing: log to console "[SMS Verify] Twilio not configured, OTP to {phoneNumber}: simulated", return `{ success: true }` (dev mode allows simulated verification).
       - Create Twilio client, call `client.verify.v2.services(TWILIO_VERIFY_SERVICE_SID).verifications.create({ channel: 'sms', to: phoneNumber })`.
       - Return `{ success: verification.status === 'pending' }`.
       - Catch errors, return `{ success: false, error: message }`.

    2. `checkOTP(phoneNumber: string, code: string): Promise<{ success: boolean; error?: string }>`:
       - If Twilio not configured: if code === '000000' return `{ success: true }` (dev mode magic code), else return `{ success: false, error: 'Invalid code' }`.
       - Create Twilio client, call `client.verify.v2.services(TWILIO_VERIFY_SERVICE_SID).verificationChecks.create({ to: phoneNumber, code })`.
       - Return `{ success: check.status === 'approved' }`.
       - Catch errors, return `{ success: false, error: message }`.

    Create `src/lib/utils/phone.ts`:

    1. `normalizePhone(raw: string, defaultCountry: CountryCode = 'US'): string | null`:
       - Uses `isValidPhoneNumber` and `parsePhoneNumber` from `libphonenumber-js`.
       - Returns E.164 format (e.g., '+15551234567') or null if invalid.

    2. `formatPhoneDisplay(e164: string): string`:
       - Uses `parsePhoneNumber` from `libphonenumber-js`.
       - Returns national format (e.g., '(555) 123-4567') or raw input on error.

    Both use try/catch for safety.
  </action>
  <verify>
    Files exist and export correctly. TypeScript compiles.
    `normalizePhone('5551234567', 'US')` should return '+15551234567'.
    `normalizePhone('invalid')` should return null.
  </verify>
  <done>OTP verification module with dev fallback and phone utility with E.164 normalization both working.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. All 3 files exist with correct exports
3. sendSMS has console fallback when Twilio not configured
4. sendOTP/checkOTP have dev mode fallback with simulated verification
5. normalizePhone correctly handles US phone numbers to E.164
</verification>

<success_criteria>
- src/lib/sms/index.ts exports sendSMS() with Twilio client + console fallback + dev whitelist
- src/lib/sms/verify.ts exports sendOTP() and checkOTP() with Twilio Verify + dev fallback
- src/lib/utils/phone.ts exports normalizePhone() and formatPhoneDisplay() using libphonenumber-js
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-sms-notifications/13-02-SUMMARY.md`
</output>
