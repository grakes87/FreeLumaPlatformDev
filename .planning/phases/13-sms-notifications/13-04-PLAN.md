---
phase: 13-sms-notifications
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/api/settings/route.ts
  - src/lib/notifications/create.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/settings returns phone, phone_verified, and all 6 SMS toggle values"
    - "PUT /api/settings accepts all 6 SMS toggle fields and persists them"
    - "SMS toggles are only settable when phone_verified is true (server-side guard)"
    - "createNotification dispatches SMS after email (fire-and-forget)"
    - "SMS dispatch in createNotification is non-fatal (try/catch)"
  artifacts:
    - path: "src/app/api/settings/route.ts"
      provides: "Extended settings API with SMS fields"
    - path: "src/lib/notifications/create.ts"
      provides: "SMS dispatch wired into notification flow"
  key_links:
    - from: "src/lib/notifications/create.ts"
      to: "src/lib/sms/queue.ts"
      via: "dynamic import dispatchSMSNotification"
      pattern: "import.*sms/queue"
    - from: "src/app/api/settings/route.ts"
      to: "src/lib/db/models/UserSetting.ts"
      via: "SMS toggle field read/write"
      pattern: "sms_notifications_enabled|sms_dm_notifications"
---

<objective>
Extend settings API with SMS fields and wire SMS dispatch into createNotification.

Purpose: Connects SMS system to existing settings flow and notification pipeline — makes SMS toggles configurable and notifications deliverable.
Output: Settings API handles SMS fields; every notification also dispatches SMS when enabled.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-sms-notifications/13-RESEARCH.md
@src/app/api/settings/route.ts
@src/lib/notifications/create.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend settings API with SMS toggle fields and phone display</name>
  <files>src/app/api/settings/route.ts</files>
  <action>
    Modify `src/app/api/settings/route.ts`:

    **1. Update Zod schema (updateSettingsSchema):**
    Add 6 new optional boolean fields:
    - sms_notifications_enabled: z.boolean().optional()
    - sms_dm_notifications: z.boolean().optional()
    - sms_follow_notifications: z.boolean().optional()
    - sms_prayer_notifications: z.boolean().optional()
    - sms_daily_reminder: z.boolean().optional()
    - sms_workshop_notifications: z.boolean().optional()

    **2. Update GET handler:**
    - Add `phone` and `phone_verified` to User.findByPk attributes array.
    - Add all 6 SMS toggle fields to UserSetting findOne (they're already in the model from Plan 01).
    - Include phone, phone_verified, and all 6 SMS toggles in the response settings object.

    **3. Update PUT handler:**
    - Add SMS toggle fields to the settingFields type and mapping block (same pattern as email toggles).
    - **Server-side guard:** If any sms_* toggle is being set to true, verify the user's phone_verified is true. If not, return 400 "Phone number must be verified before enabling SMS notifications".
    - Update the response object to include all new fields.

    Follow the EXACT existing pattern for email_* toggles — just mirror it for sms_*.
  </action>
  <verify>
    GET /api/settings response includes phone, phone_verified, and all 6 sms_* fields.
    PUT /api/settings accepts sms_* fields and persists them.
    PUT rejects SMS enable when phone_verified is false.
    TypeScript compiles.
  </verify>
  <done>Settings API extended with phone display and SMS notification toggles with phone_verified guard.</done>
</task>

<task type="auto">
  <name>Task 2: Wire SMS dispatch into createNotification</name>
  <files>src/lib/notifications/create.ts</files>
  <action>
    Modify `src/lib/notifications/create.ts`:

    After the existing email dispatch blocks (workshop, follow, prayer) at the end of the createNotification function, add an SMS dispatch block.

    Follow the exact same fire-and-forget pattern used for email dispatch:

    ```typescript
    // ---- SMS dispatch (fire-and-forget, non-fatal) ----
    try {
      const { dispatchSMSNotification } = await import('@/lib/sms/queue');
      await dispatchSMSNotification(
        recipient_id,
        type,
        entity_type,
        entity_id,
        preview_text ?? null
      );
    } catch (err) {
      console.error('[Notification] SMS dispatch error:', err);
    }
    ```

    This block goes AFTER all email dispatch blocks but BEFORE `return payload;`.

    The dispatchSMSNotification function (from Plan 03) handles ALL the guard logic internally:
    - Phone exists and is verified
    - Global SMS toggle enabled
    - Per-category toggle enabled
    - Quiet hours check
    - Rate limiting
    - Template existence

    So createNotification just calls it unconditionally (fire-and-forget).
  </action>
  <verify>
    createNotification() has the SMS dispatch block after email blocks.
    The block uses try/catch (non-fatal).
    The block uses dynamic import (same as email pattern).
    TypeScript compiles.
  </verify>
  <done>Every notification now attempts SMS dispatch after email. SMS dispatch is fire-and-forget with full internal guard logic.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. GET /api/settings returns phone, phone_verified, and 6 SMS toggles
3. PUT /api/settings rejects SMS enable when phone not verified
4. createNotification has SMS dispatch block after email blocks
</verification>

<success_criteria>
- Settings GET returns phone, phone_verified, and all 6 sms_* toggles
- Settings PUT accepts and persists SMS toggles, guarded by phone_verified
- createNotification dispatches SMS for every notification (fire-and-forget, non-fatal)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-sms-notifications/13-04-SUMMARY.md`
</output>
