---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server.js
  - next.config.ts
  - package.json
  - tsconfig.json
  - .env.local
  - .env.example
  - .sequelizerc
  - .eslintrc.json
  - .gitignore
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/db/index.ts
  - src/lib/db/config.js
  - src/lib/utils/constants.ts
autonomous: true

must_haves:
  truths:
    - "Next.js dev server starts successfully via custom server.js on port 3000"
    - "Tailwind CSS v4 classes render correctly (utility classes apply styles)"
    - "Sequelize connects to MySQL database without errors"
    - "TypeScript compilation succeeds with zero errors"
  artifacts:
    - path: "server.js"
      provides: "Custom HTTP server wrapping Next.js request handler"
      min_lines: 15
    - path: "src/lib/db/index.ts"
      provides: "Sequelize singleton connection to MySQL"
      contains: "new Sequelize"
    - path: "src/app/globals.css"
      provides: "Tailwind v4 import with dark mode custom variant"
      contains: "@custom-variant dark"
    - path: ".env.example"
      provides: "Template for all required environment variables"
      contains: "JWT_SECRET"
  key_links:
    - from: "server.js"
      to: "next"
      via: "next() app handler"
      pattern: "app\\.getRequestHandler"
    - from: "src/lib/db/index.ts"
      to: "MySQL"
      via: "Sequelize connection"
      pattern: "dialect.*mysql"
---

<objective>
Scaffold the entire Next.js project foundation: custom server, database connection, Tailwind v4, TypeScript config, environment variables, and Sequelize CLI setup.

Purpose: Every other plan in Phase 1 depends on the project existing with a working dev server, database connection, and styling framework. This is the absolute foundation.
Output: A running Next.js 16 app with custom server.js, MySQL/Sequelize connection, Tailwind v4 with dark mode variant, and all config files.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js project with all dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    .eslintrc.json
    .gitignore
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
  </files>
  <action>
Run `npx create-next-app@latest . --typescript --tailwind --app --src-dir --no-import-alias` in the project root (FreeLumaPlatform directory). If prompted about existing files, allow overwrite of scaffolding files only.

After scaffolding, install ALL Phase 1 dependencies in one batch:

```bash
npm install sequelize@6 mysql2 jose bcryptjs @react-oauth/google google-auth-library apple-signin-auth swiper srt-parser-2 html-to-image next-themes lucide-react react-easy-crop @aws-sdk/client-s3 @aws-sdk/s3-request-presigner sharp web-push react-hook-form @hookform/resolvers zod date-fns date-fns-tz nodemailer

npm install -D @types/bcryptjs @types/web-push @types/nodemailer sequelize-cli
```

Update `next.config.ts`:
- Set `reactCompiler: true` in experimental (Next.js 16 supports this)
- Add `serverExternalPackages: ['sequelize', 'mysql2', 'sharp', 'bcryptjs']` to prevent bundling server-only packages
- Do NOT use `output: 'standalone'` (incompatible with custom server)

Update `src/app/globals.css` to use Tailwind v4 syntax:
```css
@import "tailwindcss";

@custom-variant dark (&:where([data-theme="dark"], [data-theme="dark"] *));

@theme {
  --color-primary: #6366F1;
  --color-primary-light: #818CF8;
  --color-primary-dark: #4F46E5;
  --color-accent: #EC4899;
  --color-surface: #FFFFFF;
  --color-surface-dark: #1A1A2E;
  --color-background: #F8FAFC;
  --color-background-dark: #0F0F23;
  --color-text: #1E293B;
  --color-text-dark: #E2E8F0;
  --color-text-muted: #64748B;
  --color-text-muted-dark: #94A3B8;
  --color-border: #E2E8F0;
  --color-border-dark: #334155;
}
```

Update `src/app/layout.tsx` to be a minimal shell (providers added in Plan 03/04):
- Set metadata title to "Free Luma"
- Set metadata description
- Keep `<html>` and `<body>` tags, add `suppressHydrationWarning` to html tag
- Import globals.css

Update `src/app/page.tsx` to show a simple "Free Luma" heading confirming the app works.

Update `.gitignore` to include: `.env.local`, `.env`, `node_modules/`, `.next/`, `out/`, `.DS_Store`. Also add `Old Code/` since that's reference-only.
  </action>
  <verify>
Run `npm run build` and confirm it completes without TypeScript errors. Run `npm run dev` and confirm the page loads at http://localhost:3000 with the "Free Luma" heading.
  </verify>
  <done>Next.js project runs with all Phase 1 dependencies installed, Tailwind v4 renders utility classes, TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Custom server, database connection, Sequelize CLI, and environment config</name>
  <files>
    server.js
    .env.local
    .env.example
    .sequelizerc
    src/lib/db/index.ts
    src/lib/db/config.js
    src/lib/utils/constants.ts
  </files>
  <action>
Create `server.js` at project root (ES module syntax since Next.js 16):
```javascript
import { createServer } from "node:http";
import next from "next";

const dev = process.env.NODE_ENV !== "production";
const hostname = process.env.HOST || "0.0.0.0";
const port = parseInt(process.env.PORT || "3000", 10);

const app = next({ dev, hostname, port });
const handler = app.getRequestHandler();

app.prepare().then(() => {
  const httpServer = createServer(handler);
  // Socket.IO will be attached here in Phase 3
  httpServer.listen(port, hostname, () => {
    console.log(`> Ready on http://${hostname}:${port}`);
  });
});
```

Update `package.json` scripts:
- `"dev": "node server.js"` (not `next dev` -- use custom server)
- `"build": "next build"`
- `"start": "NODE_ENV=production node server.js"`

Create `.env.local` with actual development values for XAMPP MySQL:
```
# Database
DB_HOST=localhost
DB_PORT=3306
DB_NAME=freeluma_dev
DB_USER=root
DB_PASS=

# Auth
JWT_SECRET=dev-jwt-secret-change-in-production-min-32-chars
BCRYPT_ROUNDS=12

# Google OAuth
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# Apple OAuth
APPLE_CLIENT_ID=
APPLE_TEAM_ID=
APPLE_KEY_ID=
APPLE_PRIVATE_KEY=

# Backblaze B2
B2_KEY_ID=
B2_APP_KEY=
B2_BUCKET_NAME=
B2_REGION=us-west-004

# Cloudflare CDN
CDN_BASE_URL=

# Email (SMTP)
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
EMAIL_FROM=noreply@freeluma.com

# Web Push (VAPID)
VAPID_PUBLIC_KEY=
VAPID_PRIVATE_KEY=
VAPID_SUBJECT=mailto:admin@freeluma.com

# Bible API (fallback)
BIBLE_API_KEY=

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_CDN_URL=
NEXT_PUBLIC_VAPID_PUBLIC_KEY=
```

Create `.env.example` as a copy of `.env.local` but with empty/placeholder values and comments explaining each variable.

Create `.sequelizerc` (CommonJS, pointing to src/lib/db paths):
```javascript
const path = require('path');
module.exports = {
  'config': path.resolve('src', 'lib', 'db', 'config.js'),
  'models-path': path.resolve('src', 'lib', 'db', 'models'),
  'seeders-path': path.resolve('src', 'lib', 'db', 'seeders'),
  'migrations-path': path.resolve('src', 'lib', 'db', 'migrations'),
};
```

Create `src/lib/db/config.js` (CommonJS for Sequelize CLI compatibility):
```javascript
require('dotenv').config({ path: '.env.local' });
module.exports = {
  development: {
    username: process.env.DB_USER || 'root',
    password: process.env.DB_PASS || '',
    database: process.env.DB_NAME || 'freeluma_dev',
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '3306'),
    dialect: 'mysql',
    logging: console.log,
  },
  production: {
    username: process.env.DB_USER,
    password: process.env.DB_PASS,
    database: process.env.DB_NAME,
    host: process.env.DB_HOST,
    port: parseInt(process.env.DB_PORT || '3306'),
    dialect: 'mysql',
    logging: false,
    pool: { max: 10, min: 2, acquire: 30000, idle: 10000 },
  },
};
```

Create `src/lib/db/index.ts` (Sequelize singleton using globalThis to survive HMR):
```typescript
import { Sequelize } from 'sequelize';

const globalForSequelize = globalThis as unknown as {
  sequelize: Sequelize | undefined;
};

function createSequelizeInstance(): Sequelize {
  const instance = new Sequelize(
    process.env.DB_NAME || 'freeluma_dev',
    process.env.DB_USER || 'root',
    process.env.DB_PASS || '',
    {
      host: process.env.DB_HOST || 'localhost',
      port: parseInt(process.env.DB_PORT || '3306'),
      dialect: 'mysql',
      logging: process.env.NODE_ENV === 'development' ? console.log : false,
      pool: { max: 10, min: 2, acquire: 30000, idle: 10000 },
    }
  );
  return instance;
}

export const sequelize = globalForSequelize.sequelize ?? createSequelizeInstance();

if (process.env.NODE_ENV !== 'production') {
  globalForSequelize.sequelize = sequelize;
}

// Guard: Prevent sync() in production
const originalSync = sequelize.sync.bind(sequelize);
sequelize.sync = async (...args: any[]) => {
  if (process.env.NODE_ENV === 'production') {
    throw new Error('sequelize.sync() is disabled in production. Use migrations.');
  }
  return originalSync(...args);
};
```

Create `src/lib/utils/constants.ts` with app-wide constants:
```typescript
export const TRANSLATIONS = ['KJV', 'NIV', 'NRSV', 'NAB'] as const;
export type Translation = typeof TRANSLATIONS[number];

export const MODES = ['bible', 'positivity'] as const;
export type Mode = typeof MODES[number];

export const LANGUAGES = ['en', 'es'] as const;
export type Language = typeof LANGUAGES[number];

export const AVATAR_COLORS = [
  '#6366F1', '#8B5CF6', '#EC4899', '#EF4444', '#F97316',
  '#EAB308', '#22C55E', '#14B8A6', '#06B6D4', '#3B82F6',
] as const;

export const BIO_MAX_LENGTH = 150;
export const USERNAME_MIN_LENGTH = 3;
export const USERNAME_MAX_LENGTH = 30;
export const PASSWORD_MIN_LENGTH = 8;

export const BCRYPT_ROUNDS = parseInt(process.env.BCRYPT_ROUNDS || '12');
```

Create the MySQL database using the XAMPP MySQL CLI:
```bash
mysql -u root -e "CREATE DATABASE IF NOT EXISTS freeluma_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

Initialize Sequelize CLI directory structure:
```bash
npx sequelize-cli init
```
This creates the migrations/ and seeders/ directories under the paths defined in .sequelizerc.

Test the database connection by creating a small test script or adding a health check API route at `src/app/api/health/route.ts` that calls `sequelize.authenticate()` and returns { status: 'ok', db: 'connected' }.
  </action>
  <verify>
1. Run `node server.js` and confirm the custom server starts on port 3000.
2. Run `curl http://localhost:3000/api/health` and confirm response includes `"db": "connected"`.
3. Run `npx sequelize-cli db:migrate:status` and confirm it connects to the database (even if no migrations exist yet).
4. Confirm `.env.example` exists with all variable names documented.
  </verify>
  <done>Custom server runs, Sequelize connects to MySQL, Sequelize CLI is configured, all environment variables are documented in .env.example, health endpoint confirms DB connectivity.</done>
</task>

</tasks>

<verification>
1. `node server.js` starts without errors and serves the Next.js app
2. `curl http://localhost:3000` returns HTML with "Free Luma"
3. `curl http://localhost:3000/api/health` returns `{"status":"ok","db":"connected"}`
4. `npx sequelize-cli db:migrate:status` shows connected (no pending migrations yet)
5. `npm run build` succeeds with zero TypeScript errors
</verification>

<success_criteria>
- Next.js 16 project running via custom server.js
- All Phase 1 npm dependencies installed
- Sequelize connected to MySQL via XAMPP
- Tailwind v4 with dark mode custom variant configured
- Environment variables documented and templated
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
