---
phase: 01-foundation
plan: 08
type: execute
wave: 4
depends_on: ["01-02", "01-04"]
files_modified:
  - src/lib/storage/b2.ts
  - src/lib/storage/presign.ts
  - src/app/api/upload/presigned/route.ts
  - src/app/api/upload/avatar/route.ts
  - src/components/profile/InitialsAvatar.tsx
  - src/components/profile/AvatarUpload.tsx
  - src/components/profile/AvatarCrop.tsx
  - src/components/profile/ProfileCard.tsx
  - src/app/(app)/profile/page.tsx
autonomous: true
user_setup:
  - service: backblaze-b2
    why: "Object storage for avatar images and media files"
    env_vars:
      - name: B2_KEY_ID
        source: "Backblaze B2 -> App Keys -> Add New Application Key"
      - name: B2_APP_KEY
        source: "Backblaze B2 -> App Keys -> Application Key (shown once)"
      - name: B2_BUCKET_NAME
        source: "Backblaze B2 -> Buckets -> Create Bucket"
      - name: B2_REGION
        source: "Backblaze B2 -> Buckets -> Endpoint URL (extract region, e.g., us-west-004)"
    dashboard_config:
      - task: "Create a B2 bucket (Public)"
        location: "Backblaze B2 -> Buckets -> Create a Bucket"
      - task: "Create application key with read/write access to the bucket"
        location: "Backblaze B2 -> App Keys -> Add a New Application Key"
      - task: "Optional: Configure Cloudflare CNAME for CDN delivery"
        location: "Cloudflare DNS -> Add CNAME record pointing to B2 bucket URL"

must_haves:
  truths:
    - "User sees their initials avatar with assigned color when no photo is uploaded"
    - "User can upload a photo, crop it, and see the cropped avatar on their profile"
    - "Presigned URLs enable direct browser-to-B2 uploads (no server proxy)"
    - "Profile card displays avatar, name, username, and bio"
  artifacts:
    - path: "src/lib/storage/b2.ts"
      provides: "S3Client configured for Backblaze B2"
      contains: "S3Client"
    - path: "src/lib/storage/presign.ts"
      provides: "Presigned URL generator for B2 uploads"
      contains: "getSignedUrl"
    - path: "src/components/profile/ProfileCard.tsx"
      provides: "Profile card with avatar, name, username, bio"
      min_lines: 30
    - path: "src/components/profile/AvatarCrop.tsx"
      provides: "Avatar crop modal using react-easy-crop"
      contains: "Cropper"
  key_links:
    - from: "src/components/profile/AvatarUpload.tsx"
      to: "/api/upload/presigned"
      via: "fetches presigned URL then uploads to B2"
      pattern: "fetch.*presigned|PUT.*b2"
    - from: "src/components/profile/ProfileCard.tsx"
      to: "src/components/profile/InitialsAvatar.tsx"
      via: "renders initials avatar when no avatar_url"
      pattern: "InitialsAvatar|avatar_url"
---

<objective>
Build the Backblaze B2 storage integration, avatar upload/crop system, and profile card component.

Purpose: Avatar uploads are the first use of the B2 storage system (later used for daily content media). The profile card is the user's identity display used in the profile tab and throughout the app.
Output: B2 client with presigned URL uploads, avatar crop tool, initials avatar fallback, and profile card component on the profile tab.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: B2 storage client, presigned URLs, and avatar processing API</name>
  <files>
    src/lib/storage/b2.ts
    src/lib/storage/presign.ts
    src/app/api/upload/presigned/route.ts
    src/app/api/upload/avatar/route.ts
  </files>
  <action>
Create `src/lib/storage/b2.ts`:
- Configure S3Client for Backblaze B2:
  ```typescript
  import { S3Client } from '@aws-sdk/client-s3';
  export const b2Client = new S3Client({
    endpoint: `https://s3.${process.env.B2_REGION}.backblazeb2.com`,
    region: process.env.B2_REGION!,
    credentials: {
      accessKeyId: process.env.B2_KEY_ID!,
      secretAccessKey: process.env.B2_APP_KEY!,
    },
  });
  export const B2_BUCKET = process.env.B2_BUCKET_NAME!;
  export const CDN_BASE_URL = process.env.CDN_BASE_URL || `https://f005.backblazeb2.com/file/${process.env.B2_BUCKET_NAME}`;
  ```
- Guard: If B2 env vars are missing, log warning but don't crash (graceful degradation)

Create `src/lib/storage/presign.ts`:
- `getUploadUrl(key: string, contentType: string, expiresIn = 3600)`: Generate presigned PUT URL
- `getDownloadUrl(key: string, expiresIn = 3600)`: Generate presigned GET URL (for private files)
- `getPublicUrl(key: string)`: Return CDN URL for public files
- Key format: `{type}/{userId}/{timestamp}-{random}.{ext}` (e.g., avatars/123/1707600000-abc.webp)
- Use PutObjectCommand from @aws-sdk/client-s3 and getSignedUrl from @aws-sdk/s3-request-presigner

Create `src/app/api/upload/presigned/route.ts`:
- GET (protected with withAuth): Generate presigned upload URL
- Query params: type (avatar | daily-content | etc), contentType (image/jpeg, image/png, image/webp, video/mp4)
- Validate allowed content types per upload type:
  - avatar: image/jpeg, image/png, image/webp (max 5MB implied by frontend)
  - daily-content: image/*, video/mp4, audio/* (admin only)
- Generate unique key: `{type}/{userId}/{Date.now()}-${randomChars}.${ext}`
- Return { uploadUrl, key, publicUrl }
- If B2 is not configured: return 503 with { error: "Storage not configured" }

Create `src/app/api/upload/avatar/route.ts`:
- POST (protected with withAuth): Process avatar after upload
- Accepts { key: string } (the B2 key where the avatar was uploaded)
- Optionally: Use sharp to resize/optimize the avatar on the server (download from B2, process, re-upload)
- For Phase 1 simpler approach: Trust the client-side crop (react-easy-crop produces correctly sized output). Just validate the key exists and update the user's avatar_url.
- Update user.avatar_url with the public CDN URL for the key
- Return updated user data
  </action>
  <verify>
1. If B2 is configured:
```bash
curl "http://localhost:3000/api/upload/presigned?type=avatar&contentType=image/jpeg" -H "Cookie: auth_token=..."
# Expected: {"uploadUrl":"https://s3...","key":"avatars/...","publicUrl":"https://..."}
```
2. If B2 is NOT configured:
```bash
curl "http://localhost:3000/api/upload/presigned?type=avatar&contentType=image/jpeg" -H "Cookie: auth_token=..."
# Expected: 503 {"error":"Storage not configured"}
```
3. `npm run build` passes.
  </verify>
  <done>B2 client configured, presigned URL generation working, avatar processing endpoint ready, graceful fallback when B2 not configured.</done>
</task>

<task type="auto">
  <name>Task 2: Avatar components (initials, upload, crop) and profile card</name>
  <files>
    src/components/profile/InitialsAvatar.tsx
    src/components/profile/AvatarUpload.tsx
    src/components/profile/AvatarCrop.tsx
    src/components/profile/ProfileCard.tsx
    src/app/(app)/profile/page.tsx
  </files>
  <action>
Create `src/components/profile/InitialsAvatar.tsx`:
- "use client" directive
- Props: name (string), color (string -- hex), size (number, default 48), className
- Extract initials: first letter of first two words, uppercase, max 2 chars
- Render circular div with background color, centered white text
- Font size scales with container: fontSize = size * 0.4
- Use cn() for class merging

Create `src/components/profile/AvatarCrop.tsx`:
- "use client" directive
- Uses react-easy-crop Cropper component inside a Modal
- Props: imageSrc (string -- data URL or object URL), onCropComplete(croppedBlob: Blob), onCancel()
- Cropper config: aspect ratio 1 (square), cropShape 'round', showGrid false
- Zoom slider below the crop area
- "Save" and "Cancel" buttons
- On save: Use the getCroppedImg helper (create utility using canvas API) to extract cropped area as Blob
- Cropped output: 256x256 pixels, JPEG quality 0.9

Create `src/components/profile/AvatarUpload.tsx`:
- "use client" directive
- Props: currentAvatarUrl (string | null), avatarColor (string), displayName (string), onAvatarChange(url: string)
- Shows current avatar: If avatarUrl exists, show <img>. If not, show InitialsAvatar.
- "Change Photo" button overlaid on avatar (camera icon)
- On click: Opens hidden file input (accept="image/jpeg,image/png,image/webp")
- On file select: Read file as data URL, open AvatarCrop modal
- On crop complete:
  1. Fetch presigned URL from /api/upload/presigned?type=avatar&contentType=image/jpeg
  2. Upload cropped blob to B2 via PUT to the presigned URL
  3. Call POST /api/upload/avatar with { key } to confirm and update user
  4. Call onAvatarChange(publicUrl) to update parent state
- If presigned URL returns 503 (B2 not configured): Show toast "Photo upload not available yet" and use initials avatar
- Loading state during upload

Create `src/components/profile/ProfileCard.tsx`:
- "use client" directive
- Props: user (UserData from AuthContext)
- Layout: Card component wrapping:
  - Avatar (large, centered or left-aligned) -- AvatarUpload or just display
  - Display name (bold, large)
  - @username (muted, smaller)
  - Bio (if present, regular text)
- Edit button to toggle into edit mode (or link to settings)
- Clean, minimal design per CONTEXT.md: "No badges or mode indicators on profile card"

Update `src/app/(app)/profile/page.tsx`:
- Replace placeholder with actual profile page
- Top section: ProfileCard with current user data from useAuth()
- Below: Settings list (links to settings sub-pages)
- Settings links (each as a Card/list item with chevron):
  - Account Management (edit email, password)
  - Appearance (dark mode toggle)
  - Language Preference
  - Notification Settings
  - Mode Toggle (faith/positivity)
  - Log Out (red text, calls logout from useAuth)
- For Phase 1: Most settings links are stubs that navigate to /settings or show "Coming soon". The Log Out button should work immediately.
- Add a working dark mode toggle (light/dark/system) inline in Appearance row using useTheme()
  </action>
  <verify>
1. Navigate to /profile tab -- ProfileCard shows user's initials avatar with assigned color.
2. Click "Change Photo" -- file picker opens, select an image, crop modal appears.
3. Crop and save -- if B2 configured, avatar uploads and displays. If not, shows fallback toast.
4. Display name, @username, and bio render correctly.
5. Settings list items render with proper labels.
6. "Log Out" button logs user out and redirects to /login.
7. Dark mode toggle in Appearance works.
8. `npm run build` passes.
  </verify>
  <done>Complete profile tab: ProfileCard with avatar (initials fallback or uploaded photo), settings list with working logout and dark mode toggle, avatar upload/crop via B2 presigned URLs.</done>
</task>

</tasks>

<verification>
1. InitialsAvatar renders with correct initials and assigned color
2. Avatar crop produces square 256x256 output
3. Presigned URL upload to B2 works (when configured)
4. Graceful degradation when B2 not configured
5. Profile card displays all user info
6. Profile page has settings links with working logout
7. Build succeeds
</verification>

<success_criteria>
- B2 S3Client configured with presigned URL generation
- Avatar upload flow: file select -> crop -> upload to B2 -> display
- InitialsAvatar fallback with permanent random color
- ProfileCard with avatar, name, @username, bio
- Profile tab with settings list (logout works, dark mode toggle works)
- Graceful degradation when B2 credentials not configured
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-08-SUMMARY.md`
</output>
