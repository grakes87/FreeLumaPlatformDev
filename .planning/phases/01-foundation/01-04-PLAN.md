---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-03"]
files_modified:
  - src/app/layout.tsx
  - src/app/(public)/layout.tsx
  - src/app/(app)/layout.tsx
  - src/app/onboarding/layout.tsx
  - src/app/(app)/page.tsx
  - src/app/(app)/prayer-wall/page.tsx
  - src/app/(app)/feed/page.tsx
  - src/app/(app)/bible-studies/page.tsx
  - src/app/(app)/animations/page.tsx
  - src/app/(app)/profile/page.tsx
  - src/app/not-found.tsx
  - src/app/error.tsx
  - src/app/loading.tsx
  - src/components/layout/TopBar.tsx
  - src/components/layout/BottomNav.tsx
  - src/components/layout/AppShell.tsx
  - src/context/AuthContext.tsx
  - src/hooks/useAuth.ts
  - src/styles/globals.css
autonomous: true

must_haves:
  truths:
    - "Bottom tab navigation shows correct tabs based on user mode (6 for bible, 5 for positivity)"
    - "Dark mode toggle switches between light, dark, and system themes"
    - "Authenticated routes redirect unauthenticated users to login"
    - "Public routes (/login, /signup) are accessible without auth"
  artifacts:
    - path: "src/components/layout/BottomNav.tsx"
      provides: "Bottom tab navigation with mode-conditional tabs and icons"
      min_lines: 50
    - path: "src/components/layout/TopBar.tsx"
      provides: "Top bar with app logo and notification bell"
      min_lines: 20
    - path: "src/context/AuthContext.tsx"
      provides: "Auth state provider checking JWT cookie via /api/auth/me"
      contains: "AuthProvider"
    - path: "src/app/(app)/layout.tsx"
      provides: "Authenticated layout with TopBar and BottomNav"
      contains: "BottomNav"
  key_links:
    - from: "src/app/(app)/layout.tsx"
      to: "src/context/AuthContext.tsx"
      via: "AuthProvider wrapping or auth check"
      pattern: "useAuth|AuthProvider"
    - from: "src/components/layout/BottomNav.tsx"
      to: "src/context/AuthContext.tsx"
      via: "user mode determines visible tabs"
      pattern: "mode.*bible|positivity"
    - from: "src/app/layout.tsx"
      to: "next-themes"
      via: "ThemeProvider wrapping"
      pattern: "ThemeProvider"
---

<objective>
Build the app shell: root layout with providers, route groups (public/app/onboarding), bottom tab navigation, top bar, dark mode, auth context, and placeholder pages for all tabs.

Purpose: This creates the navigation and layout structure that all feature pages live inside. Without it, there is no authenticated/public route separation, no navigation, and no theme support.
Output: Complete app shell with working navigation between all tab pages, dark mode toggle, and auth-aware routing.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Root layout, providers, auth context, route group layouts</name>
  <files>
    src/app/layout.tsx
    src/app/not-found.tsx
    src/app/error.tsx
    src/app/loading.tsx
    src/app/(public)/layout.tsx
    src/app/(app)/layout.tsx
    src/app/onboarding/layout.tsx
    src/context/AuthContext.tsx
    src/hooks/useAuth.ts
  </files>
  <action>
Update `src/app/layout.tsx` (root layout):
- Import and wrap children with ThemeProvider from next-themes (attribute="data-theme", defaultTheme="system", enableSystem)
- Import and wrap children with ToastProvider from '@/components/ui/Toast'
- Set `<html lang="en" suppressHydrationWarning>`
- Set metadata: title="Free Luma", description="Daily inspiration and faith-based community"
- Import globals.css

Create `src/context/AuthContext.tsx`:
- "use client" directive
- AuthContext with createContext
- State: user (null | UserData), loading (boolean), isAuthenticated (boolean)
- On mount, fetch GET /api/auth/me to check if JWT cookie is valid
- If valid: set user data, isAuthenticated = true
- If 401: set user = null, isAuthenticated = false
- Provide: user, loading, isAuthenticated, login(userData), logout(), refreshUser()
- login(): Sets user state (JWT cookie is set by the login API response)
- logout(): Calls POST /api/auth/logout, clears user state, redirects to /login
- refreshUser(): Re-fetches /api/auth/me (for after profile updates)
- UserData type: { id, email, display_name, username, avatar_url, avatar_color, mode, onboarding_complete, is_admin, preferred_translation, language, timezone }
- NOTE: The /api/auth/me endpoint does not exist yet (created in Plan 05). For now, AuthContext should handle the 401 gracefully (treats as not authenticated).

Create `src/hooks/useAuth.ts`:
- Simple hook that returns useContext(AuthContext) with a guard for provider missing

Create `src/app/(public)/layout.tsx`:
- Minimal layout: no navigation shell, centered content area
- White/dark background, max-width container centered
- Does NOT wrap with AuthProvider (public routes don't need auth state)

Create `src/app/(app)/layout.tsx`:
- Wraps children with AuthProvider
- Checks isAuthenticated + loading state
- If loading: show LoadingSpinner
- If not authenticated: redirect to /login (use next/navigation redirect)
- If authenticated but onboarding_complete === false: redirect to /onboarding/mode
- Renders TopBar at top, children in main area (scrollable), BottomNav at bottom
- Main area: pb-16 (space for fixed bottom nav), pt-14 (space for fixed top bar)

Create `src/app/onboarding/layout.tsx`:
- Wraps children with AuthProvider
- If not authenticated: redirect to /login
- If onboarding_complete === true: redirect to / (app home)
- Shows step indicator at top (Step 1 of 4, Step 2 of 4, etc.)
- No bottom nav, no top bar
- Clean centered layout with logo

Create `src/app/not-found.tsx`: Simple 404 page with "Page not found" message and link to home.
Create `src/app/error.tsx`: Error boundary UI using ErrorBoundary component.
Create `src/app/loading.tsx`: Full-page LoadingSpinner.
  </action>
  <verify>
1. `npm run build` succeeds (TypeScript compiles).
2. Visit http://localhost:3000 -- should redirect to /login (since no auth cookie exists).
3. The root layout renders without hydration warnings.
  </verify>
  <done>Root layout with ThemeProvider + ToastProvider, auth context with JWT check, three route group layouts (public/app/onboarding), and global error/loading/404 pages.</done>
</task>

<task type="auto">
  <name>Task 2: Bottom nav, top bar, app shell, placeholder pages, dark mode</name>
  <files>
    src/components/layout/TopBar.tsx
    src/components/layout/BottomNav.tsx
    src/components/layout/AppShell.tsx
    src/app/(app)/page.tsx
    src/app/(app)/prayer-wall/page.tsx
    src/app/(app)/feed/page.tsx
    src/app/(app)/bible-studies/page.tsx
    src/app/(app)/animations/page.tsx
    src/app/(app)/profile/page.tsx
  </files>
  <action>
Create `src/components/layout/TopBar.tsx`:
- "use client" directive
- Fixed at top, full width, z-30
- Left: App logo text "Free Luma" in brand font/color (or simple styled text)
- Right: Notification bell icon (lucide-react Bell icon), with future badge spot
- Background: bg-surface/90 backdrop-blur-md border-b border-border, dark variants
- Height: h-14
- Special behavior: When on daily post page, use bg-transparent (semi-transparent overlay on video). Accept a `transparent` prop for this.

Create `src/components/layout/BottomNav.tsx`:
- "use client" directive
- Fixed at bottom, full width, z-30
- Uses useAuth() to get user's mode
- Icons only, no labels (per CONTEXT.md decision)
- Bible mode (6 tabs): Daily Post (Sparkles icon), Prayer Wall (Heart icon), Feed (MessageSquare icon), Bible Studies (BookOpen icon), Luma Animations (Film icon), Profile (User icon)
- Positivity mode (5 tabs): Same minus Luma Animations
- Active tab: primary color icon, slightly larger or filled variant
- Inactive tab: muted text color
- Background: bg-surface/90 backdrop-blur-md border-t border-border, dark variants
- Height: h-16
- Special behavior: When on daily post page, use bg-transparent (semi-transparent). Accept a `transparent` prop.
- Use Next.js Link for navigation, usePathname() for active state detection
- Tab routes: / (daily), /prayer-wall, /feed, /bible-studies, /animations, /profile

Create `src/components/layout/AppShell.tsx`:
- Combines TopBar and BottomNav around children
- Handles the transparent overlay detection (checks if current route is '/' for daily post)
- main element with overflow-y-auto, padding for top/bottom bars

Create placeholder pages (all "use client", each shows EmptyState with appropriate icon and "Coming in Phase 2" or similar message):
- `src/app/(app)/page.tsx`: "Daily Post" (will be replaced by Plan 10). For now show "Daily Post - Coming Soon" with Sparkles icon.
- `src/app/(app)/prayer-wall/page.tsx`: "Prayer Wall - Coming in Phase 2"
- `src/app/(app)/feed/page.tsx`: "Feed - Coming in Phase 2"
- `src/app/(app)/bible-studies/page.tsx`: "Bible Studies - Coming Soon"
- `src/app/(app)/animations/page.tsx`: "Luma Animations - Coming Soon"
- `src/app/(app)/profile/page.tsx`: "Profile - Coming Soon" (will be replaced by Plan 08)

Each placeholder should be visually clean: centered EmptyState component with icon, title, and brief description.

Verify dark mode works end-to-end:
- ThemeProvider is in root layout
- Add a temporary theme toggle button in the TopBar (or profile placeholder page) using `useTheme()` from next-themes
- Confirm light/dark/system all work and persist across page refresh
  </action>
  <verify>
1. Since the (app) layout requires auth, temporarily bypass the auth check (or create a mock) to view the app shell. Alternative: manually set a cookie in the browser or temporarily disable the auth redirect.
2. Confirm bottom nav shows 6 tabs (assuming bible mode default or mock).
3. Click each tab -- navigation works and corresponding placeholder page loads.
4. Toggle dark mode -- all components switch theme correctly.
5. `npm run build` passes with zero errors.
  </verify>
  <done>Complete app shell with fixed top bar (logo + bell), bottom tab nav (mode-conditional, icons only), all tab placeholder pages, and working dark mode toggle.</done>
</task>

</tasks>

<verification>
1. App shell renders with TopBar and BottomNav
2. Bottom nav conditionally shows/hides Luma Animations tab based on user mode
3. Dark mode toggle works (light -> dark -> system)
4. Route groups separate public/app/onboarding layouts
5. Unauthenticated access to (app) routes redirects to login
6. Build succeeds
</verification>

<success_criteria>
- Three route groups: (public), (app), onboarding
- TopBar with logo and notification bell
- BottomNav with 6 tabs (bible) / 5 tabs (positivity), icons only
- AuthContext checks JWT via /api/auth/me
- Dark mode (light/dark/system) works via next-themes
- All tab routes have placeholder pages
- Semi-transparent nav overlay mode for daily post page
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
