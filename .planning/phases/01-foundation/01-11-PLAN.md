---
phase: 01-foundation
plan: 11
type: execute
wave: 5
depends_on: ["01-05", "01-08"]
files_modified:
  - src/app/(app)/settings/page.tsx
  - src/app/api/settings/route.ts
  - src/app/api/auth/forgot-password/route.ts
  - src/app/api/auth/reset-password/route.ts
  - src/app/(public)/forgot-password/page.tsx
  - src/app/(public)/reset-password/page.tsx
  - src/components/common/VerifyEmailBanner.tsx
  - src/lib/email/index.ts
  - src/lib/email/templates.ts
autonomous: true
user_setup:
  - service: smtp-email
    why: "Send password reset and verification emails"
    env_vars:
      - name: SMTP_HOST
        source: "Email provider settings (e.g., smtp.gmail.com, smtp.sendgrid.net)"
      - name: SMTP_PORT
        source: "Email provider settings (typically 587 for TLS)"
      - name: SMTP_USER
        source: "Email provider username or API key"
      - name: SMTP_PASS
        source: "Email provider password or API key"
    dashboard_config:
      - task: "Configure SMTP credentials (Gmail app password, SendGrid API key, or similar)"
        location: "Your email provider's dashboard"

must_haves:
  truths:
    - "User can access settings page and change preferences"
    - "User can request password reset and receives email with reset link"
    - "User can reset password via the emailed link"
    - "Settings changes persist to database"
    - "Verify email banner shows for unverified users"
  artifacts:
    - path: "src/app/(app)/settings/page.tsx"
      provides: "Settings page with all preference options"
      min_lines: 50
    - path: "src/app/api/auth/forgot-password/route.ts"
      provides: "Password reset email sending"
      exports: ["POST"]
    - path: "src/lib/email/index.ts"
      provides: "Nodemailer email sending utility"
      contains: "nodemailer"
    - path: "src/components/common/VerifyEmailBanner.tsx"
      provides: "Banner prompting unverified users to verify email"
      contains: "verify"
  key_links:
    - from: "src/app/api/auth/forgot-password/route.ts"
      to: "src/lib/email/index.ts"
      via: "sends reset email"
      pattern: "sendEmail|sendPasswordReset"
    - from: "src/app/api/settings/route.ts"
      to: "src/lib/db/models/UserSetting.ts"
      via: "updates user settings in DB"
      pattern: "UserSetting\\.(update|findOne)"
---

<objective>
Build the settings page, password reset flow, email sending infrastructure, and email verification banner.

Purpose: Users need to manage their preferences (dark mode, language, mode, notifications) and recover access when they forget passwords. Email infrastructure is also needed for verification reminders.
Output: Complete settings page, working password reset flow (email -> link -> new password), and verify email banner.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
@.planning/phases/01-foundation/01-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email infrastructure, password reset flow</name>
  <files>
    src/lib/email/index.ts
    src/lib/email/templates.ts
    src/app/api/auth/forgot-password/route.ts
    src/app/api/auth/reset-password/route.ts
    src/app/(public)/forgot-password/page.tsx
    src/app/(public)/reset-password/page.tsx
  </files>
  <action>
Create `src/lib/email/index.ts`:
- Configure nodemailer transporter:
  ```typescript
  import nodemailer from 'nodemailer';
  const transporter = nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: parseInt(process.env.SMTP_PORT || '587'),
    secure: false,
    auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS },
  });
  ```
- `sendEmail(to: string, subject: string, html: string)`: Send email via transporter
- If SMTP_HOST not configured: Log the email to console instead of sending (graceful dev mode)
- `sendPasswordResetEmail(to: string, resetUrl: string)`: Uses template
- `sendVerificationEmail(to: string, verifyUrl: string)`: Uses template

Create `src/lib/email/templates.ts`:
- `passwordResetTemplate(resetUrl: string)`: Returns HTML email body for password reset
  - Clean HTML email with Free Luma branding
  - "Reset Your Password" heading
  - Button/link to the reset URL
  - "This link expires in 1 hour"
  - Footer: "If you didn't request this, ignore this email"
- `verificationTemplate(verifyUrl: string)`: Returns HTML email for email verification
  - Similar clean branding
  - "Verify Your Email" heading
  - Button/link to verify URL

Create `src/app/api/auth/forgot-password/route.ts`:
- POST: Accepts { email: string }
- Rate limit: 3 per hour per email
- Find user by email
- If not found: Still return 200 (don't reveal whether email exists)
- If found:
  - Generate random token (crypto.randomUUID())
  - Store token in user.email_verification_token (or a separate password_reset_token column -- add to User model if needed. Alternatively, use a JWT with short expiry that encodes the user ID)
  - Better approach: Generate a signed JWT with 1-hour expiry containing { id, email, purpose: 'password_reset' }. No DB column needed.
  - Build reset URL: `${APP_URL}/reset-password?token=${jwt}`
  - Send password reset email
- Always return 200 { message: "If an account exists with that email, a reset link has been sent" }

Create `src/app/api/auth/reset-password/route.ts`:
- POST: Accepts { token: string, password: string }
- Verify the reset JWT (must have purpose: 'password_reset' and not expired)
- Validate new password with Zod (same rules as registration)
- Hash new password with bcryptjs
- Update user's password_hash
- Reset failed_login_attempts to 0, clear locked_until
- Return 200 { message: "Password reset successfully" }

Create `src/app/(public)/forgot-password/page.tsx`:
- "use client" directive
- Simple form: email input + "Send Reset Link" button
- On submit: POST /api/auth/forgot-password
- On success: Show "Check your email for a reset link" message
- Link: "Back to Login" -> /login

Create `src/app/(public)/reset-password/page.tsx`:
- "use client" directive
- Reads token from URL query param (?token=...)
- If no token: Show error "Invalid reset link"
- Form: new password + confirm password inputs
- Validate passwords match and meet requirements
- On submit: POST /api/auth/reset-password with { token, password }
- On success: Show "Password reset! Redirecting to login..." and redirect to /login
- On error: Show error message (expired token, invalid token)
  </action>
  <verify>
```bash
# 1. Request password reset
curl -X POST http://localhost:3000/api/auth/forgot-password -H "Content-Type: application/json" -d '{"email":"test@example.com"}'
# Expected: 200 (check console for logged email if SMTP not configured)

# 2. Visit forgot-password page
# http://localhost:3000/forgot-password -- form renders

# 3. Extract the reset token from the console log (if SMTP not configured)
# Visit http://localhost:3000/reset-password?token=<jwt_token>

# 4. Submit new password
curl -X POST http://localhost:3000/api/auth/reset-password -H "Content-Type: application/json" -d '{"token":"<jwt>","password":"NewPass123!"}'
# Expected: 200

# 5. Login with new password
curl -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"email":"test@example.com","password":"NewPass123!"}'
# Expected: 200 with JWT cookie

# 6. Build passes
npm run build
```
  </verify>
  <done>Email infrastructure (nodemailer with dev fallback), password reset flow (forgot -> email -> reset page -> new password), and email templates.</done>
</task>

<task type="auto">
  <name>Task 2: Settings page and verify email banner</name>
  <files>
    src/app/(app)/settings/page.tsx
    src/app/api/settings/route.ts
    src/components/common/VerifyEmailBanner.tsx
  </files>
  <action>
Create `src/app/api/settings/route.ts`:
- GET (protected with withAuth): Return user's settings (from UserSetting table + user preferences from User table)
  - Merge UserSetting fields (dark_mode, push_enabled, email_notifications, daily_reminder_time) with User fields (mode, language, preferred_translation, timezone)
- PUT (protected with withAuth): Update settings
  - Accepts partial updates: { dark_mode?, push_enabled?, email_notifications?, daily_reminder_time?, mode?, language?, preferred_translation?, timezone? }
  - Validate with Zod
  - Update UserSetting for setting-specific fields
  - Update User for user-specific fields (mode, language, preferred_translation)
  - Return updated settings

Create `src/app/(app)/settings/page.tsx`:
- "use client" directive
- Fetches settings on mount from GET /api/settings
- Sections (each a Card or grouped list):

**Account**
- Email display (read-only, with "Change" link -- change email deferred)
- "Change Password" button -> shows inline form: current password + new password + confirm. Calls PUT /api/auth/change-password (create this simple endpoint that verifies current password then updates)
- Create `src/app/api/auth/change-password/route.ts`: POST, protected, accepts { current_password, new_password }, verifies current, hashes new, updates.

**Appearance**
- Dark mode: 3-option toggle (Light / Dark / System) using useTheme() from next-themes
- This should update the local theme immediately AND save to DB for cross-device sync

**Content Preferences**
- Mode toggle: Bible / Positivity (two large toggle buttons)
  - Switching mode immediately updates the nav tabs (Luma Animations appears/disappears)
  - Calls PUT /api/settings with { mode: newMode }
  - Shows confirmation: "Switch to [mode]? This changes your daily content."
- Default Bible translation: Dropdown select (KJV, NIV, NRSV, NAB)
- Language: Toggle (English / Spanish)

**Notifications**
- Push notifications: Toggle switch (on/off)
- Email notifications: Toggle switch
- Daily reminder time: Time picker (default 8:00 AM)
- (Quiet hours deferred -- UI present but disabled with "Coming soon" label)

**About**
- "Log Out" button (red, prominent)
- App version info
- Terms of Service link (placeholder)
- Privacy Policy link (placeholder)

All toggles/selects should auto-save on change (debounced PUT to /api/settings) with a subtle "Saved" toast confirmation.

Create `src/components/common/VerifyEmailBanner.tsx`:
- "use client" directive
- Uses useAuth() to check user.email_verified
- If email_verified === false: Show a dismissable banner at top of app (below TopBar)
  - "Verify your email address to secure your account" + "Send verification email" button + "X" dismiss
  - On "Send": POST to a verify-email endpoint (send verification email)
  - Dismissable: hide for current session (store in sessionStorage)
- If email_verified === true: render nothing
- Add this banner to the (app) layout, above the main content

Also create the email verification endpoint:
- POST /api/auth/send-verification: Protected, generates verification JWT, sends email
- GET /api/auth/verify-email?token=xxx: Verifies token, sets user.email_verified = true, redirects to app
  </action>
  <verify>
1. Navigate to /settings -- all sections render with current values.
2. Toggle dark mode -- switches immediately and persists across refresh.
3. Switch mode (Bible -> Positivity) -- bottom nav updates (Animations tab disappears).
4. Change Bible translation -- saves to DB.
5. Log out -- redirects to /login, cookie cleared.
6. Verify email banner shows for unverified users.
7. Click "Send verification email" -- email sent (or logged to console).
8. Change password -- old password no longer works, new password works.
9. `npm run build` passes.
  </verify>
  <done>Complete settings page with all preference controls, change password, verify email banner, and auto-saving preferences to database.</done>
</task>

</tasks>

<verification>
1. Password reset: forgot -> email -> reset page -> login with new password
2. Settings page renders all sections
3. Dark mode, mode, language, translation preferences save and persist
4. Change password works (verifies current, sets new)
5. Verify email banner shows for unverified users
6. Logout clears session and redirects
7. Email infrastructure works (sends or logs to console)
8. Build succeeds
</verification>

<success_criteria>
- Nodemailer email sending (with console fallback for dev)
- Password reset flow: request -> email -> reset page -> new password
- Settings page: dark mode, mode toggle, language, translation, notification toggles
- Change password with current password verification
- Verify email banner (non-blocking, dismissable)
- All settings auto-save to database
- Log out works from settings
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-11-SUMMARY.md`
</output>
