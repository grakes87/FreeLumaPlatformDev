---
phase: 01-foundation
plan: 09
type: execute
wave: 4
depends_on: ["01-02", "01-05"]
files_modified:
  - src/app/api/daily-posts/route.ts
  - src/app/api/daily-posts/[date]/route.ts
  - src/app/api/translations/route.ts
  - src/lib/bible-api/index.ts
  - src/lib/utils/timezone.ts
  - src/hooks/useDailyContent.ts
autonomous: true
user_setup:
  - service: bible-api
    why: "Fallback Bible translation source when translation missing from database"
    env_vars:
      - name: BIBLE_API_KEY
        source: "scripture.api.bible -> Sign Up -> My Apps -> Create App -> API Key"
    dashboard_config:
      - task: "Create free account and application"
        location: "scripture.api.bible"

must_haves:
  truths:
    - "GET /api/daily-posts returns today's content based on user timezone and mode"
    - "GET /api/daily-posts/YYYY-MM-DD returns historical content for that date"
    - "Translation switcher returns verse in requested translation"
    - "If translation missing from DB, it's fetched from bible.api and cached"
    - "Daily content changes at user's local midnight"
  artifacts:
    - path: "src/app/api/daily-posts/route.ts"
      provides: "GET today's daily content with timezone awareness"
      exports: ["GET"]
    - path: "src/app/api/daily-posts/[date]/route.ts"
      provides: "GET historical daily content by date"
      exports: ["GET"]
    - path: "src/lib/bible-api/index.ts"
      provides: "API.Bible fallback fetcher that caches translations to DB"
      contains: "bible.api"
    - path: "src/lib/utils/timezone.ts"
      provides: "Timezone-aware date calculation for user's local midnight"
      contains: "getUserLocalDate"
  key_links:
    - from: "src/app/api/daily-posts/route.ts"
      to: "src/lib/utils/timezone.ts"
      via: "calculates today for user's timezone"
      pattern: "getUserLocalDate|timezone"
    - from: "src/app/api/daily-posts/route.ts"
      to: "src/lib/db/models/DailyContent.ts"
      via: "queries daily content by date and mode"
      pattern: "DailyContent\\.findOne"
    - from: "src/app/api/translations/route.ts"
      to: "src/lib/bible-api/index.ts"
      via: "falls back to bible.api when translation not in DB"
      pattern: "fetchFromBibleApi|bible.*api"
---

<objective>
Build the daily content API: fetch today's post by user timezone and mode, historical posts by date, translation switching with bible.api fallback, and the client-side hook.

Purpose: Daily inspirational content is the core value of the platform. This plan creates the data pipeline: timezone-aware "today" calculation, content retrieval from the database, translation switching, and API.Bible fallback for missing translations.
Output: Working API endpoints that return daily content with proper timezone handling, translation support, and caching fallback.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Timezone utility, bible.api fallback, and daily content API endpoints</name>
  <files>
    src/lib/utils/timezone.ts
    src/lib/bible-api/index.ts
    src/app/api/daily-posts/route.ts
    src/app/api/daily-posts/[date]/route.ts
    src/app/api/translations/route.ts
  </files>
  <action>
Create `src/lib/utils/timezone.ts`:
- `getUserLocalDate(timezone: string): string` -- Returns YYYY-MM-DD for "today" in the user's timezone
  - Use date-fns-tz: `formatInTimeZone(new Date(), timezone, 'yyyy-MM-dd')`
- `detectTimezone(): string` -- Client-side: returns Intl.DateTimeFormat().resolvedOptions().timeZone
- Export both functions

Create `src/lib/bible-api/index.ts`:
- `fetchVerseFromBibleApi(verseReference: string, translationCode: string): Promise<string | null>`
- Uses scripture.api.bible REST API
- Steps:
  1. Map our translation codes to bible.api Bible IDs (e.g., KJV -> 'de4e12af7f28f599-02')
  2. Parse verse reference (e.g., "John 3:16" -> book/chapter/verse)
  3. Fetch: GET /v1/bibles/{bibleId}/verses/{verseId} with API key header
  4. Extract passage text from response
  5. If successful: Cache to DailyContentTranslation table with source='api'
  6. Return text or null on failure
- Handle errors gracefully: log but don't throw (fallback should not crash the main flow)
- If BIBLE_API_KEY is not set: return null (skip fallback)
- Mapping of translation codes to bible.api IDs (maintain a lookup object)

Create `src/app/api/daily-posts/route.ts`:
- GET (protected with withAuth):
- Read user's timezone and mode from the JWT user data (or fetch from User model)
- Calculate "today" in user's timezone using getUserLocalDate()
- Query: DailyContent.findOne({ where: { post_date: today, mode: userMode, language: userLanguage, published: true }, include: [DailyContentTranslation] })
- If found: Return daily content with all available translations
- If not found: Return 404 { error: "No content for today" } with helpful message
- Response shape:
  ```json
  {
    "id": 1,
    "post_date": "2026-02-11",
    "mode": "bible",
    "title": "Daily Verse",
    "content_text": "For God so loved the world...",
    "verse_reference": "John 3:16",
    "chapter_reference": "John 3",
    "video_background_url": "https://cdn.../bg.mp4",
    "audio_url": "https://cdn.../audio.mp3",
    "audio_srt_url": "https://cdn.../subtitles.srt",
    "lumashort_video_url": "https://cdn.../lumashort.mp4",
    "translations": [
      { "code": "KJV", "text": "For God so loved..." },
      { "code": "NIV", "text": "For God so loved..." }
    ]
  }
  ```

Create `src/app/api/daily-posts/[date]/route.ts`:
- GET (protected with withAuth):
- Param: date (YYYY-MM-DD format)
- Validate date format
- Ensure date is not in the future (based on user timezone)
- Same query as above but with specific date instead of "today"
- Return daily content for that date or 404

Create `src/app/api/translations/route.ts`:
- GET (protected with withAuth):
- Query params: daily_content_id, translation_code
- First: Check DailyContentTranslation table for existing translation
- If found: Return the text
- If not found AND mode is 'bible': Attempt fetchVerseFromBibleApi() using the verse_reference from the DailyContent record
- If bible.api returns text: Save to DailyContentTranslation (source='api'), return text
- If bible.api fails: Return 404 { error: "Translation not available" }
- For positivity mode: Translations don't apply (quotes are language-based, not translation-based). Return 400 if translation requested for positivity content.

Also create a seeder or manual SQL insert for sample daily content to test with:
- Insert 3-5 daily content records (past dates + today) for both bible and positivity modes
- Insert some DailyContentTranslation records (at least KJV for bible posts)
- Use placeholder URLs for video/audio (can be empty strings or placeholder URLs)
  </action>
  <verify>
```bash
# Insert test content first (if not done by seeder)
# Then test:

# 1. Get today's content
curl http://localhost:3000/api/daily-posts -H "Cookie: auth_token=..."
# Expected: 200 with daily content JSON (or 404 if no content seeded for today)

# 2. Get historical content
curl http://localhost:3000/api/daily-posts/2026-02-10 -H "Cookie: auth_token=..."
# Expected: 200 with content for that date

# 3. Get translation
curl "http://localhost:3000/api/translations?daily_content_id=1&translation_code=KJV" -H "Cookie: auth_token=..."
# Expected: 200 with translation text

# 4. Future date should fail
curl http://localhost:3000/api/daily-posts/2099-01-01 -H "Cookie: auth_token=..."
# Expected: 400 "Cannot view future content"

# 5. Build passes
npm run build
```
  </verify>
  <done>Daily content API endpoints working: timezone-aware today query, historical date query, translation switching with bible.api fallback and DB caching, sample content seeded for testing.</done>
</task>

<task type="auto">
  <name>Task 2: Client-side daily content hook and admin content seeder</name>
  <files>
    src/hooks/useDailyContent.ts
    src/lib/db/seeders/005-sample-daily-content.js
  </files>
  <action>
Create `src/hooks/useDailyContent.ts`:
- "use client" hook
- `useDailyContent(date?: string)`: Fetches daily content for a specific date or today
- State: content (DailyContentData | null), loading (boolean), error (string | null)
- Fetches from GET /api/daily-posts (or /api/daily-posts/{date} if date provided)
- `switchTranslation(translationCode: string)`: Fetches translation from /api/translations and updates the displayed text
- `activeTranslation`: Currently displayed translation code
- Caches fetched translations in state to avoid re-fetching
- Returns: { content, loading, error, activeTranslation, switchTranslation, availableTranslations }
- Type definitions:
  ```typescript
  interface DailyContentData {
    id: number;
    post_date: string;
    mode: 'bible' | 'positivity';
    title: string;
    content_text: string;
    verse_reference: string | null;
    chapter_reference: string | null;
    video_background_url: string;
    audio_url: string | null;
    audio_srt_url: string | null;
    lumashort_video_url: string | null;
    translations: Array<{ code: string; text: string }>;
  }
  ```

Create `src/lib/db/seeders/005-sample-daily-content.js`:
- Insert sample daily content for the past 7 days plus today
- For bible mode: sample verses (John 3:16, Psalm 23:1, Philippians 4:13, etc.)
- For positivity mode: sample inspirational quotes
- Include DailyContentTranslation records for KJV (at least)
- Use placeholder URLs for media: empty string or a known public placeholder video URL
- This seeder is critical for testing the daily content UI in Plan 10

Run the seeder:
```bash
npx sequelize-cli db:seed --seed 005-sample-daily-content.js
```
  </action>
  <verify>
1. Import useDailyContent in a test component and verify it fetches today's content.
2. Call switchTranslation('KJV') and verify the text updates.
3. Verify the seeder creates content: `mysql -u root -e "SELECT post_date, mode, title FROM freeluma_dev.daily_content ORDER BY post_date DESC LIMIT 10;"`
4. `npm run build` passes.
  </verify>
  <done>Client-side hook for fetching and switching daily content translations, plus sample content seeded for 7+ days of testing.</done>
</task>

</tasks>

<verification>
1. GET /api/daily-posts returns content for today based on user timezone
2. GET /api/daily-posts/YYYY-MM-DD returns historical content
3. Translation switching works (fetches from DB or falls back to bible.api)
4. Future dates are rejected
5. useDailyContent hook fetches and caches translations
6. Sample content exists in DB for testing
7. Build succeeds
</verification>

<success_criteria>
- Timezone-aware daily content retrieval (user's local midnight)
- Historical content access via date parameter
- Translation switching: KJV/NIV/NRSV/NAB with DB-first, bible.api fallback
- Fetched translations cached to database for future requests
- Client hook with translation caching and switching
- Sample content seeded for 7+ days of testing
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-09-SUMMARY.md`
</output>
