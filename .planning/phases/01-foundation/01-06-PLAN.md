---
phase: 01-foundation
plan: 06
type: execute
wave: 4
depends_on: ["01-04", "01-05"]
files_modified:
  - src/app/(public)/login/page.tsx
  - src/app/(public)/signup/page.tsx
  - src/app/(public)/layout.tsx
  - src/components/auth/LoginForm.tsx
  - src/components/auth/SignupForm.tsx
  - src/components/auth/ActivationCodeStep.tsx
  - src/components/auth/GoogleButton.tsx
  - src/components/auth/AppleButton.tsx
  - src/components/auth/SocialDivider.tsx
  - src/app/api/auth/google/route.ts
  - src/app/api/auth/apple/route.ts
  - src/lib/auth/google.ts
  - src/lib/auth/apple.ts
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google Sign-In for user registration/login"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized JavaScript origins: http://localhost:3000 and production URL"
        location: "Google Cloud Console -> OAuth Client ID settings"
  - service: apple-signin
    why: "Apple Sign-In for user registration/login"
    env_vars:
      - name: APPLE_CLIENT_ID
        source: "Apple Developer -> Identifiers -> Services IDs"
      - name: APPLE_TEAM_ID
        source: "Apple Developer -> Account -> Membership -> Team ID"
      - name: APPLE_KEY_ID
        source: "Apple Developer -> Keys -> Sign in with Apple key"
      - name: APPLE_PRIVATE_KEY
        source: "Apple Developer -> Keys -> Download .p8 key file, base64 encode contents"
    dashboard_config:
      - task: "Create Service ID with Sign in with Apple capability"
        location: "Apple Developer -> Certificates, Identifiers & Profiles -> Identifiers"
      - task: "Create and download Sign in with Apple key (.p8)"
        location: "Apple Developer -> Keys"
      - task: "Configure return URL in Service ID (HTTPS required)"
        location: "Apple Developer -> Identifiers -> Services IDs -> Configure"

must_haves:
  truths:
    - "User sees a clean login page with email/password form and social login buttons"
    - "User can complete signup flow: activation code -> credentials -> redirects to onboarding"
    - "Google Sign-In button triggers OAuth popup and creates/links account"
    - "Login and signup forms validate inputs and show error messages"
  artifacts:
    - path: "src/app/(public)/login/page.tsx"
      provides: "Login page with form and social buttons"
      min_lines: 20
    - path: "src/components/auth/LoginForm.tsx"
      provides: "Login form with react-hook-form + zod validation"
      contains: "useForm"
    - path: "src/components/auth/SignupForm.tsx"
      provides: "Multi-step signup: activation code -> credentials"
      contains: "useForm"
    - path: "src/app/api/auth/google/route.ts"
      provides: "Google OAuth credential verification and JWT issuance"
      exports: ["POST"]
  key_links:
    - from: "src/components/auth/LoginForm.tsx"
      to: "/api/auth/login"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/auth/login"
    - from: "src/components/auth/SignupForm.tsx"
      to: "/api/auth/register"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/auth/register"
    - from: "src/components/auth/GoogleButton.tsx"
      to: "/api/auth/google"
      via: "sends Google credential to backend"
      pattern: "fetch.*api/auth/google"
---

<objective>
Build the login page, signup page, and social OAuth (Google + Apple Sign-In) with complete UI forms and API endpoints.

Purpose: Users need to be able to see and interact with the platform entry points. This creates the visual login/signup experience and adds Google/Apple as alternative auth methods.
Output: Working login page with social buttons, multi-step signup flow (activation code -> credentials), and Google/Apple OAuth backend integration.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Login page, signup page, and auth form components</name>
  <files>
    src/app/(public)/login/page.tsx
    src/app/(public)/signup/page.tsx
    src/app/(public)/layout.tsx
    src/components/auth/LoginForm.tsx
    src/components/auth/SignupForm.tsx
    src/components/auth/ActivationCodeStep.tsx
    src/components/auth/SocialDivider.tsx
  </files>
  <action>
Update `src/app/(public)/layout.tsx` if needed:
- Centered layout, max-w-md container
- Background: subtle gradient or clean white/dark surface
- No nav bars

Create `src/components/auth/LoginForm.tsx`:
- "use client" directive
- Uses react-hook-form with zodResolver and loginSchema from validation.ts
- Fields: email (Input component), password (Input component with type="password")
- Submit button (Button component with loading state)
- On submit: fetch POST /api/auth/login
- On success: call login() from useAuth(), redirect to / (router.push('/'))
- On error: show error message (toast or inline)
- Link below: "Don't have an account? Sign up" -> /signup
- Link below: "Forgot password?" -> /forgot-password

Create `src/components/auth/ActivationCodeStep.tsx`:
- "use client" directive
- Uses react-hook-form for a single code input field
- On URL load, check for ?activation_code= query param and auto-fill
- On submit: fetch POST /api/activation-codes/validate
- On success: call onValidated(code, mode_hint) callback prop
- On error: show "Invalid or expired activation code"
- Clean UI: centered card with "Enter your activation code" heading

Create `src/components/auth/SignupForm.tsx`:
- "use client" directive
- Two-step form:
  1. ActivationCodeStep (validates code)
  2. Credentials step: email, password, display_name, username fields + Terms checkbox + Date of birth (date picker or 3 selects for month/day/year)
- Uses react-hook-form with zodResolver and registerSchema
- On submit (step 2): fetch POST /api/auth/register with all fields + activation_code
- On success: call login() from useAuth(), redirect to /onboarding/mode
- On error: show appropriate error (duplicate email, duplicate username, etc.)
- Check for ?mode= query param to store for later use in onboarding
- Password requirements displayed below password field (at least 8 chars, uppercase, lowercase, number)
- Username field: prefix with "@" visual indicator, validate lowercase alphanumeric + underscores

Create `src/components/auth/SocialDivider.tsx`:
- Simple "or" divider line between form and social buttons
- Renders: `<div class="flex items-center gap-4"><hr class="flex-1"/><span>or</span><hr class="flex-1"/></div>`

Create `src/app/(public)/login/page.tsx`:
- App logo at top (text "Free Luma" or image if available)
- LoginForm component centered
- SocialDivider
- Google and Apple sign-in buttons (placeholder for now, connected in Task 2)
- Clean, branded layout per CONTEXT.md: "app logo at top, login form centered, social login buttons below"

Create `src/app/(public)/signup/page.tsx`:
- App logo at top
- SignupForm component centered
- SocialDivider + social buttons after credentials step
- Link: "Already have an account? Log in" -> /login
  </action>
  <verify>
1. Visit http://localhost:3000/login -- login page renders with form and social button placeholders.
2. Visit http://localhost:3000/signup -- activation code step shows.
3. Enter a valid activation code from the DB -- proceeds to credentials step.
4. Fill in credentials and submit -- user created, cookie set, redirects to /onboarding/mode (which may show loading/redirect since onboarding pages don't exist yet, that's OK).
5. Visit http://localhost:3000/login, log in with the new user -- redirects to app.
6. Try duplicate email -- shows error.
7. Try invalid activation code -- shows error.
  </verify>
  <done>Login and signup pages with complete forms, activation code validation, react-hook-form + zod, social button placeholders, and proper error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Google and Apple OAuth integration (backend + frontend buttons)</name>
  <files>
    src/components/auth/GoogleButton.tsx
    src/components/auth/AppleButton.tsx
    src/app/api/auth/google/route.ts
    src/app/api/auth/apple/route.ts
    src/lib/auth/google.ts
    src/lib/auth/apple.ts
  </files>
  <action>
Create `src/lib/auth/google.ts`:
- Import OAuth2Client from google-auth-library
- `verifyGoogleCredential(credential: string)`: Verifies the Google ID token using OAuth2Client.verifyIdToken(). Returns { email, name, picture, googleId } or throws.
- Uses process.env.GOOGLE_CLIENT_ID as audience

Create `src/lib/auth/apple.ts`:
- Import appleSignin from apple-signin-auth
- `verifyAppleToken(identityToken: string)`: Verifies Apple identity token. Returns { email, name, appleId } or throws.
- Uses Apple public keys for verification (handled by apple-signin-auth library)

Create `src/app/api/auth/google/route.ts`:
- POST: Accepts { credential: string, activation_code?: string }
- Verify Google credential server-side
- Extract email, name, picture, googleId from verified payload
- Find user by google_id:
  - If found: Sign JWT, set cookie, return user (login flow)
  - If not found by google_id, check by email:
    - If found by email: Link google_id to existing user, sign JWT (account linking)
    - If not found at all: This is a new signup -- activation_code is REQUIRED
      - Validate activation code (same atomic pattern as register)
      - Create user with google_id, email, display_name from Google, avatar_url from picture
      - Mark onboarding_complete = false
      - Sign JWT, return user with redirect hint to /onboarding/mode
- Always return user data + set auth cookie

Create `src/app/api/auth/apple/route.ts`:
- POST: Accepts { identityToken: string, user?: { name?: { firstName, lastName } }, activation_code?: string }
- Apple only returns user's name on FIRST authorization (subsequent logins omit it)
- Verify identity token server-side
- Same find-or-create flow as Google:
  - Find by apple_id -> login
  - Find by email -> link apple_id
  - Not found -> require activation_code, create user
- Apple may not provide email if user chose "Hide My Email" -- handle relay email

Create `src/components/auth/GoogleButton.tsx`:
- "use client" directive
- Uses @react-oauth/google GoogleLogin component
- Wrap the app with GoogleOAuthProvider in the public layout (provide clientId from env)
- On success callback: send credential to POST /api/auth/google
- If new user (no activation code yet): Show message that activation code is needed, pass code along
- Handle the flow: If user is signing up and already entered activation code, pass it with the Google credential
- Style: Google-branded button (GoogleLogin component handles this)
- If GOOGLE_CLIENT_ID is not set, render the button in disabled state with tooltip "Google Sign-In not configured"

Create `src/components/auth/AppleButton.tsx`:
- "use client" directive
- Load Apple JS SDK via script tag or use a React wrapper
- Render "Sign in with Apple" button (Apple-branded black button)
- On success: send identityToken + user info to POST /api/auth/apple
- Same activation code flow as Google
- If APPLE_CLIENT_ID is not set, render disabled with tooltip

Wire the Google and Apple buttons into the login and signup pages (below the SocialDivider).

Wrap the (public) layout with GoogleOAuthProvider:
```tsx
<GoogleOAuthProvider clientId={process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID || ''}>
  {children}
</GoogleOAuthProvider>
```

NOTE: OAuth buttons will only fully work when the user configures the OAuth credentials. The implementation should gracefully handle missing credentials by disabling the buttons rather than crashing.
  </action>
  <verify>
1. Visit http://localhost:3000/login -- Google and Apple buttons render (may be disabled if credentials not configured).
2. If GOOGLE_CLIENT_ID is set: Click Google button, popup opens, consent screen shows.
3. After Google consent: user created/logged in, cookie set, redirected.
4. `npm run build` passes -- no import errors or TypeScript issues.
5. Test the API directly with curl (mock a Google credential if needed):
```bash
curl -X POST http://localhost:3000/api/auth/google -H "Content-Type: application/json" -d '{"credential":"invalid"}'
# Expected: 400 or 401 (invalid token)
```
  </verify>
  <done>Google and Apple OAuth integration: client-side buttons trigger popup, server-side verification with find-or-create user flow, activation code required for new signups, graceful degradation when credentials not configured.</done>
</task>

</tasks>

<verification>
1. Login page renders with email/password form + Google + Apple buttons
2. Signup page renders with activation code step -> credentials step
3. Email/password registration creates user with hashed password
4. Google OAuth creates/links user account
5. Apple OAuth creates/links user account
6. Social login buttons gracefully handle missing credentials
7. All forms validate inputs with inline error messages
8. Build succeeds
</verification>

<success_criteria>
- Clean branded login page (logo, form, social buttons)
- Multi-step signup (activation code -> credentials + TOC + DOB)
- Google Sign-In via @react-oauth/google with server-side verification
- Apple Sign-In via apple-signin-auth with server-side verification
- Both OAuth methods require activation code for new users
- React-hook-form + zod validation on all forms
- Graceful degradation when OAuth credentials not configured
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md`
</output>
