---
phase: 01-foundation
plan: 12
type: execute
wave: 4
depends_on: ["01-02", "01-04"]
files_modified:
  - public/sw.js
  - src/lib/push/index.ts
  - src/app/api/push/subscribe/route.ts
  - src/hooks/usePushNotifications.ts
  - src/app/api/admin/activation-codes/route.ts
  - src/app/api/admin/daily-content/route.ts
  - src/app/(public)/bible/page.tsx
  - src/app/(public)/positivity/page.tsx
autonomous: true

must_haves:
  truths:
    - "Service worker registers and can receive push events"
    - "User can subscribe to push notifications via the API"
    - "Admin can generate activation codes in bulk"
    - "Admin can schedule daily content"
    - "/bible and /positivity entry pages render for unauthenticated users"
  artifacts:
    - path: "public/sw.js"
      provides: "Minimal push-only service worker (NOT a PWA)"
      contains: "push"
    - path: "src/lib/push/index.ts"
      provides: "web-push VAPID configuration and send helper"
      contains: "webpush"
    - path: "src/app/api/admin/activation-codes/route.ts"
      provides: "POST endpoint for bulk activation code generation"
      exports: ["POST", "GET"]
    - path: "src/app/api/admin/daily-content/route.ts"
      provides: "POST/PUT endpoint for scheduling daily content"
      exports: ["POST", "PUT", "GET"]
  key_links:
    - from: "src/hooks/usePushNotifications.ts"
      to: "public/sw.js"
      via: "registers service worker and subscribes"
      pattern: "serviceWorker\\.register|PushManager"
    - from: "src/app/api/push/subscribe/route.ts"
      to: "src/lib/db/models/PushSubscription.ts"
      via: "saves subscription to database"
      pattern: "PushSubscription\\.create"
---

<objective>
Build push notification infrastructure (service worker + VAPID + subscription API), basic admin endpoints (activation codes + daily content management), and entry pages (/bible, /positivity).

Purpose: Push notification infrastructure must be established in Phase 1 even though it's fully used in Phase 3. Admin endpoints are needed to populate daily content and generate activation codes. Entry pages support NFC bracelet and shareable link flows.
Output: Push-ready service worker, admin CRUD for codes/content, and branded entry pages.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push notification infrastructure (service worker, VAPID, subscription API)</name>
  <files>
    public/sw.js
    src/lib/push/index.ts
    src/app/api/push/subscribe/route.ts
    src/hooks/usePushNotifications.ts
  </files>
  <action>
Create `public/sw.js` (minimal push-only service worker -- NOT a PWA):
```javascript
// Minimal push-only service worker for Free Luma
// This is NOT a PWA -- no offline caching, no install prompts

self.addEventListener('push', (event) => {
  const data = event.data?.json() ?? {};
  event.waitUntil(
    self.registration.showNotification(data.title || 'Free Luma', {
      body: data.body || '',
      icon: '/icons/icon-192.png',
      badge: '/icons/badge-72.png',
      data: { url: data.url || '/' },
      tag: data.tag || 'default',
    })
  );
});

self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  const url = event.notification.data?.url || '/';
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((windowClients) => {
      for (const client of windowClients) {
        if (client.url.includes(self.location.origin) && 'focus' in client) {
          return client.focus();
        }
      }
      return clients.openWindow(url);
    })
  );
});
```

Create placeholder icon files:
- `public/icons/icon-192.png` -- create a simple placeholder (can be generated or use a 1x1 transparent PNG for now)
- `public/icons/badge-72.png` -- same placeholder

Create `src/lib/push/index.ts`:
- Configure web-push with VAPID keys:
  ```typescript
  import webpush from 'web-push';

  if (process.env.VAPID_PUBLIC_KEY && process.env.VAPID_PRIVATE_KEY) {
    webpush.setVapidDetails(
      process.env.VAPID_SUBJECT || 'mailto:admin@freeluma.com',
      process.env.VAPID_PUBLIC_KEY,
      process.env.VAPID_PRIVATE_KEY
    );
  }
  ```
- `sendPushNotification(subscription: PushSubscriptionData, payload: { title, body, url?, tag? })`: Calls webpush.sendNotification()
- `sendPushToUser(userId: number, payload)`: Fetches all active PushSubscription records for user, sends to each. Handles 410 Gone by deactivating stale subscriptions.
- `generateVapidKeys()`: Helper to generate new VAPID key pair (utility for initial setup)
- If VAPID keys not configured: log warning, functions are no-ops

Create `src/app/api/push/subscribe/route.ts`:
- POST (protected with withAuth): Save push subscription
- Accepts: { endpoint: string, keys: { p256dh: string, auth: string } }
- Validate payload structure
- Upsert: If subscription with same endpoint exists for user, update. If new, create.
- Save to PushSubscription model: user_id, endpoint, p256dh=keys.p256dh, auth_key=keys.auth, user_agent from request headers
- Return 201 { message: "Subscribed" }

- DELETE (protected with withAuth): Unsubscribe
- Accepts: { endpoint: string }
- Set active=false for matching subscription
- Return 200 { message: "Unsubscribed" }

Create `src/hooks/usePushNotifications.ts`:
- "use client" hook
- `usePushNotifications()`:
  - `isSupported`: Check if 'serviceWorker' in navigator && 'PushManager' in window
  - `permission`: Current notification permission state (default, granted, denied)
  - `isSubscribed`: Whether user has an active push subscription
  - `subscribe()`:
    1. Register service worker: `navigator.serviceWorker.register('/sw.js')`
    2. Request notification permission: `Notification.requestPermission()`
    3. If granted: Get push subscription from service worker registration: `registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: VAPID_PUBLIC_KEY })`
    4. Send subscription to POST /api/push/subscribe
    5. Update isSubscribed state
  - `unsubscribe()`: Unsubscribe from push manager, call DELETE /api/push/subscribe
  - Returns: { isSupported, permission, isSubscribed, subscribe, unsubscribe }
- VAPID public key from process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY
  </action>
  <verify>
1. Visit http://localhost:3000 -- service worker registers (check browser DevTools -> Application -> Service Workers)
2. Call subscribe() (e.g., from a test button or browser console) -- permission dialog appears
3. After granting permission: subscription saved to push_subscriptions table in DB
4. `mysql -u root -e "SELECT user_id, endpoint FROM freeluma_dev.push_subscriptions LIMIT 5;"`
5. If VAPID keys configured: test sending a push notification via a temporary test endpoint or script
6. `npm run build` passes
  </verify>
  <done>Push notification infrastructure ready: minimal service worker, VAPID configuration, subscription API, and client-side hook for subscribing/unsubscribing.</done>
</task>

<task type="auto">
  <name>Task 2: Admin endpoints (activation codes, daily content) and entry pages</name>
  <files>
    src/app/api/admin/activation-codes/route.ts
    src/app/api/admin/daily-content/route.ts
    src/app/(public)/bible/page.tsx
    src/app/(public)/positivity/page.tsx
  </files>
  <action>
Create admin auth helper: Create or extend middleware with `withAdmin(handler)` that checks withAuth AND user.is_admin === true. Return 403 if not admin.

Create `src/app/api/admin/activation-codes/route.ts`:
- POST (protected with withAdmin): Generate activation codes in bulk
- Accepts: { count: number (1-100), mode_hint?: 'bible' | 'positivity', expires_in_days?: number (default 365) }
- Generate `count` unique codes: 12-character alphanumeric strings (uppercase letters + digits, exclude confusing chars like O/0/I/l)
- Insert all codes in bulk: ActivationCode.bulkCreate(codes)
- Return 201 { codes: string[], count: number }

- GET (protected with withAdmin): List activation codes with stats
- Query params: page, limit, used (boolean filter)
- Return paginated list with usage stats: { codes: [...], total, unused_count, used_count }

Create `src/app/api/admin/daily-content/route.ts`:
- POST (protected with withAdmin): Schedule daily content
- Accepts: { post_date, mode, title, content_text, verse_reference?, chapter_reference?, video_background_url, audio_url?, audio_srt_url?, lumashort_video_url?, language?, translations?: [{ code, text }] }
- Validate: post_date format, required fields
- Create DailyContent record
- If translations provided: create DailyContentTranslation records
- Return 201 with created content

- PUT (protected with withAdmin): Update daily content
- Accepts: { id: number, ...same fields as POST }
- Update existing DailyContent record
- Return 200 with updated content

- GET (protected with withAdmin): List daily content
- Query params: page, limit, mode, start_date, end_date
- Return paginated list of daily content with translation counts

NOTE: A full admin panel UI is deferred (could be built as a simple admin section or using a tool like AdminJS). For Phase 1, these API endpoints are sufficient for managing content via curl or a REST client. The seeder (Plan 09) pre-populates sample content for development.

Create `src/app/(public)/bible/page.tsx`:
- Entry page for /bible path (NFC bracelet tap or shared link)
- Clean branded landing page:
  - Large "Free Luma" logo
  - Tagline: "Daily inspiration for your faith journey"
  - Subtle Bible verse or inspirational message
  - "Get Started" button -> /signup?mode=bible
  - "Already have an account?" -> /login
- If ?activation_code= in URL: Pass to signup page via query param
- Visual: Beautiful, immersive landing with faith-oriented imagery or gradient

Create `src/app/(public)/positivity/page.tsx`:
- Entry page for /positivity path
- Same structure as /bible but with positivity branding:
  - Tagline: "Daily positivity to brighten your world"
  - Warm, uplifting visual design
  - "Get Started" -> /signup?mode=positivity
  - "Already have an account?" -> /login
- If ?activation_code= in URL: Pass to signup

Both entry pages should:
- Detect and forward query params: activation_code, mode
- Be visually distinct but share the same layout structure
- Be SEO-friendly (proper meta tags, description)
  </action>
  <verify>
```bash
# Login as admin
curl -s -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@freeluma.com","password":"AdminDev123!"}' -c cookies.txt

# Generate activation codes
curl -X POST http://localhost:3000/api/admin/activation-codes -H "Content-Type: application/json" -b cookies.txt -d '{"count":5,"mode_hint":"bible"}'
# Expected: 201 with 5 codes

# List codes
curl "http://localhost:3000/api/admin/activation-codes?page=1&limit=10" -b cookies.txt
# Expected: 200 with paginated code list

# Schedule daily content
curl -X POST http://localhost:3000/api/admin/daily-content -H "Content-Type: application/json" -b cookies.txt -d '{"post_date":"2026-02-12","mode":"bible","title":"Daily Verse","content_text":"For God so loved the world...","verse_reference":"John 3:16","video_background_url":"","translations":[{"code":"KJV","text":"For God so loved the world..."}]}'
# Expected: 201

# Visit entry pages
# http://localhost:3000/bible -- bible landing page renders
# http://localhost:3000/positivity -- positivity landing page renders
# http://localhost:3000/bible?activation_code=TESTCODE -- redirects to signup with params

# Non-admin user should get 403 on admin endpoints
curl -X POST http://localhost:3000/api/admin/activation-codes -H "Content-Type: application/json" -H "Cookie: auth_token=<regular_user_token>" -d '{"count":5}'
# Expected: 403

# Build passes
npm run build
```
  </verify>
  <done>Admin endpoints for activation code generation and daily content scheduling, plus branded /bible and /positivity entry pages with NFC bracelet URL support.</done>
</task>

</tasks>

<verification>
1. Service worker registers in browser
2. Push subscription saves to database
3. Admin can generate activation codes in bulk
4. Admin can schedule daily content
5. Non-admin users get 403 on admin endpoints
6. /bible entry page renders with faith branding
7. /positivity entry page renders with positivity branding
8. URL params (activation_code, mode) forward to signup
9. Build succeeds
</verification>

<success_criteria>
- Minimal push-only service worker (NOT a PWA) deployed at /sw.js
- web-push VAPID configuration with send helper
- Push subscription API (subscribe/unsubscribe)
- Client hook for push permission and subscription management
- Admin bulk activation code generation (admin-only)
- Admin daily content scheduling (admin-only)
- /bible and /positivity branded entry pages
- NFC bracelet URL flow: /bible?activation_code=XXX -> signup with pre-filled code and mode
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-12-SUMMARY.md`
</output>
