---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/db/models/User.ts
  - src/lib/db/models/ActivationCode.ts
  - src/lib/db/models/DailyContent.ts
  - src/lib/db/models/DailyContentTranslation.ts
  - src/lib/db/models/BibleTranslation.ts
  - src/lib/db/models/Category.ts
  - src/lib/db/models/UserCategory.ts
  - src/lib/db/models/UserSetting.ts
  - src/lib/db/models/PushSubscription.ts
  - src/lib/db/models/index.ts
  - src/lib/db/migrations/*
  - src/lib/db/seeders/*
autonomous: true

must_haves:
  truths:
    - "All database tables are created via migrations (not sync)"
    - "Model associations correctly link Users to their content, categories, and settings"
    - "Seeder populates initial categories and a test admin user"
  artifacts:
    - path: "src/lib/db/models/User.ts"
      provides: "User model with all auth, profile, and preference fields"
      contains: "class User extends Model"
    - path: "src/lib/db/models/DailyContent.ts"
      provides: "DailyContent model for admin-scheduled daily posts"
      contains: "post_date"
    - path: "src/lib/db/models/index.ts"
      provides: "Model registry with all associations defined"
      contains: "hasMany"
  key_links:
    - from: "src/lib/db/models/index.ts"
      to: "src/lib/db/index.ts"
      via: "imports sequelize instance"
      pattern: "import.*sequelize.*from"
    - from: "src/lib/db/models/User.ts"
      to: "src/lib/db/models/ActivationCode.ts"
      via: "hasOne/belongsTo association"
      pattern: "ActivationCode"
---

<objective>
Create all Sequelize database models, migrations, and seeders for Phase 1.

Purpose: Every feature (auth, daily content, profiles, settings) needs database models. Creating them all upfront in one plan avoids model-creation overhead in every subsequent plan and ensures associations are defined coherently.
Output: 9 Sequelize models with TypeScript types, CLI migrations for all tables, and seeders for initial data.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create all Sequelize models with TypeScript types</name>
  <files>
    src/lib/db/models/User.ts
    src/lib/db/models/ActivationCode.ts
    src/lib/db/models/DailyContent.ts
    src/lib/db/models/DailyContentTranslation.ts
    src/lib/db/models/BibleTranslation.ts
    src/lib/db/models/Category.ts
    src/lib/db/models/UserCategory.ts
    src/lib/db/models/UserSetting.ts
    src/lib/db/models/PushSubscription.ts
    src/lib/db/models/index.ts
  </files>
  <action>
Create each model file following the pattern from 01-RESEARCH.md. Each model must:
- Use TypeScript interfaces for attributes and creation attributes
- Use `Model<Attributes, CreationAttributes>` generics
- Use `declare` for attribute properties
- Use `underscored: true` for snake_case column names
- Use `timestamps: true` for created_at/updated_at

**User.ts** (most complex model):
- Fields: id (INT AUTO_INCREMENT PK), email (STRING UNIQUE NOT NULL), password_hash (STRING nullable for OAuth-only), google_id (STRING UNIQUE nullable), apple_id (STRING UNIQUE nullable), display_name (STRING NOT NULL), username (STRING UNIQUE NOT NULL), avatar_url (STRING nullable), avatar_color (STRING NOT NULL -- hex for initials), bio (STRING(150) nullable), date_of_birth (DATEONLY nullable), mode (ENUM bible/positivity DEFAULT bible), timezone (STRING DEFAULT America/New_York), preferred_translation (STRING(10) DEFAULT KJV), language (ENUM en/es DEFAULT en), email_verified (BOOLEAN DEFAULT false), email_verification_token (STRING nullable), onboarding_complete (BOOLEAN DEFAULT false), is_admin (BOOLEAN DEFAULT false), last_login_at (DATE nullable), failed_login_attempts (INT DEFAULT 0), locked_until (DATE nullable), deleted_at (DATE nullable -- paranoid soft delete)
- Options: paranoid: true, tableName: 'users'

**ActivationCode.ts:**
- Fields: id, code (STRING(12) UNIQUE NOT NULL), used (BOOLEAN DEFAULT false), used_by (INT nullable FK->users), mode_hint (ENUM bible/positivity nullable), expires_at (DATE NOT NULL), created_by (INT nullable FK->users for admin tracking)
- Options: tableName: 'activation_codes'

**DailyContent.ts:**
- Fields: id, post_date (DATEONLY NOT NULL), mode (ENUM bible/positivity NOT NULL), title (STRING NOT NULL), content_text (TEXT NOT NULL -- verse text or quote), verse_reference (STRING nullable -- e.g. "John 3:16"), chapter_reference (STRING nullable -- e.g. "John 3"), video_background_url (STRING(500) NOT NULL), audio_url (STRING(500) nullable), audio_srt_url (STRING(500) nullable), lumashort_video_url (STRING(500) nullable), language (ENUM en/es DEFAULT en), published (BOOLEAN DEFAULT true)
- Unique constraint on [post_date, mode, language]
- Options: tableName: 'daily_content'

**DailyContentTranslation.ts:**
- Fields: id, daily_content_id (INT FK->daily_content NOT NULL), translation_code (STRING(10) NOT NULL -- KJV/NIV/etc), translated_text (TEXT NOT NULL), verse_reference (STRING nullable), source (ENUM database/api DEFAULT database)
- Unique constraint on [daily_content_id, translation_code]
- Options: tableName: 'daily_content_translations'

**BibleTranslation.ts:**
- Fields: id, code (STRING(10) UNIQUE NOT NULL -- KJV/NIV/etc), name (STRING NOT NULL -- "King James Version"), language (STRING DEFAULT en), is_public_domain (BOOLEAN DEFAULT false), attribution_text (TEXT nullable -- required copyright notice), active (BOOLEAN DEFAULT true)
- Options: tableName: 'bible_translations'

**Category.ts:**
- Fields: id, name (STRING NOT NULL), slug (STRING UNIQUE NOT NULL), description (TEXT nullable), icon (STRING nullable), sort_order (INT DEFAULT 0), active (BOOLEAN DEFAULT true)
- Options: tableName: 'categories'

**UserCategory.ts:**
- Fields: id, user_id (INT FK->users NOT NULL), category_id (INT FK->categories NOT NULL)
- Unique constraint on [user_id, category_id]
- Options: tableName: 'user_categories'

**UserSetting.ts:**
- Fields: id, user_id (INT FK->users UNIQUE NOT NULL), dark_mode (ENUM light/dark/system DEFAULT system), push_enabled (BOOLEAN DEFAULT true), email_notifications (BOOLEAN DEFAULT true), daily_reminder_time (STRING DEFAULT '08:00'), quiet_hours_start (STRING nullable), quiet_hours_end (STRING nullable)
- Options: tableName: 'user_settings'

**PushSubscription.ts:**
- Fields: id, user_id (INT FK->users NOT NULL), endpoint (TEXT NOT NULL), p256dh (TEXT NOT NULL), auth_key (TEXT NOT NULL -- named auth_key to avoid collision with Sequelize's auth), user_agent (STRING nullable), active (BOOLEAN DEFAULT true)
- Options: tableName: 'push_subscriptions'

**index.ts** (model registry):
- Import sequelize from '../index'
- Import all model classes
- Define associations:
  - User hasMany PushSubscription
  - User hasMany UserCategory
  - User hasOne UserSetting
  - User hasMany ActivationCode (via used_by as "usedCodes")
  - DailyContent hasMany DailyContentTranslation
  - Category hasMany UserCategory
  - UserCategory belongsTo User
  - UserCategory belongsTo Category
  - DailyContentTranslation belongsTo DailyContent
  - PushSubscription belongsTo User
  - UserSetting belongsTo User
- Export all models and the sequelize instance
  </action>
  <verify>
Import the model registry in a test script or the health API route and call `sequelize.authenticate()` followed by `sequelize.sync({ alter: true })` in development to verify all models compile and create tables correctly. Then verify tables exist:
```bash
mysql -u root -e "USE freeluma_dev; SHOW TABLES;"
```
Should list: users, activation_codes, daily_content, daily_content_translations, bible_translations, categories, user_categories, user_settings, push_subscriptions.
  </verify>
  <done>All 9 models defined with TypeScript types, associations configured, and tables can be created in the database.</done>
</task>

<task type="auto">
  <name>Task 2: Create Sequelize CLI migrations and seeders</name>
  <files>
    src/lib/db/migrations/001-create-users.js
    src/lib/db/migrations/002-create-activation-codes.js
    src/lib/db/migrations/003-create-categories.js
    src/lib/db/migrations/004-create-user-categories.js
    src/lib/db/migrations/005-create-daily-content.js
    src/lib/db/migrations/006-create-daily-content-translations.js
    src/lib/db/migrations/007-create-bible-translations.js
    src/lib/db/migrations/008-create-user-settings.js
    src/lib/db/migrations/009-create-push-subscriptions.js
    src/lib/db/seeders/001-bible-translations.js
    src/lib/db/seeders/002-categories.js
    src/lib/db/seeders/003-admin-user.js
    src/lib/db/seeders/004-sample-activation-codes.js
  </files>
  <action>
Create Sequelize CLI migration files (CommonJS format for CLI compatibility). Each migration must have `up` and `down` functions. Use timestamps in filenames (e.g., `20260211000001-create-users.js`) -- OR use numeric prefix ordering (001, 002, etc.). The numeric prefix approach is simpler.

Each migration should mirror the corresponding model definition exactly. Include:
- All columns with correct types, constraints, defaults
- Foreign key constraints with ON DELETE CASCADE or SET NULL as appropriate
- Unique indexes and composite unique constraints
- created_at and updated_at timestamps

Migration 001 (users): Include all User columns. Add indexes on email, username, google_id, apple_id.
Migration 002 (activation_codes): FK to users (used_by). Add index on code.
Migration 003 (categories): Standard table.
Migration 004 (user_categories): FKs to users and categories. Composite unique on [user_id, category_id].
Migration 005 (daily_content): Composite unique on [post_date, mode, language]. Add index on post_date.
Migration 006 (daily_content_translations): FK to daily_content. Composite unique on [daily_content_id, translation_code].
Migration 007 (bible_translations): Add index on code.
Migration 008 (user_settings): FK to users (unique). One-to-one relationship.
Migration 009 (push_subscriptions): FK to users.

Create seeders:

**001-bible-translations.js**: Insert the 4 supported translations:
- KJV: "King James Version", en, is_public_domain: true, attribution: null
- NIV: "New International Version", en, is_public_domain: false, attribution: "Scripture quotations taken from the Holy Bible, New International Version..."
- NRSV: "New Revised Standard Version", en, is_public_domain: false, attribution: appropriate text
- NAB: "New American Bible", en, is_public_domain: false, attribution: appropriate text

**002-categories.js**: Insert initial categories:
- Prayer Requests (slug: prayer-requests)
- Testimony (slug: testimony)
- Devotional (slug: devotional)
- Encouragement (slug: encouragement)
- Bible Study (slug: bible-study)
- Worship (slug: worship)

**003-admin-user.js**: Create a test admin user (email: admin@freeluma.com, password hashed with bcrypt, is_admin: true, display_name: "Admin", username: "admin", avatar_color: "#6366F1", onboarding_complete: true, mode: "bible"). Use bcryptjs to hash a known dev password ("AdminDev123!").

**004-sample-activation-codes.js**: Generate 10 sample activation codes (12-char alphanumeric strings), unused, expiring 1 year from now. These are for development testing.

Run all migrations and seeders:
```bash
npx sequelize-cli db:migrate
npx sequelize-cli db:seed:all
```
  </action>
  <verify>
1. `npx sequelize-cli db:migrate:status` shows all migrations as "up".
2. `mysql -u root -e "USE freeluma_dev; SELECT COUNT(*) FROM bible_translations;"` returns 4.
3. `mysql -u root -e "USE freeluma_dev; SELECT COUNT(*) FROM categories;"` returns 6.
4. `mysql -u root -e "USE freeluma_dev; SELECT email, is_admin FROM users;"` returns admin@freeluma.com with is_admin=1.
5. `mysql -u root -e "USE freeluma_dev; SELECT COUNT(*) FROM activation_codes WHERE used=0;"` returns 10.
6. `npx sequelize-cli db:migrate:undo:all` successfully drops all tables (test rollback), then `npx sequelize-cli db:migrate && npx sequelize-cli db:seed:all` re-creates everything cleanly.
  </verify>
  <done>All database tables created via CLI migrations (not sync), seeders populate initial data, migrations are reversible.</done>
</task>

</tasks>

<verification>
1. `npx sequelize-cli db:migrate:status` -- all migrations "up"
2. `SHOW TABLES` in MySQL returns all 9 tables
3. Foreign key constraints verified: deleting a user cascades to user_categories and user_settings
4. TypeScript model imports compile without errors in a test route
5. Seeders can be re-run after undo without errors
</verification>

<success_criteria>
- 9 Sequelize models with proper TypeScript interfaces
- All model associations defined (hasMany, belongsTo, hasOne)
- CLI migrations create all tables with correct schema
- Seeders populate Bible translations, categories, admin user, and test activation codes
- Migrations are fully reversible (up + down)
- No use of sequelize.sync() -- migrations only
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
