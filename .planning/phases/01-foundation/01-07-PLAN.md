---
phase: 01-foundation
plan: 07
type: execute
wave: 5
depends_on: ["01-06"]
files_modified:
  - src/app/onboarding/mode/page.tsx
  - src/app/onboarding/profile/page.tsx
  - src/app/onboarding/interests/page.tsx
  - src/app/onboarding/follow/page.tsx
  - src/app/onboarding/layout.tsx
  - src/components/onboarding/ModeSelector.tsx
  - src/components/onboarding/ProfileSetup.tsx
  - src/components/onboarding/InterestPicker.tsx
  - src/components/onboarding/FollowSuggestions.tsx
  - src/app/api/users/route.ts
  - src/app/api/users/[id]/route.ts
  - src/app/api/users/check-username/route.ts
autonomous: true

must_haves:
  truths:
    - "New user is guided through 4-step onboarding after signup"
    - "User selects faith or positivity mode in step 1"
    - "User sets display name, username, avatar, and bio in step 2"
    - "User selects interest categories in step 3"
    - "After completing all steps, user lands on the app home page"
  artifacts:
    - path: "src/app/onboarding/mode/page.tsx"
      provides: "Step 1: Mode selection (faith/positivity)"
      min_lines: 20
    - path: "src/components/onboarding/ProfileSetup.tsx"
      provides: "Step 2: Display name, username, avatar, bio form"
      contains: "useForm"
    - path: "src/app/api/users/route.ts"
      provides: "POST endpoint for updating user profile during onboarding"
      exports: ["POST"]
  key_links:
    - from: "src/components/onboarding/ProfileSetup.tsx"
      to: "/api/users"
      via: "fetch POST to save profile data"
      pattern: "fetch.*api/users"
    - from: "src/app/onboarding/interests/page.tsx"
      to: "src/lib/db/models/UserCategory.ts"
      via: "saves selected categories"
      pattern: "categories|interests"
---

<objective>
Build the 4-step guided onboarding flow: mode selection, profile setup, interest selection, and follow suggestions.

Purpose: Every new user must complete onboarding before accessing the app. This captures essential profile information (mode, name, username, avatar, categories) that drive the entire personalized experience.
Output: Complete onboarding wizard with 4 steps, user profile API endpoints, username availability check, and category selection persistence.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: User profile API endpoints and username check</name>
  <files>
    src/app/api/users/route.ts
    src/app/api/users/[id]/route.ts
    src/app/api/users/check-username/route.ts
  </files>
  <action>
Create `src/app/api/users/route.ts`:
- POST (protected with withAuth): Update current user's profile during onboarding
- Accepts partial updates: { display_name?, username?, bio?, mode?, avatar_url?, avatar_color?, date_of_birth?, timezone?, preferred_translation?, language?, onboarding_step? }
- Validate with Zod (partial profile schema)
- If username provided: check uniqueness before updating
- If onboarding_step === 'complete': set onboarding_complete = true
- Return updated user data
- Also handles saving category selections: { categories: number[] } -- bulk create UserCategory records (delete existing, insert new)

Create `src/app/api/users/[id]/route.ts`:
- GET (protected with withAuth): Fetch user profile by ID
- Return: id, display_name, username, avatar_url, avatar_color, bio, mode (exclude sensitive fields like password_hash, email)
- PUT (protected with withAuth): Only allow updating own profile (user.id must match param id)
- Same validation as POST /api/users

Create `src/app/api/users/check-username/route.ts`:
- GET: Accepts ?username= query param
- Check if username exists in users table (case-insensitive)
- Return { available: boolean }
- Rate limit: 10 per minute per IP (to prevent enumeration)
- Used for real-time username availability check during onboarding
  </action>
  <verify>
```bash
# Login as existing user first to get auth cookie
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"email":"test@example.com","password":"TestPass123"}' | grep -o 'auth_token=[^;]*' || echo "get token manually")

# Check username availability
curl "http://localhost:3000/api/users/check-username?username=testuser"
# Expected: {"available":false}

curl "http://localhost:3000/api/users/check-username?username=newuniquename"
# Expected: {"available":true}

# Update profile (with auth cookie)
curl -X POST http://localhost:3000/api/users -H "Content-Type: application/json" -H "Cookie: auth_token=..." -d '{"mode":"bible","bio":"Test bio"}'
# Expected: 200 with updated user
```
  </verify>
  <done>User profile CRUD endpoints working: create/update profile, check username availability, save category selections.</done>
</task>

<task type="auto">
  <name>Task 2: 4-step onboarding UI (mode, profile, interests, follow)</name>
  <files>
    src/app/onboarding/layout.tsx
    src/app/onboarding/mode/page.tsx
    src/app/onboarding/profile/page.tsx
    src/app/onboarding/interests/page.tsx
    src/app/onboarding/follow/page.tsx
    src/components/onboarding/ModeSelector.tsx
    src/components/onboarding/ProfileSetup.tsx
    src/components/onboarding/InterestPicker.tsx
    src/components/onboarding/FollowSuggestions.tsx
  </files>
  <action>
Update `src/app/onboarding/layout.tsx`:
- Verify auth (redirect to /login if not authenticated)
- If onboarding_complete: redirect to /
- Show step indicator: "Step X of 4" with progress dots/bar at top
- Determine current step from pathname: /onboarding/mode = 1, /profile = 2, /interests = 3, /follow = 4
- Clean centered layout, no nav bars, app logo above step indicator

Create `src/components/onboarding/ModeSelector.tsx`:
- Two large cards: "Bible / Faith" and "Positivity"
- Bible card: Book icon, "Daily Bible verses, prayer, and faith community"
- Positivity card: Sun icon, "Daily inspirational quotes and positive community"
- Pre-select if URL had ?mode= hint (stored in signup flow or query param)
- Animated selection state (border highlight, checkmark)
- "Continue" button at bottom (disabled until selection made)
- On continue: POST /api/users with { mode: selected }, navigate to /onboarding/profile

Create `src/app/onboarding/mode/page.tsx`: Renders ModeSelector

Create `src/components/onboarding/ProfileSetup.tsx`:
- Uses react-hook-form
- Fields: display_name (required, 3-100 chars), username (required, 3-30 chars, live availability check with debounce), bio (optional, 150 chars max with character counter)
- Avatar section: Shows current avatar (InitialsAvatar from constants) with "Upload Photo" button
- Avatar upload triggers file picker -> opens crop modal (use react-easy-crop) -> uploads cropped image -> sets avatar_url
- NOTE: For Phase 1, avatar upload goes through a presigned URL to B2 (depends on Plan 08 B2 setup). If B2 not configured yet, show placeholder with initials avatar only and skip upload. The crop/upload can use a simple temporary upload to /api/upload/avatar as fallback.
- Username field: "@" prefix displayed, validates lowercase alphanumeric + underscores, shows green check or red X for availability
- On continue: POST /api/users with { display_name, username, bio, avatar_url }, navigate to /onboarding/interests

Create `src/app/onboarding/profile/page.tsx`: Renders ProfileSetup

Create `src/components/onboarding/InterestPicker.tsx`:
- Fetches categories from database (GET /api/categories -- create this simple endpoint)
- Displays categories as toggleable chips/cards (icon + name)
- User taps to select/deselect (minimum 1 required)
- On continue: POST /api/users with { categories: [selectedIds] }, navigate to /onboarding/follow
- Add GET /api/categories route that returns all active categories

Create `src/app/onboarding/interests/page.tsx`: Renders InterestPicker

Create `src/components/onboarding/FollowSuggestions.tsx`:
- Shows list of suggested accounts to follow (for Phase 1: just the admin user and any placeholder official accounts)
- Each suggestion: avatar, display name, username, "Follow" button
- "Follow" toggles follow state (note: Follow model doesn't exist yet in Phase 1 -- store follow intent in state, actual follow will work in Phase 2)
- For Phase 1: simulate follows or skip actual follow persistence. Show the UI with a "Skip" and "Continue" button.
- On continue: POST /api/users with { onboarding_step: 'complete' } (sets onboarding_complete = true), navigate to /

Create `src/app/onboarding/follow/page.tsx`: Renders FollowSuggestions

Also create `src/app/api/categories/route.ts`:
- GET: Return all active categories ordered by sort_order
- No auth required (public endpoint for onboarding)
  </action>
  <verify>
1. Register a new user -> auto-redirected to /onboarding/mode
2. Select "Bible" mode -> proceed to /onboarding/profile
3. Fill in display name, username (check availability works), bio -> proceed to /onboarding/interests
4. Select categories -> proceed to /onboarding/follow
5. Click "Continue" on follow step -> redirected to / (app home)
6. Refresh page -> app loads normally (onboarding_complete = true, not redirected back)
7. Verify in database: user.mode = 'bible', user.display_name set, user.username set, user.onboarding_complete = true, user_categories rows created.
  </verify>
  <done>Complete 4-step onboarding wizard: mode selection -> profile setup (name, username, avatar placeholder, bio) -> interest categories -> follow suggestions -> app home.</done>
</task>

</tasks>

<verification>
1. New user registration -> onboarding flow -> app home (complete path works)
2. Step indicator shows correct step number
3. Mode selection persists to user profile
4. Username availability check works in real-time
5. Categories saved to user_categories table
6. onboarding_complete flag set after final step
7. Users who completed onboarding are NOT redirected back
8. Build succeeds
</verification>

<success_criteria>
- 4-step onboarding: mode -> profile -> interests -> follow
- Mode pre-selection from URL hint
- Username availability with debounced live check
- Category multi-select with minimum 1 required
- Profile data persisted to database after each step
- onboarding_complete = true after final step
- Redirects work: unauthenticated -> login, incomplete onboarding -> onboarding, complete -> app
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md`
</output>
