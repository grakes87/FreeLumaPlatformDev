---
phase: 08-database-migration-mapping
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/generate-migration-mapping.mjs
autonomous: true

must_haves:
  truths:
    - "All 24 non-workshop old tables have dedicated mapping sheets in the spreadsheet"
    - "Daily content domain tables (5 tables) correctly map to daily_content, daily_comments, daily_reactions, listen_logs, bookmarks"
    - "Verse domain tables (4 tables) flagged as NEEDS DECISION with descriptive notes"
    - "Chat table documents the flat-to-relational restructuring (chats -> conversations + participants + messages)"
    - "Notifications table documents the polymorphic column collapse (6 context columns -> entity_id + entity_type)"
    - "Orphan detection results included per table"
  artifacts:
    - path: "scripts/generate-migration-mapping.mjs"
      provides: "Complete migration mapping generator with all 24 table configs"
      min_lines: 800
    - path: "migration-mapping.xlsx"
      provides: "Complete Excel spreadsheet with all mapping sheets"
  key_links:
    - from: "scripts/generate-migration-mapping.mjs"
      to: "migration-mapping.xlsx"
      via: "workbook.xlsx.writeFile"
      pattern: "writeFile.*\\.xlsx"
---

<objective>
Extend the migration mapping script with the remaining 14 table mapping configurations: Daily Content domain (dailyposts, dailypostcomments, dailypostusercomments, dailypostusers, dailychapters), Verse domain (verses, verse_comments, verse_likes, verse_user_comments), Chat (chats), Notes (notes), Notifications (notifications), and Video domain (uservideos, uservideorelations). Add orphan detection logic and regenerate the complete spreadsheet.

Purpose: Complete the mapping deliverable so every non-workshop old table has a dedicated sheet with column-by-column mappings, transformation rules, sample data, relationships, data quality notes, and orphan detection results.

Output: The final `migration-mapping.xlsx` file with Overview + 24 table sheets, ready for human review.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-database-migration-mapping/08-CONTEXT.md
@.planning/phases/08-database-migration-mapping/08-RESEARCH.md
@.planning/phases/08-database-migration-mapping/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Daily Content, Verse, Chat, Notes, Notifications, and Video domain mapping configurations</name>
  <files>scripts/generate-migration-mapping.mjs</files>
  <action>
Read the existing script from Plan 01 and extend it with the remaining 14 table mapping configurations. Add each config following the same pattern established in Plan 01 (columns array, relationships array, status, notes).

**Daily Content Domain (5 tables):**

`DAILYPOSTS_MAPPING` (old `dailyposts` -> `daily_content`):
- id -> id, title -> title, content/description -> body, verse -> verse_reference
- audio_file -> (B2 migration path), video_file -> video_url
- category_id -> mode (map: BIBLE category -> 'bible', POSITIVITY -> 'positivity')
- likes_count, comments_count, bookmark_count -> COMPUTED in new schema
- created_at, updated_at -> direct copy
- Relationships: dailyposts -> dailypostcomments, dailyposts -> dailypostusers

`DAILYPOSTCOMMENTS_MAPPING` (old `dailypostcomments` -> `daily_comments`):
- id -> id, daily_post_id -> daily_content_id, user_id -> user_id
- text -> body, parent_id -> parent_id (convert 0 -> NULL)
- likes_count, reply_count -> COMPUTED
- category_id -> (not needed in new schema, daily_content carries mode)
- Quality note: parent_id=0 means root comment, must convert to NULL

`DAILYPOSTUSERCOMMENTS_MAPPING` (old `dailypostusercomments` -> NEEDS DECISION):
- This is a reactions-on-comments table. Each row represents a user reaction to a daily post comment.
- id, user_id, comment_id, like_type (emoji type), created_at
- Status: NEEDS DECISION. Could map to daily_reactions on comments if the new schema supports it, or may need a new daily_comment_reactions table.
- Note: "Represents reactions on daily post comments. New schema daily_reactions targets daily_content, not daily_comments. May need new table or extend daily_reactions to support comment targets."

`DAILYPOSTUSERS_MAPPING` (old `dailypostusers` -> splits into `daily_reactions` + `bookmarks`):
- This is a DUAL-PURPOSE pivot table. Each row has is_liked and is_bookmarked flags.
- id, daily_post_id, user_id, is_liked, is_bookmarked, like_type (emoji), category_id, created_at
- Transformation:
  - WHERE is_liked=1: create `daily_reactions` row (daily_content_id=daily_post_id, user_id, reaction_type=like_type)
  - WHERE is_bookmarked=1: create `bookmarks` row (daily_content_id=daily_post_id, user_id)
  - A single old row can generate BOTH a reaction AND a bookmark
- Relationships: dailypostusers -> dailyposts, dailypostusers -> users

`DAILYCHAPTERS_MAPPING` (old `dailychapters` -> `listen_logs`):
- id -> id, user_id -> user_id, chapter_text (the chapter/verse reference) -> chapter_text
- daily_post_id -> daily_content_id, progress -> progress
- completed -> completed, created_at, updated_at
- Note: Represents how far users listened to daily audio content

**Verse Domain (4 tables — ALL NEEDS DECISION):**

`VERSES_MAPPING`:
- Status: NEEDS DECISION
- Columns: id, verse_name, verse_text, created_at, updated_at
- Notes: "3,409 verses with no direct equivalent in new schema. New daily_content has verse_reference but verses are not standalone entities. Options: (a) migrate verse text into a reference table, (b) drop if superseded by daily_content, (c) map verse interactions to daily_reactions on matching daily_content entries"

`VERSE_COMMENTS_MAPPING`:
- Status: NEEDS DECISION
- Columns: id, verse_id, user_id, text, parent_id, likes_count, reply_count, created_at, updated_at
- Notes: "42 comments on verses. Could map to daily_comments if verses are matched to daily_content entries."

`VERSE_LIKES_MAPPING`:
- Status: NEEDS DECISION
- Columns: id, user_id, verse_name (NOT verse_id — joined by name string!), created_at
- Notes: "3,716 likes. WARNING: References verses by name string, not by ID (fragile join). Some verse_name values are empty strings."
- Quality: HIGH concern — joining by name instead of ID is fragile

`VERSE_USER_COMMENTS_MAPPING`:
- Status: NEEDS DECISION
- Columns: id, user_id, comment_id, like_type, created_at
- Notes: "Only 1 row. Reactions on verse comments. Same NEEDS DECISION as parent verse tables."

**Chat Domain (1 table):**

`CHATS_MAPPING` (old `chats` -> `conversations` + `conversation_participants` + `messages`):
- Status: MAPPED (complex transformation)
- Old columns: id, sender_id, receiver_id, message (text), is_seen (tinyint), seen_at, created_at, updated_at
- Transformation is STRUCTURAL (not just column rename):
  1. Group chats by unique sender/receiver pairs: normalize each (sender_id, receiver_id) pair to (min, max) so (A,B) and (B,A) map to same conversation
  2. Create one `conversations` row per unique pair (type='direct', created_at = earliest chat in group)
  3. Create two `conversation_participants` rows per conversation (one for each user)
  4. Map each old `chats` row to a `messages` row: conversation_id from step 2, sender_id from old sender_id, body from old message, type='text', created_at from old created_at
  5. is_seen -> create MessageStatus row (status: is_seen=1 ? 'read' : 'delivered')
- Quality: "Unicode escape sequences in message column (e.g., U+2764U+FE0F). 286 total messages."
- Relationships: chats -> users (sender_id, receiver_id)

**Notes Domain (1 table):**

`NOTES_MAPPING`:
- Status: NEEDS DECISION
- Old columns: id, user_id, title, content (HTML), audio (file path), type (enum: 'text','audio'), created_at, updated_at
- Notes: "Only 7 personal journal entries. No direct equivalent in new schema (workshop_notes is workshop-specific). Options: (a) create a new personal_notes table, (b) drop (likely test data given only 7 rows), (c) convert to bookmarks with notes text. Content contains rich HTML with inline styles."
- Quality: MEDIUM — HTML content needs stripping if migrated

**Notifications Domain (1 table):**

`NOTIFICATIONS_MAPPING` (old `notifications` -> `notifications`):
- Status: MAPPED (complex transformation)
- Old columns: id, user_id, action_done_by, notification_type, post_id, comment_id, daily_post_comment_id, chat_id, workshop_id, like_type, comment_type, is_seen, request_follow, accept_follow, created_at, updated_at
- New columns: id, recipient_id, actor_id, type, entity_id, entity_type, group_key, is_read, created_at
- Transformation rules:
  - user_id -> recipient_id
  - action_done_by -> actor_id
  - notification_type mapping: FOLLOW -> 'follow', LIKE -> 'reaction', COMMENT -> 'comment', CHAT -> 'message', WORKSHOP_* -> 'workshop_*'
  - is_seen -> is_read
  - Entity resolution: check which of (post_id, comment_id, daily_post_comment_id, chat_id, workshop_id) is non-null and non-zero -> that becomes entity_id, and the column name determines entity_type
  - request_follow=1 -> type becomes 'follow_request' instead of 'follow'
  - accept_follow=1 -> type becomes 'follow_accept'
  - group_key: compute from type + entity_type + entity_id (e.g., "reaction:post:123")
  - like_type: preserved in notification metadata or used to determine emoji in group_key
  - comment_type: used to refine entity_type (comment on post vs comment on daily)
- Quality: "Very wide table with many nullable context columns. 28,480 rows. Complex polymorphic references."

**Video Domain (2 tables):**

`USERVIDEOS_MAPPING` (old `uservideos` -> `videos`):
- id -> id, title -> title, description -> description
- video_url -> video_url (may need B2 path prefix)
- thumbnail_url -> thumbnail_url, duration -> duration
- view_count -> view_count (direct copy for initial value, then COMPUTED)
- category_id -> category_id, created_at, updated_at
- Notes: "Only 4 videos in old database"

`USERVIDEORELATIONS_MAPPING` (old `uservideorelations` -> `video_progress`):
- id -> id, user_id -> user_id, uservideo_id -> video_id
- progress -> watched_seconds (may need type conversion from percentage to seconds)
- completed -> completed, created_at, updated_at
- Notes: "1,159 progress records. Progress format needs verification — is it percentage (0-100) or seconds?"

**After adding all configs, register them in the main tables array so the execution loop picks them up.**
  </action>
  <verify>
Check the script file has mapping configs for all 14 new tables by searching for each table name in the config objects. The total should be 24 non-workshop table configs.
  </verify>
  <done>
- All 14 remaining table mapping configurations added to the script
- Total of 24 non-workshop table configs in the script
- Each config has: columns array, relationships array, status, notes, quality flags
- NEEDS DECISION tables (verses x4, homescreen_tile_categories, notes, dailypostusercomments) have descriptive notes with options
  </done>
</task>

<task type="auto">
  <name>Task 2: Add orphan detection and regenerate complete spreadsheet</name>
  <files>scripts/generate-migration-mapping.mjs</files>
  <action>
**Add orphan detection function:**

Create `detectOrphans(sql, schemas, sampleRows)` that checks referential integrity within the SQL dump data:

1. **User ID orphans:** For each table with a `user_id` (or `sender_id`, `receiver_id`, `follower_id`, `following_id`, `action_done_by`) column, check if referenced user IDs exist in the users table. Since we can't load all 32K users into memory efficiently for a simple script, use this approach:
   - Extract the set of ALL user IDs from INSERT statements (just the ID column)
   - For each child table, extract the FK column values from sample rows
   - Report any FK values not found in the user ID set

2. **Post ID orphans:** Check `comments.post_id`, `notifications.post_id` against post IDs. Given the low post count in the dump (~42), this will likely find many orphans — flag this prominently.

3. **Daily post orphans:** Check `dailypostcomments.daily_post_id`, `dailypostusers.daily_post_id`, `dailychapters.daily_post_id` against dailyposts IDs.

4. **Category orphans:** Check `category_user_relations.category_id`, `posts.category_id` against categories IDs.

5. **Comment orphans:** Check `usercomments.comment_id` against comments IDs. Check `dailypostusercomments.comment_id` against dailypostcomments IDs.

6. **Verse orphans:** Check `verse_likes.verse_name` against `verses.verse_name` (string match, not ID match).

For efficiency, extract FULL ID sets only for small tables (categories, posts, dailyposts, verses, comments, dailypostcomments, uservideos). For users (32K rows), extract IDs in batches from INSERT statements.

**Add orphan results to each table sheet:**
After the relationships section and before the sample data section, add:
- "ORPHAN DETECTION" header row (merged, bold 12pt, orange fill #FCE4D6)
- Table with columns: FK Column | References | Orphan Count | Sample Orphan IDs | Notes
- If no orphans found: single row saying "No orphans detected in sample data"
- If the dump appears incomplete (e.g., posts): note "Dump may be incomplete — orphan count may be inflated"

**Run the complete script:**

Execute `node scripts/generate-migration-mapping.mjs` to generate the final spreadsheet. The script should log:
- Total tables processed: 24 (non-workshop) + 5 (excluded) = 29 total catalogued
- Detailed sheets created: 24
- Tables with orphans detected: N
- NEEDS DECISION items: N
- Output file path and size

**Verify the output:**
- File should be substantially larger than Plan 01's output (all 24 sheets now)
- Overview sheet should show all tables with final status
- Spot-check 2-3 table sheets for completeness
  </action>
  <verify>
Run: `node scripts/generate-migration-mapping.mjs`

Expected:
- Script completes without errors
- Logs show 24 detailed sheets created
- `migration-mapping.xlsx` file exists, larger than Plan 01 output
- Orphan detection results included in output log

Verify sheet count: the script should log the exact number of sheets in the workbook (should be 25: 1 overview + 24 table sheets).
  </verify>
  <done>
- Script runs successfully and generates complete `migration-mapping.xlsx`
- All 24 non-workshop tables have dedicated sheets with: column mappings, relationships, orphan detection, sample data
- 5 workshop tables listed as EXCLUDED in overview sheet
- Orphan detection results present on each table sheet
- NEEDS DECISION items clearly flagged in yellow
- Overview sheet shows correct row counts and statuses for all tables
- Script logs comprehensive summary
  </done>
</task>

</tasks>

<verification>
- `node scripts/generate-migration-mapping.mjs` runs without errors
- `migration-mapping.xlsx` contains 25 sheets (1 overview + 24 tables)
- Overview sheet lists all 29 old tables (24 mapped/flagged + 5 excluded)
- Every non-workshop table has: column mapping, relationships, orphan check, sample data
- NEEDS DECISION count matches research (7 items: verses x4, homescreen_tile_categories, notes, dailypostusercomments)
- Complex transformations documented: users split, posts split, chats restructure, notifications collapse, dailypostusers dual split
</verification>

<success_criteria>
1. All 24 non-workshop old tables have complete mapping sheets
2. Orphan detection runs and reports results per table
3. 6 NEEDS DECISION tables have descriptive notes with options for the user
4. Complex transformations (chat, notifications, posts, dailypostusers) have step-by-step rules
5. Sample data from real SQL dump visible in every table sheet
6. Final spreadsheet is the complete Phase 8 deliverable
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-migration-mapping/08-02-SUMMARY.md`
</output>
