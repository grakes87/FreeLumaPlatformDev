---
phase: 08-database-migration-mapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/generate-migration-mapping.mjs
  - package.json
autonomous: true

must_haves:
  truths:
    - "Script parses all 29 CREATE TABLE statements from old SQL dump"
    - "Script extracts 5 sample rows per table from INSERT statements"
    - "Overview sheet lists all 24 non-workshop tables with status and row counts"
    - "Users table sheet has complete column-by-column mapping with transformations"
    - "Posts table sheet documents the FEED/PRAYER_WALL split correctly"
    - "Excel file generates without errors and opens in any spreadsheet app"
  artifacts:
    - path: "scripts/generate-migration-mapping.mjs"
      provides: "Migration mapping spreadsheet generator script"
      min_lines: 400
    - path: "package.json"
      provides: "exceljs devDependency added"
      contains: "exceljs"
  key_links:
    - from: "scripts/generate-migration-mapping.mjs"
      to: "Old Database/main free luma database.sql"
      via: "fs.readFileSync"
      pattern: "readFileSync.*main free luma database"
    - from: "scripts/generate-migration-mapping.mjs"
      to: "migration-mapping.xlsx"
      via: "workbook.xlsx.writeFile"
      pattern: "writeFile.*\\.xlsx"
---

<objective>
Create the migration mapping script foundation with SQL parser, Excel generation framework, and complete mappings for the three most complex domains: Users (users, settings, subscribewebpushes), Categories (categories, category_user_relations, homescreen_tile_categories), and Social (posts, comments, usercomments, follows).

Purpose: Establish the script infrastructure and tackle the hardest mapping tables first (users with 30+ columns, posts with type splitting, notifications-adjacent usercomments). The remaining simpler domains will extend this foundation in Plan 02.

Output: A working script that generates a partial .xlsx with overview sheet + 10 table sheets, verifiable by running `node scripts/generate-migration-mapping.mjs`.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-database-migration-mapping/08-CONTEXT.md
@.planning/phases/08-database-migration-mapping/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install exceljs and create the migration mapping script with SQL parser and Users/Categories/Social domain mappings</name>
  <files>
    package.json
    scripts/generate-migration-mapping.mjs
  </files>
  <action>
**Step 1: Install exceljs as devDependency**

```bash
npm install --save-dev exceljs
```

**Step 2: Create `scripts/generate-migration-mapping.mjs`**

This is a standalone ESM script. Structure it in these sections:

**Section A: Imports and Constants**
- Import `fs`, `path`, `ExcelJS` (default import from 'exceljs')
- Define `SQL_DUMP_PATH` as `path.resolve('Old Database/main free luma database.sql')`
- Define `OUTPUT_PATH` as `path.resolve('migration-mapping.xlsx')`
- Define `EXCLUDED_TABLES` as `['workshops', 'workshop_series', 'workshop_interests', 'workshop_invitations', 'workshoplogs']`
- Define domain group order for sheet organization (see RESEARCH.md Pattern 3)

**Section B: SQL Dump Parser**

Two main parsing functions:

`parseCreateTables(sql)` - Returns Map<tableName, Array<{name, type, extra}>> by matching CREATE TABLE blocks. For each column line starting with backtick, extract column name, full type (including ENUM values), and any constraints (NOT NULL, DEFAULT, AUTO_INCREMENT). Also capture PRIMARY KEY and KEY/INDEX definitions from each CREATE TABLE block. Handle the fact that some column type definitions span ideas like `enum('FEED','PRAYER_WALL')`. Return the full column definition string after the column name.

`extractSampleRows(sql, tableName, columnNames, limit=5)` - Returns Array<Object> where each object maps column names to values. Strategy:
1. Find INSERT INTO `tableName` statements (there may be multiple per table)
2. For each INSERT, extract the column list from `INSERT INTO tableName (col1, col2, ...) VALUES`
3. Parse value tuples carefully: handle nested parentheses in function calls, escaped quotes within string values (`\'`), NULL literals, numeric literals, and string literals
4. A tuple parser that tracks depth and quote state is essential (see RESEARCH.md code example for the depth-tracking approach)
5. For each tuple, split values respecting quotes and nested structures, then map to column names
6. Stop after `limit` rows total across all INSERT statements for that table
7. Handle edge cases: empty string `''`, NULL, escaped unicode, JSON strings (which contain nested quotes)

`countTableRows(sql, tableName)` - Returns approximate total row count by counting value tuples across all INSERT statements for that table. Also check AUTO_INCREMENT value in the CREATE TABLE statement as an upper bound for max ID.

**Section C: Excel Framework**

`createWorkbook()` - Create ExcelJS workbook with metadata (creator: 'FreeLuma Migration Tool', created: new Date())

`createOverviewSheet(workbook, tableData)` - Creates the first sheet "Overview" with columns:
- Old Table (width 30)
- Status (width 15) - values: MAPPED, NEEDS DECISION, EXCLUDED
- New Table(s) (width 35)
- Row Count (width 15)
- Notes (width 55)

Style: Header row with bold white text on blue background (#4472C4). Rows for NEEDS DECISION tables should have yellow fill (#FFF2CC). EXCLUDED rows get gray fill (#D9D9D9). MAPPED rows get light green fill (#E2EFDA).

`createTableSheet(workbook, tableName, config)` - Creates a sheet for one old table with:
1. **Title row (merged A1:I1):** "Table: {tableName}" in bold 14pt
2. **Blank row**
3. **Column mapping header (row 3):** Old Column | Old Type | New Table | New Column | New Type | Transformation Rule | Sample Old Value | Expected New Value | Data Quality Notes
   - Header style: bold, light blue fill (#D9E2F3)
   - Column widths: 18, 22, 20, 20, 20, 35, 28, 28, 35
4. **Column mapping data rows** from config.columns array
5. **Blank separator row**
6. **"RELATIONSHIPS" header row** (merged, bold 12pt, gray fill)
7. **Relationship rows** from config.relationships array, with columns: Type | From | To | Description | New Schema Equivalent
8. **Blank separator row**
9. **"SAMPLE DATA (5 rows)" header row** (merged, bold 12pt, gray fill)
10. **Sample data column headers** (the old table's column names)
11. **5 sample data rows** with actual values from the SQL dump

Apply auto-filter on the column mapping header row. Freeze panes at row 4 (so header stays visible).

**Section D: Mapping Configuration — Users Domain**

`USERS_MAPPING`:
```javascript
{
  oldTable: 'users',
  status: 'MAPPED',
  newTables: ['users', 'user_settings'],
  notes: 'Split: profile fields to users, preferences to user_settings. 30+ column transformations.',
  columns: [
    { oldCol: 'id', oldType: 'bigint unsigned AUTO_INCREMENT', newTable: 'users', newCol: 'id', newType: 'INTEGER AUTO_INCREMENT', transform: 'direct copy (preserve IDs)', quality: '' },
    { oldCol: 'first_name', oldType: 'varchar(191)', newTable: 'users', newCol: 'display_name', transform: 'merge with last_name: first_name + " " + last_name (trim if last_name empty)', quality: 'Some accounts have empty first_name' },
    { oldCol: 'last_name', oldType: 'varchar(191)', newTable: 'users', newCol: '(merged into display_name)', transform: 'merge with first_name (see above)', quality: 'Often empty for newer accounts' },
    { oldCol: 'username', oldType: 'varchar(191)', newTable: 'users', newCol: 'username', newType: 'VARCHAR(30)', transform: 'direct copy', quality: 'First ~85 IDs are test accounts (test1234, shady123, etc.)' },
    { oldCol: 'email', oldType: 'varchar(191)', newTable: 'users', newCol: 'email', newType: 'VARCHAR(255)', transform: 'direct copy', quality: 'Unique constraint' },
    { oldCol: 'password', oldType: 'varchar(191)', newTable: 'users', newCol: 'password_hash', newType: 'VARCHAR(255)', transform: 'replace $2y$ prefix with $2b$ for bcrypt compat; FLAG plaintext passwords for forced reset', quality: 'HIGH: At least 1 plaintext password found (user_id=6). Most are $2y$10$ format' },
    { oldCol: 'profile_picture', oldType: 'varchar(191)', newTable: 'users', newCol: 'avatar_url', newType: 'VARCHAR(500)', transform: 'prefix with B2 storage URL path (MIG-08); handle "default.jpg" as NULL', quality: 'Mix of filenames: default.jpg, username.jpg, username.png' },
    { oldCol: 'city', oldType: 'varchar(191)', newTable: 'users', newCol: 'location', newType: 'VARCHAR(100)', transform: 'merge: city + ", " + state + ", " + country (filter empties)', quality: '' },
    { oldCol: 'state', oldType: 'varchar(191)', newTable: 'users', newCol: '(merged into location)', transform: 'merge with city and country (see above)', quality: '' },
    { oldCol: 'country', oldType: 'varchar(191)', newTable: 'users', newCol: '(merged into location)', transform: 'merge with city and state (see above)', quality: '' },
    { oldCol: 'bio', oldType: 'text', newTable: 'users', newCol: 'bio', newType: 'TEXT', transform: 'direct copy; strip HTML if present', quality: '' },
    { oldCol: 'phone', oldType: 'varchar(191)', newTable: '--', newCol: '--', newType: '--', transform: 'NEEDS DECISION: no phone column in new schema', quality: 'Some users have phone numbers stored' },
    { oldCol: 'dob', oldType: 'date', newTable: 'users', newCol: 'date_of_birth', newType: 'DATEONLY', transform: 'rename; convert 0000-00-00 to NULL', quality: 'MEDIUM: Contains 0000-00-00 invalid dates for many users' },
    { oldCol: 'followings_count', oldType: 'int', newTable: '--', newCol: '--', newType: '--', transform: 'COMPUTED in new schema (COUNT from follows table) -- no migration needed', quality: 'Denormalized counter' },
    { oldCol: 'followers_count', oldType: 'int', newTable: '--', newCol: '--', newType: '--', transform: 'COMPUTED in new schema (COUNT from follows table) -- no migration needed', quality: 'Denormalized counter' },
    { oldCol: 'posts_count', oldType: 'int', newTable: '--', newCol: '--', newType: '--', transform: 'COMPUTED in new schema (COUNT from posts table) -- no migration needed', quality: 'Denormalized counter' },
    { oldCol: 'liked_posts', oldType: 'longtext (JSON)', newTable: 'post_reactions', newCol: 'post_id + user_id + reaction_type', newType: 'See post_reactions model', transform: 'parse JSON array of post IDs -> create PostReaction row per ID with reaction_type="like"', quality: 'LOW: JSON array may contain IDs of deleted posts (orphan check needed)' },
    { oldCol: 'notification_preference', oldType: 'text (JSON)', newTable: 'user_settings', newCol: 'multiple columns', newType: 'See user_settings model', transform: 'parse JSON -> split into email_dm, email_follow, email_prayer, email_daily_reminder boolean settings', quality: '' },
    { oldCol: 'account_visibility', oldType: "enum('PUBLIC','PRIVATE')", newTable: 'users', newCol: 'profile_privacy', newType: "ENUM('public','private')", transform: 'lowercase: PUBLIC->public, PRIVATE->private', quality: '' },
    { oldCol: 'daily_post_notification_time', oldType: 'time', newTable: 'user_settings', newCol: 'daily_reminder_time', newType: 'STRING', transform: 'move to user_settings table; convert TIME to string HH:MM', quality: '' },
    { oldCol: 'bookmark_setting', oldType: 'varchar(191)', newTable: 'users', newCol: 'preferred_translation', newType: 'VARCHAR(10)', transform: 'rename; maps Bible translation preference (e.g. KJV, NIV)', quality: 'NEEDS DECISION: also see bible_setting column -- which one maps?' },
    { oldCol: 'bible_setting', oldType: 'varchar(191)', newTable: '--', newCol: '--', newType: '--', transform: 'NEEDS DECISION: may duplicate bookmark_setting or carry different meaning', quality: 'Show sample values to user for decision' },
    { oldCol: 'tile_category', oldType: 'int', newTable: '--', newCol: '--', newType: '--', transform: 'NEEDS DECISION: relates to homescreen_tile_categories, no equivalent in new schema', quality: '' },
    { oldCol: 'top_slide_preference', oldType: 'varchar(191)', newTable: '--', newCol: '--', newType: '--', transform: 'NEEDS DECISION: no equivalent in new schema', quality: '' },
    { oldCol: 'comment_hidden', oldType: 'tinyint', newTable: '--', newCol: '--', newType: '--', transform: 'NEEDS DECISION: no direct equivalent in new schema', quality: '' },
    { oldCol: 'created_at', oldType: 'timestamp', newTable: 'users', newCol: 'created_at', newType: 'DATE', transform: 'direct copy (preserve original registration date)', quality: '' },
    { oldCol: 'updated_at', oldType: 'timestamp', newTable: 'users', newCol: 'updated_at', newType: 'DATE', transform: 'direct copy', quality: '' },
    // New schema computed columns (no old source):
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'google_id', newType: 'VARCHAR(255)', transform: 'COMPUTED in new schema -- default NULL, no migration needed', quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'apple_id', newType: 'VARCHAR(255)', transform: 'COMPUTED in new schema -- default NULL, no migration needed', quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'avatar_color', newType: 'CHAR(7)', transform: 'COMPUTED in new schema -- generate random hex color', quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'mode', newType: "ENUM('bible','positivity')", transform: "derive from category_user_relations: if user has BIBLE category -> 'bible', POSITIVITY -> 'positivity', default 'bible'", quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'timezone', newType: 'VARCHAR(50)', transform: "default 'America/New_York'", quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'language', newType: 'VARCHAR(5)', transform: "default 'en'", quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'email_verified', newType: 'BOOLEAN', transform: 'default true for migrated users', quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'onboarding_complete', newType: 'BOOLEAN', transform: 'default true for migrated users', quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'status', newType: "ENUM('active','deactivated','deleted')", transform: "default 'active'", quality: '' },
    { oldCol: '(new)', oldType: '--', newTable: 'users', newCol: 'role', newType: "ENUM('user','moderator')", transform: "default 'user'", quality: '' },
  ],
  relationships: [
    { type: '1:N', from: 'users.id', to: 'category_user_relations.user_id', desc: 'User category preferences', newEquiv: 'users.id -> user_categories.user_id' },
    { type: '1:N', from: 'users.id', to: 'posts.user_id', desc: 'User posts', newEquiv: 'users.id -> posts.user_id' },
    { type: '1:N', from: 'users.id', to: 'follows.follower_id / following_id', desc: 'Social graph', newEquiv: 'users.id -> follows.follower_id / following_id' },
    { type: '1:N', from: 'users.id', to: 'chats.sender_id / receiver_id', desc: 'Chat messages', newEquiv: 'users.id -> messages.sender_id (via conversations)' },
    { type: '1:N', from: 'users.id', to: 'notifications.user_id / action_done_by', desc: 'Notification targets/actors', newEquiv: 'users.id -> notifications.recipient_id / actor_id' },
    { type: 'JSON M:N', from: 'users.liked_posts', to: 'posts.id', desc: 'User liked posts (implicit, JSON array)', newEquiv: 'post_reactions (user_id + post_id)' },
  ]
}
```

`SETTINGS_MAPPING` (old `settings` table -> `platform_settings`):
- id, name (varchar) -> key, value (varchar) -> value. 2 rows: map each setting name to platform_settings key.

`SUBSCRIBEWEBPUSHES_MAPPING` (old `subscribewebpushes` -> `push_subscriptions`):
- id, user (int) -> user_id, subscription (text JSON) -> subscription (JSON), created_at/updated_at

**Section E: Mapping Configuration — Categories Domain**

`CATEGORIES_MAPPING` (old `categories` -> `categories`):
- id, name, slug, etc. Simple 1:1 mapping. Only 2 rows.

`CATEGORY_USER_RELATIONS_MAPPING` (old `category_user_relations` -> `user_categories`):
- id, user_id, category_id, created_at. Simple rename mapping.

`HOMESCREEN_TILE_CATEGORIES_MAPPING`:
- Status: NEEDS DECISION. List all columns. No direct new table equivalent.
- Include all 10 category names as sample data.

**Section F: Mapping Configuration — Social Domain**

`POSTS_MAPPING`:
- Document the split: FEED posts -> posts (post_type='text'), PRAYER_WALL posts -> posts (post_type='prayer_request') + prayer_requests row
- text_content -> body (strip HTML), media JSON -> post_media rows, is_deleted -> deleted_at, category_id -> mode
- Flag posts row count discrepancy prominently in quality notes
- Include cover_media as NEEDS DECISION

`COMMENTS_MAPPING` (old `comments` -> `post_comments`):
- id, user_id, post_id, text -> body, parent_id (0->NULL), likes_count (COMPUTED), reply_count (COMPUTED), created_at, updated_at

`USERCOMMENTS_MAPPING` (old `usercomments` -> `post_comment_reactions`):
- id, user_id, comment_id, like_type -> reaction_type (map emoji types), created_at

`FOLLOWS_MAPPING`:
- id, follower_id, following_id, status (0->pending, 1->active), request_follow (redundant), created_at

**Section G: Main Execution**

1. Read SQL dump file
2. Parse all CREATE TABLE statements
3. For each mapped table: extract sample rows, count rows
4. Create workbook
5. Create overview sheet (iterate ALL 24 non-workshop tables, marking status)
6. For each domain mapping configured so far: create table sheet
7. Write .xlsx file
8. Log summary: tables processed, file location, tables remaining for Plan 02

For the overview sheet, include ALL 24 tables even if their detailed mapping sheet hasn't been created yet (those will say "Detailed sheet: see Plan 02"). This ensures the overview is complete from the start.

**Important implementation notes:**
- Use `new URL(import.meta.url)` pattern for ESM path resolution
- Handle the SQL dump's phpMyAdmin format: `-- Table structure for table`, backtick-quoted identifiers
- For sample data extraction, SQL string values are single-quoted with internal single quotes escaped as `\'`. Handle `NULL` keyword, numeric literals, and the ENUM string values
- For JSON columns (liked_posts, notification_preference, media, subscription), unescape SQL escaping (`\\'` -> `'`, `\\"` -> `"`) before showing in sample data cells
- For the sample data section in each table sheet, show RAW values from the SQL dump (don't transform them). The "Expected New Value" column in the mapping section shows the TRANSFORMED version
- Style NEEDS DECISION cells with yellow fill (#FFF2CC) and bold text
- Style COMPUTED cells with gray italic text
  </action>
  <verify>
Run: `node scripts/generate-migration-mapping.mjs`

Expected output:
- Script completes without errors
- Prints summary showing ~10 table sheets created
- `migration-mapping.xlsx` file exists in project root
- File size > 50KB (meaningful content)

Verify content by checking the script logged correct row counts (users ~32K, category_user_relations ~44K, follows ~1.1K).
  </verify>
  <done>
- `npm ls exceljs` shows exceljs installed as devDependency
- `scripts/generate-migration-mapping.mjs` exists with SQL parser, Excel framework, and 10 table mapping configs
- Running the script produces `migration-mapping.xlsx` with Overview sheet + sheets for: users, settings, subscribewebpushes, categories, category_user_relations, homescreen_tile_categories, posts, comments, usercomments, follows
- Overview sheet lists all 24 non-workshop tables with correct status indicators
- Each table sheet has column mapping, relationship, and sample data sections
  </done>
</task>

</tasks>

<verification>
- `migration-mapping.xlsx` exists and is > 50KB
- Script runs without errors: `node scripts/generate-migration-mapping.mjs`
- Overview sheet contains all 24 non-workshop tables
- 10 detailed table sheets created (Users + Categories + Social domains)
- Sample data rows visible in each table sheet (5 rows from real SQL dump data)
- NEEDS DECISION items highlighted in yellow
- COMPUTED fields marked with gray italic
- EXCLUDED workshop tables listed in overview with gray fill
</verification>

<success_criteria>
1. exceljs installed as devDependency
2. Script parses the 24MB SQL dump successfully (all 29 CREATE TABLE statements found)
3. Overview sheet is complete with all 24+5 tables listed
4. 10 domain table sheets have full column mappings with transformation rules
5. Sample data extracted from real INSERT statements (not placeholder data)
6. Excel file opens correctly (valid .xlsx format)
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-migration-mapping/08-01-SUMMARY.md`
</output>
