---
phase: 04-enhanced-content
plan: 13
type: execute
wave: 3
depends_on: ["04-08"]
files_modified:
  - src/app/(admin)/admin/moderation/page.tsx
  - src/components/admin/ModerationQueue.tsx
  - src/components/admin/ModerationActionModal.tsx
  - src/components/admin/BanManager.tsx
  - src/components/admin/UserBrowser.tsx
  - src/components/admin/AuditLog.tsx
  - src/components/admin/ModerationStats.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view grouped moderation queue with report details"
    - "Admin can take moderation actions (remove, warn, ban, dismiss) from the queue"
    - "Admin can browse and edit users with search and filters"
    - "Admin can view and manage bans (create, lift)"
    - "Admin can view searchable audit log of all moderation actions"
    - "Admin can see moderation stats dashboard"
  artifacts:
    - path: "src/app/(admin)/admin/moderation/page.tsx"
      provides: "Enhanced admin moderation page with tabs"
    - path: "src/components/admin/ModerationQueue.tsx"
      provides: "Grouped report queue with action buttons"
    - path: "src/components/admin/UserBrowser.tsx"
      provides: "User browser with search, filter, edit"
    - path: "src/components/admin/AuditLog.tsx"
      provides: "Searchable moderation audit log"
  key_links:
    - from: "src/components/admin/ModerationQueue.tsx"
      to: "/api/admin/moderation"
      via: "Fetch grouped reports and submit actions"
      pattern: "api/admin/moderation"
    - from: "src/components/admin/UserBrowser.tsx"
      to: "/api/admin/users"
      via: "Search and edit users"
      pattern: "api/admin/users"
---

<objective>
Build the admin moderation UI — enhanced moderation queue, user browser, ban management, audit log, and moderation stats dashboard.

Purpose: Admins need a comprehensive moderation interface to review reports, manage users, enforce bans, and track moderation activity.
Output: Admin moderation page with 5 functional sections (queue, users, bans, audit log, stats).
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-08-SUMMARY.md

Follow existing patterns:
@src/app/(admin)/admin/moderation/page.tsx (existing moderation page to enhance)
@src/app/(admin)/admin/users/page.tsx (existing user management to enhance)
@src/components/admin/ (existing admin components)
@src/components/ui/ (Button, Input, Card, Modal, Skeleton)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced moderation queue with actions modal</name>
  <files>
    src/app/(admin)/admin/moderation/page.tsx
    src/components/admin/ModerationQueue.tsx
    src/components/admin/ModerationActionModal.tsx
  </files>
  <action>
    Rewrite admin moderation page with tab layout:
    - Tabs: "Queue" | "Users" | "Bans" | "Audit Log" | "Stats"
    - Default to Queue tab
    - Each tab lazy-loads its component

    Create ModerationQueue component:
    - Fetch from GET /api/admin/moderation?status=pending
    - Display as list of report cards, each showing:
      - Content preview (first 200 chars of post/comment)
      - Author info (avatar, username)
      - Report count badge ("5 reports")
      - Reporter reasons summary (e.g., "harassment (3), spam (1), inappropriate (1)")
      - Date of first and most recent report
      - "Take Action" button
    - Filter bar: status dropdown (pending, reviewed, dismissed), content type dropdown
    - Infinite scroll or load-more pagination
    - Empty state: "No pending reports"

    Create ModerationActionModal component:
    - Opens when "Take Action" is clicked
    - Shows content preview and all reporter details
    - Action buttons:
      1. "Remove Content" — removes the content, notifies author
      2. "Warn User" — opens textarea for custom warning message
      3. "Ban User" — opens ban duration selector (24h, 7d, 30d, permanent) + reason textarea. ONLY VISIBLE TO ADMINS (not moderators).
      4. "Dismiss" — dismisses reports without action
    - On action: PUT /api/admin/moderation/[id] with { action, reason, ban_duration }
    - Success: remove item from queue, show toast
    - For warn/ban: show confirmation before submitting
  </action>
  <verify>Navigate to /admin/moderation. Queue shows grouped reports. Click "Take Action" opens modal. Submit action removes from queue. Ban option hidden for moderators.</verify>
  <done>Moderation queue displays grouped reports with action modal supporting remove, warn, ban (admin only), and dismiss.</done>
</task>

<task type="auto">
  <name>Task 2: User browser + ban manager</name>
  <files>
    src/components/admin/UserBrowser.tsx
    src/components/admin/BanManager.tsx
  </files>
  <action>
    Create UserBrowser component:
    - Fetch from GET /api/admin/users with search and filters
    - Search bar: search by username, display_name, email
    - Filters: role dropdown, status dropdown, mode dropdown
    - Results as table/list:
      - Avatar, username, display_name, email
      - Role badge (user/moderator/admin)
      - Status badge (active/deactivated/pending_deletion/banned with colors)
      - Mode badge (bible/positivity)
      - Joined date, last login
      - Action buttons: Edit, Ban (if not already banned)
    - Edit opens inline form or modal with editable fields:
      - email, username, display_name, mode, is_verified toggle, role dropdown
      - Save calls PUT /api/admin/users/[id]
    - Ban button opens ban form (same as moderation queue ban flow)
    - Pagination with load-more

    Create BanManager component:
    - Fetch from GET /api/admin/bans?active=true
    - Active bans tab: list of currently banned users
      - User info, ban reason, duration, expires_at, banned_by admin name
      - "Lift Ban" button → PUT /api/admin/bans/[id]
    - Ban history tab: all bans including lifted ones
    - Create ban button: opens form with user search, reason, duration selector
      - POST /api/admin/bans
    - Visual: green for lifted bans, red for active, yellow for expiring soon
  </action>
  <verify>User browser shows users with search and filters. Edit user updates fields. Ban manager shows active bans with lift button. Create ban from ban manager works.</verify>
  <done>User browser supports search, filtering, inline editing. Ban manager shows active bans with lift capability and ban creation.</done>
</task>

<task type="auto">
  <name>Task 3: Audit log + moderation stats</name>
  <files>
    src/components/admin/AuditLog.tsx
    src/components/admin/ModerationStats.tsx
  </files>
  <action>
    Create AuditLog component:
    - Fetch from GET /api/admin/audit-log
    - Searchable: text search on reason
    - Filterable: admin dropdown, action type dropdown, date range picker
    - Display as table/list:
      - Timestamp (relative + absolute on hover)
      - Admin name + avatar
      - Action badge (color-coded: red for ban, yellow for warn, gray for dismiss, orange for remove)
      - Target user (if applicable)
      - Content reference (if applicable)
      - Reason (expandable if long)
    - Pagination with load-more
    - Sortable by date (newest first default)

    Create ModerationStats component:
    - Fetch from GET /api/admin/moderation-stats
    - Dashboard layout with stat cards:
      1. Reports Overview: total reports, pending, today's count
      2. Active Bans count
      3. Action Breakdown: pie chart or bar chart of actions (remove, warn, ban, dismiss) — can use simple colored bars, no need for chart library
      4. Repeat Offenders: list of top 10 users with most reports against them
         - Username, report count, current status, link to user detail
      5. Activity Timeline: simple bar visualization of moderation actions per day (last 7 days)
    - Loading states with skeletons
    - Responsive grid layout

    Wire both components into the moderation page tabs.
  </action>
  <verify>Audit log shows searchable/filterable log entries. Stats dashboard shows report counts, action breakdown, repeat offenders. All data loads correctly.</verify>
  <done>Audit log is fully searchable with filters. Stats dashboard shows comprehensive moderation metrics.</done>
</task>

</tasks>

<verification>
1. Moderation page has 5 tabs (Queue, Users, Bans, Audit Log, Stats)
2. Queue shows grouped reports with functional action modal
3. All 4 actions work (remove, warn, ban, dismiss) with proper logging
4. Ban option hidden for moderators in action modal
5. User browser supports search, filtering, and inline editing
6. Ban manager shows active bans with lift capability
7. Audit log is searchable and filterable by admin, action, date
8. Stats dashboard shows reports, bans, action breakdown, repeat offenders
</verification>

<success_criteria>
- 5-tab moderation interface is fully functional
- Queue displays grouped reports with all reporter details
- Action modal handles all moderation actions with role enforcement
- User browser enables admin to search, filter, and edit any user
- Ban manager shows active bans and supports ban creation/lifting
- Audit log provides full searchable history of all moderation actions
- Stats dashboard gives overview of moderation health
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-13-SUMMARY.md`
</output>
