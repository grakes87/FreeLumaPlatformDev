---
phase: 04-enhanced-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/models/VideoCategory.ts
  - src/lib/db/models/Video.ts
  - src/lib/db/models/VideoProgress.ts
  - src/lib/db/models/VideoReaction.ts
  - src/lib/db/models/index.ts
  - src/lib/db/migrations/043-create-video-categories.cjs
  - src/lib/db/migrations/044-create-videos.cjs
  - src/lib/db/migrations/045-create-video-progress.cjs
  - src/lib/db/migrations/046-create-video-reactions.cjs
autonomous: true

must_haves:
  truths:
    - "VideoCategory, Video, VideoProgress, VideoReaction models can be imported from @/lib/db/models"
    - "All 4 migrations run successfully and create tables in the database"
    - "Associations are wired: Video belongsTo VideoCategory, Video hasMany VideoProgress/VideoReaction, VideoProgress/VideoReaction belongsTo User"
  artifacts:
    - path: "src/lib/db/models/VideoCategory.ts"
      provides: "VideoCategory model with name, slug, sort_order, is_active"
      contains: "VideoCategory.init"
    - path: "src/lib/db/models/Video.ts"
      provides: "Video model with title, description, category_id, video_url, thumbnail_url, caption_url, duration_seconds, view_count, is_hero, published, uploaded_by"
      contains: "Video.init"
    - path: "src/lib/db/models/VideoProgress.ts"
      provides: "VideoProgress model with user_id, video_id, watched_seconds, duration_seconds, last_position, completed"
      contains: "VideoProgress.init"
    - path: "src/lib/db/models/VideoReaction.ts"
      provides: "VideoReaction model with user_id, video_id, type (same 6 as PostReaction)"
      contains: "VideoReaction.init"
  key_links:
    - from: "src/lib/db/models/index.ts"
      to: "VideoCategory, Video, VideoProgress, VideoReaction"
      via: "import and association setup"
      pattern: "Video\\.belongsTo.*VideoCategory"
---

<objective>
Create the video library database foundation — 4 Sequelize models and 4 migrations for the video category system, video content, per-user watch progress tracking, and video reactions.

Purpose: All video library features (admin upload, Netflix-style browsing, playback tracking, reactions) depend on these database tables.
Output: 4 model files, 4 migration files, updated model index with associations.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md

Follow existing model patterns exactly:
@src/lib/db/models/PostReaction.ts (for VideoReaction pattern — same 6 reaction types)
@src/lib/db/models/ListenLog.ts (for VideoProgress pattern — progress tracking)
@src/lib/db/models/Category.ts (for VideoCategory pattern — name, slug, sort_order)
@src/lib/db/models/DailyContent.ts (for Video pattern — content with media URLs)
@src/lib/db/models/index.ts (for association registration pattern)
@src/lib/db/migrations/001-create-users.cjs (for migration .cjs format)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoCategory and Video models with migrations</name>
  <files>
    src/lib/db/models/VideoCategory.ts
    src/lib/db/models/Video.ts
    src/lib/db/migrations/043-create-video-categories.cjs
    src/lib/db/migrations/044-create-videos.cjs
  </files>
  <action>
    Create VideoCategory model following the Category model pattern:
    - Fields: id (PK auto-increment), name (STRING 100, not null), slug (STRING 100, unique, not null), description (STRING 500, nullable), sort_order (INTEGER, default 0), is_active (BOOLEAN, default true), created_at, updated_at
    - No paranoid (admin can hard-delete categories)

    Create Video model following the DailyContent model pattern:
    - Fields: id (PK auto-increment), title (STRING 200, not null), description (TEXT, nullable), category_id (INTEGER, not null, FK to video_categories), video_url (STRING 500, not null — B2 URL), thumbnail_url (STRING 500, nullable — auto-generated), caption_url (STRING 500, nullable — WebVTT file URL), duration_seconds (INTEGER, not null, default 0), view_count (INTEGER, not null, default 0), is_hero (BOOLEAN, default false — for hero banner), published (BOOLEAN, default false), uploaded_by (INTEGER, not null, FK to users), created_at, updated_at
    - NOT paranoid (admin manages deletion directly)

    Migration 043-create-video-categories.cjs:
    - Create video_categories table with all fields
    - Index on slug (unique), sort_order

    Migration 044-create-videos.cjs:
    - Create videos table with all fields
    - FK category_id -> video_categories(id) ON DELETE RESTRICT
    - FK uploaded_by -> users(id) ON DELETE RESTRICT
    - Indexes on category_id, uploaded_by, published, is_hero, view_count
    - Composite index (published, category_id, view_count DESC) for category browsing
  </action>
  <verify>Run `npx sequelize-cli db:migrate` and verify tables exist with `DESCRIBE video_categories` and `DESCRIBE videos`</verify>
  <done>video_categories and videos tables created with correct columns, indexes, and foreign keys</done>
</task>

<task type="auto">
  <name>Task 2: Create VideoProgress and VideoReaction models with migrations</name>
  <files>
    src/lib/db/models/VideoProgress.ts
    src/lib/db/models/VideoReaction.ts
    src/lib/db/migrations/045-create-video-progress.cjs
    src/lib/db/migrations/046-create-video-reactions.cjs
  </files>
  <action>
    Create VideoProgress model following the ListenLog pattern:
    - Fields: id (PK auto-increment), user_id (INTEGER, not null, FK to users), video_id (INTEGER, not null, FK to videos), watched_seconds (INTEGER, not null, default 0 — cumulative), duration_seconds (INTEGER, not null, default 0 — video total duration), last_position (INTEGER, not null, default 0 — resume point in seconds), completed (BOOLEAN, default false), created_at, updated_at
    - Unique composite index on (user_id, video_id) — one progress record per user per video
    - Idempotent upsert pattern for saving progress

    Create VideoReaction model following the PostReaction pattern exactly:
    - Fields: id (PK auto-increment), user_id (INTEGER, not null, FK to users), video_id (INTEGER, not null, FK to videos), type (ENUM 'like','love','haha','wow','sad','pray', not null), created_at, updated_at
    - Unique composite index on (user_id, video_id) — one reaction per user per video

    Migration 045-create-video-progress.cjs:
    - Create video_progress table
    - FK user_id -> users(id) ON DELETE CASCADE
    - FK video_id -> videos(id) ON DELETE CASCADE
    - Unique index (user_id, video_id)
    - Index on video_id for analytics queries

    Migration 046-create-video-reactions.cjs:
    - Create video_reactions table
    - FK user_id -> users(id) ON DELETE CASCADE
    - FK video_id -> videos(id) ON DELETE CASCADE
    - Unique index (user_id, video_id)
    - Index on video_id for count queries
  </action>
  <verify>Run migrations, then verify tables with `DESCRIBE video_progress` and `DESCRIBE video_reactions`</verify>
  <done>video_progress and video_reactions tables created with unique composite indexes and foreign keys</done>
</task>

<task type="auto">
  <name>Task 3: Register models and associations in index.ts</name>
  <files>src/lib/db/models/index.ts</files>
  <action>
    Import and export VideoCategory, Video, VideoProgress, VideoReaction from the model index.

    Add associations:
    - VideoCategory.hasMany(Video, { foreignKey: 'category_id', as: 'videos' })
    - Video.belongsTo(VideoCategory, { foreignKey: 'category_id', as: 'category' })
    - Video.hasMany(VideoProgress, { foreignKey: 'video_id', as: 'progress' })
    - Video.hasMany(VideoReaction, { foreignKey: 'video_id', as: 'reactions' })
    - Video.belongsTo(User, { foreignKey: 'uploaded_by', as: 'uploader' })
    - VideoProgress.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
    - VideoProgress.belongsTo(Video, { foreignKey: 'video_id', as: 'video' })
    - VideoReaction.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
    - VideoReaction.belongsTo(Video, { foreignKey: 'video_id', as: 'video' })
    - User.hasMany(VideoProgress, { foreignKey: 'user_id' })
    - User.hasMany(VideoReaction, { foreignKey: 'user_id' })

    Place associations in the existing associations section of index.ts.
  </action>
  <verify>Import { VideoCategory, Video, VideoProgress, VideoReaction } from '@/lib/db/models' compiles without error. Run `npx tsc --noEmit` on the models directory.</verify>
  <done>All 4 video models are exported from index.ts and associations are registered with correct foreign keys and aliases</done>
</task>

</tasks>

<verification>
1. All 4 migrations run cleanly: `npx sequelize-cli db:migrate`
2. Models import without TypeScript errors
3. Foreign keys are correct (check with SHOW CREATE TABLE)
4. Unique composite indexes exist on video_progress(user_id, video_id) and video_reactions(user_id, video_id)
</verification>

<success_criteria>
- 4 new Sequelize models (VideoCategory, Video, VideoProgress, VideoReaction) exist and are importable
- 4 new migrations (043-046) create tables with correct schema, FKs, and indexes
- Model associations are wired in index.ts
- Database schema matches research spec
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-01-SUMMARY.md`
</output>
