---
phase: 04-enhanced-content
plan: 09
type: execute
wave: 3
depends_on: ["04-04"]
files_modified:
  - src/lib/video/thumbnail.ts
  - src/lib/video/captions.ts
  - src/app/api/videos/[id]/process/route.ts
  - src/app/(admin)/admin/videos/page.tsx
  - src/components/admin/VideoUploadForm.tsx
  - src/components/admin/VideoCategoryManager.tsx
autonomous: true
user_setup:
  - service: openai
    why: "Whisper API for auto-generating video captions"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI Dashboard -> API keys -> Create new secret key"

must_haves:
  truths:
    - "Admin can upload video via presigned URL and metadata form"
    - "Thumbnail is auto-extracted from video frame after upload"
    - "Captions are auto-generated from video audio (when OpenAI key configured)"
    - "Admin can manage video categories (create, reorder, delete)"
    - "Admin can view all videos with edit/delete/publish actions"
  artifacts:
    - path: "src/lib/video/thumbnail.ts"
      provides: "extractThumbnail() function using fluent-ffmpeg"
      exports: ["extractThumbnail"]
    - path: "src/lib/video/captions.ts"
      provides: "generateCaptions() function using OpenAI Whisper (optional)"
      exports: ["generateCaptions"]
    - path: "src/app/(admin)/admin/videos/page.tsx"
      provides: "Admin video management page with upload, list, edit"
  key_links:
    - from: "src/app/api/videos/[id]/process/route.ts"
      to: "src/lib/video/thumbnail.ts"
      via: "Calls extractThumbnail after video upload"
      pattern: "extractThumbnail"
    - from: "src/components/admin/VideoUploadForm.tsx"
      to: "/api/upload/presigned + /api/videos"
      via: "Get presigned URL, upload to B2, then POST video metadata"
      pattern: "presigned.*PUT.*POST.*videos"
---

<objective>
Build video upload processing (thumbnail extraction + caption generation) and admin video management UI — admin can upload videos, manage categories, and control the video library.

Purpose: Admins need to add video content to the library with auto-generated thumbnails and captions.
Output: FFmpeg thumbnail extraction, Whisper caption generation, admin video management page.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-04-SUMMARY.md

Follow existing patterns:
@src/app/api/upload/presigned/route.ts (for presigned URL pattern)
@src/app/(admin)/admin/page.tsx (for admin page pattern)
@src/components/admin/ (for existing admin components)
@src/lib/storage/b2.ts (for B2 upload pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Video processing utilities (thumbnail + captions)</name>
  <files>
    src/lib/video/thumbnail.ts
    src/lib/video/captions.ts
    src/app/api/videos/[id]/process/route.ts
  </files>
  <action>
    First install dependencies: `npm install fluent-ffmpeg ffmpeg-static openai && npm install -D @types/fluent-ffmpeg`

    Create src/lib/video/thumbnail.ts:
    - Import fluent-ffmpeg and ffmpeg-static
    - Set ffmpeg path: ffmpeg.setFfmpegPath(ffmpegStatic as string)
    - Export extractThumbnail(videoUrl: string, seekPercent: number = 10): Promise<Buffer>
      - Use ffmpeg to extract a single frame at seekPercent% of the video
      - Pipe output as mjpeg
      - Post-process with sharp: resize to 640x360 (16:9), convert to webp quality 80
      - Return the buffer
    - Handle errors gracefully (if ffmpeg fails, return null instead of throwing)

    Create src/lib/video/captions.ts:
    - Use null client pattern: if OPENAI_API_KEY not set, export no-op function
    - Export generateCaptions(videoUrl: string): Promise<string | null>
      - If no API key: return null
      - Use fetch to download audio from videoUrl (or use ffmpeg to extract audio track)
      - Send to OpenAI Whisper API: openai.audio.transcriptions.create({ model: 'whisper-1', file, response_format: 'vtt' })
      - Return the WebVTT string content
    - Handle errors: return null on failure (captions are optional)

    Create POST /api/videos/[id]/process (withAdmin):
    - This is called after video metadata is saved (fire-and-forget from upload form)
    - Steps:
      1. Fetch video by ID
      2. Extract thumbnail: const thumbnailBuffer = await extractThumbnail(video.video_url)
      3. If thumbnail: upload to B2 with key `videos/thumbnails/{videoId}-thumb.webp`, update video.thumbnail_url
      4. Generate captions: const captionVtt = await generateCaptions(video.video_url)
      5. If captionVtt: upload VTT file to B2 with key `videos/captions/{videoId}.vtt`, update video.caption_url
      6. Return 200 with updated video record
    - IMPORTANT: This endpoint may take 10-60 seconds. The frontend should call it in the background after upload.
  </action>
  <verify>Test extractThumbnail with a valid video URL → returns Buffer. Test generateCaptions returns VTT or null. POST /api/videos/[id]/process updates thumbnail_url and caption_url.</verify>
  <done>Thumbnail extraction works with ffmpeg. Captions work with Whisper (or gracefully no-op without API key). Processing endpoint updates video record.</done>
</task>

<task type="auto">
  <name>Task 2: Admin video management page and upload form</name>
  <files>
    src/app/(admin)/admin/videos/page.tsx
    src/components/admin/VideoUploadForm.tsx
    src/components/admin/VideoCategoryManager.tsx
  </files>
  <action>
    Create admin video management page at src/app/(admin)/admin/videos/page.tsx:
    - Tab layout: "Videos" tab and "Categories" tab
    - Videos tab:
      - "Upload Video" button opens VideoUploadForm modal
      - Table/grid of all videos (including unpublished)
      - Columns: thumbnail, title, category, duration, view count, published status, actions
      - Action buttons: Edit (inline or modal), Delete (with confirm), Toggle publish
      - Hero badge on the current hero video, button to set as hero
    - Categories tab: VideoCategoryManager component

    Create VideoUploadForm component:
    1. Form fields: title (required), description (optional), category (dropdown from /api/video-categories), published toggle
    2. Video file input: accepts video/mp4, video/webm, video/quicktime
    3. Upload flow:
       a. User selects video file
       b. Get presigned URL: GET /api/upload/presigned?type=video&contentType={mimeType} (extend presigned endpoint for video type with key prefix 'videos/')
       c. Upload directly to B2 via PUT to presigned URL (show progress bar)
       d. Extract duration from video file client-side using HTMLVideoElement
       e. POST /api/videos with { title, description, category_id, video_url, duration_seconds, published }
       f. Fire background POST /api/videos/[id]/process (fire-and-forget for thumbnail + captions)
       g. Show success message
    4. Progress indicator for upload
    5. IMPORTANT: Extend presigned URL endpoint to accept type='video' with longer expiry (4 hours instead of 1 hour)

    Create VideoCategoryManager component:
    - List all categories with sort order
    - Add new category form (name, description)
    - Edit category (inline)
    - Delete category (disabled if has videos, shows count)
    - Drag to reorder (or up/down buttons for simplicity)
  </action>
  <verify>Navigate to /admin/videos. Upload a video → presigned URL flow works, metadata saved, thumbnail auto-generated. Create/edit/delete categories. Toggle video published status.</verify>
  <done>Admin can manage the complete video library: upload videos with auto-processing, manage categories, edit/delete/publish videos.</done>
</task>

</tasks>

<verification>
1. npm install fluent-ffmpeg ffmpeg-static openai succeeds
2. extractThumbnail returns a webp buffer from a video URL
3. generateCaptions returns VTT content (or null without API key)
4. POST /api/videos/[id]/process updates thumbnail and caption URLs
5. Admin video page shows all videos with management controls
6. VideoUploadForm uploads to B2 and triggers processing
7. VideoCategoryManager handles CRUD with sort ordering
8. Presigned URL endpoint supports video type with longer expiry
</verification>

<success_criteria>
- Thumbnail auto-generated from video frame using FFmpeg
- Captions auto-generated via Whisper (optional, graceful degradation)
- Admin page provides full video library management
- Upload flow: presigned URL → B2 → metadata → background processing
- Category management with sort ordering
- Video publish/unpublish toggle
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-09-SUMMARY.md`
</output>
