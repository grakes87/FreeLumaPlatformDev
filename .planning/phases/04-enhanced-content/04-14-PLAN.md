---
phase: 04-enhanced-content
plan: 14
type: execute
wave: 4
depends_on: ["04-06", "04-10", "04-13"]
files_modified:
  - src/app/(app)/banned/page.tsx
  - src/components/common/DeactivatedProfile.tsx
  - src/components/chat/SharedVideoMessage.tsx
  - src/app/api/videos/route.ts
  - src/lib/notifications/create.ts
  - src/components/profile/ProfileHeader.tsx
  - src/components/feed/PostCard.tsx
  - src/components/social/FollowList.tsx
autonomous: true

must_haves:
  truths:
    - "Banned users see a suspension message screen with reason and expiry date"
    - "Deactivated user profiles show 'Account deactivated' message to others"
    - "New video notifications are sent to all users when admin publishes a video"
    - "Shared video messages render with video preview in chat"
    - "Deactivated users are grayed out in follower lists"
    - "Banned user content is hidden from feeds (restored when ban lifts)"
  artifacts:
    - path: "src/app/(app)/banned/page.tsx"
      provides: "Suspension message screen for banned users"
    - path: "src/components/common/DeactivatedProfile.tsx"
      provides: "Deactivated user placeholder component"
    - path: "src/components/chat/SharedVideoMessage.tsx"
      provides: "Chat bubble for shared video messages"
  key_links:
    - from: "src/app/(app)/banned/page.tsx"
      to: "withAuth ban check"
      via: "Redirected when 403 with ban info"
      pattern: "suspended|banned"
    - from: "src/components/feed/PostCard.tsx"
      to: "User.status"
      via: "Hide content from banned users"
      pattern: "status.*banned|hidden"
---

<objective>
Integration and polish — ban screen for suspended users, deactivated profile display, shared video chat messages, new video notifications, and content hiding for banned/deactivated users.

Purpose: Ties together all Phase 4 features with proper user-facing behavior for edge cases (bans, deactivation, video sharing).
Output: Ban screen, deactivated profile component, shared video chat bubble, notification dispatch, content visibility rules.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-06-SUMMARY.md
@.planning/phases/04-enhanced-content/04-10-SUMMARY.md
@.planning/phases/04-enhanced-content/04-13-SUMMARY.md

Follow existing patterns:
@src/components/profile/ProfileHeader.tsx (for profile display modifications)
@src/components/feed/PostCardInstagram.tsx (for post card modifications)
@src/components/chat/MessageBubble.tsx (for chat message types)
@src/lib/notifications/create.ts (for createNotification pattern)
@src/components/social/FollowList.tsx (for follower list modifications)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ban screen + deactivated profile + content visibility</name>
  <files>
    src/app/(app)/banned/page.tsx
    src/components/common/DeactivatedProfile.tsx
    src/components/profile/ProfileHeader.tsx
    src/components/feed/PostCard.tsx
    src/components/social/FollowList.tsx
  </files>
  <action>
    Create ban screen at src/app/(app)/banned/page.tsx:
    - Full-screen page with centered content
    - Shield/warning icon at top
    - Title: "Account Suspended"
    - Reason text from URL query or API
    - Expiry date: "Your suspension will be lifted on [date]" or "This suspension is permanent. Contact support for more information."
    - "Contact Support" link (mailto or external URL)
    - Logout button
    - No navigation (no bottom nav, no top bar)

    Handle ban redirects in the auth context:
    - When useAuth detects a 403 response with { error: 'Account suspended' }, redirect to /banned?reason=...&expires=...
    - Alternatively, store ban info in auth context and render ban screen conditionally

    Create DeactivatedProfile component:
    - Used when viewing a deactivated user's profile
    - Shows: grayed out avatar (or ghost icon), "Account deactivated" message
    - No bio, no posts tab, no follow button
    - Simple card with the deactivated message

    Update ProfileHeader:
    - When viewing another user's profile, check user.status
    - If 'deactivated': render DeactivatedProfile instead of full profile
    - If 'active': render normally

    Update PostCard:
    - When rendering a post, check the author's status
    - If author.status === 'banned': hide the post entirely (filter out in client or show "Content unavailable" placeholder)
    - If author.status === 'deactivated': show post but replace author info with "Deactivated User" (grayed)
    - IMPORTANT: The feed API should also filter out content from banned users server-side. Update the feed/posts API to exclude posts where author status is 'banned' (WHERE clause or post-filter).

    Update FollowList:
    - When rendering followers/following list, check user.status
    - Deactivated users: show grayed out with "Account deactivated" tag
    - Banned users: show grayed out with "Account suspended" tag
  </action>
  <verify>Set user status to 'banned' → ban screen shows with reason and expiry. View deactivated user profile → shows deactivated message. Feed hides banned user posts. Follower list shows status tags.</verify>
  <done>Banned users see suspension screen. Deactivated profiles show placeholder. Banned content hidden from feeds. Status indicators in follower lists.</done>
</task>

<task type="auto">
  <name>Task 2: Shared video chat messages + new video notifications</name>
  <files>
    src/components/chat/SharedVideoMessage.tsx
    src/components/chat/MessageBubble.tsx
    src/app/api/videos/route.ts
    src/lib/notifications/create.ts
  </files>
  <action>
    Create SharedVideoMessage component:
    - Props: video (id, title, thumbnail_url, duration_seconds)
    - Render a card-style preview within the chat bubble:
      - Thumbnail image (16:9 aspect ratio, rounded corners)
      - Play icon overlay on thumbnail
      - Video title below thumbnail
      - Duration badge
    - Tap → navigate to /watch/[id] (video detail page)
    - Styling: slightly different from regular message bubbles (card with border)

    Update MessageBubble component:
    - Add case for message.type === 'shared_video':
      - Render SharedVideoMessage with message.sharedVideo data
    - Ensure the shared video data is available from the message fetch (included via association in GET messages)

    Add new video notification dispatch:
    - In POST /api/videos (create video) or PUT /api/videos/[id] (update), when a video is published (published transitions from false to true):
      1. Fetch all active users (status='active') excluding the admin who uploaded
      2. For each user: createNotification({ recipient_id: user.id, actor_id: admin.id, type: 'new_video', entity_type: 'video', entity_id: video.id, preview_text: video.title })
      3. IMPORTANT: Don't send notifications for every publish toggle. Only on FIRST publish (track with a flag or check if notification already sent).
      4. Use bulk notification creation or queue pattern to avoid blocking the API response
    - Alternative approach: Instead of notifying all users immediately, use a background job. For simplicity in this phase, send notifications in a fire-and-forget loop after the API response.

    Also update the notification render to handle new types:
    - 'new_video': "New video: [title]" with play icon, tap → /watch/[id]
    - 'content_removed': "Your [content] was removed: [reason]" with warning icon
    - 'warning': "You received a warning: [reason]" with warning icon
    - 'ban': "Your account has been suspended: [reason]" with shield icon
  </action>
  <verify>Share video in chat → SharedVideoMessage renders with preview. Publish new video → users receive new_video notification. Tap notification → navigates to video. Moderation notifications render correctly.</verify>
  <done>Shared video messages display in chat with preview card. New video notifications sent on publish. All new notification types render with correct icons and navigation.</done>
</task>

</tasks>

<verification>
1. Banned user redirected to /banned page with reason and expiry
2. Deactivated user profile shows "Account deactivated" placeholder
3. Posts from banned users hidden in feed (server-side and client-side)
4. Posts from deactivated users show with "Deactivated User" attribution
5. Follower list shows status tags for deactivated/banned users
6. SharedVideoMessage renders in chat with thumbnail, title, play icon
7. Tapping shared video navigates to /watch/[id]
8. Publishing a video sends new_video notification to all active users
9. New notification types (new_video, content_removed, warning, ban) render correctly
10. Notification tap navigates to correct destination
</verification>

<success_criteria>
- Ban enforcement is visible: suspended users see clear message with reason/expiry
- Deactivated profiles display gracefully to other users
- Content from banned users is hidden; content from deactivated users shows with placeholder author
- Shared video messages are visually appealing in chat with video preview
- New video notifications reach all active users on first publish
- All 4 new notification types render with proper icons and navigation
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-14-SUMMARY.md`
</output>
