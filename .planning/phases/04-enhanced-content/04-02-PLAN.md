---
phase: 04-enhanced-content
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/models/Ban.ts
  - src/lib/db/models/ModerationLog.ts
  - src/lib/db/models/ActivityStreak.ts
  - src/lib/db/models/User.ts
  - src/lib/db/models/Message.ts
  - src/lib/db/models/index.ts
  - src/lib/db/migrations/047-add-user-status-fields.cjs
  - src/lib/db/migrations/048-create-bans.cjs
  - src/lib/db/migrations/049-create-moderation-logs.cjs
  - src/lib/db/migrations/050-create-activity-streaks.cjs
  - src/lib/db/migrations/051-add-role-to-users.cjs
  - src/lib/db/migrations/052-add-shared-video-to-messages.cjs
  - src/lib/db/migrations/053-extend-notification-enums.cjs
  - src/lib/notifications/types.ts
autonomous: true

must_haves:
  truths:
    - "User model has status, deactivated_at, deletion_requested_at fields"
    - "Ban, ModerationLog, ActivityStreak models can be imported from @/lib/db/models"
    - "User model has role column with admin/moderator/user values"
    - "Message model has shared_video_id nullable FK column"
    - "Notification types include new_video, content_removed, warning, ban"
    - "All 7 migrations run successfully"
  artifacts:
    - path: "src/lib/db/models/Ban.ts"
      provides: "Ban model with user_id, banned_by, reason, duration, expires_at, lifted_at"
      contains: "Ban.init"
    - path: "src/lib/db/models/ModerationLog.ts"
      provides: "ModerationLog model with admin_id, action, target_user_id, target_content_type, target_content_id, reason, metadata"
      contains: "ModerationLog.init"
    - path: "src/lib/db/models/ActivityStreak.ts"
      provides: "ActivityStreak model with user_id, activity_date, activities (JSON)"
      contains: "ActivityStreak.init"
  key_links:
    - from: "src/lib/db/models/User.ts"
      to: "Ban, ModerationLog, ActivityStreak"
      via: "hasMany associations"
      pattern: "User\\.hasMany.*Ban"
    - from: "src/lib/notifications/types.ts"
      to: "Notification model ENUM"
      via: "NOTIFICATION_TYPES tuple"
      pattern: "NEW_VIDEO|CONTENT_REMOVED|WARNING|BAN"
---

<objective>
Create the account lifecycle and admin moderation database foundation — 3 new models (Ban, ModerationLog, ActivityStreak), extend User/Message models, add notification types, and run 7 migrations.

Purpose: Account deactivation/deletion, ban enforcement, moderation queue, activity streaks, and video sharing to chat all depend on these schema changes.
Output: 3 new model files, 7 migration files, updated User/Message models, extended notification types.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md

Follow existing model patterns:
@src/lib/db/models/User.ts (extend with status fields + role)
@src/lib/db/models/Report.ts (for Ban pattern — user reporting/moderation)
@src/lib/db/models/Message.ts (extend with shared_video_id)
@src/lib/db/models/index.ts (for association registration)
@src/lib/notifications/types.ts (for notification enum extension)
@src/lib/db/migrations/042-add-messaging-notification-prefs-to-user-settings.cjs (for latest migration format)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user status fields + role column + Ban model with migrations</name>
  <files>
    src/lib/db/models/User.ts
    src/lib/db/models/Ban.ts
    src/lib/db/migrations/047-add-user-status-fields.cjs
    src/lib/db/migrations/048-create-bans.cjs
    src/lib/db/migrations/051-add-role-to-users.cjs
  </files>
  <action>
    Update User model TypeScript interface and init to add:
    - status: ENUM('active', 'deactivated', 'pending_deletion', 'banned'), default 'active', not null
    - deactivated_at: DATE, nullable
    - deletion_requested_at: DATE, nullable
    - role: ENUM('user', 'moderator', 'admin'), default 'user', not null
    Add these to UserAttributes interface, UserCreationAttributes optional list, class declarations, and init fields.

    Create Ban model following Report model pattern:
    - Fields: id (PK auto-increment), user_id (INTEGER, not null, FK to users), banned_by (INTEGER, not null, FK to users), reason (TEXT, not null), duration (ENUM '24h','7d','30d','permanent', not null), expires_at (DATE, nullable — null for permanent), lifted_at (DATE, nullable — set when manually lifted), created_at, updated_at
    - NOT paranoid

    Migration 047-add-user-status-fields.cjs:
    - Add status ENUM column with default 'active'
    - Add deactivated_at DATE nullable
    - Add deletion_requested_at DATE nullable
    - Index on status

    Migration 048-create-bans.cjs:
    - Create bans table with all fields
    - FK user_id -> users(id) ON DELETE CASCADE
    - FK banned_by -> users(id) ON DELETE RESTRICT
    - Index on user_id, index on (user_id, lifted_at) for active ban lookup

    Migration 051-add-role-to-users.cjs:
    - Add role ENUM('user', 'moderator', 'admin') column with default 'user'
    - Index on role
  </action>
  <verify>Run migrations, `DESCRIBE users` shows status/deactivated_at/deletion_requested_at/role columns, `DESCRIBE bans` shows all fields</verify>
  <done>User model extended with status/role fields, Ban model created with correct schema and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create ModerationLog, ActivityStreak models + Message extension + migrations</name>
  <files>
    src/lib/db/models/ModerationLog.ts
    src/lib/db/models/ActivityStreak.ts
    src/lib/db/models/Message.ts
    src/lib/db/migrations/049-create-moderation-logs.cjs
    src/lib/db/migrations/050-create-activity-streaks.cjs
    src/lib/db/migrations/052-add-shared-video-to-messages.cjs
  </files>
  <action>
    Create ModerationLog model:
    - Fields: id (PK auto-increment), admin_id (INTEGER, not null, FK to users), action (ENUM 'remove_content','warn_user','ban_user','unban_user','edit_user','dismiss_report', not null), target_user_id (INTEGER, nullable, FK to users), target_content_type (ENUM 'post','comment','video', nullable), target_content_id (INTEGER, nullable), reason (TEXT, nullable), metadata (TEXT, nullable — JSON string), created_at (DATE — no updated_at, audit logs are immutable)
    - NOT paranoid, timestamps true but only createdAt (updatedAt: false)
    - Indexes on admin_id, target_user_id, action, created_at

    Create ActivityStreak model:
    - Fields: id (PK auto-increment), user_id (INTEGER, not null, FK to users), activity_date (DATEONLY, not null — '2026-02-13' format), activities (TEXT, not null — JSON array of activity types: 'daily_view', 'audio_listen', 'video_watch', 'social_activity'), created_at, updated_at
    - Unique composite index on (user_id, activity_date) — one record per user per day
    - NOT paranoid

    Update Message model:
    - Add shared_video_id (INTEGER, nullable, FK to videos) to MessageAttributes interface and init
    - Add 'shared_video' to the message type ENUM (alongside existing text, image, video, audio, system, shared_post)

    Migration 049-create-moderation-logs.cjs:
    - Create moderation_logs table
    - FK admin_id -> users(id) ON DELETE RESTRICT
    - FK target_user_id -> users(id) ON DELETE SET NULL (user might be deleted)
    - Indexes on admin_id, target_user_id, action, created_at

    Migration 050-create-activity-streaks.cjs:
    - Create activity_streaks table
    - FK user_id -> users(id) ON DELETE CASCADE
    - Unique index (user_id, activity_date)

    Migration 052-add-shared-video-to-messages.cjs:
    - Add shared_video_id INTEGER nullable to messages table
    - FK shared_video_id -> videos(id) ON DELETE SET NULL
    - ALTER messages type ENUM to include 'shared_video' value (use raw SQL for MySQL ENUM modification — must list ALL existing values plus new one)
  </action>
  <verify>Run migrations, verify all 3 new tables exist and messages table has shared_video_id column</verify>
  <done>ModerationLog, ActivityStreak models created; Message model extended with shared_video_id and shared_video type</done>
</task>

<task type="auto">
  <name>Task 3: Extend notification types + register all new models/associations</name>
  <files>
    src/lib/notifications/types.ts
    src/lib/db/models/index.ts
    src/lib/db/migrations/053-extend-notification-enums.cjs
  </files>
  <action>
    Update src/lib/notifications/types.ts:
    - Add to NotificationType enum: NEW_VIDEO = 'new_video', CONTENT_REMOVED = 'content_removed', WARNING = 'warning', BAN = 'ban'
    - Add to NotificationEntityType enum: VIDEO = 'video'
    - NOTIFICATION_TYPES and NOTIFICATION_ENTITY_TYPES tuples will auto-update from Object.values()

    Create migration 053-extend-notification-enums.cjs:
    - Use raw SQL to ALTER notifications table type ENUM to include all existing values + 'new_video', 'content_removed', 'warning', 'ban'
    - Use raw SQL to ALTER notifications table entity_type ENUM to include all existing values + 'video'
    - IMPORTANT: MySQL ENUM ALTER requires listing ALL values (old + new). Get existing values from the current migration 040 that created the table.

    Update src/lib/db/models/index.ts:
    - Import and export Ban, ModerationLog, ActivityStreak
    - Add associations:
      - User.hasMany(Ban, { foreignKey: 'user_id', as: 'bans' })
      - Ban.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
      - Ban.belongsTo(User, { foreignKey: 'banned_by', as: 'bannedBy' })
      - User.hasMany(ModerationLog, { foreignKey: 'admin_id', as: 'moderationActions' })
      - ModerationLog.belongsTo(User, { foreignKey: 'admin_id', as: 'admin' })
      - ModerationLog.belongsTo(User, { foreignKey: 'target_user_id', as: 'targetUser' })
      - User.hasMany(ActivityStreak, { foreignKey: 'user_id', as: 'activityStreaks' })
      - ActivityStreak.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
      - Message.belongsTo(Video, { foreignKey: 'shared_video_id', as: 'sharedVideo' }) (add after Video import from Plan 01)

    NOTE: The Message.belongsTo(Video) association requires the Video model from Plan 01. If Plan 01 hasn't run yet (parallel wave), guard this association with a check or place it after the Video import. Since both plans are in wave 1, the executor will handle ordering — just add the association line in the correct section.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Migration 053 runs. Notification types enum includes new values.</verify>
  <done>Notification types extended with 4 new types + video entity type; Ban, ModerationLog, ActivityStreak registered in model index with all associations</done>
</task>

</tasks>

<verification>
1. All 7 migrations (047-053) run cleanly
2. User model has status, deactivated_at, deletion_requested_at, role columns
3. Ban, ModerationLog, ActivityStreak models importable from @/lib/db/models
4. Message model has shared_video_id column and shared_video type
5. Notification ENUM includes new_video, content_removed, warning, ban types
6. TypeScript compiles without errors
</verification>

<success_criteria>
- 3 new models (Ban, ModerationLog, ActivityStreak) exist and are importable
- User model extended with status (4 states), role (3 values), deactivated_at, deletion_requested_at
- Message model extended with shared_video_id FK and shared_video type
- Notification types extended for video/moderation notifications
- 7 migrations (047-053) run cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-02-SUMMARY.md`
</output>
