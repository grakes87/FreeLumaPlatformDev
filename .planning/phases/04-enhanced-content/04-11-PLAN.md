---
phase: 04-enhanced-content
plan: 11
type: execute
wave: 3
depends_on: ["04-04", "04-05"]
files_modified:
  - src/app/(app)/watch/[id]/page.tsx
  - src/components/video/VideoPlayer.tsx
  - src/components/video/VideoReactionBar.tsx
  - src/components/video/ShareVideoButton.tsx
  - src/hooks/useVideoProgress.ts
autonomous: true

must_haves:
  truths:
    - "User can view video detail page with title, description, and play button"
    - "Full-screen immersive player with play/pause, seek, volume, captions toggle"
    - "Video resumes from last watched position"
    - "Progress is saved periodically during playback"
    - "User can react to video with same 6 types as posts"
    - "User can share video to a DM conversation"
  artifacts:
    - path: "src/app/(app)/watch/[id]/page.tsx"
      provides: "Video detail page with metadata and player"
    - path: "src/components/video/VideoPlayer.tsx"
      provides: "Full-screen immersive video player with custom controls"
    - path: "src/components/video/VideoReactionBar.tsx"
      provides: "Reaction bar for videos (same 6 types as posts)"
    - path: "src/hooks/useVideoProgress.ts"
      provides: "Hook for saving/loading video progress"
  key_links:
    - from: "src/hooks/useVideoProgress.ts"
      to: "/api/videos/[id]/progress"
      via: "Periodic PUT calls to save position"
      pattern: "PUT.*progress"
    - from: "src/app/(app)/watch/[id]/page.tsx"
      to: "/api/videos/[id]"
      via: "Fetch video detail with user progress/reaction"
      pattern: "fetch.*api/videos"
---

<objective>
Build the video detail page and immersive video player — detail page with title/description/reactions, full-screen player with captions and resume, and share-to-chat functionality.

Purpose: Users tap a video card to see details, then play with resume support, react, and share to chat.
Output: Video detail page, immersive player component, reaction bar, share button, progress tracking hook.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-04-SUMMARY.md
@.planning/phases/04-enhanced-content/04-05-SUMMARY.md

Follow existing patterns:
@src/components/daily/DailyPostSlide.tsx (for video element and playback)
@src/components/feed/PostReactionBar.tsx (for reaction bar pattern)
@src/hooks/useReactions.ts (for reaction toggle hook)
@src/components/chat/ChatView.tsx (for immersive fullscreen pattern)
@src/contexts/ImmersiveContext.tsx (for hiding bottom nav)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Video detail page + reaction bar + share button</name>
  <files>
    src/app/(app)/watch/[id]/page.tsx
    src/components/video/VideoReactionBar.tsx
    src/components/video/ShareVideoButton.tsx
  </files>
  <action>
    Create video detail page at src/app/(app)/watch/[id]/page.tsx:
    1. Fetch video detail from GET /api/videos/[id] (includes progress, user reaction, reaction counts)
    2. Layout (scrollable, not full-screen):
       - Back button (top left, navigates to /watch)
       - Video thumbnail (full width) with large play button overlay
       - Below thumbnail: title (large text), category badge
       - Description (expandable if long)
       - VideoReactionBar component
       - ShareVideoButton component
       - Duration and view count info
    3. Tap play button → open VideoPlayer (full-screen)
    4. Loading state with skeleton
    5. 404 handling if video not found

    Create VideoReactionBar component:
    - Follow existing PostReactionBar pattern exactly
    - Props: videoId, initialReactionCounts, initialUserReaction
    - Display reaction type icons with counts
    - Tap a reaction to toggle (POST /api/video-reactions)
    - Optimistic update with rollback on error
    - Same 6 reaction types: like, love, haha, wow, sad, pray

    Create ShareVideoButton component:
    - Props: videoId, videoTitle
    - Tap opens a user/conversation picker (reuse UserPicker pattern from chat)
    - On select: POST message to selected conversation with type='shared_video' and shared_video_id
    - Show success toast: "Video shared to chat"
    - If no existing conversation: create one first, then send message
  </action>
  <verify>Navigate to /watch/[id]. Video detail shows title, description, thumbnail, reactions, share button. Tap reaction toggles it. Tap share sends to chat.</verify>
  <done>Video detail page renders with all metadata, functional reaction bar, and share-to-chat button.</done>
</task>

<task type="auto">
  <name>Task 2: Immersive video player + progress tracking hook</name>
  <files>
    src/components/video/VideoPlayer.tsx
    src/hooks/useVideoProgress.ts
  </files>
  <action>
    Create useVideoProgress hook:
    - Props: videoId, initialProgress (from detail page fetch)
    - State: watchedSeconds, lastPosition, completed
    - saveProgress(): PUT /api/videos/[id]/progress with current state
    - Auto-save: call saveProgress every 10 seconds during active playback
    - Save on pause, save on unmount (cleanup)
    - Resume: return initialProgress.last_position as starting point
    - Mark completed when watched_seconds >= duration_seconds * 0.75

    Create VideoPlayer component (full-screen immersive):
    - Props: videoUrl, captionUrl (nullable), duration, videoId, initialProgress
    - Use native HTML5 `<video>` element
    - Full-screen: fixed inset-0 z-50 bg-black (use ImmersiveContext to hide bottom nav)
    - Start playback from lastPosition (resume)
    - Custom controls overlay (semi-transparent bottom bar):
      - Play/pause button (center)
      - Seek bar (progress bar that can be tapped/dragged)
      - Current time / total duration display
      - Volume button (mute/unmute toggle — mobile typically doesn't have volume slider)
      - Captions toggle button (CC icon) — shows/hides `<track>` captions
      - Close/back button (top left) — exits player back to detail page
    - `<track>` element for WebVTT captions: `<track kind="subtitles" src={captionUrl} srclang="en" />`
    - Controls auto-hide after 3 seconds of no interaction, show on tap
    - Use useVideoProgress hook for periodic progress saving
    - On close: save final progress, exit full-screen

    IMPORTANT: Use native `<video>` element — do NOT use a video player library. The native element provides all needed functionality.
    IMPORTANT: Set ImmersiveContext to hide bottom nav when player is open.
  </action>
  <verify>Open player from detail page. Video starts from last position. Controls work (play/pause, seek, captions). Progress saves every 10 seconds. Closing saves final position.</verify>
  <done>Full-screen immersive player works with resume, custom controls, captions toggle, and periodic progress saving.</done>
</task>

</tasks>

<verification>
1. /watch/[id] loads video detail with title, description, reactions, share
2. Play button opens full-screen immersive player
3. Video resumes from last watched position
4. Custom controls: play/pause, seek, volume, captions toggle, close
5. Controls auto-hide after 3 seconds
6. Progress saved every 10 seconds during playback
7. Progress saved on pause and player close
8. Reactions toggle with optimistic update
9. Share button sends video to chat conversation
10. ImmersiveContext hides bottom nav during playback
</verification>

<success_criteria>
- Video detail page displays all metadata with working reactions and share
- Immersive player is full-screen with native `<video>` and custom overlay controls
- Resume playback from last position works correctly
- Progress tracking saves every 10s and on pause/close
- Captions toggle shows/hides WebVTT subtitles
- Controls auto-hide and re-show on tap
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-11-SUMMARY.md`
</output>
