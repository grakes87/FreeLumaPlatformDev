---
phase: 04-enhanced-content
plan: 08
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/app/api/admin/moderation/route.ts
  - src/app/api/admin/moderation/[id]/route.ts
  - src/app/api/admin/bans/route.ts
  - src/app/api/admin/bans/[id]/route.ts
  - src/app/api/admin/audit-log/route.ts
  - src/app/api/admin/moderation-stats/route.ts
  - src/app/api/admin/users/route.ts
  - src/app/api/admin/users/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view reports grouped by content item with all reporters/reasons"
    - "Admin can take action on reports: remove content, warn user, ban, dismiss"
    - "Admin can ban users with fixed durations (24h, 7d, 30d, permanent)"
    - "Admin can lift bans early"
    - "All moderation actions are logged in audit trail"
    - "Admin can browse and edit users with search/filtering"
    - "Moderator can review reports and warn but cannot ban"
    - "Moderation stats show report counts, action breakdown, repeat offenders"
  artifacts:
    - path: "src/app/api/admin/moderation/route.ts"
      provides: "GET endpoint for grouped moderation queue"
      exports: ["GET"]
    - path: "src/app/api/admin/moderation/[id]/route.ts"
      provides: "PUT endpoint for admin actions on reports"
      exports: ["PUT"]
    - path: "src/app/api/admin/bans/route.ts"
      provides: "GET (list bans) and POST (create ban) endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/audit-log/route.ts"
      provides: "GET endpoint for searchable moderation log"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/moderation/[id]/route.ts"
      to: "ModerationLog, Ban, Notification models"
      via: "Log action + optionally create ban + notify user"
      pattern: "ModerationLog\\.create.*Ban\\.create.*createNotification"
    - from: "src/app/api/admin/moderation/route.ts"
      to: "Report model"
      via: "Group reports by content_type + content_id"
      pattern: "Report\\.findAll.*GROUP BY"
---

<objective>
Build the enhanced admin moderation system — grouped report queue with actions, ban management, user administration, audit log, and moderation stats dashboard API.

Purpose: Admins need to review reports, take moderation actions (remove content, warn, ban), manage users, and track moderation activity.
Output: 8 API route files covering moderation queue, bans, audit log, stats, and user management.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-02-SUMMARY.md

Follow existing patterns:
@src/app/api/admin/moderation/route.ts (existing moderation — extend or replace)
@src/app/api/admin/users/route.ts (existing user management — extend)
@src/app/api/reports/route.ts (for Report model usage)
@src/lib/auth/middleware.ts (withAdmin, withModerator from Plan 06)
@src/lib/notifications/create.ts (createNotification pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced moderation queue API with actions</name>
  <files>
    src/app/api/admin/moderation/route.ts
    src/app/api/admin/moderation/[id]/route.ts
  </files>
  <action>
    Rewrite GET /api/admin/moderation (withModerator):
    1. Group reports by (content_type, content_id) — one queue entry per reported item
    2. For each group: include all reporters with their reasons, count of reports, content preview, content author info
    3. Filter options via query params: ?status=pending|reviewed|dismissed, ?content_type=post|comment
    4. Sort by report count DESC (most reported first) then created_at ASC (oldest first)
    5. Cursor pagination
    6. Response per item:
    ```json
    {
      "content_type": "post",
      "content_id": 123,
      "content_preview": "First 200 chars...",
      "author": { "id": 1, "username": "user1", "display_name": "User One" },
      "report_count": 5,
      "reports": [{ "reporter_id": 2, "reporter_username": "user2", "reason": "harassment", "details": "...", "created_at": "..." }],
      "status": "pending"
    }
    ```

    Create/rewrite PUT /api/admin/moderation/[id] (withModerator for warn/dismiss, withAdmin for remove/ban):
    Accept body: { action: 'remove_content' | 'warn_user' | 'ban_user' | 'dismiss_report', reason: string, ban_duration?: '24h' | '7d' | '30d' | 'permanent' }

    For each action:
    - 'remove_content': soft-delete the content (Post.destroy() for posts — uses paranoid). Send notification to author: "Your [post/comment] was removed for [reason]". Log to ModerationLog. Mark all reports for this content as 'reviewed'.
    - 'warn_user': Send custom warning notification to content author. Log to ModerationLog. Mark reports as 'reviewed'. MODERATOR CAN DO THIS.
    - 'ban_user': Create Ban record with duration and calculated expires_at. Set user.status = 'banned'. Send ban notification to user. Log to ModerationLog. Mark reports as 'reviewed'. ADMIN ONLY — check isAdmin in context, return 403 for moderators.
    - 'dismiss_report': Mark all reports for this content as 'dismissed'. Log to ModerationLog.

    IMPORTANT: All actions must create a ModerationLog entry with admin_id, action, target_user_id, target_content_type, target_content_id, reason.
    IMPORTANT: Use createNotification() for user notifications (content_removed, warning, ban types from extended enum).
  </action>
  <verify>GET /api/admin/moderation returns grouped reports. PUT with action='remove_content' soft-deletes post and notifies author. PUT with action='ban_user' creates ban and updates user status.</verify>
  <done>Moderation queue returns grouped reports. All 4 actions work with proper logging, notifications, and role enforcement.</done>
</task>

<task type="auto">
  <name>Task 2: Ban management + user administration APIs</name>
  <files>
    src/app/api/admin/bans/route.ts
    src/app/api/admin/bans/[id]/route.ts
    src/app/api/admin/users/route.ts
    src/app/api/admin/users/[id]/route.ts
  </files>
  <action>
    Create GET /api/admin/bans (withAdmin):
    1. List all bans with user info, ordered by created_at DESC
    2. Filter: ?active=true (lifted_at is null AND (expires_at is null OR expires_at > now))
    3. Include user display_name, username, avatar_url

    Create POST /api/admin/bans (withAdmin):
    1. Validate: { user_id: number, reason: string, duration: enum('24h','7d','30d','permanent') }
    2. Calculate expires_at based on duration (null for permanent)
    3. Create Ban record with banned_by = admin user ID
    4. Set user.status = 'banned'
    5. Create ModerationLog entry
    6. Send ban notification via createNotification
    7. Return 201

    Create PUT /api/admin/bans/[id] (withAdmin) — lift ban early:
    1. Find ban by ID (404 if not found)
    2. Set lifted_at = new Date()
    3. Set user.status = 'active'
    4. Create ModerationLog entry (action: 'unban_user')
    5. Return 200

    Extend GET /api/admin/users (withAdmin):
    1. Add search param: ?search= (search by username, display_name, email using LIKE)
    2. Add filters: ?role=, ?status=, ?mode=
    3. Pagination with cursor
    4. Return user list with: id, email, username, display_name, avatar_url, role, status, is_admin, is_verified, mode, created_at, last_login_at
    5. Include active ban info if user is banned

    Extend PUT /api/admin/users/[id] (withAdmin):
    1. Allow editing: email, username, display_name, mode, is_verified, role
    2. Validate changes with Zod
    3. Create ModerationLog entry (action: 'edit_user', metadata: JSON of changed fields)
    4. Return updated user
  </action>
  <verify>GET /api/admin/bans returns ban list. POST creates ban and updates user status. PUT lifts ban. GET /api/admin/users supports search and filtering. PUT /api/admin/users/[id] edits user details.</verify>
  <done>Ban CRUD works with proper status management. User browser supports search, filtering, and inline editing with audit logging.</done>
</task>

<task type="auto">
  <name>Task 3: Audit log + moderation stats APIs</name>
  <files>
    src/app/api/admin/audit-log/route.ts
    src/app/api/admin/moderation-stats/route.ts
  </files>
  <action>
    Create GET /api/admin/audit-log (withModerator):
    1. Fetch ModerationLog entries ordered by created_at DESC
    2. Filter by query params: ?admin_id=, ?action=, ?target_user_id=, ?from=, ?to= (date range)
    3. Search: ?search= searches reason text (LIKE)
    4. Include admin user info (username, display_name) and target user info
    5. Cursor pagination (limit default 50)
    6. Response per entry:
    ```json
    {
      "id": 1,
      "admin": { "id": 5, "username": "admin1", "display_name": "Admin User" },
      "action": "ban_user",
      "target_user": { "id": 10, "username": "user10" },
      "target_content_type": null,
      "target_content_id": null,
      "reason": "Repeated harassment",
      "metadata": null,
      "created_at": "2026-02-13T12:00:00Z"
    }
    ```

    Create GET /api/admin/moderation-stats (withModerator):
    1. Calculate and return moderation dashboard stats:
       - total_reports: Report.count()
       - pending_reports: Report.count({ where: { status: 'pending' } })
       - reports_today: Report.count({ where: { created_at: { [Op.gte]: today start } } })
       - active_bans: Ban.count({ where: { lifted_at: null, [Op.or]: [{ expires_at: null }, { expires_at: { [Op.gt]: now } }] } })
       - action_breakdown: ModerationLog.findAll with GROUP BY action + COUNT
       - repeat_offenders: Users with most reports against them (GROUP BY target user, ORDER BY count DESC, LIMIT 10)
       - moderation_activity_7d: ModerationLog count per day for last 7 days (for chart)
    2. Return all stats in a single response
  </action>
  <verify>GET /api/admin/audit-log returns searchable log entries. GET /api/admin/moderation-stats returns counts and breakdowns.</verify>
  <done>Audit log is searchable/filterable with admin and target user info. Moderation stats show report counts, action breakdown, and repeat offenders.</done>
</task>

</tasks>

<verification>
1. GET /api/admin/moderation returns grouped report queue
2. PUT /api/admin/moderation/[id] handles all 4 actions with logging and notifications
3. Moderators can warn and dismiss but NOT ban (403)
4. GET/POST /api/admin/bans manages bans with user status updates
5. PUT /api/admin/bans/[id] lifts ban early
6. GET /api/admin/users supports search, filtering, pagination
7. PUT /api/admin/users/[id] edits user with audit logging
8. GET /api/admin/audit-log returns searchable moderation history
9. GET /api/admin/moderation-stats returns dashboard statistics
</verification>

<success_criteria>
- Moderation queue groups reports by content with all reporters/reasons
- All moderation actions log to ModerationLog and send appropriate notifications
- Moderator role can review/warn/dismiss but not ban
- Ban management works with proper user status updates
- User browser supports search and inline editing with audit trail
- Audit log is searchable by admin, action, user, date range
- Stats dashboard shows report counts, action breakdown, repeat offenders
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-08-SUMMARY.md`
</output>
