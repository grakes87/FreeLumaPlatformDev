---
phase: 04-enhanced-content
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/api/video-categories/route.ts
  - src/app/api/videos/route.ts
  - src/app/api/videos/[id]/route.ts
  - src/app/api/videos/hero/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create, update, and delete video categories"
    - "Admin can create, update, and delete videos with metadata"
    - "Authenticated users can list videos grouped by category with view counts"
    - "Users can fetch video detail including their own progress and reaction"
    - "Hero video endpoint returns the featured video for banner"
  artifacts:
    - path: "src/app/api/video-categories/route.ts"
      provides: "GET (list categories) and POST (admin create category)"
      exports: ["GET", "POST"]
    - path: "src/app/api/videos/route.ts"
      provides: "GET (list videos with filters) and POST (admin create video)"
      exports: ["GET", "POST"]
    - path: "src/app/api/videos/[id]/route.ts"
      provides: "GET (video detail), PUT (admin update), DELETE (admin delete)"
      exports: ["GET", "PUT", "DELETE"]
  key_links:
    - from: "src/app/api/videos/route.ts"
      to: "Video, VideoCategory models"
      via: "Sequelize queries with category includes"
      pattern: "Video\\.findAll|VideoCategory\\.findAll"
    - from: "src/app/api/videos/[id]/route.ts"
      to: "VideoProgress, VideoReaction"
      via: "Include user-specific progress and reaction in detail"
      pattern: "VideoProgress\\.findOne|VideoReaction\\.findOne"
---

<objective>
Build the video library and categories CRUD API — admin can manage categories and videos, authenticated users can browse the video library grouped by category with hero banner support.

Purpose: Powers the Netflix-style video library frontend with category rows, hero banner, and video detail pages.
Output: Video categories API + Video CRUD/listing API with admin and user perspectives.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-01-SUMMARY.md

Follow existing API patterns:
@src/app/api/categories/route.ts (for category CRUD pattern)
@src/app/api/posts/route.ts (for content listing with includes)
@src/app/api/daily-posts/route.ts (for content detail with user-specific data)
@src/lib/auth/middleware.ts (withAuth, withAdmin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Video categories API</name>
  <files>
    src/app/api/video-categories/route.ts
    src/app/api/video-categories/[id]/route.ts
  </files>
  <action>
    Create GET /api/video-categories (withOptionalAuth — public for browse):
    1. Return all active categories ordered by sort_order
    2. Include video count per category (COUNT of published videos)
    3. Response: { categories: [{ id, name, slug, description, sort_order, video_count }] }

    Create POST /api/video-categories (withAdmin):
    1. Validate with Zod: { name: string().max(100), slug: string().max(100).optional(), description: string().max(500).optional(), sort_order: number().int().optional() }
    2. Auto-generate slug from name if not provided (lowercase, hyphens, no special chars)
    3. Check slug uniqueness (409 if taken)
    4. Create VideoCategory record
    5. Return 201 with created category

    Create PUT /api/video-categories/[id] (withAdmin):
    1. Validate with Zod: partial of create fields
    2. Find category by ID (404 if not found)
    3. If slug changed, check uniqueness
    4. Update and return

    Create DELETE /api/video-categories/[id] (withAdmin):
    1. Check no videos are in this category (400 if videos exist — must reassign first)
    2. Hard delete the category
    3. Return 200
  </action>
  <verify>curl GET /api/video-categories returns categories. curl POST with admin token creates category. DELETE on category with videos returns 400.</verify>
  <done>Video categories CRUD works for admins; public listing returns categories with video counts</done>
</task>

<task type="auto">
  <name>Task 2: Video listing, detail, and CRUD API</name>
  <files>
    src/app/api/videos/route.ts
    src/app/api/videos/[id]/route.ts
    src/app/api/videos/hero/route.ts
  </files>
  <action>
    Create GET /api/videos (withAuth):
    1. Query params: ?category_id (optional), ?limit (default 20), ?cursor (for pagination)
    2. If no category_id: return videos grouped by category for Netflix-style layout:
       - For each active category: top N videos ordered by view_count DESC
       - Also return "Continue Watching" row: videos where user has VideoProgress with completed=false, ordered by most recently updated
       - Response: { categories: [{ id, name, slug, videos: [...] }], continue_watching: [...] }
    3. If category_id provided: paginated list of videos in that category ordered by view_count DESC
    4. Each video includes: id, title, description, thumbnail_url, duration_seconds, view_count, published, created_at
    5. Only return published=true videos for non-admin users

    Create POST /api/videos (withAdmin):
    1. Validate with Zod: { title: string().max(200), description: string().optional(), category_id: number(), video_url: string().url(), duration_seconds: number().int().min(0), thumbnail_url: string().url().optional(), caption_url: string().url().optional(), is_hero: boolean().optional(), published: boolean().optional() }
    2. Verify category_id exists (400 if not)
    3. If is_hero=true, unset is_hero on all other videos (only one hero at a time)
    4. Set uploaded_by to current user ID
    5. Create Video record
    6. Return 201 with created video

    Create GET /api/videos/[id] (withAuth):
    1. Fetch video by ID with category include
    2. Include user's VideoProgress (watched_seconds, last_position, completed) if exists
    3. Include user's VideoReaction if exists
    4. Include reaction counts by type (aggregate query)
    5. Increment view_count (fire-and-forget, don't block response)
    6. Return 404 if not found or not published (unless admin)

    Create PUT /api/videos/[id] (withAdmin):
    1. Partial update of video fields
    2. If is_hero=true, unset on others
    3. Return updated video

    Create DELETE /api/videos/[id] (withAdmin):
    1. Hard delete video (cascades to progress and reactions via FK)
    2. Return 200

    Create GET /api/videos/hero (withAuth):
    1. Find the one video where is_hero=true and published=true
    2. Return it with category info
    3. Return 204 if no hero video set
  </action>
  <verify>GET /api/videos returns grouped categories with videos. GET /api/videos/[id] returns detail with progress/reaction. GET /api/videos/hero returns hero video. POST creates video (admin only).</verify>
  <done>Full video CRUD works for admin. User listing returns Netflix-style grouped data with continue watching. Detail includes user-specific progress and reactions.</done>
</task>

</tasks>

<verification>
1. GET /api/video-categories returns sorted active categories with video counts
2. POST /api/video-categories creates category (admin only)
3. GET /api/videos returns categories with videos + continue_watching row
4. GET /api/videos/[id] returns detail with user progress, reaction, and reaction counts
5. GET /api/videos/hero returns hero video
6. POST /api/videos creates video and enforces single hero
7. All admin endpoints return 403 for non-admins
</verification>

<success_criteria>
- Video categories CRUD API works for admin
- Video listing supports Netflix-style grouped response (categories with videos, continue watching)
- Video detail includes user-specific progress and reaction data
- Hero endpoint returns featured video
- View count incremented on detail fetch
- Published filter enforced for non-admin users
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-04-SUMMARY.md`
</output>
