---
phase: 04-enhanced-content
plan: 07
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/app/api/account/stats/route.ts
  - src/lib/streaks/tracker.ts
  - src/lib/streaks/calculator.ts
autonomous: true

must_haves:
  truths:
    - "User can view account stats: join date, total posts, followers/following count"
    - "Activity streak tracking records qualifying daily activities"
    - "Streak count is accurately calculated as consecutive days with any qualifying activity"
    - "Stats API returns current streak, longest streak, and detailed stats"
  artifacts:
    - path: "src/app/api/account/stats/route.ts"
      provides: "GET endpoint returning user stats including streak data"
      exports: ["GET"]
    - path: "src/lib/streaks/tracker.ts"
      provides: "trackActivity() function to record qualifying activities"
      exports: ["trackActivity"]
    - path: "src/lib/streaks/calculator.ts"
      provides: "calculateStreak() function for consecutive day count"
      exports: ["calculateStreak"]
  key_links:
    - from: "src/lib/streaks/tracker.ts"
      to: "ActivityStreak model"
      via: "Upsert activity record per user per day"
      pattern: "ActivityStreak\\.findOrCreate|upsert"
    - from: "src/app/api/account/stats/route.ts"
      to: "src/lib/streaks/calculator.ts"
      via: "Import and call calculateStreak"
      pattern: "calculateStreak"
---

<objective>
Build activity streak tracking and account stats API — track qualifying daily activities and compute streak counts for the account stats page.

Purpose: Users can see their account stats (join date, posts, followers, activity streaks) on their stats page.
Output: Streak tracker utility, streak calculator, account stats API endpoint.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-02-SUMMARY.md

Follow existing patterns:
@src/app/api/listen-log/route.ts (for activity tracking pattern)
@src/lib/db/models/ActivityStreak.ts (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity streak tracker and calculator utilities</name>
  <files>
    src/lib/streaks/tracker.ts
    src/lib/streaks/calculator.ts
  </files>
  <action>
    Create src/lib/streaks/tracker.ts:
    Export async function trackActivity(userId: number, activityType: ActivityType, timezone: string):
    1. ActivityType = 'daily_view' | 'audio_listen' | 'video_watch' | 'social_activity'
    2. Convert current UTC time to user's timezone using Intl.DateTimeFormat to get the local date string (YYYY-MM-DD format)
    3. Find or create ActivityStreak for (userId, activity_date):
       - If exists: parse existing activities JSON, add activityType if not already present, save
       - If not exists: create with activities = JSON.stringify([activityType])
    4. Return void (fire-and-forget pattern)

    IMPORTANT: Use the user's timezone (from User.timezone column) to determine which "day" an activity belongs to. This prevents the pitfall where a user active at 11pm EST has their activity counted as next day UTC.

    Create src/lib/streaks/calculator.ts:
    Export async function calculateStreak(userId: number, timezone: string): Promise<{ current_streak: number, longest_streak: number, total_active_days: number }>
    1. Fetch all ActivityStreak records for the user, ordered by activity_date DESC
    2. Get today's date in user's timezone
    3. Current streak: count consecutive days backwards from today (or yesterday if today has no activity yet)
       - Start from today's date. If record exists for today, count it and go back
       - If no record for today, start from yesterday
       - Walk backwards day by day, counting consecutive records
       - Break on first gap
    4. Longest streak: iterate through all records chronologically, track max consecutive run
    5. Total active days: simply the count of ActivityStreak records
    6. Return { current_streak, longest_streak, total_active_days }
  </action>
  <verify>Unit test: create ActivityStreak records for 5 consecutive days, call calculateStreak → current_streak=5. Skip a day, current_streak=0 (or starts from most recent run).</verify>
  <done>Streak tracker records activities per user per day with timezone awareness. Calculator computes current/longest streaks from activity records.</done>
</task>

<task type="auto">
  <name>Task 2: Account stats API endpoint + integrate streak tracking</name>
  <files>
    src/app/api/account/stats/route.ts
  </files>
  <action>
    Create GET /api/account/stats (withAuth):
    1. Fetch user from DB with basic fields
    2. Aggregate stats using Sequelize:
       - join_date: user.created_at
       - total_posts: Post.count({ where: { user_id } })
       - followers_count: Follow.count({ where: { following_id: user_id, status: 'accepted' } })
       - following_count: Follow.count({ where: { follower_id: user_id, status: 'accepted' } })
       - content_mode: user.mode
       - total_reactions_given: PostReaction.count({ where: { user_id } }) + VideoReaction.count({ where: { user_id } })
       - total_comments: PostComment.count({ where: { user_id } })
       - total_prayers: PrayerSupport.count({ where: { user_id } })
    3. Call calculateStreak(user_id, user.timezone) for streak data
    4. Return 200 with structured response:
    ```json
    {
      "account": {
        "join_date": "2026-01-15",
        "email": "user@example.com",
        "content_mode": "bible"
      },
      "activity": {
        "total_posts": 42,
        "total_comments": 128,
        "total_reactions_given": 256,
        "total_prayers": 15,
        "followers_count": 89,
        "following_count": 67
      },
      "streak": {
        "current_streak": 7,
        "longest_streak": 14,
        "total_active_days": 45
      }
    }
    ```

    Also: Integrate trackActivity() calls into existing API routes (fire-and-forget):
    - GET /api/daily-posts (daily_view): Add trackActivity call when user views daily post
    - POST /api/listen-log (audio_listen): Track when completed=true
    - PUT /api/videos/[id]/progress (video_watch): Track when completed=true or watched_seconds > duration_seconds * 0.75
    - POST /api/post-reactions, POST /api/post-comments, POST /api/prayer-requests, POST /api/posts (social_activity): Track on any social action

    IMPORTANT: trackActivity calls must be fire-and-forget (don't await, wrap in try/catch). They should NEVER block or fail the main request.
  </action>
  <verify>GET /api/account/stats returns full stats with streak data. View daily post → streak tracker records 'daily_view'. Complete a video → records 'video_watch'.</verify>
  <done>Account stats API returns comprehensive stats with streak data. Qualifying activities are tracked across all relevant endpoints.</done>
</task>

</tasks>

<verification>
1. GET /api/account/stats returns join date, post/follower counts, streak data
2. Streak calculation handles timezone correctly
3. trackActivity records activities per user per day without duplicates
4. Viewing daily post triggers daily_view tracking
5. Completing audio triggers audio_listen tracking
6. Watching majority of video triggers video_watch tracking
7. Social actions trigger social_activity tracking
8. All tracking calls are fire-and-forget (never block main request)
</verification>

<success_criteria>
- Account stats API returns structured data (account info, activity counts, streak)
- Streak calculation is timezone-aware (user's timezone for day boundaries)
- Current streak counts consecutive days backwards from today
- Activity tracking integrated into daily-post, listen-log, video progress, and social endpoints
- All tracking is fire-and-forget (non-blocking)
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-07-SUMMARY.md`
</output>
