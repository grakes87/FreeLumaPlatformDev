---
phase: 04-enhanced-content
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/auth/change-email/route.ts
  - src/app/api/auth/verify-email-change/route.ts
  - src/app/api/auth/change-password/route.ts
  - src/app/api/auth/link-provider/route.ts
  - src/app/api/auth/unlink-provider/route.ts
  - src/lib/email/templates.ts
autonomous: true

must_haves:
  truths:
    - "User can request email change and receives verification link at new email address"
    - "User can confirm email change by clicking verification link, switching their login email"
    - "User can change password with current password confirmation"
    - "Security alert email sent to old email on email change and on password change"
    - "User can link additional OAuth provider to existing account"
    - "User can unlink OAuth provider only if they have a password set"
  artifacts:
    - path: "src/app/api/auth/change-email/route.ts"
      provides: "POST endpoint to initiate email change with verification"
      exports: ["POST"]
    - path: "src/app/api/auth/verify-email-change/route.ts"
      provides: "GET endpoint to confirm email change via token"
      exports: ["GET"]
    - path: "src/app/api/auth/change-password/route.ts"
      provides: "POST endpoint for password change with current password confirmation"
      exports: ["POST"]
    - path: "src/app/api/auth/link-provider/route.ts"
      provides: "POST endpoint to link OAuth provider to existing account"
      exports: ["POST"]
    - path: "src/app/api/auth/unlink-provider/route.ts"
      provides: "POST endpoint to unlink OAuth provider (requires password set)"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/auth/change-email/route.ts"
      to: "src/lib/auth/jwt.ts"
      via: "Purpose-scoped JWT with purpose='email_change'"
      pattern: "purpose.*email_change"
    - from: "src/app/api/auth/change-password/route.ts"
      to: "src/lib/email/templates.ts"
      via: "Security alert email on password change"
      pattern: "sendSecurityAlert|passwordChanged"
---

<objective>
Build account credential management APIs — email change with new-email verification, password change with security alerts, and OAuth provider linking/unlinking.

Purpose: Users need to manage their account credentials (email, password, connected OAuth accounts) from settings.
Output: 5 new API routes for email change, password change, and OAuth provider management + email templates.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md

Follow existing auth patterns:
@src/app/api/auth/send-verification/route.ts (for purpose-scoped JWT email token pattern)
@src/app/api/auth/verify-email/route.ts (for token verification pattern)
@src/app/api/auth/reset-password/route.ts (for password change pattern)
@src/lib/auth/jwt.ts (for SignJWT/verifyJWT)
@src/lib/auth/password.ts (for bcryptjs hash/compare)
@src/lib/auth/middleware.ts (for withAuth)
@src/lib/email/templates.ts (for email template pattern)
@src/app/api/auth/google/route.ts (for Google OAuth verification pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email change API with verification flow</name>
  <files>
    src/app/api/auth/change-email/route.ts
    src/app/api/auth/verify-email-change/route.ts
    src/lib/email/templates.ts
  </files>
  <action>
    Create POST /api/auth/change-email (protected with withAuth):
    1. Validate input with Zod: { new_email: string().email() }
    2. Check new_email is not same as current email (400 if same)
    3. Check new_email not already taken by another user (409 if taken)
    4. Generate purpose-scoped JWT: { id: user.id, old_email: user.email, new_email, purpose: 'email_change' } with 24h expiry
    5. Send verification email to NEW email address with link: ${APP_URL}/api/auth/verify-email-change?token=...
    6. Return 200 with message "Verification email sent to new address"

    Create GET /api/auth/verify-email-change:
    1. Extract token from query params
    2. Verify JWT, check purpose === 'email_change'
    3. Verify user still exists and current email matches old_email in token (guard against race condition)
    4. Update user.email to new_email, set email_verified = true
    5. Send security alert email to OLD email: "Your email was changed to [new_email]. If this wasn't you, contact support."
    6. Redirect to /settings?email_changed=true (or return success page)

    Add email templates to src/lib/email/templates.ts:
    - emailChangeVerification(newEmail, verifyUrl): "Verify your new email address" template
    - emailChangeAlert(oldEmail, newEmail): "Your email address was changed" security alert
    - passwordChangeAlert(email): "Your password was changed" security alert (for Task 2)

    Follow existing template patterns (HTML email with styling, text fallback).
  </action>
  <verify>Test with curl: POST /api/auth/change-email with valid new email returns 200. Check console for verification email (dev mode). GET /api/auth/verify-email-change with valid token updates email.</verify>
  <done>Email change flow works: request sends verification to new email, confirmation updates email and sends security alert to old email</done>
</task>

<task type="auto">
  <name>Task 2: Password change + OAuth provider link/unlink APIs</name>
  <files>
    src/app/api/auth/change-password/route.ts
    src/app/api/auth/link-provider/route.ts
    src/app/api/auth/unlink-provider/route.ts
  </files>
  <action>
    Create POST /api/auth/change-password (protected with withAuth):
    1. Validate with Zod: { current_password: string(), new_password: string().min(8) }
    2. Fetch user from DB with password_hash
    3. Verify current_password against password_hash with bcrypt.compare (401 if wrong)
    4. If user has no password_hash (OAuth-only), return 400 "Set a password first"
    5. Hash new_password with bcryptjs (12 rounds)
    6. Update user.password_hash
    7. Send security alert email: "Your password was changed. If this wasn't you, contact support."
    8. Return 200 { message: "Password changed successfully" }

    Create POST /api/auth/link-provider (protected with withAuth):
    1. Validate with Zod: { provider: enum('google', 'apple'), token: string() }
    2. Verify the OAuth token server-side (reuse existing google.ts/apple.ts verification functions)
    3. Extract provider_id (google_id or apple_id) from verified token
    4. Check if provider_id already linked to another user (409 if so)
    5. Update current user: set google_id or apple_id to the verified provider_id
    6. Return 200 { message: "Provider linked successfully", provider }

    Create POST /api/auth/unlink-provider (protected with withAuth):
    1. Validate with Zod: { provider: enum('google', 'apple') }
    2. Fetch user with password_hash, google_id, apple_id
    3. Check user has a password set (password_hash not null) — if no password, return 400 "Cannot unlink: you need a password to sign in"
    4. Check the provider is actually linked (400 if not)
    5. If unlinking would leave no auth method (no password AND no other provider), return 400 "Cannot unlink: no other sign-in method available"
    6. Set google_id or apple_id to null
    7. Return 200 { message: "Provider unlinked successfully" }
  </action>
  <verify>Test password change with curl (current + new password). Test link-provider with mock token. Test unlink-provider refuses if no password set.</verify>
  <done>Password change works with current password confirmation and security alert. Provider linking/unlinking works with lockout prevention.</done>
</task>

</tasks>

<verification>
1. POST /api/auth/change-email sends verification to new email
2. GET /api/auth/verify-email-change updates email and sends security alert
3. POST /api/auth/change-password requires current password, sends security alert
4. POST /api/auth/link-provider verifies token and links provider
5. POST /api/auth/unlink-provider refuses if no password set
6. All endpoints return proper error codes (400, 401, 409)
</verification>

<success_criteria>
- Email change: verify-new-first flow with purpose-scoped JWT, security alert to old email
- Password change: requires current password, sends security alert email
- Provider link: verifies OAuth token, prevents duplicate linking
- Provider unlink: prevents lockout (requires password or alternative provider)
- All routes protected with withAuth
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-03-SUMMARY.md`
</output>
