---
phase: 04-enhanced-content
plan: 12
type: execute
wave: 3
depends_on: ["04-03", "04-06", "04-07"]
files_modified:
  - src/app/(app)/settings/page.tsx
  - src/components/settings/AccountSection.tsx
  - src/components/settings/StatsPage.tsx
  - src/components/settings/SecuritySection.tsx
  - src/components/settings/ConnectedAccountsSection.tsx
  - src/components/settings/DangerZone.tsx
autonomous: true

must_haves:
  truths:
    - "User can view account stats (join date, posts, followers, streaks)"
    - "User can change email with verification flow"
    - "User can change password with current password confirmation"
    - "User can link/unlink OAuth providers"
    - "User can deactivate account from settings"
    - "User can request account deletion from Danger Zone"
  artifacts:
    - path: "src/components/settings/StatsPage.tsx"
      provides: "Card-based stats display with streaks"
    - path: "src/components/settings/SecuritySection.tsx"
      provides: "Email change and password change forms"
    - path: "src/components/settings/ConnectedAccountsSection.tsx"
      provides: "OAuth provider management (link/unlink)"
    - path: "src/components/settings/DangerZone.tsx"
      provides: "Account deactivation and deletion with confirmations"
  key_links:
    - from: "src/components/settings/SecuritySection.tsx"
      to: "/api/auth/change-email, /api/auth/change-password"
      via: "Form submissions to change credential APIs"
      pattern: "change-email|change-password"
    - from: "src/components/settings/DangerZone.tsx"
      to: "/api/account/deactivate, /api/account/delete"
      via: "Confirmation dialogs triggering account actions"
      pattern: "deactivate|delete"
---

<objective>
Build the account lifecycle settings UI — stats page with streaks, email/password change forms, connected accounts management, and account deactivation/deletion in Danger Zone.

Purpose: Users manage their account credentials, view stats, and control account status from settings.
Output: Extended settings page with account stats, security section, connected accounts, and danger zone.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-03-SUMMARY.md
@.planning/phases/04-enhanced-content/04-06-SUMMARY.md
@.planning/phases/04-enhanced-content/04-07-SUMMARY.md

Follow existing patterns:
@src/app/(app)/settings/page.tsx (existing settings page to extend)
@src/components/ui/ (Button, Input, Card, Modal from UI library)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Account stats page with streak cards</name>
  <files>
    src/components/settings/StatsPage.tsx
    src/app/(app)/settings/page.tsx
  </files>
  <action>
    Create StatsPage component:
    - Fetch data from GET /api/account/stats
    - Card-based layout with 3 cards:

    1. Account Info card:
       - Join date (formatted: "Member since February 2026")
       - Email address
       - Content mode badge (Bible/Positivity)

    2. Activity card:
       - Total posts count
       - Total comments count
       - Total reactions given
       - Total prayers count
       - Followers / Following counts
       - Display as a grid of stat items (icon + number + label)

    3. Streak card:
       - Current streak with flame icon (prominent large number)
       - "day streak" label below
       - Longest streak (smaller text)
       - Total active days (smaller text)
       - Visual indicator: streak calendar dots or simple bar graph of recent 7 days

    - Loading state with card skeletons
    - Use cn() for Tailwind classes, dark mode variants
    - Responsive: cards stack vertically on mobile

    Extend settings page:
    - Add "Account Stats" navigation item that links to the stats view
    - Can be implemented as a new section in settings or a sub-page
    - Use the existing settings page layout/navigation pattern
  </action>
  <verify>Navigate to settings → stats. Three cards render with real data. Streak shows correct count. Loading skeleton shows while fetching.</verify>
  <done>Stats page shows account info, activity counts, and streak data in card layout.</done>
</task>

<task type="auto">
  <name>Task 2: Security section (email/password) + connected accounts</name>
  <files>
    src/components/settings/SecuritySection.tsx
    src/components/settings/ConnectedAccountsSection.tsx
  </files>
  <action>
    Create SecuritySection component:
    1. Email change form:
       - Show current email (read-only display)
       - Input for new email
       - Submit button: "Change Email"
       - On submit: POST /api/auth/change-email with { new_email }
       - Success: show message "Verification email sent to [new_email]. Check your inbox."
       - Error handling: 409 (email taken), 400 (invalid email)

    2. Password change form:
       - Current password input
       - New password input
       - Confirm new password input (client-side match check)
       - Submit button: "Change Password"
       - On submit: POST /api/auth/change-password with { current_password, new_password }
       - Success: show success toast "Password changed successfully"
       - Error handling: 401 (wrong current password), validation errors

    Create ConnectedAccountsSection component:
    1. List connected providers:
       - Google: show "Connected" with email or "Not connected" with "Link" button
       - Apple: show "Connected" or "Not connected" with "Link" button
       - Fetch current user data to check google_id / apple_id presence
    2. Link button: triggers the OAuth flow (reuse existing GoogleButton/AppleButton but call /api/auth/link-provider)
    3. Unlink button: POST /api/auth/unlink-provider with { provider }
       - If 400 (no password): show warning "You need to set a password before unlinking"
    4. Visual: list of provider rows with icon, name, status, action button

    Add both sections to the settings page in an "Account" or "Security" section group.
  </action>
  <verify>Email change form submits and shows verification message. Password change form validates and submits. Connected accounts shows link/unlink status. Unlink prevented when no password set.</verify>
  <done>Security section handles email and password changes. Connected accounts shows provider status with link/unlink functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Danger Zone (deactivation + deletion)</name>
  <files>
    src/components/settings/DangerZone.tsx
    src/app/(app)/settings/page.tsx
  </files>
  <action>
    Create DangerZone component:
    - Visual: Red-bordered section at bottom of settings, clearly marked "Danger Zone"
    - Two options:

    1. Deactivate Account:
       - Description: "Temporarily deactivate your account. Your profile will show as deactivated. You can reactivate anytime by logging back in."
       - Button: "Deactivate Account" (yellow/warning style)
       - On tap: show Modal confirmation dialog
         - Title: "Deactivate Account?"
         - Body: "Your account will be deactivated immediately. You can reactivate by logging in again."
         - Buttons: "Cancel" and "Deactivate" (red)
       - On confirm: POST /api/account/deactivate → redirect to login page

    2. Delete Account:
       - Description: "Permanently delete your account. After 30 days, all your data will be permanently removed. You can cancel by logging in within 30 days."
       - Button: "Delete Account" (red/danger style, buried below deactivate)
       - On tap: show Modal with password confirmation
         - Title: "Delete Account Permanently?"
         - Body: "This will schedule your account for permanent deletion in 30 days. All your content will be anonymized. Enter your password to confirm."
         - Password input field
         - Buttons: "Cancel" and "Delete My Account" (red)
       - On confirm: POST /api/account/delete with { password } → redirect to login page

    Add DangerZone to settings page:
    - Place at the very bottom of settings
    - Separated from other sections with a divider
    - Use a collapsible/accordion pattern: "Account Management" header that expands to show danger zone (keeps it "buried deeper" per CONTEXT)
  </action>
  <verify>Danger zone appears at bottom of settings. Deactivate shows confirmation, calls API, redirects to login. Delete shows password confirmation, calls API, redirects to login.</verify>
  <done>Danger zone has deactivation (simple confirm) and deletion (password confirm) with proper modals and redirects.</done>
</task>

</tasks>

<verification>
1. Stats page shows account info, activity counts, and streak with correct data
2. Email change form sends verification and shows confirmation message
3. Password change form requires current password and shows success
4. Connected accounts shows Google/Apple status with link/unlink
5. Unlink prevented when no password set (shows warning)
6. Deactivate account: confirm → API → logout → redirect
7. Delete account: password confirm → API → logout → redirect
8. Danger zone is visually separated and buried in settings
</verification>

<success_criteria>
- Stats page has 3 cards (account info, activity, streaks) with real data
- Email change initiates verification flow with success message
- Password change validates current password and changes with security alert
- Connected accounts shows provider status with link/unlink (lockout prevention)
- Danger zone has deactivate (confirm dialog) and delete (password confirm dialog)
- All actions provide appropriate feedback and redirect on success
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-12-SUMMARY.md`
</output>
