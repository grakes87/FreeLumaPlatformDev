---
phase: 04-enhanced-content
plan: 05
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/api/videos/[id]/progress/route.ts
  - src/app/api/video-reactions/route.ts
  - src/app/api/chat/conversations/[id]/messages/route.ts
autonomous: true

must_haves:
  truths:
    - "User can save video progress (resume position) and it persists across sessions"
    - "User can react to videos with same 6 types as posts (toggle on/off)"
    - "User can share a video to a DM conversation"
    - "Video reaction counts are accurately tracked"
  artifacts:
    - path: "src/app/api/videos/[id]/progress/route.ts"
      provides: "PUT endpoint for saving watch progress with idempotent upsert"
      exports: ["PUT"]
    - path: "src/app/api/video-reactions/route.ts"
      provides: "POST endpoint for toggling video reaction"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/videos/[id]/progress/route.ts"
      to: "VideoProgress model"
      via: "findOne + upsert pattern from ListenLog"
      pattern: "VideoProgress\\.findOne.*findOrCreate|upsert"
    - from: "src/app/api/video-reactions/route.ts"
      to: "VideoReaction model"
      via: "Toggle pattern from PostReaction"
      pattern: "VideoReaction\\.findOne.*destroy|create"
---

<objective>
Build video engagement APIs — progress tracking (resume playback), reactions (same 6 types as posts), and share-to-chat functionality.

Purpose: Enables resume playback, social reactions on videos, and sharing videos in DM conversations.
Output: Progress save API, reaction toggle API, share-to-chat extension.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-enhanced-content/04-RESEARCH.md
@.planning/phases/04-enhanced-content/04-01-SUMMARY.md

Follow existing patterns:
@src/app/api/listen-log/route.ts (for progress upsert pattern)
@src/app/api/post-reactions/route.ts (for reaction toggle pattern)
@src/app/api/chat/conversations/[id]/messages/route.ts (for message creation with shared content)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Video progress tracking + reaction toggle APIs</name>
  <files>
    src/app/api/videos/[id]/progress/route.ts
    src/app/api/video-reactions/route.ts
  </files>
  <action>
    Create PUT /api/videos/[id]/progress (withAuth):
    1. Validate with Zod: { watched_seconds: number().int().min(0), duration_seconds: number().int().min(0), last_position: number().int().min(0), completed: boolean().optional() }
    2. Extract video_id from route params
    3. Verify video exists (404 if not)
    4. Follow the ListenLog idempotent upsert pattern exactly:
       - Find existing VideoProgress by (user_id, video_id)
       - If exists: update watched_seconds (take max), always update last_position, set completed=true if provided and not already completed
       - If not exists: create new VideoProgress record
    5. Return 200 with updated progress: { watched_seconds, last_position, completed, duration_seconds }

    Create POST /api/video-reactions/route.ts (withAuth):
    1. Validate with Zod: { video_id: number(), type: enum('like','love','haha','wow','sad','pray') }
    2. Verify video exists (404 if not)
    3. Follow the PostReaction toggle pattern:
       - Find existing VideoReaction by (user_id, video_id)
       - If exists and same type: destroy (toggle off) → return { action: 'removed' }
       - If exists and different type: update type → return { action: 'changed', type }
       - If not exists: create → return { action: 'added', type }
    4. Return 200 with { action, type?, reaction_counts } where reaction_counts is aggregate by type for that video
  </action>
  <verify>PUT /api/videos/1/progress saves and returns progress. Calling again with higher watched_seconds updates. POST /api/video-reactions toggles reaction and returns counts.</verify>
  <done>Video progress saves with idempotent upsert (resume works). Video reaction toggle works with accurate count aggregation.</done>
</task>

<task type="auto">
  <name>Task 2: Share video to chat conversation</name>
  <files>
    src/app/api/chat/conversations/[id]/messages/route.ts
  </files>
  <action>
    Extend the existing POST /api/chat/conversations/[id]/messages to support shared_video type:
    1. Add 'shared_video' to the existing message type validation (alongside text, image, video, audio, shared_post)
    2. When type='shared_video': validate body includes { shared_video_id: number() }
    3. Verify the video exists and is published (400 if not)
    4. Create message with type='shared_video' and shared_video_id set
    5. When fetching messages (GET), include the shared video data (title, thumbnail_url, duration_seconds) when shared_video_id is present:
       - Add conditional include: if message has shared_video_id, eager-load the Video with select fields (id, title, thumbnail_url, duration_seconds)

    IMPORTANT: Only modify the existing messages route to handle the new type. Do NOT create a separate endpoint.

    Also update the GET messages handler to include Video association when shared_video_id is populated:
    - Add a conditional include for Video model on the message query
    - Or use a post-query enrichment (fetch video data for messages that have shared_video_id)
  </action>
  <verify>POST a message with type='shared_video' and shared_video_id. GET messages returns the shared video with title and thumbnail.</verify>
  <done>Shared video messages work in chat: create with video reference, display with video metadata on fetch.</done>
</task>

</tasks>

<verification>
1. PUT /api/videos/[id]/progress saves progress with idempotent upsert
2. Subsequent PUT calls update only max watched_seconds and always update last_position
3. POST /api/video-reactions toggles reactions (add, change type, remove)
4. Reaction counts returned are accurate aggregates
5. Chat messages support shared_video type with video metadata on fetch
</verification>

<success_criteria>
- Video progress tracking follows ListenLog upsert pattern (cumulative watched, always-update position)
- Video reactions use same 6 types as posts with toggle behavior
- Share-to-chat creates message with shared video reference
- GET messages includes video metadata for shared_video messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-content/04-05-SUMMARY.md`
</output>
