---
phase: 05-workshops
plan: 07
type: execute
wave: 3
depends_on: [05-01, 05-03]
files_modified:
  - src/app/api/workshops/[id]/attendees/route.ts
  - src/app/api/workshops/[id]/attendees/[userId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Host can view the full attendee list for their workshop"
    - "Host can manage attendees: mute, remove, promote to co-host"
  artifacts:
    - path: "src/app/api/workshops/[id]/attendees/route.ts"
      provides: "Attendee list endpoint"
      exports: ["GET"]
    - path: "src/app/api/workshops/[id]/attendees/[userId]/route.ts"
      provides: "Attendee management endpoint"
      exports: ["PUT", "DELETE"]
  key_links:
    - from: "src/app/api/workshops/[id]/attendees/route.ts"
      to: "src/lib/db/models/WorkshopAttendee.ts"
      via: "WorkshopAttendee.findAll"
      pattern: "WorkshopAttendee\\.findAll"
---

<objective>
Create attendee management API endpoints for hosts to view and manage workshop participants.

Purpose: Host needs to view and manage attendees — list, promote co-host, approve speakers, remove.
Output: 2 API route files.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-workshops/05-CONTEXT.md
@src/lib/auth/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attendee list and management endpoints</name>
  <files>src/app/api/workshops/[id]/attendees/route.ts, src/app/api/workshops/[id]/attendees/[userId]/route.ts</files>
  <action>
    **Attendee list (attendees/route.ts) — GET (withAuth):**

    Return attendee list for a workshop.

    - Any authenticated user can view attendees for public workshops
    - For private workshops, only host/co-host/invited users
    - Include user info: id, display_name, username, avatar_url, avatar_color
    - Include attendee info: status, joined_at, left_at, is_co_host, can_speak
    - Sort: host first, then co-hosts, then by joined_at
    - Return: { attendees: [...], total: count }

    **Attendee management (attendees/[userId]/route.ts) — PUT, DELETE (withAuth):**

    **PUT** — Update attendee properties (host/co-host only):
    Accept body with optional fields:
    - is_co_host: boolean (promote/demote co-host — host only, not co-host)
    - can_speak: boolean (approve/revoke speaker — host or co-host)

    Validation:
    - Caller must be host (for is_co_host changes) or host/co-host (for can_speak changes)
    - Target user must be in attendee list (WorkshopAttendee exists)
    - Cannot modify yourself (host can't demote self)

    Update WorkshopAttendee for the target userId.
    Return: { attendee: updated }

    NOTE: The actual mute/remove actions are handled via Socket.IO events (05-05). These API endpoints are for persistent state changes (co-host promotion, speaker approval) that need to survive reconnection.

    **DELETE** — Remove attendee (host/co-host only):
    - Validate caller is host or co-host
    - Update WorkshopAttendee: status='left', left_at=NOW()
    - Decrement Workshop.attendee_count
    - Return: { removed: true }
  </action>
  <verify>TypeScript compiles. Attendee list returns proper sorted list. Management validates host/co-host authorization.</verify>
  <done>Attendee list and management endpoints functional with proper authorization levels.</done>
</task>


</tasks>

<verification>
1. GET /api/workshops/[id]/attendees returns sorted attendee list
2. PUT /api/workshops/[id]/attendees/[userId] updates co-host and speaker status
3. DELETE /api/workshops/[id]/attendees/[userId] removes attendee
</verification>

<success_criteria>
- Host can view and manage full attendee list
- Co-host promotion persists to DB (survives reconnection)
- Speaker approval persists to DB
</success_criteria>

<output>
After completion, create `.planning/phases/05-workshops/05-07-SUMMARY.md`
</output>
