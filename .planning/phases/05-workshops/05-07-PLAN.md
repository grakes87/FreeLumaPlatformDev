---
phase: 05-workshops
plan: 07
type: execute
wave: 3
depends_on: [05-01, 05-03]
files_modified:
  - src/app/api/workshops/[id]/attendees/route.ts
  - src/app/api/workshops/[id]/attendees/[userId]/route.ts
  - src/lib/db/migrations/065-extend-notification-enums-workshops.cjs
autonomous: true

must_haves:
  truths:
    - "Host can view the full attendee list for their workshop"
    - "Host can manage attendees: mute, remove, promote to co-host"
    - "Notification types support workshop events"
  artifacts:
    - path: "src/app/api/workshops/[id]/attendees/route.ts"
      provides: "Attendee list endpoint"
      exports: ["GET"]
    - path: "src/app/api/workshops/[id]/attendees/[userId]/route.ts"
      provides: "Attendee management endpoint"
      exports: ["PUT", "DELETE"]
    - path: "src/lib/db/migrations/065-extend-notification-enums-workshops.cjs"
      provides: "Extended notification type ENUM for workshop events"
  key_links:
    - from: "src/app/api/workshops/[id]/attendees/route.ts"
      to: "src/lib/db/models/WorkshopAttendee.ts"
      via: "WorkshopAttendee.findAll"
      pattern: "WorkshopAttendee\\.findAll"
---

<objective>
Create attendee management API endpoints and extend the notification type ENUM to support workshop-specific notification types (reminder, cancelled, invite, recording, etc.).

Purpose: Host needs to view and manage attendees. Workshop notifications need their own types in the ENUM.
Output: 2 API route files + 1 migration.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-workshops/05-CONTEXT.md
@src/lib/auth/middleware.ts
@src/lib/db/migrations/053-extend-notification-enums.cjs
@src/lib/db/models/Notification.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attendee list and management endpoints</name>
  <files>src/app/api/workshops/[id]/attendees/route.ts, src/app/api/workshops/[id]/attendees/[userId]/route.ts</files>
  <action>
    **Attendee list (attendees/route.ts) — GET (withAuth):**

    Return attendee list for a workshop.

    - Any authenticated user can view attendees for public workshops
    - For private workshops, only host/co-host/invited users
    - Include user info: id, display_name, username, avatar_url, avatar_color
    - Include attendee info: status, joined_at, left_at, is_co_host, can_speak
    - Sort: host first, then co-hosts, then by joined_at
    - Return: { attendees: [...], total: count }

    **Attendee management (attendees/[userId]/route.ts) — PUT, DELETE (withAuth):**

    **PUT** — Update attendee properties (host/co-host only):
    Accept body with optional fields:
    - is_co_host: boolean (promote/demote co-host — host only, not co-host)
    - can_speak: boolean (approve/revoke speaker — host or co-host)

    Validation:
    - Caller must be host (for is_co_host changes) or host/co-host (for can_speak changes)
    - Target user must be in attendee list (WorkshopAttendee exists)
    - Cannot modify yourself (host can't demote self)

    Update WorkshopAttendee for the target userId.
    Return: { attendee: updated }

    NOTE: The actual mute/remove actions are handled via Socket.IO events (05-05). These API endpoints are for persistent state changes (co-host promotion, speaker approval) that need to survive reconnection.

    **DELETE** — Remove attendee (host/co-host only):
    - Validate caller is host or co-host
    - Update WorkshopAttendee: status='left', left_at=NOW()
    - Decrement Workshop.attendee_count
    - Return: { removed: true }
  </action>
  <verify>TypeScript compiles. Attendee list returns proper sorted list. Management validates host/co-host authorization.</verify>
  <done>Attendee list and management endpoints functional with proper authorization levels.</done>
</task>

<task type="auto">
  <name>Task 2: Extend notification ENUM for workshop types</name>
  <files>src/lib/db/migrations/065-extend-notification-enums-workshops.cjs</files>
  <action>
    Create migration following the exact pattern from 053-extend-notification-enums.cjs.

    Add new notification types to the `type` ENUM on the `notifications` table:
    - 'workshop_reminder' (1h and 15min before workshop)
    - 'workshop_cancelled' (host cancelled or no-show auto-cancel)
    - 'workshop_invite' (invited to private workshop)
    - 'workshop_recording' (recording available)
    - 'workshop_updated' (host rescheduled or changed details)
    - 'workshop_started' (workshop is now live)

    Use raw SQL ALTER TABLE MODIFY COLUMN to extend the ENUM (same pattern as 053):
    ```sql
    ALTER TABLE notifications MODIFY COLUMN type ENUM(
      'reaction', 'comment', 'follow', 'follow_request', 'follow_accept',
      'prayer_support', 'mention', 'message', 'new_video',
      'content_removed', 'warning', 'ban',
      'workshop_reminder', 'workshop_cancelled', 'workshop_invite',
      'workshop_recording', 'workshop_updated', 'workshop_started'
    ) NOT NULL
    ```

    Include all existing enum values from the current column definition (check the existing column first).

    Also update the Notification.ts model type field to include the new types in its TypeScript type union and Sequelize ENUM.
  </action>
  <verify>Run `npx sequelize-cli db:migrate` — migration succeeds. Notification type ENUM includes workshop types.</verify>
  <done>Notification system supports all workshop-specific notification types.</done>
</task>

</tasks>

<verification>
1. GET /api/workshops/[id]/attendees returns sorted attendee list
2. PUT /api/workshops/[id]/attendees/[userId] updates co-host and speaker status
3. DELETE /api/workshops/[id]/attendees/[userId] removes attendee
4. Notification ENUM extended with 6 workshop types
5. Notification.ts model updated with new types
</verification>

<success_criteria>
- Host can view and manage full attendee list
- Co-host promotion persists to DB (survives reconnection)
- Speaker approval persists to DB
- Notification types support all workshop events
</success_criteria>

<output>
After completion, create `.planning/phases/05-workshops/05-07-SUMMARY.md`
</output>
