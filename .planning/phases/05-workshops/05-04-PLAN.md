---
phase: 05-workshops
plan: 04
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/app/api/workshops/[id]/rsvp/route.ts
  - src/app/api/workshops/[id]/invite/route.ts
  - src/app/api/workshops/[id]/notes/route.ts
  - src/app/api/workshops/series/route.ts
  - src/app/api/workshops/[id]/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "User can RSVP and un-RSVP to a workshop"
    - "Host can invite specific users to private workshops"
    - "User can save and retrieve personal notes for a workshop"
    - "Host can create a recurring workshop series"
    - "Chat history is retrievable for replay"
  artifacts:
    - path: "src/app/api/workshops/[id]/rsvp/route.ts"
      provides: "RSVP toggle endpoint"
      exports: ["POST", "DELETE"]
    - path: "src/app/api/workshops/[id]/invite/route.ts"
      provides: "Workshop invitation endpoint"
      exports: ["POST"]
    - path: "src/app/api/workshops/[id]/notes/route.ts"
      provides: "Personal notes endpoint"
      exports: ["GET", "PUT"]
    - path: "src/app/api/workshops/series/route.ts"
      provides: "Series creation endpoint"
      exports: ["POST", "GET"]
    - path: "src/app/api/workshops/[id]/chat/route.ts"
      provides: "Chat history endpoint for replay"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/workshops/[id]/rsvp/route.ts"
      to: "src/lib/db/models/WorkshopAttendee.ts"
      via: "findOrCreate/destroy"
      pattern: "WorkshopAttendee"
    - from: "src/app/api/workshops/series/route.ts"
      to: "src/lib/workshop/recurrence.ts"
      via: "generateInstancesInTimezone"
      pattern: "generateInstances"
---

<objective>
Create the supporting workshop API routes: RSVP management, user invitations, personal notes, workshop series creation, and chat history retrieval.

Purpose: These endpoints support the detail page RSVP button, private workshop invitations, in-workshop note-taking, recurring series, and recording chat replay.
Output: 5 API route files.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-workshops/05-CONTEXT.md
@.planning/phases/05-workshops/05-RESEARCH.md
@src/lib/auth/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RSVP and invite API endpoints</name>
  <files>src/app/api/workshops/[id]/rsvp/route.ts, src/app/api/workshops/[id]/invite/route.ts</files>
  <action>
    **RSVP route (rsvp/route.ts):**

    **POST** (withAuth) — RSVP to a workshop:
    - Validate workshop exists, status is 'scheduled' (can only RSVP before lobby)
    - If private: check user has WorkshopInvite or is host
    - If max_capacity set: check attendee_count < max_capacity
    - Use findOrCreate on WorkshopAttendee (workshop_id, user_id) with status='rsvp'
    - Increment Workshop.attendee_count (fire-and-forget)
    - Return { rsvp: attendee, action: 'created' | 'existing' }

    **DELETE** (withAuth) — Un-RSVP:
    - Find WorkshopAttendee for this user + workshop
    - If found with status='rsvp', destroy it
    - Decrement Workshop.attendee_count (fire-and-forget)
    - Return { action: 'removed' }
    - If not found, return 404

    **Invite route (invite/route.ts):**

    **POST** (withAuth — host only):
    - Validate caller is host of this workshop (or co-host)
    - Accept body: { userIds: number[] } — array of user IDs to invite
    - Validate each userId exists and is active
    - bulkCreate WorkshopInvite rows (workshop_id, user_id, invited_by)
    - Use ignoreDuplicates to skip already-invited users
    - Send notification to each invited user (fire-and-forget via createNotification, type='workshop_invite')
    - Return { invited: count }
  </action>
  <verify>TypeScript compiles. RSVP creates attendee with proper status. Invite validates host-only access.</verify>
  <done>RSVP toggle and invitation endpoints functional with capacity checks and notifications.</done>
</task>

<task type="auto">
  <name>Task 2: Notes and chat history API endpoints</name>
  <files>src/app/api/workshops/[id]/notes/route.ts, src/app/api/workshops/[id]/chat/route.ts</files>
  <action>
    **Notes route (notes/route.ts):**

    **GET** (withAuth):
    - Find WorkshopNote for this user + workshop (unique pair)
    - If exists, return { note: { content, updated_at } }
    - If not, return { note: null }

    **PUT** (withAuth):
    - Accept body: { content: string } (max 50000 chars)
    - Upsert WorkshopNote (findOrCreate then update, or use upsert pattern)
    - Return { note: { content, updated_at } }
    - This is the auto-save endpoint (called with debounce from the client)

    **Chat history route (chat/route.ts):**

    **GET** (withAuth):
    - Validate workshop exists
    - Return all WorkshopChat messages for this workshop, ordered by offset_ms ASC
    - Include user info: id, display_name, username, avatar_url, avatar_color
    - Paginate with limit/offset for very long workshops (default limit: 500, max: 1000)
    - Return: { messages: [...], total: count }
    - This endpoint is used for chat replay alongside recorded video
  </action>
  <verify>TypeScript compiles. Notes upsert pattern works. Chat returns messages ordered by offset_ms.</verify>
  <done>Notes auto-save and chat replay endpoints functional.</done>
</task>

<task type="auto">
  <name>Task 3: Workshop series API</name>
  <files>src/app/api/workshops/series/route.ts</files>
  <action>
    **GET** (withAuth):
    - List series. Accept `host` filter param.
    - If host param set, filter by host_id
    - Include category info, workshop count, next scheduled instance
    - Return: { series: [...] }

    **POST** (withAuth):
    Create a recurring workshop series.

    Validation (Zod v4):
    - title: string, 3-200 chars, required
    - description: string, max 5000, optional
    - category_id: number, optional
    - frequency: 'daily' | 'weekly' | 'biweekly' | 'monthly', required
    - byDay: string[] optional (e.g. ['MO', 'TU'])
    - count: number optional (total instances, max 52)
    - until: ISO date string optional (end date)
    - time_of_day: string, required, format "HH:MM" (24h)
    - timezone: string, required, valid IANA timezone
    - duration_minutes: number, optional, 15-480
    - is_private: boolean, optional, default false

    On create:
    1. Check user can_host flag
    2. Build RRULE string using recurrence.ts `buildRRuleString(frequency, { byDay, count, until })`
    3. Create WorkshopSeries row
    4. Generate initial instances using `generateInstancesInTimezone(rrule, time_of_day, timezone, now, 90)` for 90-day horizon
    5. Bulk create Workshop rows for each generated date
       - Each inherits title, description, category_id from series
       - Set series_id to the new series
       - Set host_id from user
       - Set scheduled_at from generated dates
       - Set agora_channel after creation (update each with workshop-{id})
    6. Return { series, workshops: generatedWorkshops }
  </action>
  <verify>TypeScript compiles. Series creation generates workshop instances for 90-day horizon. RRULE string built correctly.</verify>
  <done>Workshop series creation generates recurring instances with proper timezone handling.</done>
</task>

</tasks>

<verification>
1. POST /api/workshops/[id]/rsvp creates attendee and increments count
2. DELETE /api/workshops/[id]/rsvp removes attendee and decrements count
3. POST /api/workshops/[id]/invite sends notifications to invited users
4. GET/PUT /api/workshops/[id]/notes upserts personal notes
5. GET /api/workshops/[id]/chat returns time-ordered messages
6. POST /api/workshops/series creates series with generated instances
</verification>

<success_criteria>
- RSVP respects capacity limits and private workshop access
- Invitations send notifications to invited users
- Notes auto-save follows existing upsert pattern
- Chat history returns offset_ms-ordered messages for replay
- Series creation generates correct recurring instances via RRULE
</success_criteria>

<output>
After completion, create `.planning/phases/05-workshops/05-04-SUMMARY.md`
</output>
