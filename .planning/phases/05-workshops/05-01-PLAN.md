---
phase: 05-workshops
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/models/Workshop.ts
  - src/lib/db/models/WorkshopSeries.ts
  - src/lib/db/models/WorkshopCategory.ts
  - src/lib/db/models/WorkshopAttendee.ts
  - src/lib/db/models/WorkshopChat.ts
  - src/lib/db/models/WorkshopNote.ts
  - src/lib/db/models/WorkshopInvite.ts
  - src/lib/db/models/index.ts
  - src/lib/db/migrations/057-create-workshop-categories.cjs
  - src/lib/db/migrations/058-create-workshop-series.cjs
  - src/lib/db/migrations/059-create-workshops.cjs
  - src/lib/db/migrations/060-create-workshop-attendees.cjs
  - src/lib/db/migrations/061-create-workshop-chats.cjs
  - src/lib/db/migrations/062-create-workshop-notes.cjs
  - src/lib/db/migrations/063-create-workshop-invites.cjs
  - src/lib/db/migrations/064-add-can-host-to-users.cjs
  - src/lib/db/migrations/065-extend-notification-enums-workshops.cjs
  - src/lib/db/models/Notification.ts
  - package.json
autonomous: true
user_setup:
  - service: agora
    why: "Live video streaming and cloud recording for workshops"
    env_vars:
      - name: AGORA_APP_ID
        source: "Agora Console -> Project Management -> App ID"
      - name: AGORA_APP_CERTIFICATE
        source: "Agora Console -> Project Management -> App Certificate (enable if needed)"
      - name: AGORA_CUSTOMER_ID
        source: "Agora Console -> RESTful API -> Customer ID"
      - name: AGORA_CUSTOMER_SECRET
        source: "Agora Console -> RESTful API -> Customer Secret"
      - name: NEXT_PUBLIC_AGORA_APP_ID
        source: "Same as AGORA_APP_ID (client-side)"
    dashboard_config:
      - task: "Create project with APP ID"
        location: "Agora Console -> Project Management -> Create"
      - task: "Enable App Certificate"
        location: "Agora Console -> Project Management -> Edit -> App Certificate"
      - task: "Get RESTful API credentials"
        location: "Agora Console -> RESTful API"

must_haves:
  truths:
    - "7 workshop-related database tables exist with correct schema"
    - "All associations between workshop models are defined"
    - "User model has can_host boolean field for host revocation"
    - "agora-rtc-react, agora-token, and rrule npm packages are installed"
    - "Notification type ENUM extended with workshop event types"
  artifacts:
    - path: "src/lib/db/models/Workshop.ts"
      provides: "Workshop model with lifecycle status enum"
      contains: "ENUM('scheduled', 'lobby', 'live', 'ended', 'cancelled')"
    - path: "src/lib/db/models/WorkshopSeries.ts"
      provides: "WorkshopSeries model with rrule string"
      contains: "rrule"
    - path: "src/lib/db/models/WorkshopCategory.ts"
      provides: "WorkshopCategory model"
      contains: "workshop_categories"
    - path: "src/lib/db/models/WorkshopAttendee.ts"
      provides: "WorkshopAttendee model with RSVP/joined/left status"
      contains: "ENUM('rsvp', 'joined', 'left')"
    - path: "src/lib/db/models/index.ts"
      provides: "All workshop model associations and exports"
      contains: "Workshop"
    - path: "src/lib/db/migrations/065-extend-notification-enums-workshops.cjs"
      provides: "Extended notification type ENUM for workshop events"
  key_links:
    - from: "src/lib/db/models/Workshop.ts"
      to: "src/lib/db/models/WorkshopSeries.ts"
      via: "series_id FK"
      pattern: "series_id.*workshop_series"
    - from: "src/lib/db/models/WorkshopAttendee.ts"
      to: "src/lib/db/models/Workshop.ts"
      via: "workshop_id FK"
      pattern: "workshop_id.*workshops"
---

<objective>
Create the database foundation for the workshop system: 7 new Sequelize models with TypeScript interfaces, 9 migrations (7 tables + 1 User column + 1 notification ENUM extension), all associations registered in the model index, and install new npm dependencies (agora-rtc-react, agora-token, rrule).

Purpose: All workshop API and UI code depends on these models and tables existing first. The notification ENUM extension is included here (Wave 1) so later plans that send workshop notifications (e.g., 05-06 recording callback) can use createNotification without ENUM errors.
Output: 7 model files, 9 migration files, updated model index with associations, updated Notification.ts model, updated package.json.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-workshops/05-CONTEXT.md
@.planning/phases/05-workshops/05-RESEARCH.md
@src/lib/db/models/index.ts
@src/lib/db/models/Video.ts
@src/lib/db/models/VideoCategory.ts
@src/lib/db/models/User.ts
@src/lib/db/migrations/056-add-hidden-to-posts-and-comments.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies and add env vars</name>
  <files>package.json, .env.example</files>
  <action>
    Run: `npm install agora-rtc-react agora-token rrule`

    Add to .env.example (do NOT modify .env.local):
    ```
    # Agora (Workshops)
    AGORA_APP_ID=
    AGORA_APP_CERTIFICATE=
    AGORA_CUSTOMER_ID=
    AGORA_CUSTOMER_SECRET=
    NEXT_PUBLIC_AGORA_APP_ID=
    ```
  </action>
  <verify>Check package.json has agora-rtc-react, agora-token, rrule in dependencies. Check .env.example has AGORA vars.</verify>
  <done>Three new npm packages installed and Agora env vars templated.</done>
</task>

<task type="auto">
  <name>Task 2: Create 7 workshop models and 9 migrations</name>
  <files>
    src/lib/db/models/Workshop.ts
    src/lib/db/models/WorkshopSeries.ts
    src/lib/db/models/WorkshopCategory.ts
    src/lib/db/models/WorkshopAttendee.ts
    src/lib/db/models/WorkshopChat.ts
    src/lib/db/models/WorkshopNote.ts
    src/lib/db/models/WorkshopInvite.ts
    src/lib/db/migrations/057-create-workshop-categories.cjs
    src/lib/db/migrations/058-create-workshop-series.cjs
    src/lib/db/migrations/059-create-workshops.cjs
    src/lib/db/migrations/060-create-workshop-attendees.cjs
    src/lib/db/migrations/061-create-workshop-chats.cjs
    src/lib/db/migrations/062-create-workshop-notes.cjs
    src/lib/db/migrations/063-create-workshop-invites.cjs
    src/lib/db/migrations/064-add-can-host-to-users.cjs
    src/lib/db/migrations/065-extend-notification-enums-workshops.cjs
    src/lib/db/models/Notification.ts
  </files>
  <action>
    Create 7 model files following the EXACT pattern from Video.ts / VideoCategory.ts:
    - TypeScript interfaces (Attributes + CreationAttributes with Optional)
    - Model class with `declare` fields
    - `.init()` with sequelize, tableName, timestamps: true, underscored: true

    **WorkshopCategory** (table: workshop_categories):
    - id: INTEGER PK AUTO_INCREMENT
    - name: STRING(100) NOT NULL
    - slug: STRING(100) UNIQUE NOT NULL
    - description: STRING(500) NULLABLE
    - sort_order: INTEGER DEFAULT 0
    - is_active: BOOLEAN DEFAULT true
    - created_at, updated_at: DATE
    Follow VideoCategory pattern exactly.

    **WorkshopSeries** (table: workshop_series):
    - id: INTEGER PK AUTO_INCREMENT
    - host_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE RESTRICT
    - category_id: INTEGER NULLABLE REFERENCES workshop_categories(id)
    - title: STRING(200) NOT NULL
    - description: TEXT NULLABLE
    - rrule: STRING(500) NOT NULL (e.g. "FREQ=WEEKLY;BYDAY=MO")
    - time_of_day: STRING(8) NOT NULL (e.g. "19:00:00" — store as string, not TIME type for Sequelize compatibility)
    - timezone: STRING(50) NOT NULL (IANA timezone e.g. "America/New_York")
    - duration_minutes: INTEGER NULLABLE
    - is_active: BOOLEAN DEFAULT true
    - created_at, updated_at: DATE

    **Workshop** (table: workshops):
    - id: INTEGER PK AUTO_INCREMENT
    - series_id: INTEGER NULLABLE REFERENCES workshop_series(id) ON DELETE SET NULL
    - host_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE RESTRICT
    - category_id: INTEGER NULLABLE REFERENCES workshop_categories(id)
    - title: STRING(200) NOT NULL
    - description: TEXT NULLABLE
    - scheduled_at: DATE NOT NULL
    - duration_minutes: INTEGER NULLABLE (estimated, not enforced)
    - actual_started_at: DATE NULLABLE
    - actual_ended_at: DATE NULLABLE
    - status: ENUM('scheduled', 'lobby', 'live', 'ended', 'cancelled') DEFAULT 'scheduled'
    - is_private: BOOLEAN DEFAULT false
    - max_capacity: INTEGER NULLABLE (null = unlimited)
    - recording_url: STRING(500) NULLABLE
    - recording_sid: STRING(100) NULLABLE
    - recording_resource_id: STRING(200) NULLABLE
    - agora_channel: STRING(100) (generated as "workshop-{id}" at API level)
    - attendee_count: INTEGER DEFAULT 0 (denormalized)
    - created_at, updated_at: DATE
    Indexes: (host_id), (category_id), (status, scheduled_at), (series_id)

    **WorkshopAttendee** (table: workshop_attendees):
    - id: INTEGER PK AUTO_INCREMENT
    - workshop_id: INTEGER NOT NULL REFERENCES workshops(id) ON DELETE CASCADE
    - user_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
    - status: ENUM('rsvp', 'joined', 'left') DEFAULT 'rsvp'
    - joined_at: DATE NULLABLE
    - left_at: DATE NULLABLE
    - is_co_host: BOOLEAN DEFAULT false
    - can_speak: BOOLEAN DEFAULT false
    - created_at, updated_at: DATE
    UNIQUE constraint on (workshop_id, user_id)

    **WorkshopChat** (table: workshop_chats):
    - id: INTEGER PK AUTO_INCREMENT
    - workshop_id: INTEGER NOT NULL REFERENCES workshops(id) ON DELETE CASCADE
    - user_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
    - message: TEXT NOT NULL
    - offset_ms: INTEGER NOT NULL (ms from workshop actual_started_at)
    - created_at: DATE (timestamps: true, updatedAt: false)
    Index: (workshop_id, offset_ms)

    **WorkshopNote** (table: workshop_notes):
    - id: INTEGER PK AUTO_INCREMENT
    - workshop_id: INTEGER NOT NULL REFERENCES workshops(id) ON DELETE CASCADE
    - user_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
    - content: TEXT NULLABLE
    - created_at, updated_at: DATE
    UNIQUE constraint on (workshop_id, user_id)

    **WorkshopInvite** (table: workshop_invites):
    - id: INTEGER PK AUTO_INCREMENT
    - workshop_id: INTEGER NOT NULL REFERENCES workshops(id) ON DELETE CASCADE
    - user_id: INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
    - invited_by: INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
    - created_at: DATE (timestamps: true, updatedAt: false)
    UNIQUE constraint on (workshop_id, user_id)

    Create corresponding .cjs migration files following the exact pattern from existing migrations (e.g., 056-add-hidden-to-posts-and-comments.cjs). Use `queryInterface.createTable()` for new tables and `queryInterface.addColumn()` for the User can_host field.

    **Migration 064-add-can-host-to-users.cjs:**
    Add `can_host` BOOLEAN NOT NULL DEFAULT true to users table. This allows admin to revoke hosting privileges.

    **Migration 065-extend-notification-enums-workshops.cjs:**
    Extend the notification `type` ENUM to include workshop event types. Follow exact pattern from 053-extend-notification-enums.cjs:
    ```sql
    ALTER TABLE notifications MODIFY COLUMN type ENUM(
      'reaction', 'comment', 'follow', 'follow_request', 'follow_accept',
      'prayer_support', 'mention', 'message', 'new_video',
      'content_removed', 'warning', 'ban',
      'workshop_reminder', 'workshop_cancelled', 'workshop_invite',
      'workshop_recording', 'workshop_updated', 'workshop_started'
    ) NOT NULL
    ```
    Include all existing enum values from the current column definition (check the existing column first).

    **Update Notification.ts model:**
    Add the 6 new workshop types to the TypeScript type union and Sequelize ENUM definition in src/lib/db/models/Notification.ts.
  </action>
  <verify>Run `npx sequelize-cli db:migrate` — all 9 migrations should succeed. Check all 7 tables exist with correct columns via `npx sequelize-cli db:migrate:status`. Notification type ENUM includes workshop types.</verify>
  <done>7 workshop tables created with proper schema, indexes, and constraints. User table has can_host column. Notification ENUM extended with 6 workshop types.</done>
</task>

<task type="auto">
  <name>Task 3: Register all associations and exports in model index</name>
  <files>src/lib/db/models/index.ts</files>
  <action>
    Add imports for all 7 new models at top of index.ts.

    Add associations section "---- Phase 5: Workshop Associations ----":

    - WorkshopCategory -> Workshop (one-to-many via category_id)
    - WorkshopSeries -> Workshop (one-to-many via series_id)
    - User -> WorkshopSeries (one-to-many via host_id, as 'workshopSeries')
    - User -> Workshop (one-to-many via host_id, as 'hostedWorkshops')
    - Workshop -> WorkshopAttendee (one-to-many via workshop_id, as 'attendees')
    - User -> WorkshopAttendee (one-to-many via user_id, as 'workshopAttendances')
    - Workshop -> WorkshopChat (one-to-many via workshop_id, as 'chatMessages')
    - User -> WorkshopChat (one-to-many via user_id, as 'workshopChats')
    - Workshop -> WorkshopNote (one-to-many via workshop_id, as 'notes')
    - User -> WorkshopNote (one-to-many via user_id, as 'workshopNotes')
    - Workshop -> WorkshopInvite (one-to-many via workshop_id, as 'invites')
    - User -> WorkshopInvite (one-to-many via user_id, as 'workshopInvites')
    - WorkshopInvite -> User (invited_by, as 'invitedBy')
    - WorkshopCategory -> WorkshopSeries (one-to-many via category_id)

    Add all 7 models to the export block at the bottom.

    Follow the exact association pattern used for Phase 3 and Phase 4 models (hasMany/belongsTo with foreignKey and as alias).
  </action>
  <verify>TypeScript compilation: `npx tsc --noEmit src/lib/db/models/index.ts` or check that `npm run build` doesn't error on model imports. All 7 new models appear in exports.</verify>
  <done>All workshop models imported, associated, and exported from model index. No circular dependency issues.</done>
</task>

</tasks>

<verification>
1. `npm ls agora-rtc-react agora-token rrule` — all three packages listed
2. `npx sequelize-cli db:migrate:status` — all 9 new migrations show as "up"
3. TypeScript compiles without errors on model index
4. All 7 tables exist in MySQL with correct columns and constraints
5. User table has `can_host` boolean column defaulting to true
6. Notification type ENUM includes all 6 workshop types
</verification>

<success_criteria>
- 7 workshop model files with TypeScript interfaces match research schema
- 9 migration files create/modify tables correctly (7 tables + 1 User column + 1 notification ENUM)
- Model index has all associations registered
- npm dependencies installed
- .env.example has Agora env vars
- Notification ENUM ready for all workshop plans that send notifications
</success_criteria>

<output>
After completion, create `.planning/phases/05-workshops/05-01-SUMMARY.md`
</output>
