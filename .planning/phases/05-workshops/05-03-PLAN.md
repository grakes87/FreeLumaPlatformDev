---
phase: 05-workshops
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/app/api/workshops/route.ts
  - src/app/api/workshops/[id]/route.ts
  - src/app/api/workshops/categories/route.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated user can list upcoming workshops with pagination and category filter"
    - "Authenticated user with can_host=true can create a workshop with title, description, schedule, and category"
    - "Authenticated user can view workshop detail with host info and RSVP count"
    - "Host can update workshop details and cancel a workshop"
    - "Admin can CRUD workshop categories"
    - "Private workshops only visible to invited users and host"
  artifacts:
    - path: "src/app/api/workshops/route.ts"
      provides: "GET list + POST create workshop"
      exports: ["GET", "POST"]
    - path: "src/app/api/workshops/[id]/route.ts"
      provides: "GET detail + PUT update + DELETE cancel"
      exports: ["GET", "PUT", "DELETE"]
    - path: "src/app/api/workshops/categories/route.ts"
      provides: "GET list + POST create + PUT update + DELETE categories"
      exports: ["GET", "POST", "PUT", "DELETE"]
  key_links:
    - from: "src/app/api/workshops/route.ts"
      to: "src/lib/db/models/Workshop.ts"
      via: "Workshop.findAll/create"
      pattern: "Workshop\\.(findAll|create)"
    - from: "src/app/api/workshops/[id]/route.ts"
      to: "src/lib/db/models/Workshop.ts"
      via: "Workshop.findByPk"
      pattern: "Workshop\\.findByPk"
---

<objective>
Create the core workshop CRUD API routes: listing workshops with filters, creating workshops, viewing workshop details, updating/cancelling workshops, and admin workshop category management.

Purpose: These endpoints power the workshop browse page, create form, and detail page.
Output: 3 API route files covering workshops CRUD and categories.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-workshops/05-CONTEXT.md
@.planning/phases/05-workshops/05-RESEARCH.md
@src/lib/auth/middleware.ts
@src/app/api/videos/route.ts
@src/app/api/video-categories/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workshop categories API (admin CRUD)</name>
  <files>src/app/api/workshops/categories/route.ts</files>
  <action>
    Follow the EXACT pattern from src/app/api/video-categories/route.ts:

    **GET** (withAuth — any authenticated user):
    - Return all active WorkshopCategory rows sorted by sort_order
    - Include video_count equivalent: workshop_count via Sequelize literal subquery counting workshops WHERE status != 'cancelled'
    - Return: { categories: [...] }

    **POST** (withAdmin):
    - Validate: name (required, 2-100 chars), description (optional, max 500)
    - Auto-generate slug from name (lowercase, replace spaces with hyphens, remove special chars)
    - Set sort_order to MAX(sort_order) + 1
    - Return 201 with created category

    **PUT** (withAdmin):
    - Accept id in request body
    - Validate same fields as POST
    - Update name, description, slug, is_active, sort_order
    - Return updated category

    **DELETE** (withAdmin):
    - Accept id in query params
    - Check no workshops reference this category (or set to null)
    - Delete category
    - Return 204

    Use Zod v4 safeParse for validation. Follow established pattern.
  </action>
  <verify>TypeScript compiles. Category CRUD follows video-categories pattern.</verify>
  <done>Workshop categories API provides full admin CRUD with workshop count aggregation.</done>
</task>

<task type="auto">
  <name>Task 2: Workshop list and create API</name>
  <files>src/app/api/workshops/route.ts</files>
  <action>
    **GET** (withAuth):
    Query upcoming workshops with filters and cursor pagination.

    Parameters:
    - `category`: filter by category_id
    - `status`: filter by status (default: show 'scheduled' + 'lobby' + 'live')
    - `host`: filter by host_id
    - `cursor`: cursor-based pagination (id-based)
    - `limit`: default 20, max 50
    - `past`: if 'true', show ended workshops (for replay/history)
    - `my`: if 'true', show workshops where user is host or RSVP'd

    Query logic:
    - Default: WHERE status IN ('scheduled', 'lobby', 'live') AND scheduled_at >= NOW() ORDER BY scheduled_at ASC
    - If past=true: WHERE status IN ('ended') ORDER BY actual_ended_at DESC
    - If my=true: JOIN workshop_attendees or WHERE host_id = user.id
    - EXCLUDE private workshops UNLESS user is host or has WorkshopInvite
    - Include host User (id, display_name, username, avatar_url, avatar_color)
    - Include WorkshopCategory (id, name, slug)
    - Include attendee_count (denormalized field)
    - Include user's RSVP status if authenticated (subquery or separate lookup)

    Return: { workshops: [...], nextCursor: id | null }

    **POST** (withAuth):
    Create a new workshop. Validate user has can_host=true.

    Validation (Zod v4):
    - title: string, 3-200 chars, required
    - description: string, max 5000 chars, optional
    - category_id: number, optional (must exist if provided)
    - scheduled_at: ISO date string, required, must be >= 15 minutes from now
    - duration_minutes: number, optional, 15-480
    - is_private: boolean, optional, default false
    - max_capacity: number, optional, 2-500

    On create:
    - Check user can_host flag (lazy import User)
    - Check user status is 'active'
    - Validate category_id exists if provided
    - Validate scheduled_at is at least 15 minutes in the future
    - Create Workshop row
    - Set agora_channel to `workshop-${workshop.id}`
    - Update workshop with agora_channel
    - Return 201 with workshop

    Return: { workshop: {...} }
  </action>
  <verify>TypeScript compiles. POST validates 15-min minimum lead time. GET excludes private workshops for non-invited users.</verify>
  <done>Workshop list API supports browse with filters, and create API enforces can_host + 15-min lead time.</done>
</task>

<task type="auto">
  <name>Task 3: Workshop detail, update, and cancel API</name>
  <files>src/app/api/workshops/[id]/route.ts</files>
  <action>
    **GET** (withAuth):
    Return workshop detail by ID.

    Include:
    - Host user info (id, display_name, username, avatar_url, avatar_color, bio)
    - Category info (id, name, slug)
    - Series info if series_id set (id, title, rrule — via WorkshopSeries)
    - attendee_count
    - User's RSVP status (check WorkshopAttendee for current user)
    - User's co-host status
    - Whether recording is available (recording_url not null)
    - is_host flag (host_id === user.id)
    - Next workshop in series (if series_id, find next scheduled instance)

    Access control:
    - If workshop is_private, only host, co-hosts, and invited users can view
    - Return 404 for unauthorized access to private workshops

    Return: { workshop: {...}, userRsvp: { status, is_co_host, can_speak } | null, isHost: boolean }

    **PUT** (withAuth — host only):
    Update workshop details. Only host can edit.

    Validate:
    - User is the host (host_id === user.id)
    - Workshop status is 'scheduled' (can't edit lobby/live/ended/cancelled)
    - Same Zod validation as create (title, description, category_id, scheduled_at, duration_minutes, is_private, max_capacity)
    - scheduled_at must still be >= 15 minutes from now if changed

    On update:
    - Update Workshop row
    - If scheduled_at changed, send notification to all RSVP'd attendees (fire-and-forget via createNotification)

    Return: { workshop: {...} }

    **DELETE** (withAuth — host only):
    Cancel a workshop. Only host can cancel.

    - Validate user is host
    - Set status to 'cancelled'
    - Send cancellation notification to all RSVP'd attendees (fire-and-forget)
    - Return 200 with { cancelled: true }
  </action>
  <verify>TypeScript compiles. PUT validates host-only access. DELETE sends cancellation notifications.</verify>
  <done>Workshop detail, update, and cancel endpoints working with proper authorization.</done>
</task>

</tasks>

<verification>
1. GET /api/workshops returns upcoming workshops with host info and category
2. POST /api/workshops creates workshop with validation
3. GET /api/workshops/[id] returns workshop detail with RSVP status
4. PUT /api/workshops/[id] updates workshop (host only, scheduled only)
5. DELETE /api/workshops/[id] cancels workshop (host only)
6. Workshop categories CRUD works for admin
7. Private workshops hidden from non-invited users
</verification>

<success_criteria>
- All workshop CRUD operations functional
- Category management follows video-categories pattern
- Host-only authorization enforced for edit/cancel
- Private workshop visibility rules enforced
- 15-minute minimum lead time validated on create/edit
</success_criteria>

<output>
After completion, create `.planning/phases/05-workshops/05-03-SUMMARY.md`
</output>
