---
phase: 03-real-time
plan: 08
type: execute
wave: 3
depends_on: ["03-04", "03-05"]
files_modified:
  - src/app/(app)/chat/[conversationId]/page.tsx
  - src/components/chat/ChatView.tsx
  - src/components/chat/MessageBubble.tsx
  - src/components/chat/MessageInput.tsx
  - src/components/chat/TypingIndicator.tsx
  - src/components/chat/MessageContextMenu.tsx
  - src/components/chat/MessageReactionPicker.tsx
  - src/components/chat/SharedPostCard.tsx
  - src/hooks/useChat.ts
  - src/hooks/useMessageStatus.ts
autonomous: true

must_haves:
  truths:
    - "User can view message history with infinite scroll (older messages load on scroll up)"
    - "User can send text messages that appear instantly (optimistic update)"
    - "Messages render as Instagram DM style bubbles with sender avatar"
    - "Typing indicator shows when other user is typing"
    - "Message status shows checkmarks (sent/delivered/read) in 1:1 chats"
    - "Long-press on message opens context menu (Reply, React, Copy, Unsend)"
    - "Swipe right on message quotes the message for reply"
    - "Shared posts render as tappable rich card previews"
  artifacts:
    - path: "src/app/(app)/chat/[conversationId]/page.tsx"
      provides: "Individual chat conversation page"
    - path: "src/components/chat/ChatView.tsx"
      provides: "Main chat interface with message list and input"
    - path: "src/components/chat/MessageBubble.tsx"
      provides: "Individual message rendering with status indicators"
    - path: "src/hooks/useChat.ts"
      provides: "Chat state: messages, send, typing, pagination"
  key_links:
    - from: "src/hooks/useChat.ts"
      to: "/api/chat/conversations/[id]/messages"
      via: "fetch for history + Socket.IO for real-time"
      pattern: "fetch.*messages"
    - from: "src/hooks/useChat.ts"
      to: "src/hooks/useSocket.ts"
      via: "chatSocket for real-time events"
      pattern: "chatSocket.*on.*message:new"
    - from: "src/components/chat/ChatView.tsx"
      to: "src/components/chat/MessageBubble.tsx"
      via: "renders message list"
      pattern: "MessageBubble"
---

<objective>
Build the individual chat conversation view: message history with infinite scroll, real-time message delivery, Instagram DM-style bubbles with status indicators, typing indicator, message context menu (reply/react/copy/unsend), and shared post cards.

Purpose: The core chat experience â€” where users read and send messages in real-time.
Output: Chat page, 7 components, 2 hooks.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-CONTEXT.md (chat interface style, message management)
@.planning/phases/03-real-time/03-04-SUMMARY.md
@.planning/phases/03-real-time/03-05-SUMMARY.md
@src/components/social/PostReactionPicker.tsx (reference for reaction picker pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat hooks (useChat, useMessageStatus)</name>
  <files>
    src/hooks/useChat.ts
    src/hooks/useMessageStatus.ts
  </files>
  <action>
    1. Create `src/hooks/useChat.ts`:
       - Params: conversationId: number
       - State: messages[], loading, hasMore, replyTo (message being replied to)
       - Initial load: GET /api/chat/conversations/[id]/messages (latest 30)
       - Pagination: loadMore() fetches older messages with cursor (scroll-up to load)
       - Real-time via chatSocket:
         - Listen "message:new": prepend to messages list (optimistic already added for own messages)
         - Listen "message:unsent": update message to show "This message was unsent"
         - Listen "message:reaction": update reaction on specific message
         - Listen "messages:read": update message status to 'read' for batch
       - Join conversation room on mount: chatSocket.emit("conversation:join", { conversationId })
       - Leave room on unmount: chatSocket.emit("conversation:leave", { conversationId })
       - sendMessage(content, options): POST /api/chat/conversations/[id]/messages, optimistic insert
       - setReplyTo(message | null): set reply context
       - Cleanup: socket.off() all listeners on unmount
       - Typing: emit "typing:start" on input change (debounced), listen for "typing:start"/"typing:stop" from others
       - Track typingUsers: Map<number, {name, timeout}>

    2. Create `src/hooks/useMessageStatus.ts`:
       - For 1:1 conversations: track sent/delivered/read status per message
       - Status from message data: if MessageStatus exists for recipient with 'read' -> read, 'delivered' -> delivered, else -> sent
       - Real-time: listen for "messages:read" event to update statuses
       - Export: getStatus(messageId): 'sent' | 'delivered' | 'read'
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - useChat returns messages, loading, hasMore, sendMessage, typingUsers
    - useMessageStatus tracks per-message status
  </verify>
  <done>Chat state management hooks ready with real-time updates, pagination, and optimistic sends</done>
</task>

<task type="auto">
  <name>Task 2: Create chat view components</name>
  <files>
    src/app/(app)/chat/[conversationId]/page.tsx
    src/components/chat/ChatView.tsx
    src/components/chat/MessageBubble.tsx
    src/components/chat/MessageInput.tsx
    src/components/chat/TypingIndicator.tsx
    src/components/chat/MessageContextMenu.tsx
    src/components/chat/MessageReactionPicker.tsx
    src/components/chat/SharedPostCard.tsx
  </files>
  <action>
    1. Create `src/components/chat/MessageBubble.tsx`:
       - Props: message, isOwnMessage, onLongPress, onSwipeRight, status?, showAvatar
       - Layout: Instagram DM style
         - Other's messages: avatar on left, bubble on left, light gray bg
         - Own messages: bubble on right, primary/blue bg, white text
       - Content rendering:
         - Text: plain text with line breaks
         - Media: render images/videos inline (tappable to full screen)
         - Voice: waveform visualization + play button + duration
         - Shared post: render SharedPostCard component
       - Reply preview: if reply_to_id, show quoted message above bubble (small, truncated)
       - Reactions: small emoji indicators below bubble (like Instagram)
       - Status indicators (own messages only, 1:1 only):
         - Single gray check: sent
         - Double gray check: delivered
         - Double blue check: read
       - is_unsent messages: show italic "This message was unsent" in muted text
       - Long press handler for context menu
       - Swipe right handler for reply

    2. Create `src/components/chat/MessageInput.tsx`:
       - Input area at bottom of chat
       - Text input (auto-expanding textarea, max 4 lines visible)
       - "+" button on left: opens MediaAttachmentSheet (built in 03-09)
       - Mic button on right: triggers voice recording (built in 03-09)
       - Send button: appears when text is entered (replaces mic button, or shown alongside)
       - Reply preview bar: shown above input when replying to a message (X to cancel)
       - Typing indicator: call onTyping() callback on input change
       - Submit on Enter (mobile: send button tap)
       - Placeholder: "Message..."

    3. Create `src/components/chat/TypingIndicator.tsx`:
       - Shows when other user(s) are typing
       - Animated dots (3 bouncing dots) with user name
       - "Sarah is typing..." for 1:1
       - "Sarah, John are typing..." for group
       - Positioned below message list, above input

    4. Create `src/components/chat/MessageContextMenu.tsx`:
       - Full-screen overlay with blur background
       - Shows selected message centered/highlighted
       - Options: Reply, React, Copy text, Unsend (own messages only)
       - Reply: sets replyTo in useChat
       - React: opens MessageReactionPicker
       - Copy: navigator.clipboard.writeText
       - Unsend: calls API to unsend message
       - Tap outside to close

    5. Create `src/components/chat/MessageReactionPicker.tsx`:
       - Row of 6 emoji reactions (same as posts: like, love, haha, wow, sad, pray)
       - Appears above message context menu
       - Tap to react (calls API then Socket.IO broadcasts)
       - Tap same reaction to remove

    6. Create `src/components/chat/SharedPostCard.tsx`:
       - Compact card preview of a shared post
       - Shows: author avatar + name, text snippet (2 lines), media thumbnail (if any)
       - Tappable: navigates to /post/[id]
       - Styled as a bordered card within the message bubble

    7. Create `src/components/chat/ChatView.tsx`:
       - Main chat container component
       - Props: conversationId, conversationInfo (name, type, participants)
       - Uses useChat hook for message state
       - Message list: scrollable div, reversed (newest at bottom)
       - Scroll to bottom on new message, auto-load older on scroll to top
       - Date separators between message groups ("Today", "Yesterday", "Feb 12")
       - Time grouping: consecutive messages from same sender within 2 min show single avatar
       - MessageInput at bottom
       - TypingIndicator between messages and input

    8. Create `src/app/(app)/chat/[conversationId]/page.tsx`:
       - Full-screen layout: hides bottom nav (per CONTEXT decision)
       - Custom header: back arrow + user avatar + user name (or group name) + online status dot
       - Renders ChatView component
       - Fetch conversation info on mount
       - Mark conversation as read on mount (emit "conversation:read")
       - Handle conversation not found (redirect to /chat)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Chat page renders at /chat/[conversationId]
    - MessageBubble shows both own/other styles with status indicators
    - MessageInput has text area, send button, reply preview
    - Context menu appears on long press with all options
    - Typing indicator animates correctly
  </verify>
  <done>Complete chat conversation UI with message bubbles, input, typing indicator, context menu, reactions, and shared post cards</done>
</task>

</tasks>

<verification>
- Chat conversation page loads and shows message history
- New messages appear in real-time without refresh
- Typing indicator shows when other user types
- Message status checkmarks display correctly (sent/delivered/read)
- Long press opens context menu with Reply/React/Copy/Unsend
- Shared post cards are tappable and navigate to post
- Scroll up loads older messages
- Chat page hides bottom nav for full-screen experience
</verification>

<success_criteria>
Users can open a conversation, view message history, send messages in real-time, see typing indicators, interact with messages via long-press context menu, and view shared post previews.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-08-SUMMARY.md`
</output>
