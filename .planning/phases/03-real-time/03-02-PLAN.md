---
phase: 03-real-time
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/033-create-conversations.cjs
  - src/lib/db/migrations/034-create-conversation-participants.cjs
  - src/lib/db/migrations/035-create-messages.cjs
  - src/lib/db/migrations/036-create-message-media.cjs
  - src/lib/db/migrations/037-create-message-status.cjs
  - src/lib/db/migrations/038-create-message-reactions.cjs
  - src/lib/db/migrations/039-create-message-requests.cjs
  - src/lib/db/models/Conversation.ts
  - src/lib/db/models/ConversationParticipant.ts
  - src/lib/db/models/Message.ts
  - src/lib/db/models/MessageMedia.ts
  - src/lib/db/models/MessageStatus.ts
  - src/lib/db/models/MessageReaction.ts
  - src/lib/db/models/MessageRequest.ts
autonomous: true

must_haves:
  truths:
    - "Conversations table supports both direct and group types with denormalized last_message fields"
    - "Conversation participants track membership, role, and last_read_at for unread calculation"
    - "Messages support text, media, voice, shared_post, and system types with reply threading"
    - "Message status tracks delivered/read per recipient for 1:1 read receipts"
    - "Message reactions use same 6 types as post reactions"
    - "Message requests enable messaging access control with accept/decline flow"
  artifacts:
    - path: "src/lib/db/models/Conversation.ts"
      provides: "Conversation Sequelize model"
      contains: "class Conversation"
    - path: "src/lib/db/models/Message.ts"
      provides: "Message Sequelize model"
      contains: "class Message"
    - path: "src/lib/db/models/ConversationParticipant.ts"
      provides: "ConversationParticipant model with last_read_at"
      contains: "last_read_at"
  key_links:
    - from: "src/lib/db/models/Conversation.ts"
      to: "src/lib/db/models/Message.ts"
      via: "hasMany association"
      pattern: "conversation_id"
    - from: "src/lib/db/models/ConversationParticipant.ts"
      to: "src/lib/db/models/Conversation.ts"
      via: "belongsTo association"
      pattern: "conversation_id"
---

<objective>
Create all chat-related database tables (7 migrations) and Sequelize models with full type definitions. This establishes the data layer for 1:1 and group conversations, messages with media, read receipts, reactions, and message requests.

Purpose: Provide the persistent storage foundation for all chat functionality.
Output: 7 migration files + 7 Sequelize models ready for API routes.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-real-time/03-RESEARCH.md (Database Schema Design section)
@src/lib/db/models/Post.ts (reference for model pattern)
@src/lib/db/models/UserSetting.ts (reference for model pattern)
@src/lib/db/migrations/032-add-is-verified-to-users.cjs (reference for migration pattern — last existing migration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat database migrations (033-039)</name>
  <files>
    src/lib/db/migrations/033-create-conversations.cjs
    src/lib/db/migrations/034-create-conversation-participants.cjs
    src/lib/db/migrations/035-create-messages.cjs
    src/lib/db/migrations/036-create-message-media.cjs
    src/lib/db/migrations/037-create-message-status.cjs
    src/lib/db/migrations/038-create-message-reactions.cjs
    src/lib/db/migrations/039-create-message-requests.cjs
  </files>
  <action>
    Create 7 .cjs migration files following existing migration pattern (module.exports with up/down, queryInterface).

    **033-create-conversations.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - type: ENUM('direct', 'group') NOT NULL DEFAULT 'direct'
    - name: VARCHAR(100) NULL (group name; NULL for direct)
    - avatar_url: VARCHAR(500) NULL (group photo)
    - creator_id: INT NULL, FK -> users(id) ON DELETE SET NULL
    - last_message_id: INT NULL (denormalized, no FK — set after messages created)
    - last_message_at: DATETIME NULL
    - created_at, updated_at: DATETIME NOT NULL
    - Index: idx_conversations_last_message_at on (last_message_at DESC)

    **034-create-conversation-participants.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - conversation_id: INT NOT NULL, FK -> conversations(id) ON DELETE CASCADE
    - user_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - role: ENUM('member', 'admin') NOT NULL DEFAULT 'member'
    - last_read_at: DATETIME NULL
    - deleted_at: DATETIME NULL (soft delete for "delete conversation" per user)
    - joined_at: DATETIME NOT NULL
    - created_at, updated_at: DATETIME NOT NULL
    - Unique: idx_conv_user (conversation_id, user_id)
    - Index: idx_cp_user_id on (user_id)

    **035-create-messages.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - conversation_id: INT NOT NULL, FK -> conversations(id) ON DELETE CASCADE
    - sender_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - type: ENUM('text', 'media', 'voice', 'shared_post', 'system') NOT NULL DEFAULT 'text'
    - content: TEXT NULL (text content; NULL for media-only)
    - reply_to_id: INT NULL, FK -> messages(id) ON DELETE SET NULL
    - shared_post_id: INT NULL, FK -> posts(id) ON DELETE SET NULL
    - is_unsent: BOOLEAN NOT NULL DEFAULT FALSE
    - flagged: BOOLEAN NOT NULL DEFAULT FALSE (profanity flag)
    - created_at, updated_at: DATETIME NOT NULL
    - Index: idx_messages_conv_created on (conversation_id, created_at DESC)
    - Index: idx_messages_sender on (sender_id)

    **036-create-message-media.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - message_id: INT NOT NULL, FK -> messages(id) ON DELETE CASCADE
    - media_url: VARCHAR(500) NOT NULL
    - media_type: ENUM('image', 'video', 'voice') NOT NULL
    - duration: INT NULL (voice message duration in seconds)
    - sort_order: TINYINT NOT NULL DEFAULT 0
    - created_at, updated_at: DATETIME NOT NULL
    - Index: idx_message_media_msg on (message_id)

    **037-create-message-status.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - message_id: INT NOT NULL, FK -> messages(id) ON DELETE CASCADE
    - user_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE (the recipient)
    - status: ENUM('delivered', 'read') NOT NULL DEFAULT 'delivered'
    - status_at: DATETIME NOT NULL
    - Unique: idx_msg_user_status (message_id, user_id)

    **038-create-message-reactions.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - message_id: INT NOT NULL, FK -> messages(id) ON DELETE CASCADE
    - user_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - reaction_type: ENUM('like', 'love', 'haha', 'wow', 'sad', 'pray') NOT NULL
    - created_at, updated_at: DATETIME NOT NULL
    - Unique: idx_msg_reaction_user (message_id, user_id)

    **039-create-message-requests.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - conversation_id: INT NOT NULL, FK -> conversations(id) ON DELETE CASCADE
    - requester_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - recipient_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - status: ENUM('pending', 'accepted', 'declined') NOT NULL DEFAULT 'pending'
    - created_at, updated_at: DATETIME NOT NULL
    - Unique: idx_request_pair (requester_id, recipient_id)

    Run migrations: `npx sequelize-cli db:migrate`
  </action>
  <verify>
    - `npx sequelize-cli db:migrate` succeeds
    - All 7 tables exist in freeluma_dev database
    - Tables have correct columns, indexes, and foreign keys
  </verify>
  <done>All 7 chat tables created with proper schema, indexes, and foreign key constraints</done>
</task>

<task type="auto">
  <name>Task 2: Create Sequelize models and register associations</name>
  <files>
    src/lib/db/models/Conversation.ts
    src/lib/db/models/ConversationParticipant.ts
    src/lib/db/models/Message.ts
    src/lib/db/models/MessageMedia.ts
    src/lib/db/models/MessageStatus.ts
    src/lib/db/models/MessageReaction.ts
    src/lib/db/models/MessageRequest.ts
    src/lib/db/models/index.ts
  </files>
  <action>
    Create 7 Sequelize model files following existing patterns (see Post.ts, UserSetting.ts):
    - Each model has Attributes interface, CreationAttributes (with Optional), class declaration with declare fields
    - Use sequelize from '../index', timestamps: true, underscored: true

    **Conversation.ts:** tableName 'conversations'. Type enum: direct/group.
    **ConversationParticipant.ts:** tableName 'conversation_participants'. Role enum: member/admin. Has last_read_at, deleted_at, joined_at.
    **Message.ts:** tableName 'messages'. Type enum: text/media/voice/shared_post/system. Has content, reply_to_id, shared_post_id, is_unsent, flagged.
    **MessageMedia.ts:** tableName 'message_media'. Media_type enum: image/video/voice. Has duration, sort_order.
    **MessageStatus.ts:** tableName 'message_status'. Status enum: delivered/read. Has status_at. No timestamps (only status_at matters).
    **MessageReaction.ts:** tableName 'message_reactions'. Reaction_type enum matching post reactions.
    **MessageRequest.ts:** tableName 'message_requests'. Status enum: pending/accepted/declined.

    **Update src/lib/db/models/index.ts:**
    - Import all 7 new models
    - Add associations:
      - Conversation hasMany ConversationParticipant (conversation_id), hasMany Message (conversation_id)
      - ConversationParticipant belongsTo Conversation, belongsTo User
      - User hasMany ConversationParticipant (user_id)
      - Message belongsTo Conversation, belongsTo User (sender_id)
      - Message hasMany MessageMedia, hasMany MessageStatus, hasMany MessageReaction
      - Message belongsTo Message (reply_to_id, as 'replyTo'), hasMany Message (reply_to_id, as 'replies')
      - Message belongsTo Post (shared_post_id, as 'sharedPost')
      - MessageMedia belongsTo Message
      - MessageStatus belongsTo Message, belongsTo User
      - MessageReaction belongsTo Message, belongsTo User
      - MessageRequest belongsTo Conversation, belongsTo User (requester_id), belongsTo User (recipient_id)
      - Conversation belongsTo User (creator_id, as 'creator')
    - Export all 7 models
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All models exported from index.ts
    - Associations properly defined (check no circular dependency issues)
  </verify>
  <done>7 Sequelize models with full TypeScript types and associations registered in index.ts</done>
</task>

</tasks>

<verification>
- All 7 migrations run successfully
- All 7 models compile without TypeScript errors
- Models are exported from src/lib/db/models/index.ts
- Associations connect conversations -> participants -> users, messages -> media, etc.
- Database tables match the schema from 03-RESEARCH.md
</verification>

<success_criteria>
Complete chat data layer: 7 tables created in MySQL, 7 Sequelize models with TypeScript interfaces, all associations registered. Ready for API routes to query.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-02-SUMMARY.md`
</output>
