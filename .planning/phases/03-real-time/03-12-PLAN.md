---
phase: 03-real-time
plan: 12
type: execute
wave: 4
depends_on: ["03-06", "03-03"]
files_modified:
  - src/lib/email/templates.ts
  - src/lib/email/queue.ts
  - src/lib/email/scheduler.ts
  - src/lib/email/tracking.ts
  - src/app/api/email/unsubscribe/route.ts
  - src/app/api/email/track/route.ts
  - server.js
autonomous: true

must_haves:
  truths:
    - "Unread DM emails batch per sender after 15 minutes"
    - "Daily content reminder email sent at user's configured time"
    - "Follow request and prayer response emails sent promptly"
    - "Max 3-5 emails per hour per user enforced"
    - "Quiet hours queue emails for delivery after end"
    - "One-click unsubscribe link in each email footer"
    - "Email tracking pixel records opens"
    - "Branded HTML emails with FreeLuma logo"
    - "node-cron jobs initialized on server startup"
  artifacts:
    - path: "src/lib/email/scheduler.ts"
      provides: "Cron job initialization for email processing"
      exports: ["initEmailScheduler"]
    - path: "src/lib/email/queue.ts"
      provides: "Email batching, throttling, quiet hours logic"
      exports: ["queueEmail", "processDMEmailBatch", "processDailyReminders"]
    - path: "src/lib/email/templates.ts"
      provides: "HTML email templates for all notification types"
    - path: "src/app/api/email/unsubscribe/route.ts"
      provides: "One-click email unsubscribe endpoint"
  key_links:
    - from: "src/lib/email/scheduler.ts"
      to: "src/lib/email/queue.ts"
      via: "cron jobs call queue processing functions"
      pattern: "processDMEmailBatch|processDailyReminders"
    - from: "server.js"
      to: "src/lib/email/scheduler.ts"
      via: "initEmailScheduler() called on startup"
      pattern: "initEmailScheduler"
    - from: "src/lib/email/templates.ts"
      to: "src/lib/email/index.ts"
      via: "existing sendEmail function"
      pattern: "sendEmail"
---

<objective>
Build the email notification system: branded HTML email templates, batching/throttling queue, cron-based scheduler, tracking pixel, and one-click unsubscribe. Emails send for unread DMs (batched), follow requests, prayer responses, and daily content reminders.

Purpose: Ensure offline users are notified of important events via email, with proper rate limiting and user control.
Output: Email queue, scheduler, templates, tracking, unsubscribe endpoint.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-CONTEXT.md (email notification strategy)
@.planning/phases/03-real-time/03-RESEARCH.md (Email Notification Queue, Pitfall 6)
@.planning/phases/03-real-time/03-03-SUMMARY.md
@.planning/phases/03-real-time/03-06-SUMMARY.md
@src/lib/email/index.ts (existing sendEmail)
@src/lib/email/templates.ts (existing email templates)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email templates and tracking</name>
  <files>
    src/lib/email/templates.ts (update)
    src/lib/email/tracking.ts
    src/app/api/email/track/route.ts
    src/app/api/email/unsubscribe/route.ts
  </files>
  <action>
    1. Update `src/lib/email/templates.ts`:
       - Add new template functions (keep existing templates, add new ones):
       - **dmBatchEmail(params)**: "You have {count} unread messages from {senderName}"
         - Params: recipientName, senderName, messageCount, messagePreview (~100 chars), conversationUrl
         - Branded HTML layout: FreeLuma logo, brand colors, mobile-responsive
         - CTA button: "Reply in app" linking to conversationUrl
         - Footer: unsubscribe link (per-category), FreeLuma branding
       - **followRequestEmail(params)**: "{actorName} wants to follow you"
         - Params: recipientName, actorName, actorAvatarUrl, profileUrl
         - CTA: "View Request" linking to profile or notifications
       - **prayerResponseEmail(params)**: "{actorName} prayed for your request"
         - Params: recipientName, actorName, prayerTitle (truncated), prayerUrl
         - CTA: "View Prayer Request"
       - **dailyReminderEmail(params)**: "Your daily inspiration is ready"
         - Params: recipientName, verseText, verseReference, dailyUrl
         - Show the actual verse/quote text in the email body
         - CTA: "Read More"
       - All templates include:
         - Tracking pixel: `<img src="{baseUrl}/api/email/track?id={trackingId}" width="1" height="1" />`
         - Unsubscribe link: `<a href="{baseUrl}/api/email/unsubscribe?token={token}&category={category}">Unsubscribe</a>`
         - List-Unsubscribe header for RFC 8058 compliance

    2. Create `src/lib/email/tracking.ts`:
       - generateTrackingId(): create UUID for tracking pixel
       - Functions to update EmailLog status: markSent, markBounced, markOpened

    3. Create `src/app/api/email/track/route.ts`:
       - GET handler (no auth — tracking pixels are loaded by email clients)
       - Query param: id (tracking UUID)
       - Look up EmailLog by tracking_id, update status to 'opened', set opened_at
       - Return 1x1 transparent GIF image (Content-Type: image/gif)

    4. Create `src/app/api/email/unsubscribe/route.ts`:
       - GET handler (no auth — clicked from email links)
       - Query params: token (signed JWT with userId + category), category
       - Verify token (use existing verifyJWT with purpose scope)
       - Update UserSetting: set email_{category}_notifications = false
       - Show simple HTML page: "You've been unsubscribed from {category} emails. [Re-subscribe link]"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Email templates render branded HTML
    - Tracking endpoint returns 1x1 GIF
    - Unsubscribe endpoint disables category
  </verify>
  <done>Branded email templates with tracking pixels and one-click unsubscribe for all notification categories</done>
</task>

<task type="auto">
  <name>Task 2: Create email queue, scheduler, and integrate with server</name>
  <files>
    src/lib/email/queue.ts
    src/lib/email/scheduler.ts
    server.js (update)
  </files>
  <action>
    1. Create `src/lib/email/queue.ts`:
       - **queueEmail(params)**: Create EmailLog entry with status 'queued', check throttling
         - Check email_logs for emails sent to this user in last hour
         - If count >= 5, skip (return null) — rate limiting
         - Check quiet hours: if current time in user's timezone is within quiet hours, skip (will be picked up next cycle)
       - **processDMEmailBatch()**: called by cron every 5 minutes
         - Find conversations with unread messages older than 15 minutes
         - For each: check if user is offline (not in presenceManager), has email_dm_notifications enabled
         - Group by sender: "You have X unread messages from Y"
         - Check if a DM email was already sent recently for this sender (avoid re-sending)
         - Send email, create EmailLog, update tracking
       - **processDailyReminders()**: called by cron at top of each hour
         - Find users whose daily_reminder_time matches current hour in their reminder_timezone
         - Check email_daily_reminder setting enabled
         - Fetch today's daily content
         - Send daily reminder email with verse/quote text
       - **cleanupOldNotifications()**: called by cron daily at 3 AM
         - Delete notifications older than 30 days
         - Delete email_logs older than 90 days
       - **processFollowRequestEmail(userId, actorId)**: called directly from createNotification
         - Check user email_follow_notifications setting
         - Check rate limit and quiet hours
         - Send immediately (not batched)
       - **processPrayerResponseEmail(userId, actorId, prayerRequestId)**: called from createNotification
         - Check user email_prayer_notifications setting
         - Send immediately

    2. Create `src/lib/email/scheduler.ts`:
       - Import node-cron
       - Export function initEmailScheduler():
         - Schedule DM batch: every 5 minutes ("*/5 * * * *")
         - Schedule daily reminders: top of each hour ("0 * * * *")
         - Schedule cleanup: daily at 3 AM ("0 3 * * *")
         - Log: "[Email Scheduler] Cron jobs initialized"
       - Guard against multiple initializations (flag check)

    3. Update `server.js`:
       - After Socket.IO initialization, call initEmailScheduler()
       - Import dynamically or invoke via globalThis pattern
       - Since server.js is plain JS and scheduler is TS, store initEmailScheduler on globalThis from the lib code and call from server.js
       - OR: have the scheduler auto-initialize when first imported (self-registering pattern)
       - Simplest: add to server.js startup sequence after httpServer.listen()
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Email scheduler initializes cron jobs on server start
    - DM batch processing finds unread conversations
    - Daily reminder matches user timezone
    - Rate limiting enforces 5 emails/hour cap
    - Quiet hours suppress emails
  </verify>
  <done>Email notification queue with batching, throttling, quiet hours, cron scheduler integrated with server startup</done>
</task>

</tasks>

<verification>
- Email templates render with tracking pixels and unsubscribe links
- DM emails batch per sender after 15 minute delay
- Daily reminders sent at user's configured time
- Rate limiting prevents email flooding
- Quiet hours queue emails for later
- Tracking pixel records opens
- Unsubscribe disables per-category
- Cron jobs start on server startup
</verification>

<success_criteria>
Complete email notification system: branded emails for DMs, follows, prayers, and daily reminders with proper batching, throttling, quiet hours, tracking, and user control via unsubscribe.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-12-SUMMARY.md`
</output>
