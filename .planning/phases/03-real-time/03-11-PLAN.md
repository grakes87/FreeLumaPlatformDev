---
phase: 03-real-time
plan: 11
type: execute
wave: 4
depends_on: ["03-07", "03-08"]
files_modified:
  - src/components/chat/GroupInfoSheet.tsx
  - src/components/chat/GroupCreateFlow.tsx
  - src/components/chat/MentionPicker.tsx
  - src/app/api/chat/conversations/[id]/route.ts
  - src/app/api/chat/conversations/[id]/participants/route.ts
  - src/app/api/upload/chat-media/route.ts
autonomous: true

must_haves:
  truths:
    - "Creator can create group chat with name and selected followers"
    - "Group info sheet shows name, member count, and member list"
    - "Creator can add/remove members and change group name/photo"
    - "Members can leave group voluntarily"
    - "@mentions trigger member picker and create notifications"
    - "Group messages show sender name above bubble"
    - "Max 256 members enforced"
  artifacts:
    - path: "src/components/chat/GroupInfoSheet.tsx"
      provides: "Group info overlay with member list and admin actions"
    - path: "src/components/chat/GroupCreateFlow.tsx"
      provides: "Multi-step group creation (name, photo, members)"
    - path: "src/components/chat/MentionPicker.tsx"
      provides: "@mention member selection dropdown"
  key_links:
    - from: "src/components/chat/GroupCreateFlow.tsx"
      to: "/api/chat/conversations"
      via: "POST to create group conversation"
      pattern: "type.*group"
    - from: "src/components/chat/MentionPicker.tsx"
      to: "src/lib/notifications/create.ts"
      via: "@mention triggers notification"
      pattern: "mention"
---

<objective>
Build group chat features: group creation flow, group info sheet with admin controls, @mention picker for tagging members, and group-specific message display (sender name above bubbles).

Purpose: Enable multi-person group conversations with admin management and @mentions.
Output: 3 components + API route updates.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-CONTEXT.md (group chat decisions)
@.planning/phases/03-real-time/03-07-SUMMARY.md
@.planning/phases/03-real-time/03-08-SUMMARY.md
@src/components/chat/UserPicker.tsx
@src/components/chat/ChatView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create group creation flow and info sheet</name>
  <files>
    src/components/chat/GroupCreateFlow.tsx
    src/components/chat/GroupInfoSheet.tsx
  </files>
  <action>
    1. Create `src/components/chat/GroupCreateFlow.tsx`:
       - Full-screen overlay (createPortal)
       - Step 1: Group name input + optional group photo upload
         - Name: required, max 100 chars
         - Photo: tap avatar circle to upload (uses chat-media upload endpoint)
       - Step 2: Select members from followers
         - Reuse UserPicker component in multi-select mode
         - Show selected members as chips/tags at top
         - Max 256 members (show counter)
         - Search to filter followers
       - "Create" button: POST /api/chat/conversations with type: 'group'
       - On success: navigate to /chat/[conversationId]
       - Back/Cancel navigation

    2. Create `src/components/chat/GroupInfoSheet.tsx`:
       - Bottom sheet or full-screen overlay
       - Accessible from chat header (tap group name/avatar)
       - Shows:
         - Group avatar + name (editable by creator)
         - Member count
         - Member list with avatars (tappable to navigate to profile)
         - Online status dots on member avatars
       - Creator (admin) actions:
         - Edit group name (inline edit)
         - Change group photo
         - Add members (opens UserPicker filtered to followers)
         - Remove member (swipe left on member item, or long-press)
       - All member actions:
         - Leave group button (red, with confirmation)
       - Leave creates system message: "[Name] left the group"

    3. Update group-related API handling:
       - Ensure PUT /api/chat/conversations/[id] handles:
         - Update name (creator only)
         - Update avatar_url (creator only)
       - Ensure POST /api/chat/conversations/[id]/participants validates:
         - Only creator can add
         - Added user must be in creator's followers
         - Max 256 members
       - System messages: when member added/removed/left, create Message with type: 'system'
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GroupCreateFlow creates group via API
    - GroupInfoSheet shows member list with admin controls
    - System messages created for member changes
  </verify>
  <done>Group creation flow with member selection, info sheet with admin controls, system messages for membership changes</done>
</task>

<task type="auto">
  <name>Task 2: Create @mention picker and group message display</name>
  <files>
    src/components/chat/MentionPicker.tsx
    src/components/chat/MessageBubble.tsx (update)
    src/components/chat/MessageInput.tsx (update)
  </files>
  <action>
    1. Create `src/components/chat/MentionPicker.tsx`:
       - Dropdown that appears above input when user types "@"
       - Shows group members filtered by text after "@"
       - Each item: avatar + display_name + username
       - Tap to insert mention: replaces "@text" with "@display_name" (styled differently in input)
       - Position: anchored above the cursor position or above input area
       - Dismiss on outside tap or Escape
       - Only shown in group conversations

    2. Update `src/components/chat/MessageInput.tsx`:
       - Detect "@" character in input
       - If in group conversation, show MentionPicker
       - Pass group member list as prop
       - On mention select: insert display name, store mentioned userId for notification
       - When sending message with mentions: include mentioned_user_ids in POST body

    3. Update `src/components/chat/MessageBubble.tsx` for group conversations:
       - Show sender display_name above bubble (in lighter text)
       - Only show name when sender changes from previous message (grouping)
       - Highlight @mentions in message text (bold or different color)
       - Sender avatar shown on left for all group messages (not just alternating)

    4. Update message API (if needed):
       - POST /api/chat/conversations/[id]/messages: if mentioned_user_ids provided, create notifications for each mentioned user
       - Use createNotification with type: 'mention', entity_type: 'message'
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - MentionPicker appears when typing "@" in group chat
    - Group messages show sender name above bubble
    - @mentions highlighted in message text
    - Mentioned users receive notifications
  </verify>
  <done>@mention picker with member filtering, group message sender names, mention notifications</done>
</task>

</tasks>

<verification>
- Group creation works with name, photo, and member selection
- Group info sheet shows all members with admin controls
- Creator can add/remove members
- Members can leave group
- @mentions trigger member picker and notifications
- Group messages show sender names
- System messages appear for member changes
- Max 256 members enforced
</verification>

<success_criteria>
Full group chat functionality: creation flow, member management, @mentions with notifications, and proper group message display with sender names.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-11-SUMMARY.md`
</output>
