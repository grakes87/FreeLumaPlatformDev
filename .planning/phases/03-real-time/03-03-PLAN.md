---
phase: 03-real-time
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/040-create-notifications.cjs
  - src/lib/db/migrations/041-create-email-logs.cjs
  - src/lib/db/migrations/042-add-messaging-notification-prefs-to-user-settings.cjs
  - src/lib/db/models/Notification.ts
  - src/lib/db/models/EmailLog.ts
  - src/lib/db/models/UserSetting.ts
  - src/lib/db/models/index.ts
  - src/lib/notifications/types.ts
autonomous: true

must_haves:
  truths:
    - "Notifications table stores all notification types with group_key for collapsing"
    - "Email logs table tracks email delivery status (queued, sent, bounced, opened)"
    - "UserSetting model extended with messaging_access and per-category email toggles"
    - "NotificationType enum covers all notification categories"
  artifacts:
    - path: "src/lib/db/models/Notification.ts"
      provides: "Notification Sequelize model with group_key support"
      contains: "class Notification"
    - path: "src/lib/db/models/EmailLog.ts"
      provides: "EmailLog Sequelize model for tracking"
      contains: "class EmailLog"
    - path: "src/lib/notifications/types.ts"
      provides: "NotificationType enum and payload interfaces"
      exports: ["NotificationType"]
  key_links:
    - from: "src/lib/db/models/Notification.ts"
      to: "src/lib/db/models/User.ts"
      via: "recipient_id and actor_id FKs"
      pattern: "recipient_id"
    - from: "src/lib/db/models/UserSetting.ts"
      to: "messaging_access column"
      via: "migration 042 adds new columns"
      pattern: "messaging_access"
---

<objective>
Create notification and email log database tables, Sequelize models, extend UserSetting with messaging access and notification preference columns, and define notification type constants.

Purpose: Establish the data layer for the notification system and email tracking, plus user preferences for messaging access control.
Output: 2 new tables, 2 new models, updated UserSetting model, notification type definitions.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-RESEARCH.md (Database Schema Design section)
@src/lib/db/models/UserSetting.ts
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification/email migrations and user_settings extension</name>
  <files>
    src/lib/db/migrations/040-create-notifications.cjs
    src/lib/db/migrations/041-create-email-logs.cjs
    src/lib/db/migrations/042-add-messaging-notification-prefs-to-user-settings.cjs
  </files>
  <action>
    **040-create-notifications.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - recipient_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - actor_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - type: ENUM('follow', 'follow_request', 'reaction', 'comment', 'prayer', 'message', 'mention', 'group_invite', 'daily_reminder') NOT NULL
    - entity_type: ENUM('post', 'comment', 'follow', 'prayer_request', 'message', 'conversation', 'daily_content') NOT NULL
    - entity_id: INT NOT NULL
    - preview_text: VARCHAR(200) NULL
    - group_key: VARCHAR(100) NULL (for collapsing: "reaction:post:123")
    - is_read: BOOLEAN NOT NULL DEFAULT FALSE
    - created_at, updated_at: DATETIME NOT NULL
    - Index: idx_notif_recipient_read on (recipient_id, is_read, created_at DESC)
    - Index: idx_notif_group_key on (group_key, recipient_id)
    - Index: idx_notif_created_at on (created_at) â€” for 30-day cleanup

    **041-create-email-logs.cjs:**
    - id: INT AUTO_INCREMENT PRIMARY KEY
    - recipient_id: INT NOT NULL, FK -> users(id) ON DELETE CASCADE
    - email_type: ENUM('dm_batch', 'follow_request', 'prayer_response', 'daily_reminder') NOT NULL
    - subject: VARCHAR(255) NOT NULL
    - status: ENUM('queued', 'sent', 'bounced', 'opened') NOT NULL DEFAULT 'queued'
    - sent_at: DATETIME NULL
    - opened_at: DATETIME NULL
    - tracking_id: VARCHAR(100) NULL (UUID for tracking pixel)
    - created_at, updated_at: DATETIME NOT NULL
    - Index: idx_email_log_status on (status, created_at)
    - Index: idx_email_log_tracking on (tracking_id)

    **042-add-messaging-notification-prefs-to-user-settings.cjs:**
    Add columns to existing user_settings table:
    - messaging_access: ENUM('everyone', 'followers', 'mutual', 'nobody') NOT NULL DEFAULT 'mutual'
    - email_dm_notifications: BOOLEAN NOT NULL DEFAULT TRUE
    - email_follow_notifications: BOOLEAN NOT NULL DEFAULT TRUE
    - email_prayer_notifications: BOOLEAN NOT NULL DEFAULT TRUE
    - email_daily_reminder: BOOLEAN NOT NULL DEFAULT TRUE
    - reminder_timezone: VARCHAR(50) NULL DEFAULT NULL (IANA timezone for daily reminder)

    Down migration: remove the added columns.

    Run: `npx sequelize-cli db:migrate`
  </action>
  <verify>
    - `npx sequelize-cli db:migrate` succeeds
    - notifications and email_logs tables exist
    - user_settings table has new columns (messaging_access, email_*_notifications, reminder_timezone)
  </verify>
  <done>Notification, email_logs tables created; user_settings extended with messaging access and notification preferences</done>
</task>

<task type="auto">
  <name>Task 2: Create Sequelize models, notification types, update UserSetting</name>
  <files>
    src/lib/db/models/Notification.ts
    src/lib/db/models/EmailLog.ts
    src/lib/db/models/UserSetting.ts
    src/lib/db/models/index.ts
    src/lib/notifications/types.ts
  </files>
  <action>
    1. Create `src/lib/notifications/types.ts`:
       - Export enum NotificationType with values: follow, follow_request, reaction, comment, prayer, message, mention, group_invite, daily_reminder
       - Export enum NotificationEntityType: post, comment, follow, prayer_request, message, conversation, daily_content
       - Export interface NotificationPayload: { id, recipient_id, actor_id, type, entity_type, entity_id, preview_text?, group_key?, is_read, created_at, actor?: { id, display_name, username, avatar_url, avatar_color } }

    2. Create `src/lib/db/models/Notification.ts`:
       - Follow existing model pattern
       - All fields from migration 040
       - tableName: 'notifications', timestamps: true, underscored: true

    3. Create `src/lib/db/models/EmailLog.ts`:
       - All fields from migration 041
       - tableName: 'email_logs', timestamps: true, underscored: true

    4. Update `src/lib/db/models/UserSetting.ts`:
       - Add to UserSettingAttributes interface:
         - messaging_access: 'everyone' | 'followers' | 'mutual' | 'nobody'
         - email_dm_notifications: boolean
         - email_follow_notifications: boolean
         - email_prayer_notifications: boolean
         - email_daily_reminder: boolean
         - reminder_timezone: string | null
       - Add to Optional list in CreationAttributes
       - Add declare fields in class
       - Add column definitions in init():
         - messaging_access: ENUM with default 'mutual'
         - email_dm_notifications: BOOLEAN default true
         - email_follow_notifications: BOOLEAN default true
         - email_prayer_notifications: BOOLEAN default true
         - email_daily_reminder: BOOLEAN default true
         - reminder_timezone: STRING(50), allowNull: true

    5. Update `src/lib/db/models/index.ts`:
       - Import Notification, EmailLog
       - Add associations:
         - User hasMany Notification (recipient_id, as 'notifications')
         - Notification belongsTo User (recipient_id, as 'recipient')
         - User hasMany Notification (actor_id, as 'actedNotifications')
         - Notification belongsTo User (actor_id, as 'actor')
         - User hasMany EmailLog (recipient_id, as 'emailLogs')
         - EmailLog belongsTo User (recipient_id, as 'recipient')
       - Export Notification, EmailLog
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Notification and EmailLog models exported from index.ts
    - UserSetting has new fields in TypeScript interface
    - NotificationType enum exported from types.ts
  </verify>
  <done>Notification and EmailLog models created, UserSetting extended, notification types defined</done>
</task>

</tasks>

<verification>
- All 3 migrations run successfully
- Notification and EmailLog models compile and are exported
- UserSetting has messaging_access, email preference columns
- NotificationType enum covers all 9 notification categories
</verification>

<success_criteria>
Complete notification/email data layer with proper models, types, and user preference columns ready for the notification creation service and email scheduler.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-03-SUMMARY.md`
</output>
