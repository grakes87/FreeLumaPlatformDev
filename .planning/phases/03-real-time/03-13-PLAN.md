---
phase: 03-real-time
plan: 13
type: execute
wave: 4
depends_on: ["03-07", "03-08", "03-10"]
files_modified:
  - src/components/layout/TopBar.tsx
  - src/components/layout/AppShell.tsx
  - src/components/layout/BottomNav.tsx
  - src/app/(app)/layout.tsx
  - src/app/(app)/settings/page.tsx
  - src/app/(app)/chat/[conversationId]/page.tsx
  - src/components/profile/ProfileHeader.tsx
autonomous: true

must_haves:
  truths:
    - "Chat icon in TopBar with separate red dot badge for unread messages"
    - "Bell icon in TopBar with red dot badge for unread notifications"
    - "SocketProvider wraps authenticated layout"
    - "NotificationProvider wraps authenticated layout"
    - "NotificationToastManager renders globally for real-time toasts"
    - "Chat view hides bottom nav for full-screen experience"
    - "Settings page includes notification preferences section"
    - "Block behavior hides chat conversations bidirectionally"
    - "Profile shows message button (respects messaging access setting)"
    - "Online status dots appear on avatars in conversation list"
  artifacts:
    - path: "src/components/layout/TopBar.tsx"
      provides: "Updated TopBar with chat icon and notification badges"
    - path: "src/app/(app)/layout.tsx"
      provides: "App layout with SocketProvider and NotificationProvider"
    - path: "src/app/(app)/settings/page.tsx"
      provides: "Settings page with notification preferences section"
  key_links:
    - from: "src/app/(app)/layout.tsx"
      to: "src/context/SocketContext.tsx"
      via: "SocketProvider wrapping children"
      pattern: "SocketProvider"
    - from: "src/app/(app)/layout.tsx"
      to: "src/context/NotificationContext.tsx"
      via: "NotificationProvider wrapping children"
      pattern: "NotificationProvider"
    - from: "src/components/layout/TopBar.tsx"
      to: "src/components/notifications/NotificationDropdown.tsx"
      via: "renders dropdown on bell click"
      pattern: "NotificationDropdown"
---

<objective>
Integrate all Phase 3 features into the existing app: add chat icon to TopBar, wire up Socket.IO and notification providers in the app layout, add notification preferences to settings, implement block behavior in chat, update profile with message button, and ensure chat view properly hides bottom nav.

Purpose: Connect all the isolated Phase 3 components into a cohesive, working real-time experience within the existing app.
Output: Updated layout, TopBar, settings, profile, and chat integration.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-CONTEXT.md
@.planning/phases/03-real-time/03-07-SUMMARY.md
@.planning/phases/03-real-time/03-08-SUMMARY.md
@.planning/phases/03-real-time/03-10-SUMMARY.md
@src/components/layout/TopBar.tsx
@src/components/layout/AppShell.tsx
@src/components/layout/BottomNav.tsx
@src/app/(app)/layout.tsx
@src/app/(app)/settings/page.tsx
@src/components/profile/ProfileHeader.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire providers and update TopBar with chat icon + badges</name>
  <files>
    src/app/(app)/layout.tsx
    src/components/layout/TopBar.tsx
    src/components/layout/AppShell.tsx
    src/components/notifications/NotificationToast.tsx
  </files>
  <action>
    1. Update `src/app/(app)/layout.tsx`:
       - Wrap children with SocketProvider (from src/context/SocketContext.tsx)
       - Wrap children with NotificationProvider (from src/context/NotificationContext.tsx)
       - Nesting order: AuthProvider > SocketProvider > NotificationProvider > children
       - Add NotificationToastManager component at the layout level (renders globally)

    2. Update `src/components/layout/TopBar.tsx`:
       - Add chat icon (MessageCircle from lucide-react) to the right of the logo area, before bell
       - Order: [Logo] ... [Chat icon] [Language] [Bell icon]
       - Chat icon: tappable, navigates to /chat
       - Chat badge: red dot (not count) when unread messages exist
         - Get unread status from useConversations hook or a lightweight /api/chat/unread-count endpoint
       - Bell badge: red dot when unread notifications exist
         - Get unread count from NotificationContext
       - Replace existing placeholder notification dropdown with NotificationDropdown component
       - Both badges are independent (separate red dots)
       - Transparent mode: white icon color, colored dots still visible

    3. Update `src/components/layout/AppShell.tsx`:
       - Detect when on /chat/[conversationId] route (conversation view)
       - Hide BottomNav and adjust padding when in chat conversation view
       - The chat conversation page should be full-screen with its own custom header
       - Use pathname from usePathname() to detect chat conversation routes
       - Pattern: pathname.startsWith('/chat/') && pathname !== '/chat'

    4. Ensure NotificationToastManager renders properly:
       - Fixed position, above TopBar z-index
       - Not blocking TopBar interactions
       - Renders via createPortal to document.body if needed
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - TopBar shows chat icon with red dot badge
    - TopBar shows bell icon with red dot badge
    - SocketProvider and NotificationProvider wrap app
    - Chat conversation view hides bottom nav
    - Toast notifications appear globally
  </verify>
  <done>App layout wired with socket/notification providers, TopBar has chat + notification icons with badges, chat view is full-screen</done>
</task>

<task type="auto">
  <name>Task 2: Add notification settings, profile message button, and block behavior</name>
  <files>
    src/app/(app)/settings/page.tsx
    src/components/profile/ProfileHeader.tsx
    src/app/(app)/chat/[conversationId]/page.tsx (update)
  </files>
  <action>
    1. Update `src/app/(app)/settings/page.tsx`:
       - Add "Notifications" section after existing settings sections
       - Subsections:
         - **Messaging Access**: dropdown select (Everyone / Followers / Mutual follows / Nobody)
         - **Email Notifications**: toggle switches per category
           - DM notifications (email_dm_notifications)
           - Follow request notifications (email_follow_notifications)
           - Prayer notifications (email_prayer_notifications)
           - Daily content reminder (email_daily_reminder)
         - **Daily Reminder Time**: time picker for reminder_time (HH:MM)
         - **Quiet Hours**: start time + end time pickers (or toggle + time range)
       - All settings use existing debounced auto-save pattern (PUT /api/settings)
       - Update /api/settings route to handle new fields if not already handled (it should be since UserSetting model is updated)

    2. Update `src/components/profile/ProfileHeader.tsx`:
       - Add "Message" button on other users' profiles (next to Follow button)
       - Button state based on messaging access:
         - If access allowed: blue "Message" button -> navigates to or creates conversation
         - If access = 'nobody': disabled gray button with tooltip "This user doesn't accept messages"
         - If message request needed: "Message" button -> creates message request
       - Check if conversation already exists: if so, navigate directly
       - If blocked: don't show message button at all
       - For own profile: no message button

    3. Update `src/app/(app)/chat/[conversationId]/page.tsx`:
       - Block behavior: when user blocks someone, hide conversation from both
         - On mount, check if any participant is blocked/blocking
         - If so, show "This conversation is unavailable" and redirect
       - In group chats with blocked users: hide blocked user's messages (filter in rendering)
       - Report option: add to conversation context menu (calls existing Report API with content_type: 'conversation')
       - Apply profanity filter display: if message.flagged, show censored version

    4. Integrate notification creation into existing social actions:
       - This is the critical wiring step: existing API routes for follows, reactions, comments, and prayers need to call createNotification()
       - Update these existing API routes to call createNotification() after successful action:
         - POST /api/follows (follow or follow request): createNotification type 'follow' or 'follow_request'
         - POST /api/post-reactions (react to post): createNotification type 'reaction'
         - POST /api/post-comments (comment on post): createNotification type 'comment'
         - POST /api/prayer-requests/[id]/supporters (pray for request): createNotification type 'prayer'
       - Each notification includes appropriate preview_text and entity references
       - Also trigger email notification where applicable (follow requests, prayer responses)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Settings page shows notification preferences
    - Profile shows message button with access rules
    - Block behavior hides conversations
    - Existing social actions trigger notifications
  </verify>
  <done>Notification settings in settings page, message button on profiles with access rules, block behavior in chat, notifications wired into existing social actions</done>
</task>

</tasks>

<verification>
- Chat icon visible in TopBar with badge
- Bell icon dropdown shows real notifications
- SocketProvider connects on auth
- Settings page has notification preferences
- Profile shows message button (respects access rules)
- Blocked users don't see conversations
- Follows, reactions, comments, and prayers create notifications
- Toast notifications appear for real-time events
- Chat view is full-screen (no bottom nav)
</verification>

<success_criteria>
All Phase 3 features integrated into the existing app: real-time chat accessible from TopBar, notifications active with badges and toasts, settings allow preference control, profiles have message buttons, and block behavior works correctly in chat.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-13-SUMMARY.md`
</output>
