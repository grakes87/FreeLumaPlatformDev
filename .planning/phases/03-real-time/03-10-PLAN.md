---
phase: 03-real-time
plan: 10
type: execute
wave: 3
depends_on: ["03-06"]
files_modified:
  - src/app/(app)/notifications/page.tsx
  - src/components/notifications/NotificationDropdown.tsx
  - src/components/notifications/NotificationItem.tsx
  - src/components/notifications/NotificationToast.tsx
  - src/components/notifications/NotificationFilters.tsx
  - src/hooks/useNotifications.ts
  - src/context/NotificationContext.tsx
autonomous: true

must_haves:
  truths:
    - "Notification bell dropdown shows latest 5-10 notifications with 'See all' link"
    - "Full /notifications page shows chronological feed with grouped notifications"
    - "Filter tabs (All/Follows/Reactions/Comments/Prayer) filter the notification list"
    - "Toast notifications slide in from top for real-time events"
    - "Toasts are color-coded by notification type"
    - "Tapping notification navigates to the source (post, profile, conversation)"
    - "Unread notifications have highlight background"
    - "Mark all as read and clear all buttons work"
  artifacts:
    - path: "src/app/(app)/notifications/page.tsx"
      provides: "Full notification activity feed page"
    - path: "src/components/notifications/NotificationDropdown.tsx"
      provides: "TopBar bell dropdown with latest notifications"
    - path: "src/components/notifications/NotificationToast.tsx"
      provides: "Real-time toast notification manager"
    - path: "src/hooks/useNotifications.ts"
      provides: "Notification state with Socket.IO real-time updates"
  key_links:
    - from: "src/hooks/useNotifications.ts"
      to: "/api/notifications"
      via: "fetch for feed + Socket.IO for real-time"
      pattern: "fetch.*notifications"
    - from: "src/components/notifications/NotificationToast.tsx"
      to: "src/hooks/useSocket.ts"
      via: "notifSocket for real-time events"
      pattern: "notifSocket.*notification:new"
---

<objective>
Build the full notification UI: bell icon dropdown in TopBar, full notifications page with liquid glass styling, grouped notification items with action buttons, filter tabs, toast notification manager with color coding, and notification context for global state.

Purpose: Let users see and manage all their in-app notifications with real-time delivery.
Output: Notifications page, 4 components, 1 hook, 1 context.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-CONTEXT.md (notification activity feed, in-app toast decisions)
@.planning/phases/03-real-time/03-RESEARCH.md (NotificationToast code example)
@.planning/phases/03-real-time/03-06-SUMMARY.md
@src/components/layout/TopBar.tsx (existing notification bell placeholder)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification hook and context</name>
  <files>
    src/hooks/useNotifications.ts
    src/context/NotificationContext.tsx
  </files>
  <action>
    1. Create `src/context/NotificationContext.tsx`:
       - "use client" directive
       - NotificationContextValue: { unreadCount, toastQueue, addToast, dismissToast, refreshUnreadCount }
       - NotificationProvider:
         - Fetch initial unread count from GET /api/notifications?count_only=true
         - Listen for Socket.IO "notification:new" event via notifSocket:
           - Increment unreadCount
           - Add to toastQueue
         - Toast management: queue array, show one at a time, auto-dismiss after 3.5s
         - Expose context value

    2. Create `src/hooks/useNotifications.ts`:
       - For the full notifications feed page
       - State: notifications[], loading, hasMore, filter, unreadCount
       - Fetch: GET /api/notifications with cursor + filter params
       - loadMore(): fetch next page with cursor
       - setFilter(): change filter tab, reset and refetch
       - markRead(id): PUT /api/notifications with notification_id
       - markAllRead(): PUT /api/notifications with action 'mark-all-read'
       - clearAll(): DELETE /api/notifications/clear
       - Real-time: listen for "notification:new", prepend to list
       - Return: { notifications, loading, hasMore, filter, setFilter, markRead, markAllRead, clearAll, loadMore, unreadCount }
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - NotificationContext provides unreadCount and toast queue
    - useNotifications returns paginated notification feed with filter support
  </verify>
  <done>Notification state management with real-time Socket.IO updates, toast queue, and feed pagination</done>
</task>

<task type="auto">
  <name>Task 2: Create notification UI components and page</name>
  <files>
    src/app/(app)/notifications/page.tsx
    src/components/notifications/NotificationDropdown.tsx
    src/components/notifications/NotificationItem.tsx
    src/components/notifications/NotificationToast.tsx
    src/components/notifications/NotificationFilters.tsx
  </files>
  <action>
    1. Create `src/components/notifications/NotificationItem.tsx`:
       - Props: notification (with actor, type, entity info, actor_count, is_read, created_at)
       - Layout: [Avatar with type icon overlay] [Text content] [Timestamp]
       - Avatar: actor's avatar with small icon overlay in bottom-right corner
         - Heart for reaction, speech bubble for comment, user-plus for follow, hands-prayer for prayer
       - Text: "[Actor name] reacted to your post" / "[Actor] and 3 others commented on your post"
       - Unread: subtle bg highlight (bg-primary/5)
       - Timestamp: relative (formatDistanceToNow)
       - Action buttons (context-aware):
         - Follow notifications: "Follow back" button (if not already following)
         - Follow request: "Accept" / "Decline" buttons
       - Tap: navigate to source entity (post, profile, conversation)
       - Swipe left: reveal delete/dismiss button (optional: can use simple X button instead)

    2. Create `src/components/notifications/NotificationFilters.tsx`:
       - Horizontal scrollable tab bar at top
       - Tabs: All | Follows | Reactions | Comments | Prayer
       - Active tab: primary color underline
       - Tap changes filter in useNotifications

    3. Create `src/components/notifications/NotificationDropdown.tsx`:
       - Replaces existing empty notification dropdown in TopBar
       - Shows latest 5-10 notifications (GET /api/notifications?limit=10)
       - Each item: compact NotificationItem
       - "See all" link at bottom -> navigates to /notifications
       - "Mark all as read" button in header
       - Liquid glass styling (matching existing TopBar dropdown pattern)
       - Updates in real-time when new notifications arrive

    4. Create `src/components/notifications/NotificationToast.tsx`:
       - NotificationToastManager component
       - Follow research code example closely
       - Listen for "notification:new" via notifSocket
       - Suppress chat toasts when viewing that conversation (check pathname)
       - Queue: one toast at a time, next shows after current dismisses
       - Auto-dismiss after 3.5 seconds
       - Color-coded left border by type:
         - reaction: pink, comment: blue, follow: green, prayer: purple, message: teal, mention: orange
       - Shows: actor name + preview text
       - Tappable: navigate to source
       - Positioned: fixed top-16 (below TopBar), centered, max-w-sm
       - Animation: slide down from top (animate-slide-down)

    5. Create `src/app/(app)/notifications/page.tsx`:
       - Full page notification feed
       - Liquid glass styling (bg-white/10 backdrop-blur-2xl) per CONTEXT
       - Header: "Notifications" + "Mark all as read" button + "Clear all" button
       - NotificationFilters tabs
       - Infinite scroll list of NotificationItem
       - Empty state: illustration + "No notifications yet - interact with the community to see activity here"
       - Clear all: confirmation dialog before clearing
       - On mount: mark visible notifications as read (or mark on scroll into view)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /notifications page renders with filter tabs and notification list
    - NotificationDropdown shows in TopBar (liquid glass style)
    - NotificationToast slides in from top with color coding
    - NotificationItem shows correct icons and text for each type
  </verify>
  <done>Complete notification UI: dropdown, full page with filters, toast manager, all with liquid glass styling and real-time updates</done>
</task>

</tasks>

<verification>
- Notification dropdown replaces placeholder bell in TopBar
- Full page shows grouped notifications with filter tabs
- Toast notifications appear for real-time events
- Color coding consistent across toast and notification items
- Mark all read and clear all work correctly
- Navigation from notification to source entity works
- Empty state displays correctly
</verification>

<success_criteria>
Users have full notification experience: bell dropdown for quick view, full page with filtering, real-time toast alerts, grouped notifications with action buttons, and clear/mark-read management.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-10-SUMMARY.md`
</output>
