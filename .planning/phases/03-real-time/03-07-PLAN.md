---
phase: 03-real-time
plan: 07
type: execute
wave: 3
depends_on: ["03-04", "03-05"]
files_modified:
  - src/app/(app)/chat/page.tsx
  - src/components/chat/ConversationList.tsx
  - src/components/chat/ConversationItem.tsx
  - src/components/chat/UserPicker.tsx
  - src/components/chat/OnlineStatusDot.tsx
  - src/components/chat/MessageRequestBanner.tsx
  - src/hooks/useConversations.ts
  - src/hooks/usePresence.ts
autonomous: true

must_haves:
  truths:
    - "User can view conversation list sorted by most recent message"
    - "Each conversation shows message preview, timestamp, unread indicator, and online status"
    - "User can search conversations by participant name"
    - "User can start new conversation via compose button + user picker"
    - "Message requests section appears at top of list for pending requests"
    - "Green dot shows online status on user avatars"
  artifacts:
    - path: "src/app/(app)/chat/page.tsx"
      provides: "Chat conversation list page"
    - path: "src/components/chat/ConversationList.tsx"
      provides: "Scrollable conversation list with search"
    - path: "src/components/chat/UserPicker.tsx"
      provides: "User selection for new conversations"
    - path: "src/hooks/useConversations.ts"
      provides: "Conversation list state with real-time updates"
  key_links:
    - from: "src/hooks/useConversations.ts"
      to: "/api/chat/conversations"
      via: "fetch for initial load + Socket.IO for real-time updates"
      pattern: "fetch.*chat/conversations"
    - from: "src/components/chat/ConversationItem.tsx"
      to: "src/app/(app)/chat/[conversationId]/page.tsx"
      via: "navigation on tap"
      pattern: "router\\.push.*chat/"
---

<objective>
Build the chat conversation list page and supporting components: ConversationList with search, ConversationItem with message preview/unread/online indicators, UserPicker for starting new conversations, and the useConversations hook with real-time updates.

Purpose: Give users their chat inbox — the entry point to all messaging.
Output: Chat page, 5 components, 2 hooks.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-real-time/03-CONTEXT.md (chat access & layout decisions)
@.planning/phases/03-real-time/03-04-SUMMARY.md
@.planning/phases/03-real-time/03-05-SUMMARY.md
@src/components/layout/AppShell.tsx (for understanding layout structure)
@src/components/profile/InitialsAvatar.tsx (for avatar rendering pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks for conversations and presence</name>
  <files>
    src/hooks/useConversations.ts
    src/hooks/usePresence.ts
  </files>
  <action>
    1. Create `src/hooks/useConversations.ts`:
       - Fetch initial conversation list from GET /api/chat/conversations
       - State: conversations[], messageRequests[], loading, error
       - Listen for Socket.IO events via useSocket():
         - "message:new": update last message preview and sort order, increment unread if not current conversation
         - "conversation:new": add new conversation to list
         - "conversation:deleted": remove from list
         - "message:unsent": update last message preview if it was the unsent message
       - Search: debounced search param passed to API
       - Expose: conversations, messageRequests, loading, error, search, refreshConversations()
       - Cleanup: remove socket listeners on unmount (prevent duplicate handlers per Pitfall 2)

    2. Create `src/hooks/usePresence.ts`:
       - Track online status of users in conversation list
       - Listen for "presence:online" and "presence:offline" events from chat socket
       - Maintain Map<number, boolean> of userId -> isOnline
       - Expose: isOnline(userId), onlineUsers
       - Also fetch initial presence status: emit "presence:query" with userIds[] and listen for "presence:status" response
       - Cleanup socket listeners on unmount
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - useConversations returns typed conversation list
    - usePresence tracks online status via Socket.IO events
  </verify>
  <done>Conversation list and presence hooks ready with real-time Socket.IO updates</done>
</task>

<task type="auto">
  <name>Task 2: Create chat page and conversation list components</name>
  <files>
    src/app/(app)/chat/page.tsx
    src/components/chat/ConversationList.tsx
    src/components/chat/ConversationItem.tsx
    src/components/chat/UserPicker.tsx
    src/components/chat/OnlineStatusDot.tsx
    src/components/chat/MessageRequestBanner.tsx
  </files>
  <action>
    1. Create `src/components/chat/OnlineStatusDot.tsx`:
       - Simple green dot component (absolute positioned on avatar)
       - Props: isOnline: boolean, size?: 'sm' | 'md' (default 'sm')
       - sm: 8px, md: 12px green circle with white border ring
       - Only renders when isOnline is true

    2. Create `src/components/chat/ConversationItem.tsx`:
       - Props: conversation data (name/avatar, last message, timestamp, unread count, online status, type)
       - Layout: Avatar (with OnlineStatusDot) | name + last message preview | timestamp + unread badge
       - For direct: show other user's avatar and name
       - For group: show group name/avatar (or member collage placeholder)
       - Last message: truncated to ~40 chars, "You: ..." prefix if sent by current user
       - Timestamp: relative (date-fns formatDistanceToNow or custom "2m", "1h", "Yesterday")
       - Unread: blue filled circle with count
       - Tap: navigate to /chat/[conversationId]
       - Tailwind: minimal Instagram DM style, clean borders

    3. Create `src/components/chat/MessageRequestBanner.tsx`:
       - Shows count of pending message requests
       - "Message Requests (3)" with arrow — taps to show request list
       - Expandable: shows requester avatars + message preview + Accept/Decline buttons
       - Accept calls POST /api/chat/requests with action: 'accept'
       - Decline calls POST /api/chat/requests with action: 'decline'

    4. Create `src/components/chat/UserPicker.tsx`:
       - Full-screen overlay (createPortal) for selecting users to message
       - Search bar at top: searches users via existing GET /api/users/search
       - Show followed users first as suggestions
       - Each result: avatar + name + username
       - Tap to select user and create/navigate to conversation
       - For group creation: multi-select mode with "Next" button
       - Close button (X) in top right

    5. Create `src/components/chat/ConversationList.tsx`:
       - Combines all above components
       - Header: "Messages" title + compose button (pencil icon)
       - Search bar below header
       - MessageRequestBanner at top (if requests exist)
       - Scrollable list of ConversationItem
       - Empty state: "No conversations yet — start a chat!"
       - Compose button opens UserPicker

    6. Create `src/app/(app)/chat/page.tsx`:
       - Full page component
       - Renders ConversationList
       - Uses useConversations and usePresence hooks
       - Custom header (not using default AppShell header if needed — but per CONTEXT, chat list still shows in normal layout)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Chat page exists at /chat route
    - ConversationList renders with search, compose, and request banner
    - UserPicker opens as overlay for new conversations
    - OnlineStatusDot shows green dot for online users
  </verify>
  <done>Chat conversation list page with search, compose, message requests, and online indicators</done>
</task>

</tasks>

<verification>
- Chat page accessible at /chat
- Conversation list loads from API and updates in real-time
- Search filters conversations by participant name
- Compose button opens user picker for new conversations
- Message requests show at top with accept/decline
- Online status dots appear on avatars
- Empty state shown when no conversations exist
</verification>

<success_criteria>
Users can view their chat inbox, search conversations, see online/offline status, handle message requests, and start new conversations via the user picker.
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time/03-07-SUMMARY.md`
</output>
