---
phase: 10-email-system-sendgrid
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/email/templates.ts
  - src/lib/email/queue.ts
autonomous: true

must_haves:
  truths:
    - "Workshop attendees receive email for all 6 lifecycle events"
    - "Workshop emails respect email_workshop_notifications user setting"
    - "Workshop emails include deep links to the workshop page"
    - "Workshop emails respect quiet hours and rate limiting"
  artifacts:
    - path: "src/lib/email/templates.ts"
      provides: "6 workshop email template functions"
      contains: "workshopReminderEmail"
    - path: "src/lib/email/queue.ts"
      provides: "processWorkshopEmail dispatcher"
      contains: "processWorkshopEmail"
  key_links:
    - from: "src/lib/email/queue.ts"
      to: "src/lib/email/templates.ts"
      via: "workshop template function calls"
      pattern: "workshop(Reminder|Cancelled|Invite|Recording|Updated|Started)Email"
---

<objective>
Create 6 workshop lifecycle email templates and a dispatcher function that sends the appropriate email when workshop events occur (reminder, cancelled, invite, recording ready, updated, started).

Purpose: Workshop attendees and invitees receive timely email notifications about workshop lifecycle events they care about.
Output: 6 new templates in templates.ts and a processWorkshopEmail dispatcher in queue.ts.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-email-system-sendgrid/10-CONTEXT.md
@.planning/phases/10-email-system-sendgrid/10-RESEARCH.md
@src/lib/email/templates.ts
@src/lib/email/queue.ts
@src/lib/db/models/UserSetting.ts
@src/lib/db/models/EmailLog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 6 workshop email templates</name>
  <files>src/lib/email/templates.ts</files>
  <action>
Add 6 workshop email template functions to `src/lib/email/templates.ts`. All follow the same pattern as existing templates (baseTemplate + actionButton + notificationFooter, return `{ html, subject, headers }`).

Common interface for all 6:
```typescript
export interface WorkshopEmailParams {
  recipientName: string;
  workshopTitle: string;
  workshopUrl: string;        // https://freeluma.com/workshops/{id}
  hostName: string;
  scheduledAt?: string;       // formatted date/time string (for reminder, started, updated)
  trackingId?: string;
  unsubscribeUrl?: string;
}
```

1. `workshopReminderEmail(params)`:
   - Subject: `"Reminder: {workshopTitle} starts in 1 hour"`
   - Content: "Your workshop **{workshopTitle}** hosted by **{hostName}** is starting soon at **{scheduledAt}**."
   - Button: "Join Workshop" -> workshopUrl
   - Purple left border on the info block (#8b5cf6, matching prayer style for spiritual events)
   - Footer: notificationFooter with category 'Workshop'

2. `workshopCancelledEmail(params)`:
   - Subject: `"{workshopTitle} has been cancelled"`
   - Content: "The workshop **{workshopTitle}** hosted by **{hostName}** has been cancelled."
   - Red info block (same style as account deletion template, #ef4444 border)
   - Button: "Browse Workshops" -> https://freeluma.com/workshops
   - No scheduledAt needed

3. `workshopInviteEmail(params)`:
   - Subject: `"You're invited to {workshopTitle}"`
   - Content: "**{hostName}** has invited you to their workshop **{workshopTitle}** scheduled for **{scheduledAt}**."
   - Teal info block (brand color)
   - Button: "View Workshop" -> workshopUrl

4. `workshopRecordingEmail(params)`:
   - Subject: `"Recording available: {workshopTitle}"`
   - Content: "The recording from **{workshopTitle}** is now available to watch."
   - Add an optional `recordingUrl` parameter (string, defaults to workshopUrl). This links to the video in the watch library.
   - Button: "Watch Recording" -> recordingUrl or workshopUrl

5. `workshopUpdatedEmail(params)`:
   - Subject: `"{workshopTitle} has been updated"`
   - Content: "The workshop **{workshopTitle}** by **{hostName}** has been updated. The workshop is now scheduled for **{scheduledAt}**."
   - Amber info block (#f59e0b border)
   - Button: "View Details" -> workshopUrl

6. `workshopStartedEmail(params)`:
   - Subject: `"{workshopTitle} is live now!"`
   - Content: "**{workshopTitle}** hosted by **{hostName}** has just started! Join now to participate."
   - Green info block (#22c55e border)
   - Button: "Join Now" -> workshopUrl

All templates use `notificationFooter({ trackingId, unsubscribeUrl, category: 'Workshop' })` and include List-Unsubscribe headers when unsubscribeUrl is provided.
  </action>
  <verify>
    - `grep -c "workshopReminderEmail\|workshopCancelledEmail\|workshopInviteEmail\|workshopRecordingEmail\|workshopUpdatedEmail\|workshopStartedEmail" src/lib/email/templates.ts` returns 6+ matches
    - `grep "WorkshopEmailParams" src/lib/email/templates.ts` finds the interface
    - No TypeScript errors in the file
  </verify>
  <done>
    6 workshop email templates exist with appropriate subjects, content, colored info blocks, action buttons, and unsubscribe footers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workshop email dispatcher function</name>
  <files>src/lib/email/queue.ts</files>
  <action>
Add `processWorkshopEmail()` export function to `src/lib/email/queue.ts`.

This is an immediate (non-batched) email sender, called directly when workshop events occur (like processFollowRequestEmail and processPrayerResponseEmail).

```typescript
export type WorkshopEmailType =
  | 'workshop_reminder'
  | 'workshop_cancelled'
  | 'workshop_invite'
  | 'workshop_recording'
  | 'workshop_updated'
  | 'workshop_started';

export async function processWorkshopEmail(
  recipientIds: number[],  // array to support sending to all attendees
  workshopEmailType: WorkshopEmailType,
  workshopData: {
    workshopId: number;
    workshopTitle: string;
    hostName: string;
    scheduledAt?: string;
    recordingUrl?: string;
  }
): Promise<void>
```

Implementation:
1. Import all 6 workshop template functions from templates.ts
2. For each recipientId in the array:
   a. Load recipient user + settings (User.findByPk with include UserSetting)
   b. Check `email_workshop_notifications` setting is true; skip if false
   c. Generate trackingId and unsubscribeUrl (category 'workshop')
   d. Build workshopUrl: `https://freeluma.com/workshops/${workshopData.workshopId}`
   e. Build common params: `{ recipientName, workshopTitle, workshopUrl, hostName, scheduledAt, trackingId, unsubscribeUrl }`
   f. Select the correct template function based on workshopEmailType:
      - 'workshop_reminder' -> workshopReminderEmail
      - 'workshop_cancelled' -> workshopCancelledEmail
      - 'workshop_invite' -> workshopInviteEmail
      - 'workshop_recording' -> workshopRecordingEmail (pass recordingUrl)
      - 'workshop_updated' -> workshopUpdatedEmail
      - 'workshop_started' -> workshopStartedEmail
   g. Call sendNotificationEmail with the appropriate emailType matching the workshopEmailType
   h. Wrap each recipient in try/catch (same error isolation pattern)
3. Log errors per-recipient but do not throw (fire-and-forget friendly)
  </action>
  <verify>
    - `grep "processWorkshopEmail" src/lib/email/queue.ts` finds the function
    - `grep "WorkshopEmailType" src/lib/email/queue.ts` finds the type
    - `grep "workshopReminderEmail\|workshopCancelledEmail" src/lib/email/queue.ts` shows template imports
    - No TypeScript errors
  </verify>
  <done>
    processWorkshopEmail() dispatches the correct workshop template to an array of recipient IDs, respecting email_workshop_notifications preference, quiet hours, and rate limits.
  </done>
</task>

</tasks>

<verification>
1. All 6 workshop templates render correctly with proper subjects and content
2. processWorkshopEmail dispatches to correct template based on type
3. Settings check (email_workshop_notifications) properly gates email sending
4. Fire-and-forget safe (errors logged but not thrown)
5. No TypeScript compile errors
</verification>

<success_criteria>
- 6 distinct workshop email templates with colored info blocks and action buttons
- processWorkshopEmail accepts array of recipient IDs and sends appropriate template
- email_workshop_notifications setting respected for each recipient
- Quiet hours and rate limiting applied via sendNotificationEmail
- All templates use hardcoded freeluma.com domain
</success_criteria>

<output>
After completion, create `.planning/phases/10-email-system-sendgrid/10-03-SUMMARY.md`
</output>
