---
phase: 10-email-system-sendgrid
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/email/templates.ts
  - src/lib/email/queue.ts
  - src/lib/email/scheduler.ts
autonomous: true

must_haves:
  truths:
    - "All users receive an email when a new video is published"
    - "Video broadcast emails are sent in chunks via cron to handle volume"
    - "Users who disabled email_new_video_notifications do not receive the email"
    - "Duplicate broadcast emails are prevented for the same video"
  artifacts:
    - path: "src/lib/email/templates.ts"
      provides: "newVideoEmail template function"
      contains: "newVideoEmail"
    - path: "src/lib/email/queue.ts"
      provides: "processVideoBroadcast chunked processor"
      contains: "processVideoBroadcast"
    - path: "src/lib/email/scheduler.ts"
      provides: "5-minute cron for video broadcast processing"
      contains: "processVideoBroadcast"
  key_links:
    - from: "src/lib/email/scheduler.ts"
      to: "src/lib/email/queue.ts"
      via: "processVideoBroadcast cron call"
      pattern: "processVideoBroadcast"
    - from: "src/lib/email/queue.ts"
      to: "src/lib/email/templates.ts"
      via: "newVideoEmail template call"
      pattern: "newVideoEmail"
---

<objective>
Create the new video broadcast email system -- when a new video is published, all users receive a notification email. Because the user base is large (31K), this uses a chunked cron approach rather than inline sending.

Purpose: Users are notified about new content in the video library, driving engagement with the Watch section.
Output: New video template, chunked broadcast processor, and 5-minute cron job.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-email-system-sendgrid/10-CONTEXT.md
@.planning/phases/10-email-system-sendgrid/10-RESEARCH.md
@src/lib/email/templates.ts
@src/lib/email/queue.ts
@src/lib/email/scheduler.ts
@src/lib/email/tracking.ts
@src/lib/db/models/EmailLog.ts
@src/lib/db/models/UserSetting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: New video email template</name>
  <files>src/lib/email/templates.ts</files>
  <action>
Add `newVideoEmail` template function to `src/lib/email/templates.ts`.

1. Define interface `NewVideoEmailParams`:
   ```typescript
   export interface NewVideoEmailParams {
     recipientName: string;
     videoTitle: string;
     videoDescription: string;     // truncated to 150 chars
     videoThumbnailUrl: string;    // CDN URL for the video thumbnail
     videoUrl: string;             // https://freeluma.com/watch/{id}
     trackingId?: string;
     unsubscribeUrl?: string;
   }
   ```

2. Template content:
   - Subject: `"New video: {videoTitle} - Free Luma"`
   - Header: "New Video Available"
   - Greeting: "Hi {recipientName},"
   - Body: "A new video has been added to the Free Luma library:"
   - Video card block:
     - If videoThumbnailUrl is provided, render an `<img>` tag with the thumbnail (max-width: 100%, border-radius: 8px, margin-bottom: 12px)
     - Video title in bold (18px, #18181b)
     - Description below in 14px gray text
     - Wrapped in a light gray background block with 16px padding and 8px border-radius
   - Action button: "Watch Now" -> videoUrl
   - Footer: notificationFooter with trackingId, unsubscribeUrl, category: 'New Video'
   - Return `{ html, subject, headers }` with List-Unsubscribe headers

3. Follow established template patterns exactly (baseTemplate, actionButton, notificationFooter).
  </action>
  <verify>
    - `grep "newVideoEmail" src/lib/email/templates.ts` finds the function
    - `grep "NewVideoEmailParams" src/lib/email/templates.ts` finds the interface
    - No TypeScript errors
  </verify>
  <done>
    newVideoEmail template renders a video announcement with thumbnail, title, description, and Watch Now button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Chunked video broadcast processor + cron</name>
  <files>
    src/lib/email/queue.ts
    src/lib/email/scheduler.ts
  </files>
  <action>
1. In `src/lib/email/queue.ts`, add `processVideoBroadcast()` export function:

The approach: Use PlatformSetting as a lightweight queue. When a new video is published, a platform setting `pending_video_broadcast` is set with the video ID. The cron picks it up and processes chunks of users.

```typescript
export async function processVideoBroadcast(): Promise<void>
```

Implementation:
a. Import `PlatformSetting, Video, User, UserSetting, EmailLog` from models
b. Check for pending broadcast: `PlatformSetting.get('pending_video_broadcast')`. If null/empty, return immediately.
c. Parse the value as JSON: `{ videoId: number, lastProcessedUserId: number }` (lastProcessedUserId starts at 0 for new broadcasts)
d. Load the video: `Video.findByPk(videoId, { attributes: ['id', 'title', 'description', 'thumbnail_url'], raw: true })`
e. If video not found, clear the setting and return.
f. Check for duplicate: Query EmailLog for any `new_video` email with a subject containing the video title. If count > 0 AND lastProcessedUserId === 0, this is a re-run of an already-completed broadcast. Clear the setting and return. (This prevents re-sending if the setting is accidentally re-created.)
g. Load a chunk of 100 users with IDs > lastProcessedUserId:
   ```sql
   SELECT u.id, u.email, u.display_name
   FROM users u
   JOIN user_settings us ON us.user_id = u.id
   WHERE u.id > :lastProcessedUserId
     AND u.status = 'active'
     AND us.email_new_video_notifications = TRUE
   ORDER BY u.id ASC
   LIMIT 100
   ```
h. For each user in the chunk:
   - Generate trackingId and unsubscribeUrl (category 'new_video')
   - Build email via `newVideoEmail` template:
     - videoUrl: `https://freeluma.com/watch/${videoId}`
     - videoDescription: truncated to 150 chars
     - videoThumbnailUrl: video.thumbnail_url (may be null -- template should handle gracefully)
   - Call sendNotificationEmail with emailType 'new_video'
   - Wrap in try/catch per user (error logged, continue processing)
i. After processing the chunk:
   - If chunk had 100 users, update the setting with new lastProcessedUserId (= last user ID processed)
   - If chunk had fewer than 100, broadcast is complete. Clear the setting: `PlatformSetting.set('pending_video_broadcast', null)`.
   - Log: "[Email Queue] Video broadcast: processed {N} users for video {videoId}"

2. Add a helper function `triggerVideoBroadcast(videoId: number)` that sets the platform setting:
   ```typescript
   export async function triggerVideoBroadcast(videoId: number): Promise<void> {
     const { PlatformSetting } = await import('@/lib/db/models');
     await PlatformSetting.set(
       'pending_video_broadcast',
       JSON.stringify({ videoId, lastProcessedUserId: 0 })
     );
   }
   ```

3. In `src/lib/email/scheduler.ts`:
   - Import `processVideoBroadcast` from queue
   - Add cron: `cron.schedule('*/5 * * * *', ...)` calling processVideoBroadcast()
   - Use same try/catch + console.error pattern
   - Place after the reaction/comment batch cron
  </action>
  <verify>
    - `grep "processVideoBroadcast" src/lib/email/queue.ts` finds the function
    - `grep "triggerVideoBroadcast" src/lib/email/queue.ts` finds the helper
    - `grep "processVideoBroadcast" src/lib/email/scheduler.ts` finds the cron registration
    - `grep "*/5" src/lib/email/scheduler.ts` finds the 5-minute schedule
    - No TypeScript errors
  </verify>
  <done>
    processVideoBroadcast processes 100 users per cron tick (every 5 minutes), sending new video emails. At 100 users per tick and 5-minute intervals, 31K users are fully processed in ~26 hours (acceptable for non-urgent broadcast). triggerVideoBroadcast helper sets the pending broadcast.
  </done>
</task>

</tasks>

<verification>
1. newVideoEmail template exists with thumbnail, title, description, Watch Now button
2. processVideoBroadcast uses chunked pagination (100 per tick) via PlatformSetting queue
3. triggerVideoBroadcast helper correctly initiates a broadcast
4. Duplicate protection prevents re-sending
5. email_new_video_notifications setting respected in SQL query
6. 5-minute cron registered in scheduler
7. No TypeScript compile errors
</verification>

<success_criteria>
- New video template renders with thumbnail image, title, description, and deep link
- Chunked processor handles 100 users per 5-minute tick
- PlatformSetting used as lightweight queue (videoId + lastProcessedUserId cursor)
- Duplicate broadcast prevention via EmailLog check
- email_new_video_notifications filter applied in user query
- triggerVideoBroadcast() available for calling from video publish endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/10-email-system-sendgrid/10-04-SUMMARY.md`
</output>
