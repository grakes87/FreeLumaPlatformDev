---
phase: 10-email-system-sendgrid
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/email/templates.ts
  - src/lib/email/queue.ts
  - src/lib/email/scheduler.ts
autonomous: true

must_haves:
  truths:
    - "Users receive a batched digest email for reactions and comments every 15 minutes"
    - "The digest combines reactions, comments, and replies into a single email per user"
    - "Users in quiet hours or who are online do not receive the email"
    - "Users who disabled email_reaction_comment_notifications do not receive the email"
  artifacts:
    - path: "src/lib/email/templates.ts"
      provides: "reactionCommentBatchEmail template function"
      contains: "reactionCommentBatchEmail"
    - path: "src/lib/email/queue.ts"
      provides: "processReactionCommentBatch processor"
      contains: "processReactionCommentBatch"
    - path: "src/lib/email/scheduler.ts"
      provides: "15-minute cron for reaction/comment batch"
      contains: "*/15 * * * *"
  key_links:
    - from: "src/lib/email/scheduler.ts"
      to: "src/lib/email/queue.ts"
      via: "processReactionCommentBatch import and cron call"
      pattern: "processReactionCommentBatch"
    - from: "src/lib/email/queue.ts"
      to: "src/lib/email/templates.ts"
      via: "reactionCommentBatchEmail template call"
      pattern: "reactionCommentBatchEmail"
---

<objective>
Create the reaction/comment batch email digest system -- a 15-minute batched email that combines all unread reactions, comments, and replies for a user into a single digest email.

Purpose: Users who are offline get notified about engagement on their content without being spammed by individual emails.
Output: New template, batch processor, and cron job for reaction/comment digest emails.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-email-system-sendgrid/10-CONTEXT.md
@.planning/phases/10-email-system-sendgrid/10-RESEARCH.md
@src/lib/email/templates.ts
@src/lib/email/queue.ts
@src/lib/email/scheduler.ts
@src/lib/email/tracking.ts
@src/lib/db/models/EmailLog.ts
@src/lib/db/models/UserSetting.ts
@src/lib/db/models/Notification.ts
@src/lib/notifications/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reaction/comment batch email template</name>
  <files>src/lib/email/templates.ts</files>
  <action>
Add a new template function `reactionCommentBatchEmail` to `src/lib/email/templates.ts`.

1. Define interface `ReactionCommentBatchEmailParams`:
   ```
   recipientName: string
   items: Array<{
     type: 'reaction' | 'comment' | 'reply'
     actorName: string
     contentPreview: string  // truncated post/comment text
     emoji?: string          // for reactions: the emoji used
     contentUrl: string      // deep link to the post
   }>
   trackingId?: string
   unsubscribeUrl?: string
   ```

2. Build the template:
   - Subject: `"You have {N} new reaction{s} and comment{s} - Free Luma"` (count reactions and comments separately, only mention types that exist -- e.g. "3 new reactions" or "2 new comments" or "3 new reactions and 2 new comments")
   - Header: "Activity on Your Content"
   - Greeting: "Hi {recipientName},"
   - Summary line: "Here's what happened while you were away:"
   - For each item, render a compact row:
     - Reaction: "{actorName} reacted {emoji} to your post" with content preview in a light gray quote block
     - Comment: "{actorName} commented on your post" with content preview
     - Reply: "{actorName} replied to your comment" with content preview
   - Each item row has a subtle left border (teal for reactions, blue for comments/replies) similar to the existing dmBatchEmail quote block style
   - Limit to showing 5 items max in the email. If more than 5, show first 5 + "and {N} more..."
   - Action button: "View Activity" linking to `https://freeluma.com/notifications`
   - Use notificationFooter with trackingId, unsubscribeUrl, category: 'Reaction & Comment'
   - Return `{ html, subject, headers }` matching the existing template pattern with List-Unsubscribe headers

3. Follow the exact same code patterns as `dmBatchEmail` and `followRequestEmail` -- use baseTemplate, actionButton, notificationFooter helpers.
  </action>
  <verify>
    - `grep "reactionCommentBatchEmail" src/lib/email/templates.ts` finds the function
    - `grep "ReactionCommentBatchEmailParams" src/lib/email/templates.ts` finds the interface
    - No TypeScript errors in the file
  </verify>
  <done>
    reactionCommentBatchEmail template function renders a digest of reactions/comments/replies with activity deep links and unsubscribe headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Batch processor + cron job for reaction/comment digest</name>
  <files>
    src/lib/email/queue.ts
    src/lib/email/scheduler.ts
  </files>
  <action>
1. In `src/lib/email/queue.ts`, add `processReactionCommentBatch()` export function:
   - Import `reactionCommentBatchEmail` from templates
   - Use same pattern as `processDMEmailBatch()`:
     a. Use raw SQL query to find unread notifications of types 'reaction' and 'comment' from the `notifications` table where:
        - `is_read = FALSE`
        - `created_at` between 24 hours ago and 15 minutes ago (same delay pattern as DM batch)
        - `type IN ('reaction', 'comment')`
        - Group by `recipient_id`
     b. For each recipient:
        - Skip if recipient is online (presenceManager.isOnline)
        - Skip if recent reaction_comment_batch email sent within 30 min (same dedup as DM batch)
        - Load recipient user + settings (include UserSetting)
        - Check `email_reaction_comment_notifications` setting is true
        - Load the actual notifications with actor info:
          ```sql
          SELECT n.type, n.entity_type, n.entity_id, n.preview_text, n.created_at,
                 u.display_name AS actor_name
          FROM notifications n
          JOIN users u ON u.id = n.actor_id
          WHERE n.recipient_id = :recipientId
            AND n.is_read = FALSE
            AND n.type IN ('reaction', 'comment')
            AND n.created_at >= :windowStart
          ORDER BY n.created_at DESC
          LIMIT 10
          ```
        - Map notifications to template items:
          - type 'reaction' with entity_type 'post' -> `{ type: 'reaction', actorName, contentPreview: preview_text, contentUrl: 'https://freeluma.com/feed/{entity_id}' }`
          - type 'comment' with entity_type 'post' -> `{ type: 'comment', actorName, contentPreview: preview_text, contentUrl: 'https://freeluma.com/feed/{entity_id}' }`
          - type 'comment' with entity_type 'comment' -> `{ type: 'reply', ...same }`
        - Generate trackingId, unsubscribeUrl (category 'reaction_comment')
        - Build email via reactionCommentBatchEmail template
        - Send via sendNotificationEmail with emailType 'reaction_comment_batch'
     c. Wrap each recipient in try/catch (same error isolation as DM batch)

2. In `src/lib/email/scheduler.ts`:
   - Import `processReactionCommentBatch` from queue
   - Add new cron job: `cron.schedule('*/15 * * * *', ...)` calling processReactionCommentBatch()
   - Use same try/catch + console.error pattern as existing cron entries
   - Place it after the existing DM batch cron and before the daily reminder cron
  </action>
  <verify>
    - `grep "processReactionCommentBatch" src/lib/email/queue.ts` finds the function
    - `grep "processReactionCommentBatch" src/lib/email/scheduler.ts` finds the cron registration
    - `grep "*/15" src/lib/email/scheduler.ts` finds the 15-minute schedule
    - No TypeScript errors in either file
  </verify>
  <done>
    Every 15 minutes, the cron fires processReactionCommentBatch() which finds users with unread reaction/comment notifications, builds a digest email, and sends via SendGrid. Respects quiet hours, rate limits, online status, and user preferences.
  </done>
</task>

</tasks>

<verification>
1. reactionCommentBatchEmail template exists and follows established patterns
2. processReactionCommentBatch properly queries notifications, groups by recipient, respects preferences
3. 15-minute cron registered in scheduler
4. No TypeScript compile errors
</verification>

<success_criteria>
- New template renders reaction/comment digest with up to 5 items and "N more" overflow
- Batch processor respects email_reaction_comment_notifications setting
- Batch processor skips online users and recently-emailed users (30-min dedup)
- 15-minute cron job registered alongside existing crons
- All code follows established patterns from processDMEmailBatch
</success_criteria>

<output>
After completion, create `.planning/phases/10-email-system-sendgrid/10-02-SUMMARY.md`
</output>
