---
phase: 10-email-system-sendgrid
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/email/index.ts
  - src/lib/db/models/EmailLog.ts
  - src/lib/db/models/UserSetting.ts
  - src/lib/db/migrations/076-add-email-notification-settings.cjs
  - src/lib/db/migrations/077-extend-email-log-types.cjs
  - src/app/api/email/unsubscribe/route.ts
  - src/app/api/settings/route.ts
  - src/lib/email/templates.ts
autonomous: true
user_setup:
  - service: sendgrid
    why: "Email transport provider"
    env_vars:
      - name: SENDGRID_API_KEY
        source: "SendGrid Dashboard -> Settings -> API Keys -> Create API Key (Full Access)"
    dashboard_config:
      - task: "Verify sender identity for hello@freeluma.com"
        location: "SendGrid Dashboard -> Settings -> Sender Authentication"
      - task: "Authenticate freeluma.com domain (SPF/DKIM/DMARC)"
        location: "SendGrid Dashboard -> Settings -> Sender Authentication -> Domain Authentication"

must_haves:
  truths:
    - "sendEmail() uses SendGrid API instead of Nodemailer SMTP"
    - "Dev mode silently skips emails to non-whitelisted addresses"
    - "user_settings table has 3 new email preference columns"
    - "email_logs.email_type supports 8 new notification categories"
    - "Unsubscribe route handles all 7 email categories"
    - "All email links use hardcoded freeluma.com domain"
  artifacts:
    - path: "src/lib/email/index.ts"
      provides: "SendGrid transport replacing Nodemailer"
      contains: "sgMail.send"
    - path: "src/lib/db/migrations/076-add-email-notification-settings.cjs"
      provides: "3 new boolean columns on user_settings"
    - path: "src/lib/db/migrations/077-extend-email-log-types.cjs"
      provides: "Extended email_type ENUM with 8 new values"
    - path: "src/app/api/email/unsubscribe/route.ts"
      provides: "Updated CATEGORY_TO_SETTING and CATEGORY_LABELS maps"
  key_links:
    - from: "src/lib/email/index.ts"
      to: "@sendgrid/mail"
      via: "sgMail.send() call"
      pattern: "sgMail\\.send"
    - from: "src/lib/email/index.ts"
      to: "EMAIL_DEV_WHITELIST"
      via: "dev whitelist guard"
      pattern: "EMAIL_DEV_WHITELIST"
---

<objective>
Replace Nodemailer SMTP transport with SendGrid API SDK, add database migrations for new email notification settings and email log types, update unsubscribe route for new categories, and hardcode freeluma.com domain in all templates.

Purpose: This is the foundation for Phase 10 -- every subsequent plan depends on SendGrid transport working and the DB schema being extended for new email types.
Output: SendGrid transport operational, 2 migrations applied, unsubscribe route updated, templates using freeluma.com.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-email-system-sendgrid/10-CONTEXT.md
@.planning/phases/10-email-system-sendgrid/10-RESEARCH.md
@src/lib/email/index.ts
@src/lib/email/templates.ts
@src/lib/email/queue.ts
@src/lib/email/tracking.ts
@src/lib/db/models/EmailLog.ts
@src/lib/db/models/UserSetting.ts
@src/app/api/email/unsubscribe/route.ts
@src/app/api/settings/route.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SendGrid SDK, replace transport, add dev whitelist</name>
  <files>
    package.json
    src/lib/email/index.ts
    src/lib/email/templates.ts
  </files>
  <action>
1. Install `@sendgrid/mail` (latest v8.x): `npm install @sendgrid/mail`
2. Remove `nodemailer` and `@types/nodemailer`: `npm uninstall nodemailer @types/nodemailer`

3. Rewrite `src/lib/email/index.ts`:
   - Import `sgMail` from `@sendgrid/mail`
   - Remove ALL Nodemailer imports and transporter code
   - At module level: `sgMail.setApiKey(process.env.SENDGRID_API_KEY || '')` (guarded so it does not throw if key missing)
   - Replace `sendEmail()` function:
     a. Check if `SENDGRID_API_KEY` is configured. If not, fall back to console logging (same dev fallback pattern as current SMTP check).
     b. **Dev whitelist guard**: If `process.env.NODE_ENV !== 'production'` AND `process.env.EMAIL_DEV_WHITELIST` is set, parse it as comma-separated emails. If `to` address is NOT in the whitelist, log "Skipped (not in dev whitelist): {to}" and return silently. If EMAIL_DEV_WHITELIST is not set in dev, allow all emails through (backwards compatible).
     c. Call `sgMail.send({ to, from: { email: 'hello@freeluma.com', name: 'Free Luma' }, subject, html, headers: customHeaders, trackingSettings: { clickTracking: { enable: false, enableText: false }, openTracking: { enable: false } } })`. Disable BOTH click tracking AND open tracking at the SendGrid level (the app uses its own tracking pixel).
     d. Wrap in try/catch. On error, log `error.response?.body` for actionable SendGrid error details, then re-throw.
   - Keep ALL existing convenience functions (sendPasswordResetEmail, sendVerificationEmail, sendEmailChangeVerification, sendPasswordChangeAlert, sendAccountDeletionEmail) -- they just call sendEmail() so they automatically use SendGrid now.
   - **FROM address**: Hardcode `hello@freeluma.com` as the from address. Remove the `SMTP_FROM` / `EMAIL_FROM` env var references.

4. In `src/lib/email/templates.ts`:
   - Change `const APP_URL` to hardcoded `const APP_URL = 'https://freeluma.com'`. Remove the `process.env.NEXT_PUBLIC_APP_URL` fallback. This ensures all email links and tracking pixel URLs point to the production domain regardless of environment.

5. In `src/lib/email/index.ts`:
   - Also hardcode `const APP_URL = 'https://freeluma.com'` (replacing the process.env reference). This affects the convenience functions that build URLs (resetUrl, verifyUrl, etc.).

6. In `src/lib/email/queue.ts`:
   - Also hardcode `const APP_URL = 'https://freeluma.com'` at the top (replacing the process.env reference).
  </action>
  <verify>
    - `npm ls @sendgrid/mail` shows the package installed
    - `npm ls nodemailer` shows "empty" (removed)
    - `grep -r "nodemailer" src/` returns no results
    - `grep "SMTP_HOST\|SMTP_PORT\|SMTP_USER\|SMTP_PASS\|SMTP_FROM\|EMAIL_FROM" src/lib/email/` returns no results
    - `grep "freeluma.com" src/lib/email/templates.ts` shows hardcoded domain
    - `grep "hello@freeluma.com" src/lib/email/index.ts` shows hardcoded from address
    - TypeScript compiles without errors in the email directory
  </verify>
  <done>
    sendEmail() uses @sendgrid/mail SDK with disabled click/open tracking. Dev whitelist guard prevents accidental emails to real users. All email URLs hardcoded to freeluma.com. Nodemailer fully removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: DB migrations + model updates + unsubscribe route + settings API</name>
  <files>
    src/lib/db/migrations/076-add-email-notification-settings.cjs
    src/lib/db/migrations/077-extend-email-log-types.cjs
    src/lib/db/models/UserSetting.ts
    src/lib/db/models/EmailLog.ts
    src/app/api/email/unsubscribe/route.ts
    src/app/api/settings/route.ts
    src/lib/email/queue.ts
  </files>
  <action>
1. Create migration `076-add-email-notification-settings.cjs`:
   - Add 3 columns to `user_settings`:
     - `email_reaction_comment_notifications` BOOLEAN NOT NULL DEFAULT true
     - `email_workshop_notifications` BOOLEAN NOT NULL DEFAULT true
     - `email_new_video_notifications` BOOLEAN NOT NULL DEFAULT true
   - Down: remove these 3 columns

2. Create migration `077-extend-email-log-types.cjs`:
   - ALTER TABLE `email_logs` MODIFY COLUMN `email_type` ENUM listing ALL values (existing + new):
     Existing: 'dm_batch', 'follow_request', 'prayer_response', 'daily_reminder'
     New: 'reaction_comment_batch', 'workshop_reminder', 'workshop_cancelled', 'workshop_invite', 'workshop_recording', 'workshop_updated', 'workshop_started', 'new_video'
   - Down: ALTER back to original 4 values only (with caveat that rows with new types would need to be deleted first -- add a comment noting this)

3. Run migrations: `npx sequelize-cli db:migrate`

4. Update `src/lib/db/models/UserSetting.ts`:
   - Add 3 new fields to UserSettingAttributes interface:
     - `email_reaction_comment_notifications: boolean`
     - `email_workshop_notifications: boolean`
     - `email_new_video_notifications: boolean`
   - Add to UserSettingCreationAttributes Optional union
   - Add `declare` statements on the class
   - Add to `UserSetting.init()` definitions with `DataTypes.BOOLEAN`, `allowNull: false`, `defaultValue: true`

5. Update `src/lib/db/models/EmailLog.ts`:
   - Extend the email_type union type to include all 12 values:
     `'dm_batch' | 'follow_request' | 'prayer_response' | 'daily_reminder' | 'reaction_comment_batch' | 'workshop_reminder' | 'workshop_cancelled' | 'workshop_invite' | 'workshop_recording' | 'workshop_updated' | 'workshop_started' | 'new_video'`
   - Update the ENUM in `EmailLog.init()` to list all 12 values

6. Update `src/lib/email/queue.ts`:
   - Extend the `emailType` parameter type in `sendNotificationEmail()` to accept all 12 email types (matching EmailLog model)

7. Update `src/app/api/email/unsubscribe/route.ts`:
   - Add 3 new entries to `CATEGORY_TO_SETTING`:
     - `reaction_comment: 'email_reaction_comment_notifications'`
     - `workshop: 'email_workshop_notifications'`
     - `new_video: 'email_new_video_notifications'`
   - Add 3 new entries to `CATEGORY_LABELS`:
     - `reaction_comment: 'Reaction & Comment'`
     - `workshop: 'Workshop'`
     - `new_video: 'New Video'`

8. Update `src/app/api/settings/route.ts`:
   - Add 3 new fields to `updateSettingsSchema`:
     - `email_reaction_comment_notifications: z.boolean().optional()`
     - `email_workshop_notifications: z.boolean().optional()`
     - `email_new_video_notifications: z.boolean().optional()`
   - Add to `settingFields` partial type and the conditional assignment block
   - Add to GET response (read from settings object)
   - Add to PUT response (return updated values)
  </action>
  <verify>
    - `npx sequelize-cli db:migrate:status` shows both new migrations as "up"
    - `grep "email_reaction_comment_notifications" src/lib/db/models/UserSetting.ts` returns matches
    - `grep "reaction_comment_batch\|workshop_reminder\|new_video" src/lib/db/models/EmailLog.ts` returns matches
    - `grep "reaction_comment\|workshop\|new_video" src/app/api/email/unsubscribe/route.ts` shows new categories
    - `grep "email_reaction_comment_notifications\|email_workshop_notifications\|email_new_video_notifications" src/app/api/settings/route.ts` shows new settings fields
    - `npx next build` compiles without TypeScript errors (or at least the modified files have no type errors)
  </verify>
  <done>
    Database has 3 new user_settings columns (all default true), email_logs supports 12 email types, unsubscribe route handles 7 categories, settings API reads/writes all 7 email preference toggles.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @sendgrid/mail` confirms SDK installed
2. `npm ls nodemailer` confirms removal
3. No references to SMTP_HOST/SMTP_PORT/SMTP_USER/SMTP_PASS in email source files
4. Both migrations applied successfully
5. TypeScript compiles without errors in modified files
6. Settings API GET returns all 7 email preference booleans
</verification>

<success_criteria>
- SendGrid SDK installed and Nodemailer removed
- sendEmail() uses sgMail.send() with disabled click/open tracking
- Dev whitelist guard prevents emails to non-whitelisted addresses in dev
- All email URLs hardcoded to https://freeluma.com
- From address hardcoded to hello@freeluma.com
- 3 new user_settings columns exist with DEFAULT true
- email_logs.email_type ENUM extended with 8 new values
- Unsubscribe route handles all 7 email categories
- Settings API reads/writes all 7 email preference toggles
</success_criteria>

<output>
After completion, create `.planning/phases/10-email-system-sendgrid/10-01-SUMMARY.md`
</output>
