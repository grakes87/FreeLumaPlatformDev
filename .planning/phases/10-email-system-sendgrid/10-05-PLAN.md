---
phase: 10-email-system-sendgrid
plan: 05
type: execute
wave: 3
depends_on: ["10-02", "10-03", "10-04"]
files_modified:
  - src/app/(app)/settings/page.tsx
  - src/app/api/videos/[id]/route.ts
  - src/lib/notifications/create.ts
autonomous: true

must_haves:
  truths:
    - "Settings page shows 7 email preference toggles (4 existing + 3 new)"
    - "Publishing a video triggers the broadcast email queue"
    - "Workshop notification emails are triggered from createNotification flow"
    - "All email flows use SendGrid transport end-to-end"
  artifacts:
    - path: "src/app/(app)/settings/page.tsx"
      provides: "3 new email toggle rows in settings UI"
      contains: "email_reaction_comment_notifications"
    - path: "src/app/api/videos/[id]/route.ts"
      provides: "triggerVideoBroadcast call on video publish"
      contains: "triggerVideoBroadcast"
    - path: "src/lib/notifications/create.ts"
      provides: "Workshop email dispatch from notification creation"
      contains: "processWorkshopEmail"
  key_links:
    - from: "src/app/(app)/settings/page.tsx"
      to: "/api/settings"
      via: "saveSettings calls with new toggle fields"
      pattern: "email_reaction_comment_notifications|email_workshop_notifications|email_new_video_notifications"
    - from: "src/app/api/videos/[id]/route.ts"
      to: "src/lib/email/queue.ts"
      via: "triggerVideoBroadcast import"
      pattern: "triggerVideoBroadcast"
    - from: "src/lib/notifications/create.ts"
      to: "src/lib/email/queue.ts"
      via: "processWorkshopEmail dispatch for workshop notification types"
      pattern: "processWorkshopEmail"
---

<objective>
Wire all new email types into the application: add 3 new email preference toggles to settings UI, trigger video broadcast on publish, and dispatch workshop emails from the notification creation flow.

Purpose: This plan connects all the email infrastructure built in plans 01-04 to the actual application, making the email system fully functional end-to-end.
Output: Settings UI with 7 toggles, video publish triggers broadcast, workshop events trigger emails.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-email-system-sendgrid/10-CONTEXT.md
@.planning/phases/10-email-system-sendgrid/10-RESEARCH.md
@src/app/(app)/settings/page.tsx
@src/app/api/videos/[id]/route.ts
@src/lib/notifications/create.ts
@src/lib/email/queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3 new email toggles to settings UI</name>
  <files>src/app/(app)/settings/page.tsx</files>
  <action>
1. Read the current settings page to understand the full structure.

2. Update the `SettingsData` interface to include the 3 new fields:
   ```typescript
   email_reaction_comment_notifications: boolean;
   email_workshop_notifications: boolean;
   email_new_video_notifications: boolean;
   ```

3. In the Email Notifications section (find the section with the existing 4 toggles -- DM, Follow, Prayer, Daily Reminder), add 3 new ToggleRow components BETWEEN the Prayer Notifications row and the Daily Content Reminder row:

   After the Prayer Notifications toggle + Divider, add:

   ```tsx
   <ToggleRow
     icon={MessageSquare}  // from lucide-react, for reactions/comments
     label="Reactions & Comments"
     checked={settings?.email_reaction_comment_notifications ?? true}
     onChange={(val) => saveSettings({ email_reaction_comment_notifications: val })}
   />

   <Divider />

   <ToggleRow
     icon={Presentation}  // from lucide-react, matches workshop nav icon
     label="Workshop Events"
     checked={settings?.email_workshop_notifications ?? true}
     onChange={(val) => saveSettings({ email_workshop_notifications: val })}
   />

   <Divider />

   <ToggleRow
     icon={Play}  // from lucide-react, matches Watch tab icon
     label="New Videos"
     checked={settings?.email_new_video_notifications ?? true}
     onChange={(val) => saveSettings({ email_new_video_notifications: val })}
   />

   <Divider />
   ```

4. Import the needed lucide-react icons (MessageSquare, Presentation, Play) if not already imported. Check existing imports first to avoid duplicates.

5. The saveSettings function already handles arbitrary settings fields -- no changes needed to the save logic since it sends to PUT /api/settings which was updated in Plan 01 to accept these fields.
  </action>
  <verify>
    - `grep "email_reaction_comment_notifications\|email_workshop_notifications\|email_new_video_notifications" src/app/(app)/settings/page.tsx` finds all 3 new toggles
    - `grep "Reactions & Comments\|Workshop Events\|New Videos" src/app/(app)/settings/page.tsx` finds the labels
    - No TypeScript errors in the settings page
  </verify>
  <done>
    Settings page displays 7 email preference toggles: Direct Messages, Follow Requests, Prayer Notifications, Reactions & Comments, Workshop Events, New Videos, and Daily Content Reminder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire video broadcast trigger + workshop email dispatch</name>
  <files>
    src/app/api/videos/[id]/route.ts
    src/lib/notifications/create.ts
  </files>
  <action>
1. **Video broadcast trigger** in `src/app/api/videos/[id]/route.ts`:
   - Read the current file to understand the PUT/PATCH handler for video updates.
   - Find where `published` is set to `true` (or where the video is published for the first time). This is likely in the admin PUT handler that updates video details.
   - After a video is successfully published (published changed from false to true OR published_at is set), add:
     ```typescript
     // Trigger broadcast email for newly published video
     try {
       const { triggerVideoBroadcast } = await import('@/lib/email/queue');
       await triggerVideoBroadcast(video.id);
     } catch (err) {
       console.error('[Video] Failed to trigger broadcast email:', err);
     }
     ```
   - This should be fire-and-forget (wrapped in try/catch, non-blocking).
   - Only trigger when published changes from false to true (not on every update of an already-published video). Compare previous state: if `previousPublished === false && newPublished === true`, trigger broadcast.

2. **Workshop email dispatch** in `src/lib/notifications/create.ts`:
   - After the notification is created in the DB and the Socket.IO push is sent, add workshop email dispatch:
   - Check if the notification type is a workshop type:
     ```typescript
     const workshopEmailTypes: Record<string, string> = {
       'workshop_reminder': 'workshop_reminder',
       'workshop_cancelled': 'workshop_cancelled',
       'workshop_invite': 'workshop_invite',
       'workshop_recording': 'workshop_recording',
       'workshop_updated': 'workshop_updated',
       'workshop_started': 'workshop_started',
     };
     ```
   - If `type` matches a workshop email type, trigger workshop email:
     ```typescript
     if (workshopEmailTypes[type]) {
       try {
         const { processWorkshopEmail } = await import('@/lib/email/queue');
         // Fetch workshop details for the email
         const { Workshop, User: UserModel } = await import('@/lib/db/models');
         const workshop = await Workshop.findByPk(entity_id, {
           attributes: ['id', 'title', 'scheduled_at'],
           raw: true,
         });
         const host = await UserModel.findByPk(actor_id, {
           attributes: ['display_name'],
           raw: true,
         });
         if (workshop && host) {
           const scheduledAt = workshop.scheduled_at
             ? new Date(workshop.scheduled_at).toLocaleString('en-US', {
                 weekday: 'long', month: 'long', day: 'numeric',
                 hour: 'numeric', minute: '2-digit'
               })
             : undefined;
           await processWorkshopEmail(
             [recipient_id],
             workshopEmailTypes[type] as any,
             {
               workshopId: workshop.id,
               workshopTitle: workshop.title,
               hostName: host.display_name,
               scheduledAt,
             }
           );
         }
       } catch (err) {
         // Non-fatal: email failure should not break notification
         console.error('[Notification] Workshop email dispatch error:', err);
       }
     }
     ```
   - This goes AFTER the Socket.IO push block, in its own try/catch (non-fatal).

   - Similarly, add email dispatch for follow_request and prayer types that call the existing processFollowRequestEmail and processPrayerResponseEmail functions. Check if these are already being called elsewhere -- if they are (e.g., from the API routes directly), do NOT add duplicate calls here. If they are only defined but never called from notification creation, add the dispatch:
     ```typescript
     // Follow request email
     if (type === 'follow_request' || type === 'follow') {
       try {
         const { processFollowRequestEmail } = await import('@/lib/email/queue');
         await processFollowRequestEmail(recipient_id, actor_id);
       } catch (err) {
         console.error('[Notification] Follow email dispatch error:', err);
       }
     }

     // Prayer response email
     if (type === 'prayer') {
       try {
         const { processPrayerResponseEmail } = await import('@/lib/email/queue');
         await processPrayerResponseEmail(recipient_id, actor_id, entity_id);
       } catch (err) {
         console.error('[Notification] Prayer email dispatch error:', err);
       }
     }
     ```
   - IMPORTANT: First check if processFollowRequestEmail/processPrayerResponseEmail are already called from the follow/prayer API routes. Search for imports of these functions. If they are already wired in API routes, do NOT add them again in createNotification (would cause duplicate emails). Only add them here if they are currently orphaned (defined but never imported/called outside queue.ts).
  </action>
  <verify>
    - `grep "triggerVideoBroadcast" src/app/api/videos/[id]/route.ts` finds the trigger
    - `grep "processWorkshopEmail" src/lib/notifications/create.ts` finds the workshop dispatch
    - `grep "processFollowRequestEmail\|processPrayerResponseEmail" src/lib/notifications/create.ts` -- only present if they were orphaned
    - No TypeScript errors in modified files
  </verify>
  <done>
    Publishing a video triggers the broadcast email queue via triggerVideoBroadcast(). Workshop notification types automatically dispatch workshop emails via processWorkshopEmail(). Follow and prayer emails are wired if they were previously orphaned. All dispatches are fire-and-forget with non-fatal error handling.
  </done>
</task>

</tasks>

<verification>
1. Settings page shows 7 email preference toggles with correct icons and labels
2. Toggling new settings persists via PUT /api/settings
3. Publishing a video triggers pending_video_broadcast platform setting
4. Workshop notifications dispatch emails to recipients
5. All email dispatches are non-fatal (wrapped in try/catch)
6. No duplicate email sends (follow/prayer only wired if not already connected)
7. Full end-to-end: SendGrid transport -> templates -> queue -> triggers all connected
</verification>

<success_criteria>
- Settings UI: 7 email toggles (DM, Follow, Prayer, Reactions/Comments, Workshops, New Videos, Daily Reminder)
- Video publish: Newly published videos trigger broadcast email queue
- Workshop events: 6 lifecycle events dispatch emails via createNotification
- Follow/prayer: Emails wired if previously orphaned (no duplicates)
- All dispatch calls are fire-and-forget with error logging
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-email-system-sendgrid/10-05-SUMMARY.md`
</output>
