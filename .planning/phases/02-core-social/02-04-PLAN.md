---
phase: 02-core-social
plan: 04
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/api/post-reactions/route.ts
  - src/hooks/usePostReactions.ts
  - src/components/social/LikeButton.tsx
autonomous: true

must_haves:
  truths:
    - "User can like a post (toggle reaction)"
    - "Post displays total reaction count"
    - "User can see which reaction type they gave"
    - "Multiple reaction types supported (like, love, pray, etc.)"
  artifacts:
    - path: "src/app/api/post-reactions/route.ts"
      provides: "Post reaction toggle and counts"
      exports: ["GET", "POST"]
    - path: "src/hooks/usePostReactions.ts"
      provides: "Post reaction state with optimistic updates"
      exports: ["usePostReactions"]
    - path: "src/components/social/LikeButton.tsx"
      provides: "Like/react button for posts"
      exports: ["LikeButton"]
  key_links:
    - from: "src/components/social/LikeButton.tsx"
      to: "src/hooks/usePostReactions.ts"
      via: "hook consumption"
      pattern: "usePostReactions"
    - from: "src/hooks/usePostReactions.ts"
      to: "/api/post-reactions"
      via: "fetch POST toggle"
      pattern: "fetch.*api/post-reactions"
---

<objective>
Create the post reaction system: API for toggling reactions and fetching counts, a React hook with optimistic updates, and a LikeButton component.

Purpose: Reactions are a core engagement mechanic. The LikeButton appears on every PostCard in the feed. This mirrors the existing daily content reaction system (useReactions, daily-reactions API) for posts.
Output: 1 API route, 1 hook, 1 component.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-01-SUMMARY.md

@src/app/api/daily-reactions/route.ts
@src/hooks/useReactions.ts
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post reactions API route</name>
  <files>src/app/api/post-reactions/route.ts</files>
  <action>
    Mirror the pattern from src/app/api/daily-reactions/route.ts but for posts.

    GET: withAuth. Query param: post_id (required). Return: counts per reaction_type (object like { like: 5, love: 2, pray: 1 }), total count, user_reaction (the current user's reaction_type or null). Query PostReaction where post_id matches. Group by reaction_type for counts. Separate query for user's own reaction.

    POST: withAuth. Body: { post_id: number, reaction_type: string (one of 'like','love','haha','wow','sad','pray') }. Toggle logic: if user already has a reaction on this post with SAME type, remove it (unreact). If user has a reaction with DIFFERENT type, update it. If user has no reaction, create one. Return updated counts and user_reaction. Use the same toggle pattern as daily-reactions.
  </action>
  <verify>
    curl -X POST /api/post-reactions -d '{"post_id":1,"reaction_type":"like"}' — should toggle reaction.
    curl GET /api/post-reactions?post_id=1 — should return counts.
  </verify>
  <done>Post reaction toggle works for all 6 reaction types. GET returns counts grouped by type and user's current reaction.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePostReactions hook and LikeButton component</name>
  <files>
    src/hooks/usePostReactions.ts
    src/components/social/LikeButton.tsx
  </files>
  <action>
    **src/hooks/usePostReactions.ts:**
    Mirror src/hooks/useReactions.ts but target /api/post-reactions with post_id param. Hook takes postId and optional initial data (counts, userReaction). Exposes: counts (record of reaction_type -> number), totalCount, userReaction (string | null), toggle(reactionType: string), loading. Optimistic updates: on toggle, immediately update counts and userReaction, then POST to API, rollback on error.

    **src/components/social/LikeButton.tsx:**
    A button that shows heart icon (from lucide-react Heart) with total reaction count. When user has reacted, heart is filled/red. On tap: toggles 'like' reaction via usePostReactions. On long-press or right-click (optional enhancement): could show full reaction picker, but for now just toggle like. Props: postId, initialCounts, initialUserReaction. Use cn() for conditional styling. Show count next to icon. Compact design for PostCard use.
  </action>
  <verify>
    npm run build — no TypeScript errors.
    Manually test LikeButton renders correctly with count.
  </verify>
  <done>usePostReactions provides optimistic reaction toggle. LikeButton shows filled heart when liked, count updates immediately on tap.</done>
</task>

</tasks>

<verification>
1. POST /api/post-reactions toggles reaction correctly
2. GET /api/post-reactions returns grouped counts and user reaction
3. Switching reaction type (like -> love) updates correctly
4. Unreacting (same type toggle) removes reaction
5. usePostReactions optimistically updates before server response
6. LikeButton visually reflects liked/unliked state
</verification>

<success_criteria>
- Post reactions API mirrors daily-reactions pattern successfully
- Optimistic updates match the quality of useReactions hook
- LikeButton renders count and toggle state correctly
- All 6 reaction types (like, love, haha, wow, sad, pray) supported
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-04-SUMMARY.md`
</output>
