---
phase: 02-core-social
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/post-reactions/route.ts
  - src/app/api/post-comment-reactions/route.ts
  - src/hooks/usePostReactions.ts
  - src/hooks/usePostCommentReactions.ts
  - src/components/social/PostReactionBar.tsx
  - src/components/social/PostReactionPicker.tsx
autonomous: true

must_haves:
  truths:
    - "User can add a reaction to a post (one of 6 types: like, love, haha, wow, sad, pray)"
    - "User can change their reaction on a post by selecting a different type"
    - "User can remove their reaction by tapping the same reaction again (toggle)"
    - "Reaction counts display per-type on each post"
    - "User can react to comments with the same 6 reaction types"
    - "Reactions update optimistically in the UI"
  artifacts:
    - path: "src/app/api/post-reactions/route.ts"
      provides: "GET reaction counts + user reaction, POST toggle reaction"
      exports: ["GET", "POST"]
    - path: "src/hooks/usePostReactions.ts"
      provides: "Optimistic reaction state management hook"
      exports: ["usePostReactions"]
    - path: "src/components/social/PostReactionBar.tsx"
      provides: "Reaction count display with overlapping emoji avatars"
      exports: ["PostReactionBar"]
  key_links:
    - from: "src/components/social/PostReactionBar.tsx"
      to: "src/hooks/usePostReactions.ts"
      via: "usePostReactions hook"
      pattern: "usePostReactions"
    - from: "src/hooks/usePostReactions.ts"
      to: "src/app/api/post-reactions/route.ts"
      via: "fetch /api/post-reactions"
      pattern: "api/post-reactions"
---

<objective>
Build the post reaction system (same 6 emoji types as daily content) and comment reaction system. This mirrors the Phase 1 daily_reactions pattern but for posts and post comments.

Purpose: Reactions are core engagement on every post and comment. The same 6 reactions are consistent across the entire platform per CONTEXT decisions.
Output: 2 API routes, 2 hooks, 2 components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-01-SUMMARY.md
@src/app/api/daily-reactions/route.ts
@src/hooks/useReactions.ts
@src/components/daily/ReactionBar.tsx
@src/components/daily/ReactionPicker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post reaction and comment reaction API routes</name>
  <files>
    src/app/api/post-reactions/route.ts
    src/app/api/post-comment-reactions/route.ts
  </files>
  <action>
    **src/app/api/post-reactions/route.ts ‚Äî Mirror daily-reactions/route.ts pattern exactly:**

    **GET:**
    - withAuth (or withOptionalAuth if guest viewing is supported)
    - Query param: post_id (required, integer)
    - Fetch all reactions for the post grouped by reaction_type with COUNT
    - Also fetch the requesting user's own reaction (if any)
    - Return: { counts: { like: N, love: N, ... }, user_reaction: 'like' | null, total: N }

    **POST (toggle reaction):**
    - withAuth
    - Body: { post_id: number, reaction_type: 'like'|'love'|'haha'|'wow'|'sad'|'pray' }
    - Zod validation
    - Check if user already has a reaction on this post:
      - No existing: Create new PostReaction
      - Same type: Delete (toggle off)
      - Different type: Update reaction_type (change reaction)
    - Return updated counts and user_reaction

    **src/app/api/post-comment-reactions/route.ts ‚Äî Same pattern for comments:**

    **GET:**
    - Query param: comment_id (required)
    - Return counts per type + user's reaction

    **POST:**
    - Body: { comment_id: number, reaction_type: ... }
    - Same toggle logic against PostCommentReaction model
    - Return updated counts
  </action>
  <verify>
    - `npm run build` passes
    - POST reaction toggle: create -> toggle same type removes -> toggle different type changes
  </verify>
  <done>Post reaction and comment reaction APIs work with toggle behavior (create/remove/change). Grouped counts returned per reaction type.</done>
</task>

<task type="auto">
  <name>Task 2: Create reaction hooks and UI components</name>
  <files>
    src/hooks/usePostReactions.ts
    src/hooks/usePostCommentReactions.ts
    src/components/social/PostReactionBar.tsx
    src/components/social/PostReactionPicker.tsx
  </files>
  <action>
    **src/hooks/usePostReactions.ts ‚Äî Mirror useReactions.ts pattern:**
    - Hook: `usePostReactions(postId: number)`
    - State: counts (object of reaction_type -> count), userReaction (string | null), total, loading
    - Fetch on mount: GET /api/post-reactions?post_id={postId}
    - `toggleReaction(type: string)`: Optimistic update ‚Äî immediately update counts and userReaction, then POST. On error, rollback.
    - Handle all three cases: add new, remove same, change to different
    - Return { counts, userReaction, total, loading, toggleReaction }

    **src/hooks/usePostCommentReactions.ts ‚Äî Same pattern for comments:**
    - Hook: `usePostCommentReactions(commentId: number)`
    - Same state and toggle logic but uses comment_id and /api/post-comment-reactions

    **src/components/social/PostReactionBar.tsx:**
    - Props: postId: number, compact?: boolean
    - Uses usePostReactions hook
    - Displays reaction emojis with counts (overlapping emoji style from existing ReactionBar)
    - If compact: show total count + top 3 reaction emojis
    - Clicking the bar opens PostReactionPicker
    - If user has reacted: highlight their reaction emoji
    - Show total reaction count number
    - Use cn() for styling, dark mode support

    **src/components/social/PostReactionPicker.tsx:**
    - Props: postId: number, onClose: () => void, isOpen: boolean
    - Full overlay with 6 reaction options (same layout as existing ReactionPicker or QuickReactionPicker)
    - Emoji options: üëç Like, ‚ù§Ô∏è Love, üòÇ Haha, üòÆ Wow, üò¢ Sad, üôè Pray
    - Long-press/tap behavior: show picker bubble above the reaction area
    - On select: call toggleReaction from usePostReactions, close picker
    - Highlight currently selected reaction
    - Animated entrance/exit (scale + fade)
    - Use cn() for styling
  </action>
  <verify>
    - `npm run build` passes
    - Components render without errors in dev mode
    - Reaction toggle updates counts optimistically
  </verify>
  <done>Post reaction hooks and UI components complete. Optimistic updates work for add/remove/change. PostReactionBar shows counts with overlapping emojis. PostReactionPicker shows 6-emoji selection overlay. Comment reactions also work.</done>
</task>

</tasks>

<verification>
- Reaction toggle cycle: none -> like -> love -> remove
- Counts update correctly in all cases
- Optimistic UI updates and rolls back on error
- Comment reactions work independently from post reactions
- Build passes
</verification>

<success_criteria>
- Same 6 reactions work on posts and comments
- Toggle behavior correct (add/remove/change)
- Optimistic UI updates
- Reusable components ready for PostCard integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-04-SUMMARY.md`
</output>
