---
phase: 02-core-social
plan: 07
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/api/prayer-requests/route.ts
  - src/app/api/prayer-requests/[id]/route.ts
  - src/app/api/prayer-requests/[id]/pray/route.ts
  - src/app/api/prayer-requests/[id]/supporters/route.ts
  - src/hooks/usePrayerWall.ts
  - src/hooks/usePrayerToggle.ts
autonomous: true

must_haves:
  truths:
    - "User can create a prayer request (creates both a Post with type='prayer_request' and a PrayerRequest extension row)"
    - "User can view paginated prayer wall feed (only prayer_request type posts)"
    - "User can toggle 'praying for you' on a prayer request"
    - "Pray count updates atomically via transaction"
    - "Author can see list of people who prayed for their request"
    - "Author can mark prayer request as 'answered' with optional testimony"
    - "Prayer wall shows two tabs: Others' Prayers and My Prayers"
    - "Anonymous prayer requests show 'Anonymous' to everyone except the author"
    - "Prayer wall is bible-mode only (restricted by mode check)"
  artifacts:
    - path: "src/app/api/prayer-requests/route.ts"
      provides: "GET prayer wall feed, POST create prayer request"
      exports: ["GET", "POST"]
    - path: "src/app/api/prayer-requests/[id]/route.ts"
      provides: "GET detail, PUT update/mark answered, DELETE"
      exports: ["GET", "PUT", "DELETE"]
    - path: "src/app/api/prayer-requests/[id]/pray/route.ts"
      provides: "POST pray toggle with transaction"
      exports: ["POST"]
    - path: "src/hooks/usePrayerWall.ts"
      provides: "Prayer wall feed with tabs and pagination"
      exports: ["usePrayerWall"]
  key_links:
    - from: "src/app/api/prayer-requests/[id]/pray/route.ts"
      to: "src/lib/db/models/PrayerSupport.ts"
      via: "Transaction: create/destroy PrayerSupport + increment/decrement pray_count"
      pattern: "sequelize\\.transaction"
    - from: "src/app/api/prayer-requests/route.ts"
      to: "src/app/api/posts/route.ts"
      via: "Creates a Post (type=prayer_request) then PrayerRequest extension"
      pattern: "Post\\.create.*prayer_request"
---

<objective>
Build the complete prayer wall system — API routes for creating prayer requests, viewing the prayer wall feed, praying for others, marking answered, and viewing supporters. Plus client-side hooks.

Purpose: The prayer wall is a separate content stream from the social feed (per CONTEXT). It's a core faith-community feature that drives daily engagement through intercessory prayer.
Output: 4 API route files, 2 hooks.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-02-SUMMARY.md
@src/lib/utils/cursor.ts
@src/lib/utils/blocks.ts
@src/lib/moderation/profanity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prayer request API routes (CRUD, pray toggle, supporters, feed)</name>
  <files>
    src/app/api/prayer-requests/route.ts
    src/app/api/prayer-requests/[id]/route.ts
    src/app/api/prayer-requests/[id]/pray/route.ts
    src/app/api/prayer-requests/[id]/supporters/route.ts
  </files>
  <action>
    **src/app/api/prayer-requests/route.ts:**

    **GET (prayer wall feed):**
    - withAuth
    - Query params: cursor, limit (default 20), tab ('others' | 'my_requests' | 'my_joined'), status ('all' | 'active' | 'answered', default 'all')
    - Bible-mode check: prayer wall is bible-mode only. If requesting user's mode is 'positivity', return 403 with message "Prayer wall is available in Bible mode"
    - Get blocked user IDs
    - Build query:
      - Join posts with prayer_requests (post_type='prayer_request')
      - Include Post with author (User), media (PostMedia)
      - Include PrayerRequest fields (privacy, status, pray_count, answered_at, answered_testimony)
      - Exclude deleted posts, blocked users
      - Privacy check: only show 'public' prayers, or 'followers' if the requesting user follows the author, or 'private' only if the author is the requesting user
    - Tab logic:
      - 'others': all public prayers except the user's own (community tab)
      - 'my_requests': prayers where post.user_id = requesting user
      - 'my_joined': prayers where PrayerSupport exists for the requesting user
    - Sort: engagement-weighted (per CONTEXT): `0.6 * recency_score + 0.4 * (pray_count / max_pray_count)`. Simpler approach: ORDER BY (pray_count * 0.3 + DATEDIFF(NOW(), created_at) * -0.01) DESC, or just ORDER BY created_at DESC for initial implementation, then refine.
    - Cursor-based pagination
    - For each prayer: include whether requesting user has prayed (boolean)
    - For anonymous prayers: if is_anonymous=true AND post.user_id != requesting user, replace author info with { display_name: 'Anonymous', avatar_url: null, username: 'anonymous' }
    - Return { prayers: [...], next_cursor, has_more }

    **POST (create prayer request):**
    - withAuth
    - Bible-mode check
    - Zod schema: { body: string (1-5000), privacy: enum ('public','followers','private') default 'public', is_anonymous: boolean default false, media_keys: array max 10 optional }
    - Run profanity check (flag, don't block)
    - Create Post (type='prayer_request', mode=user.mode, is_anonymous, flagged)
    - Create PostMedia rows if media_keys provided
    - Create PrayerRequest extension row (privacy, status='active')
    - Return 201 with prayer request data

    **src/app/api/prayer-requests/[id]/route.ts:**

    **GET (prayer detail):**
    - withAuth
    - Fetch prayer request by ID with post, author, media, reaction counts, comment count, prayer support status for requesting user
    - Anonymous handling (same as feed)
    - Privacy check
    - Block check
    - Return full prayer data

    **PUT (update prayer request):**
    - withAuth
    - Verify ownership (post.user_id = requesting user)
    - Zod: { body?: string, privacy?: enum, is_anonymous?: boolean, action?: 'mark_answered', testimony?: string }
    - If action='mark_answered': update PrayerRequest status='answered', answered_at=NOW(), answered_testimony=testimony
    - If body changed: update Post body, re-run profanity, set edited=true
    - Return updated prayer

    **DELETE:**
    - withAuth, verify ownership or admin
    - Soft delete the post (paranoid)
    - Return { success: true }

    **src/app/api/prayer-requests/[id]/pray/route.ts:**
    - POST with withAuth
    - Per CONTEXT: single tap toggle
    - Use sequelize.transaction:
      - Check if PrayerSupport exists for (user_id, prayer_request_id)
      - If exists: destroy it + decrement pray_count
      - If not exists: create it + increment pray_count
    - Return { action: 'added' | 'removed', pray_count: updated_count }

    **src/app/api/prayer-requests/[id]/supporters/route.ts:**
    - GET with withAuth
    - Verify requesting user is the prayer request author (only author can see who prayed)
    - Query PrayerSupport for this prayer_request_id
    - Include User (id, username, display_name, avatar_url)
    - Paginated
    - Return { supporters: [...], total, next_cursor, has_more }
  </action>
  <verify>
    - `npm run build` passes
    - Create prayer request -> pray toggle -> mark answered flow works
    - Positivity mode user gets 403 on prayer wall access
    - Anonymous prayers hide author info for non-authors
    - Pray count updates atomically
  </verify>
  <done>Prayer request CRUD complete: create with media/profanity/anonymous, prayer wall feed with tabs (others/my_requests/my_joined), pray toggle with atomic count update, mark answered with testimony, supporters list for author. Bible-mode restriction enforced.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePrayerWall and usePrayerToggle hooks</name>
  <files>
    src/hooks/usePrayerWall.ts
    src/hooks/usePrayerToggle.ts
  </files>
  <action>
    **src/hooks/usePrayerWall.ts:**
    - Hook: `usePrayerWall()`
    - State:
      - activeTab: 'others' | 'my_requests' | 'my_joined' (default 'others')
      - statusFilter: 'all' | 'active' | 'answered' (default 'all')
      - prayers: array
      - loading, hasMore, cursor, refreshing
    - On mount and tab/filter change: reset and fetch first page
    - `fetchNextPage()`: append next page using cursor
    - `refresh()`: reset and fetch fresh
    - `setActiveTab(tab)`: switch tab, triggers reset + fetch
    - `setStatusFilter(filter)`: switch filter, triggers reset + fetch
    - `removePrayer(id)`: remove from local list
    - `updatePrayer(id, updates)`: update in local list
    - API: GET /api/prayer-requests with tab and status params
    - Return all state + methods

    **src/hooks/usePrayerToggle.ts:**
    - Hook: `usePrayerToggle(prayerRequestId: number, initialPraying: boolean, initialCount: number)`
    - State: isPraying (boolean), prayCount (number), loading
    - `toggle()`: Optimistic update — flip isPraying, adjust prayCount (+1/-1), POST to /api/prayer-requests/[id]/pray. On error: rollback.
    - Return { isPraying, prayCount, loading, toggle }
  </action>
  <verify>
    - `npm run build` passes
    - usePrayerWall fetches and paginates
    - Tab switching works
    - usePrayerToggle optimistically updates count
  </verify>
  <done>Prayer wall hooks complete: usePrayerWall manages feed state with tabs and filters; usePrayerToggle provides optimistic pray/unpray toggle with count.</done>
</task>

</tasks>

<verification>
- Prayer wall feed returns only prayer_request posts
- Tab switching (others/my_requests/my_joined) works
- Anonymous prayers show "Anonymous" to non-authors
- Pray toggle is atomic (transaction-based)
- Author can view supporters list
- Mark answered updates status with testimony
- Bible-mode restriction enforced (positivity users get 403)
- Block filtering active on prayer wall
</verification>

<success_criteria>
- Complete prayer wall API (CRUD, feed, pray, supporters, answered)
- Bible-mode restriction
- Anonymous prayer support
- Atomic pray count with transaction
- Tab-based prayer wall with pagination
- Optimistic pray toggle hook
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-07-SUMMARY.md`
</output>
