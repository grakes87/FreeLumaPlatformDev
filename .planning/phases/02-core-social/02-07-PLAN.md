---
phase: 02-core-social
plan: 07
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/app/api/prayer-requests/route.ts
  - src/app/api/prayer-requests/[id]/route.ts
  - src/app/api/prayer-requests/[id]/pray/route.ts
  - src/hooks/usePrayerWall.ts
autonomous: true

must_haves:
  truths:
    - "User can create a prayer request (creates post + prayer_request extension)"
    - "User can view paginated prayer wall feed"
    - "User can tap 'Praying for you' and prayer count updates"
    - "Prayer request author can mark request as answered with optional testimony"
    - "User can view who prayed for their request"
    - "Prayer wall can be filtered by active/answered status"
  artifacts:
    - path: "src/app/api/prayer-requests/route.ts"
      provides: "Prayer wall feed and creation"
      exports: ["GET", "POST"]
    - path: "src/app/api/prayer-requests/[id]/route.ts"
      provides: "Prayer request details and mark answered"
      exports: ["GET", "PUT"]
    - path: "src/app/api/prayer-requests/[id]/pray/route.ts"
      provides: "Pray toggle with transaction"
      exports: ["POST"]
    - path: "src/hooks/usePrayerWall.ts"
      provides: "Prayer wall feed hook"
      exports: ["usePrayerWall"]
  key_links:
    - from: "src/app/api/prayer-requests/[id]/pray/route.ts"
      to: "PrayerRequest.pray_count"
      via: "Sequelize transaction with increment/decrement"
      pattern: "sequelize\\.transaction"
    - from: "src/hooks/usePrayerWall.ts"
      to: "/api/prayer-requests"
      via: "fetch GET with cursor pagination"
      pattern: "fetch.*api/prayer-requests"
---

<objective>
Create the prayer wall API routes (feed, create, pray toggle, mark answered) and the usePrayerWall hook.

Purpose: The prayer wall is a dedicated filtered view of prayer request posts. The pray toggle with transactional count management is a key engagement feature. Mark-as-answered with testimony closes the prayer lifecycle.
Output: 3 API route files, 1 hook.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-02-SUMMARY.md

@src/lib/utils/blocks.ts
@src/lib/moderation/profanity.ts
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prayer request API routes</name>
  <files>
    src/app/api/prayer-requests/route.ts
    src/app/api/prayer-requests/[id]/route.ts
    src/app/api/prayer-requests/[id]/pray/route.ts
  </files>
  <action>
    **src/app/api/prayer-requests/route.ts:**

    GET: withAuth. Prayer wall feed. Query params: cursor (optional), limit (default 20, max 50), status ('active' | 'answered' | 'all', default 'active'), privacy ('public' only for non-author). Fetch Posts where post_type = 'prayer_request', include PrayerRequest extension (filter by status if not 'all'), include User as 'author'. Exclude blocked users. Use cursor-based pagination (same decodeCursor/encodeCursor pattern). For each result, include: pray_count, user_has_prayed (boolean, whether current user has a PrayerSupport record), reaction_count, comment_count. Return { prayer_requests, next_cursor, has_more }.

    POST: withAuth. Body: { body: string (1-5000), privacy: enum('public','followers','private') default 'public', category_id: number optional }. Check profanity. Create Post with post_type='prayer_request', then create PrayerRequest extension with post_id, privacy, status='active'. Return created prayer request with post data.

    **src/app/api/prayer-requests/[id]/route.ts:**
    Note: [id] here is the prayer_request.id.

    GET: withAuth. Fetch PrayerRequest by id, include Post (with author), include PrayerSupport records (with User info) for "who prayed" list. Only show supporters list to the prayer author. Return full prayer request detail with supporters.

    PUT: withAuth. Only prayer request author. Body: { status: 'answered', answered_testimony: string (optional, max 5000) }. Set status to 'answered', answered_at to now, answered_testimony if provided. Return updated prayer request.

    **src/app/api/prayer-requests/[id]/pray/route.ts:**

    POST: withAuth. Toggle pray using Sequelize transaction (CRITICAL: must be transactional to keep pray_count in sync). Within transaction: check if PrayerSupport exists for (user_id, prayer_request_id). If exists: destroy + decrement pray_count. If not: create + increment pray_count. Return { action: 'prayed' | 'unprayed', pray_count: updated_count }. User cannot pray for own request (return 400).
  </action>
  <verify>
    1. POST /api/prayer-requests — creates prayer request
    2. GET /api/prayer-requests — returns prayer wall feed
    3. GET /api/prayer-requests?status=answered — filters answered
    4. POST /api/prayer-requests/1/pray — toggles pray count transactionally
    5. PUT /api/prayer-requests/1 with status=answered — marks as answered
    6. GET /api/prayer-requests/1 — returns detail with supporters list (for author)
  </verify>
  <done>Prayer request CRUD works with transactional pray toggle, mark-answered, and supporters list.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePrayerWall hook</name>
  <files>src/hooks/usePrayerWall.ts</files>
  <action>
    Hook for prayer wall data management. Similar structure to useFeed but targets /api/prayer-requests. Takes: { status?: 'active' | 'answered' | 'all' }. Manages state: prayerRequests (array), nextCursor, hasMore, loading, initialLoading. Exposes: fetchNextPage(), togglePray(prayerRequestId) with optimistic update (immediately increment/decrement pray_count and flip user_has_prayed, rollback on error), markAnswered(prayerRequestId, testimony?), refresh(). When status filter changes, reset and re-fetch.
  </action>
  <verify>npm run build — no TypeScript errors. Hook returns prayer request array on initial fetch.</verify>
  <done>usePrayerWall provides paginated prayer wall data with optimistic pray toggle and filter management.</done>
</task>

</tasks>

<verification>
1. Prayer request creation creates both Post and PrayerRequest records
2. Prayer wall feed returns only prayer_request posts
3. Status filter (active/answered) works correctly
4. Pray toggle is transactional (pray_count stays in sync with prayer_supports records)
5. Cannot pray for own request
6. Mark answered sets status, timestamp, and optional testimony
7. Supporters list only visible to prayer request author
8. usePrayerWall optimistically updates pray state
</verification>

<success_criteria>
- Prayer requests extend posts correctly (post_type + extension table)
- Pray toggle uses Sequelize transactions to prevent count desync
- Prayer wall feed supports cursor pagination and status filtering
- Blocked user exclusion applied to prayer wall
- Optimistic updates in hook match server state
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-07-SUMMARY.md`
</output>
