---
phase: 02-core-social
plan: 09
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/api/drafts/route.ts
  - src/app/api/drafts/[id]/route.ts
  - src/app/api/platform-settings/route.ts
  - src/hooks/useDraft.ts
  - src/lib/utils/media-compress.ts
autonomous: true

must_haves:
  truths:
    - "Drafts auto-save when user navigates away mid-compose"
    - "User can resume a saved draft when opening the composer"
    - "Platform settings API allows admin to read/write settings (feed_style, mode_isolation, etc.)"
    - "Server-side media compression runs on uploaded images (resize, WebP conversion)"
  artifacts:
    - path: "src/app/api/drafts/route.ts"
      provides: "GET user's drafts, POST save draft"
      exports: ["GET", "POST"]
    - path: "src/app/api/platform-settings/route.ts"
      provides: "GET all settings, PUT update setting (admin only)"
      exports: ["GET", "PUT"]
    - path: "src/hooks/useDraft.ts"
      provides: "Auto-save draft hook with debounce"
      exports: ["useDraft"]
    - path: "src/lib/utils/media-compress.ts"
      provides: "Server-side image/video compression utility"
      exports: ["compressImage", "generateVideoThumbnail"]
  key_links:
    - from: "src/hooks/useDraft.ts"
      to: "src/app/api/drafts/route.ts"
      via: "Auto-save POST with debounce"
      pattern: "api/drafts"
    - from: "src/lib/utils/media-compress.ts"
      to: "sharp"
      via: "Image resize and WebP conversion"
      pattern: "sharp"
---

<objective>
Build the draft auto-save system, platform settings API (for admin toggles), and server-side media compression utility.

Purpose: Drafts ensure users don't lose work mid-compose (per CONTEXT: auto-save if user navigates away). Platform settings power the admin dashboard's feed style toggle, mode isolation toggle, and other configuration. Media compression optimizes uploaded images for CDN delivery.
Output: 4 API route files, 1 hook, 1 utility module.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-02-SUMMARY.md
@src/lib/auth/middleware.ts
@src/lib/storage/b2.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create draft API, platform settings API, and media compression utility</name>
  <files>
    src/app/api/drafts/route.ts
    src/app/api/drafts/[id]/route.ts
    src/app/api/platform-settings/route.ts
    src/lib/utils/media-compress.ts
  </files>
  <action>
    **src/app/api/drafts/route.ts:**

    **GET (list user's drafts):**
    - withAuth
    - Fetch Draft WHERE user_id = requesting user, ORDER BY updated_at DESC
    - Return { drafts: [...] }

    **POST (save/upsert draft):**
    - withAuth
    - Zod: { draft_type: enum('post','prayer_request'), body?: string, media_keys?: array of string, metadata?: object (category_id, visibility, is_anonymous, privacy, etc.) }
    - Upsert: check if a draft exists for this user + draft_type. If yes: update it. If no: create new.
    - Only one active draft per type per user (simplifies the model)
    - Return draft object

    **src/app/api/drafts/[id]/route.ts:**

    **DELETE (discard draft):**
    - withAuth
    - Verify ownership
    - Delete draft
    - Return { success: true }

    **src/app/api/platform-settings/route.ts:**

    **GET (read all settings):**
    - withAuth (any authenticated user can read settings to apply them client-side, e.g., feed_style)
    - Fetch all PlatformSetting rows
    - Return as key-value object: { feed_style: 'tiktok', mode_isolation_social: 'true', ... }

    **PUT (update setting â€” admin only):**
    - withAdmin (wraps withAuth + is_admin check)
    - Zod: { key: string, value: string }
    - Validate key exists in platform_settings table (prevent creating arbitrary keys)
    - Update the value
    - Return updated setting

    **src/lib/utils/media-compress.ts:**
    - Import sharp
    - Export `compressImage(inputBuffer: Buffer, options?: { maxWidth?: number, quality?: number }): Promise<{ buffer: Buffer, width: number, height: number, format: string }>`
      - Default maxWidth: 1200px, quality: 85
      - Resize if wider than maxWidth (maintain aspect ratio)
      - Convert to WebP format
      - Return compressed buffer with metadata
    - Export `generateVideoThumbnail(videoUrl: string): Promise<Buffer | null>`
      - For now, return null (video thumbnail generation can be deferred to a background job or use the first frame approach later)
      - Leave as a stub with a TODO comment for future implementation
    - This utility is used by the post media upload confirmation flow
  </action>
  <verify>
    - `npm run build` passes
    - POST /api/drafts saves a draft, GET returns it
    - GET /api/platform-settings returns all settings as key-value object
    - PUT /api/platform-settings updates a setting (admin only, non-admin gets 403)
    - compressImage reduces a test image to WebP
  </verify>
  <done>Draft API with upsert per type, platform settings API with admin-only write, image compression utility with sharp WebP conversion.</done>
</task>

<task type="auto">
  <name>Task 2: Create useDraft auto-save hook</name>
  <files>
    src/hooks/useDraft.ts
  </files>
  <action>
    **src/hooks/useDraft.ts:**
    - Hook: `useDraft(draftType: 'post' | 'prayer_request')`
    - State: draft (body, media_keys, metadata), loading, saving, lastSaved (timestamp)
    - On mount: fetch existing draft from GET /api/drafts, populate state if found
    - `updateDraft(updates: Partial<DraftData>)`: merge updates into local state, trigger debounced save
    - Debounced auto-save: 2000ms after last change, POST to /api/drafts with current state
    - `clearDraft()`: DELETE /api/drafts/[id], reset local state
    - `getDraftData()`: return current draft state for use when submitting the post
    - On unmount (useEffect cleanup): if there are unsaved changes, save immediately (flush)
    - Return { draft, loading, saving, lastSaved, updateDraft, clearDraft, getDraftData }
  </action>
  <verify>
    - `npm run build` passes
    - Hook loads existing draft on mount
    - Debounced save triggers after 2s of no changes
    - clearDraft removes the draft
  </verify>
  <done>Auto-save draft hook with 2s debounce, mount-time load, unmount flush, and clear functionality. Ready for PostComposer integration.</done>
</task>

</tasks>

<verification>
- Draft auto-save persists across page navigations
- Platform settings readable by any user, writable only by admin
- Image compression produces WebP output smaller than input
- Build passes
</verification>

<success_criteria>
- Draft system with auto-save and resume
- Platform settings CRUD for admin configuration
- Media compression pipeline for post images
- All APIs properly authenticated
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-09-SUMMARY.md`
</output>
