---
phase: 02-core-social
plan: 09
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/app/api/reports/route.ts
  - src/components/social/ReportModal.tsx
  - src/app/api/categories/route.ts
  - src/app/api/categories/[slug]/subscribe/route.ts
autonomous: true

must_haves:
  truths:
    - "User can report a post or comment with a reason selection"
    - "Reports are stored with status tracking for admin review"
    - "User can subscribe/unsubscribe to categories"
    - "Category list includes subscription status for current user"
  artifacts:
    - path: "src/app/api/reports/route.ts"
      provides: "Report submission API"
      exports: ["POST"]
    - path: "src/components/social/ReportModal.tsx"
      provides: "Report reason selection modal"
      exports: ["ReportModal"]
    - path: "src/app/api/categories/[slug]/subscribe/route.ts"
      provides: "Category subscription toggle"
      exports: ["POST"]
  key_links:
    - from: "src/components/social/ReportModal.tsx"
      to: "/api/reports"
      via: "fetch POST on submit"
      pattern: "fetch.*api/reports"
---

<objective>
Create the report submission system (API + modal UI) and category subscription endpoint.

Purpose: Reports provide user-driven moderation. Category subscriptions enable personalized content feeds. These are lower-complexity supporting features needed before the main UI pages.
Output: 2 API route files, 1 component, 1 existing route update.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-02-SUMMARY.md

@src/app/api/categories/route.ts
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/lib/db/models/index.ts
@src/components/ui/Modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create report API and category subscription API</name>
  <files>
    src/app/api/reports/route.ts
    src/app/api/categories/[slug]/subscribe/route.ts
    src/app/api/categories/route.ts
  </files>
  <action>
    **src/app/api/reports/route.ts:**

    POST: withAuth. Body (Zod validated): { post_id?: number, comment_id?: number, content_type: enum('post','comment'), reason: enum('spam','harassment','hate_speech','inappropriate','misinformation','other'), details?: string (max 1000) }. Validate that exactly one of post_id/comment_id is provided matching content_type. Prevent duplicate reports (same reporter + same content). Create Report with status='pending'. Return 201 with success message. Do NOT return the report details to the reporter.

    **src/app/api/categories/[slug]/subscribe/route.ts:**

    POST: withAuth. Toggle subscription: check if UserCategory exists for (user_id, category_id matched by slug). If exists, destroy (unsubscribe). If not, create (subscribe). Return { action: 'subscribed' | 'unsubscribed', category }.

    **Update src/app/api/categories/route.ts (GET):**
    The existing GET /api/categories returns all categories. Enhance it: if the request has a valid auth cookie (use withOptionalAuth), also return is_subscribed boolean for each category and subscriber_count. If no auth, just return categories as before.
  </action>
  <verify>
    1. POST /api/reports with { post_id: 1, content_type: 'post', reason: 'spam' } — returns 201
    2. Duplicate report from same user returns error
    3. POST /api/categories/prayer-requests/subscribe — toggles subscription
    4. GET /api/categories (authenticated) — includes is_subscribed per category
  </verify>
  <done>Report API stores reports for admin review. Category subscription toggles. Category list includes subscription status for authenticated users.</done>
</task>

<task type="auto">
  <name>Task 2: Create ReportModal component</name>
  <files>src/components/social/ReportModal.tsx</files>
  <action>
    Modal component for reporting content. Uses the Modal component from UI library. Props: isOpen, onClose, contentType ('post' | 'comment'), contentId (number).

    UI:
    - Title: "Report [Post/Comment]"
    - Radio button list of reasons: Spam, Harassment, Hate Speech, Inappropriate Content, Misinformation, Other
    - When "Other" selected, show optional textarea for details (max 1000 chars)
    - Submit button (disabled until reason selected)
    - On submit: POST to /api/reports, show success toast ("Report submitted. We'll review it shortly."), close modal
    - On error: show error toast

    Style: Use standard modal styling (not glass). Use cn() for classes. Use Button from UI library.
  </action>
  <verify>npm run build — no TypeScript errors. ReportModal renders with reason selection.</verify>
  <done>ReportModal provides reason selection and submits report to API with success/error feedback.</done>
</task>

</tasks>

<verification>
1. Report submission works with all reason types
2. Duplicate report prevention works
3. Category subscription toggle creates/destroys UserCategory records
4. Category list includes is_subscribed when authenticated
5. ReportModal shows correct reasons and submits successfully
</verification>

<success_criteria>
- Reports stored with pending status for admin review
- No duplicate reports allowed from same user for same content
- Category subscription uses existing UserCategory table
- ReportModal provides clear UX with reason selection
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-09-SUMMARY.md`
</output>
