---
phase: 02-core-social
plan: 10
type: execute
wave: 4
depends_on: ["02-04", "02-05", "02-06", "02-08"]
files_modified:
  - src/app/(app)/feed/page.tsx
  - src/components/feed/PostCard.tsx
  - src/components/feed/PostCardInstagram.tsx
  - src/components/feed/PostCardTikTok.tsx
  - src/components/feed/PostFeed.tsx
  - src/components/feed/FeedTabs.tsx
  - src/components/feed/MediaCarousel.tsx
  - src/components/feed/PostContextMenu.tsx
  - src/components/feed/TextPostGradient.tsx
  - src/components/feed/EmptyFeedState.tsx
  - src/hooks/usePlatformSettings.ts
autonomous: true

must_haves:
  truths:
    - "Feed page displays posts with FYP/Following tab toggle"
    - "Feed supports two display styles: TikTok (full-screen swipe) and Instagram (card scroll)"
    - "Admin-toggled feed_style setting controls which style is active"
    - "Posts display author avatar, name, timestamp, body text, and media carousel"
    - "Post cards show reaction counts, comment count, bookmark icon, repost button"
    - "TikTok mode: full-screen vertical swipe with right-side action buttons"
    - "Instagram mode: card-based scrollable feed with shadows and rounded corners"
    - "Text-only posts in TikTok mode show centered text on gradient background"
    - "Infinite scroll loads more posts as user scrolls"
    - "Empty feed state shows follow suggestions"
    - "Post context menu: Bookmark, Report, Block (Edit/Delete for own posts)"
    - "Media carousel displays up to 10 images/videos in swipeable horizontal scroll"
  artifacts:
    - path: "src/app/(app)/feed/page.tsx"
      provides: "Feed page with tab toggle, search bar, post list"
      exports: ["default"]
    - path: "src/components/feed/PostCard.tsx"
      provides: "Unified PostCard that delegates to Instagram or TikTok variant"
      exports: ["PostCard"]
    - path: "src/components/feed/PostFeed.tsx"
      provides: "Post feed list with infinite scroll and style switching"
      exports: ["PostFeed"]
  key_links:
    - from: "src/app/(app)/feed/page.tsx"
      to: "src/hooks/useFeed.ts"
      via: "useFeed hook for data"
      pattern: "useFeed"
    - from: "src/components/feed/PostFeed.tsx"
      to: "src/hooks/useInfiniteScroll.ts"
      via: "Infinite scroll trigger"
      pattern: "useInfiniteScroll"
    - from: "src/components/feed/PostCard.tsx"
      to: "src/hooks/usePlatformSettings.ts"
      via: "Read feed_style to determine TikTok vs Instagram"
      pattern: "usePlatformSettings|feed_style"
---

<objective>
Build the social feed page UI with dual display modes (TikTok and Instagram), including PostCard variants, media carousel, action buttons, context menu, empty state, and the feed page layout with FYP/Following tabs and user search bar.

Purpose: The feed is the primary content consumption surface. It must support admin-toggled display styles (TikTok full-screen swipe vs Instagram card scroll), rich post cards with all interaction buttons, and infinite scroll with pull-to-refresh.
Output: 1 page, 9 components, 1 hook.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-06-SUMMARY.md
@.planning/phases/02-core-social/02-04-SUMMARY.md
@.planning/phases/02-core-social/02-05-SUMMARY.md
@.planning/phases/02-core-social/02-08-SUMMARY.md
@src/components/daily/DailyPostSlide.tsx
@src/components/layout/BottomNav.tsx
@src/components/social/FollowButton.tsx
@src/components/social/UserSearchResult.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostCard variants (Instagram + TikTok), MediaCarousel, and supporting components</name>
  <files>
    src/components/feed/PostCardInstagram.tsx
    src/components/feed/PostCardTikTok.tsx
    src/components/feed/PostCard.tsx
    src/components/feed/MediaCarousel.tsx
    src/components/feed/PostContextMenu.tsx
    src/components/feed/TextPostGradient.tsx
    src/components/feed/FeedTabs.tsx
    src/components/feed/EmptyFeedState.tsx
    src/hooks/usePlatformSettings.ts
  </files>
  <action>
    **src/hooks/usePlatformSettings.ts:**
    - Hook: `usePlatformSettings()`
    - Fetch GET /api/platform-settings on mount
    - Cache in state, provide getter: `getSetting(key: string): string | null`
    - Specifically expose: feedStyle ('tiktok' | 'instagram'), modeIsolation (boolean)
    - Return { settings, feedStyle, modeIsolation, loading }

    **src/components/feed/MediaCarousel.tsx:**
    - Props: media (array of { id, media_type, url, thumbnail_url, width, height, duration, sort_order })
    - Horizontal swipeable carousel (like Instagram)
    - If 1 item: display as single image/video (no pagination dots)
    - If 2+ items: horizontal scroll with snap-to-item, pagination dots
    - Images: <img> with object-fit cover, lazy loading
    - Videos: <video> with poster={thumbnail_url}, autoPlay muted when visible (using IntersectionObserver), loop, playsInline
    - Video max duration badge: show "0:30" duration overlay
    - Rounded corners on media container
    - Aspect ratio: use the media dimensions if available, fallback to 1:1

    **src/components/feed/PostContextMenu.tsx:**
    - Props: postId, authorId, currentUserId, onBookmark, onReport, onBlock, onEdit, onDelete
    - Triggered by '...' button on post card
    - Shows dropdown with:
      - Bookmark / Unbookmark
      - Report
      - Block User (not shown if own post)
      - Edit (only if own post)
      - Delete (only if own post)
    - Dark mode, cn() styling
    - Closes on outside click

    **src/components/feed/TextPostGradient.tsx:**
    - Props: text: string
    - For TikTok mode text-only posts (no media)
    - Full-screen gradient background with centered text
    - Gradient: random selection from predefined set (deep blue, purple, sunset, forest green, warm orange, midnight, etc.)
    - Text: white, large font (text-2xl or text-3xl), centered, with shadow for readability
    - Gradient should be deterministic per post ID (so it doesn't change on re-render)

    **src/components/feed/PostCardInstagram.tsx:**
    - Instagram-style card layout:
      - Header: author avatar + display_name + relative timestamp + '...' context menu
      - Body: text content, truncated at ~5 lines with "Read more" to expand
      - Text supports @mentions (bold, clickable -> profile) and #hashtags (styled blue, not clickable per CONTEXT)
      - Media carousel (if media present)
      - If quote repost: embedded original post card (smaller, nested)
      - Action bar: reaction button (opens picker) + comment button + repost button + bookmark button (right-aligned)
      - Reaction counts (PostReactionBar compact)
      - Comment preview: top 1-2 comments with "View all X comments" link
      - Counts: total reactions, comment count, repost count
    - Card styling: bg-surface rounded-2xl shadow-sm p-4, dark mode
    - On comment button click: open PostCommentSheet
    - On card tap (not button): navigate to post detail page

    **src/components/feed/PostCardTikTok.tsx:**
    - Full-screen style (100vh - nav heights):
      - If has media: media takes full screen background, text overlaid at bottom
      - If text-only: TextPostGradient background with centered text
    - Right side vertical action stack (like TikTok):
      - Author avatar (circle, tappable -> profile)
      - Reaction button (heart icon) + count
      - Comment button + count
      - Repost button + count
      - Bookmark button
    - Bottom overlay: author name + text content (truncated, expand on tap)
    - Snap-to-post behavior (CSS scroll-snap on the container)
    - Videos auto-play muted, tap to unmute
    - '...' context menu in top right

    **src/components/feed/PostCard.tsx:**
    - Unified wrapper that renders PostCardInstagram or PostCardTikTok based on feedStyle
    - Props: post (full enriched post object from feed API), feedStyle: 'tiktok' | 'instagram'
    - Delegates to the appropriate variant component
    - Handles common state: reaction toggle, comment sheet open/close, bookmark toggle

    **src/components/feed/FeedTabs.tsx:**
    - Props: activeTab ('fyp' | 'following'), onTabChange
    - Sticky tabs bar below the top bar
    - Two tabs: "For You" and "Following"
    - Active tab has underline indicator
    - Animated tab indicator slide
    - cn() for styling

    **src/components/feed/EmptyFeedState.tsx:**
    - Shows when feed has zero posts
    - Message: "Your feed is empty. Follow people to see their posts here!"
    - Include follow suggestions (reuse the follow suggestions API from 02-03)
    - "Find Friends" button linking to search
    - Illustration or icon
  </action>
  <verify>
    - `npm run build` passes
    - PostCard renders both variants based on feedStyle prop
    - MediaCarousel handles single and multi-media
    - TextPostGradient shows gradient with centered text
    - FeedTabs switches between FYP and Following
  </verify>
  <done>All feed components built: PostCard with Instagram/TikTok variants, MediaCarousel, TextPostGradient, PostContextMenu, FeedTabs, EmptyFeedState. usePlatformSettings hook reads admin configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Build feed page with PostFeed list, infinite scroll, and search bar</name>
  <files>
    src/app/(app)/feed/page.tsx
    src/components/feed/PostFeed.tsx
  </files>
  <action>
    **src/components/feed/PostFeed.tsx:**
    - Props: posts, loading, hasMore, onLoadMore, feedStyle, refreshing
    - If feedStyle === 'tiktok':
      - Vertical scroll container with `scroll-snap-type: y mandatory`
      - Each PostCardTikTok wrapped in `scroll-snap-align: start` container (100vh)
      - Last item triggers onLoadMore via useInfiniteScroll
    - If feedStyle === 'instagram':
      - Standard vertical scroll with PostCardInstagram cards
      - Gap between cards (space-y-4)
      - Sentinel div at bottom with useInfiniteScroll ref
    - Loading state: skeleton cards or spinner at bottom
    - Empty state: render EmptyFeedState
    - Pull-to-refresh: implement using onTouchStart/onTouchMove/onTouchEnd with threshold (pull down > 80px triggers refresh). Show spinner during refresh.

    **src/app/(app)/feed/page.tsx:**
    - Replace existing placeholder page
    - Uses useFeed hook for data
    - Uses usePlatformSettings for feedStyle
    - Uses useUserSearch for search bar
    - Layout:
      - User search bar at top (input with search icon, shows UserSearchResult dropdown)
      - FeedTabs (FYP / Following) sticky below search
      - PostFeed component with the active tab's posts
    - Search results overlay: when search has results, show dropdown over feed
    - Handle tab switching: setActiveTab triggers re-fetch
    - Page title: "Feed" (or no title in TikTok mode for immersive experience)
  </action>
  <verify>
    - `npm run build` passes
    - Feed page renders with FYP tab active by default
    - Switching to Following tab shows different content
    - Infinite scroll loads more posts
    - Search bar shows user results
    - Both TikTok and Instagram styles render correctly
  </verify>
  <done>Feed page complete with FYP/Following tabs, user search bar, infinite scroll, pull-to-refresh, and dual display mode (TikTok full-screen swipe / Instagram card scroll). Post cards show all interaction buttons.</done>
</task>

</tasks>

<verification>
- Feed page renders posts in both TikTok and Instagram styles
- FYP/Following tab switching works
- Infinite scroll loads more posts
- Pull-to-refresh resets feed
- Post cards show author, text, media, reactions, comments, bookmarks
- Context menu shows appropriate actions
- Search bar at top with user results
- Empty feed shows follow suggestions
- Text-only posts show gradient background in TikTok mode
- Media carousel swipes horizontally with pagination dots
</verification>

<success_criteria>
- Dual feed style (TikTok + Instagram) controlled by admin setting
- FYP and Following tabs
- Rich post cards with all interaction buttons
- Media carousel for multi-media posts
- Infinite scroll with pull-to-refresh
- User search at top of feed
- Empty state with follow suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-10-SUMMARY.md`
</output>
