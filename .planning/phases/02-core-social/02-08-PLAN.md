---
phase: 02-core-social
plan: 08
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/api/bookmarks/route.ts
  - src/app/api/reposts/route.ts
  - src/app/api/blocks/route.ts
  - src/app/api/reports/route.ts
  - src/hooks/useBookmark.ts
  - src/hooks/useRepost.ts
  - src/components/social/BookmarkButton.tsx
  - src/components/social/RepostButton.tsx
  - src/components/social/ReportModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can bookmark/unbookmark a post (toggle)"
    - "User can view their bookmarked posts"
    - "User can quote-repost a post to their own feed"
    - "User can block/unblock another user"
    - "Blocking auto-unfollows both directions"
    - "User can report a post or comment with reason selection"
    - "Reports create pending items in the moderation queue"
  artifacts:
    - path: "src/app/api/bookmarks/route.ts"
      provides: "GET bookmarks list, POST toggle bookmark"
      exports: ["GET", "POST"]
    - path: "src/app/api/reposts/route.ts"
      provides: "POST create quote repost"
      exports: ["POST"]
    - path: "src/app/api/blocks/route.ts"
      provides: "GET blocked list, POST toggle block"
      exports: ["GET", "POST"]
    - path: "src/app/api/reports/route.ts"
      provides: "POST create report"
      exports: ["POST"]
    - path: "src/components/social/ReportModal.tsx"
      provides: "Report modal with reason selection"
      exports: ["ReportModal"]
  key_links:
    - from: "src/app/api/blocks/route.ts"
      to: "src/lib/db/models/Follow.ts"
      via: "Auto-unfollow on block"
      pattern: "Follow\\.destroy"
    - from: "src/app/api/reposts/route.ts"
      to: "src/lib/db/models/Post.ts"
      via: "Creates new quote post + Repost record"
      pattern: "Post\\.create.*Repost\\.create"
---

<objective>
Build the bookmark, repost, block, and report systems — API routes, hooks, and UI components.

Purpose: These are the interaction features that appear in post context menus and action bars. Bookmarks allow saving posts, reposts enable content sharing within the platform (no external sharing per CONTEXT), blocks protect users, and reports feed the moderation system.
Output: 4 API route files, 2 hooks, 3 components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-02-SUMMARY.md
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bookmark, repost, block, and report API routes</name>
  <files>
    src/app/api/bookmarks/route.ts
    src/app/api/reposts/route.ts
    src/app/api/blocks/route.ts
    src/app/api/reports/route.ts
  </files>
  <action>
    **src/app/api/bookmarks/route.ts:**

    **GET (list bookmarks):**
    - withAuth
    - Query params: cursor, limit (default 20), type ('post' | 'daily' | 'all', default 'all')
    - Fetch Bookmark WHERE user_id = requesting user
    - If type='post': WHERE post_id IS NOT NULL; include Post with author, media
    - If type='daily': WHERE daily_content_id IS NOT NULL; include DailyContent
    - Cursor pagination by created_at DESC
    - Return { bookmarks: [...], next_cursor, has_more }

    **POST (toggle bookmark):**
    - withAuth
    - Zod: { post_id?: number, daily_content_id?: number } — exactly one must be non-null
    - Validate the referenced content exists
    - Check if bookmark exists:
      - Exists: delete (unbookmark), return { action: 'removed' }
      - Not exists: create, return { action: 'added' }
    - Per CONTEXT: No bookmarks on prayer requests — validate post_type != 'prayer_request'

    **src/app/api/reposts/route.ts:**

    **POST (create quote repost):**
    - withAuth
    - Zod: { original_post_id: number, body: string (1-5000) } — body is the user's quote comment
    - Validate original post exists, is not deleted, and is not from a blocked user
    - Per CONTEXT: prayer requests CAN be quote-reposted to the social feed
    - Run profanity check on body (flag, don't block)
    - Create a new Post (type='text', body=quote body, mode=user.mode)
    - Create Repost record (user_id, post_id=original_post_id, quote_post_id=new post id)
    - Return 201 with the quote post data including embedded original post

    **src/app/api/blocks/route.ts:**

    **GET (blocked users list):**
    - withAuth
    - Fetch Block WHERE blocker_id = requesting user
    - Include blocked User (id, username, display_name, avatar_url)
    - Return { blocked_users: [...] }

    **POST (toggle block):**
    - withAuth
    - Zod: { user_id: number }
    - Prevent self-block (return 400)
    - Check if block exists:
      - Exists: delete (unblock), return { action: 'unblocked' }
      - Not exists: create block, THEN auto-unfollow both directions:
        - Delete Follow WHERE (follower_id=me AND following_id=target) OR (follower_id=target AND following_id=me)
      - Return { action: 'blocked' }

    **src/app/api/reports/route.ts:**

    **POST (create report):**
    - withAuth
    - Zod: { post_id?: number, comment_id?: number, content_type: 'post' | 'comment', reason: enum('spam','harassment','hate_speech','inappropriate','self_harm','other'), details?: string (max 1000) }
    - Validate the content exists
    - Check for duplicate report (same reporter, same content): if exists, return 409 "Already reported"
    - Create Report with status='pending'
    - Return 201 { success: true, report_id }
  </action>
  <verify>
    - `npm run build` passes
    - Bookmark toggle creates/removes bookmark
    - Repost creates new post with embedded original
    - Block auto-unfollows both directions
    - Report creates pending moderation item
  </verify>
  <done>Bookmark, repost, block, and report APIs complete. Bookmark toggle with no-prayer-request validation. Quote repost creates new post linked to original. Block with auto-unfollow. Report with duplicate prevention.</done>
</task>

<task type="auto">
  <name>Task 2: Create hooks and UI components (BookmarkButton, RepostButton, ReportModal)</name>
  <files>
    src/hooks/useBookmark.ts
    src/hooks/useRepost.ts
    src/components/social/BookmarkButton.tsx
    src/components/social/RepostButton.tsx
    src/components/social/ReportModal.tsx
  </files>
  <action>
    **src/hooks/useBookmark.ts:**
    - Hook: `useBookmark(postId: number, initialBookmarked: boolean)`
    - State: isBookmarked, loading
    - `toggle()`: Optimistic update — flip isBookmarked, POST to /api/bookmarks { post_id }. On error: rollback.
    - Return { isBookmarked, loading, toggle }

    **src/hooks/useRepost.ts:**
    - Hook: `useRepost()`
    - State: submitting
    - `createRepost(originalPostId: number, body: string)`: POST to /api/reposts, return the new post on success
    - Return { submitting, createRepost }

    **src/components/social/BookmarkButton.tsx:**
    - Props: postId, initialBookmarked, size ('sm' | 'md')
    - Uses useBookmark hook
    - Renders Bookmark icon (lucide-react) — filled when bookmarked, outline when not
    - Disabled while loading
    - Accessible aria-label: "Bookmark post" / "Remove bookmark"
    - cn() for styling

    **src/components/social/RepostButton.tsx:**
    - Props: postId, repostCount: number, onRepost?: (newPost) => void
    - Clicking opens a quote repost modal/input
    - Shows repost count
    - Uses useRepost hook internally
    - Quote input: textarea for user's comment + "Repost" button
    - Renders as icon button (Repeat2 icon from lucide-react)
    - cn() for styling

    **src/components/social/ReportModal.tsx:**
    - Props: isOpen, onClose, contentType ('post' | 'comment'), contentId: number
    - Modal overlay with reason selection
    - Reason options as radio buttons: Spam, Harassment, Hate speech, Inappropriate content, Self-harm, Other
    - Optional details textarea (shown for all reasons, but especially for "Other")
    - Submit button calls POST /api/reports
    - Success state: "Report submitted. Our team will review it."
    - Use existing Modal component from @/components/ui/Modal
    - cn() for styling, dark mode
  </action>
  <verify>
    - `npm run build` passes
    - BookmarkButton toggles icon state
    - RepostButton opens quote input and creates repost
    - ReportModal displays reasons and submits report
  </verify>
  <done>Bookmark toggle button, repost button with quote input, and report modal with reason selection — all with proper hooks and optimistic updates. Ready for integration into PostCard.</done>
</task>

</tasks>

<verification>
- Bookmark toggle works end-to-end (UI + API)
- Quote repost creates new post with embedded original
- Block toggle auto-unfollows and returns correct action
- Report creates pending moderation item
- No bookmarks allowed on prayer requests
- All UI components render correctly
</verification>

<success_criteria>
- Bookmark system with toggle and list view
- Quote repost (no external sharing)
- Block with bidirectional auto-unfollow
- Report with reason selection and duplicate prevention
- Reusable components for PostCard integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-08-SUMMARY.md`
</output>
