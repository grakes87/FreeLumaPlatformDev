---
phase: 02-core-social
plan: 08
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/app/api/bookmarks/route.ts
  - src/app/api/bookmarks/folders/route.ts
  - src/hooks/useBookmark.ts
  - src/components/social/BookmarkButton.tsx
  - src/components/social/ShareButton.tsx
  - src/lib/utils/share.ts
autonomous: true

must_haves:
  truths:
    - "User can bookmark a post"
    - "User can unbookmark a bookmarked post"
    - "User can bookmark daily content"
    - "User can view paginated list of bookmarked content"
    - "User can create bookmark folders and organize bookmarks"
    - "User can share a post via Web Share API or copy link"
  artifacts:
    - path: "src/app/api/bookmarks/route.ts"
      provides: "Bookmark toggle and list"
      exports: ["GET", "POST"]
    - path: "src/app/api/bookmarks/folders/route.ts"
      provides: "Bookmark folder CRUD"
      exports: ["GET", "POST", "PUT", "DELETE"]
    - path: "src/hooks/useBookmark.ts"
      provides: "Bookmark state with optimistic toggle"
      exports: ["useBookmark"]
    - path: "src/components/social/BookmarkButton.tsx"
      provides: "Bookmark toggle button"
      exports: ["BookmarkButton"]
    - path: "src/lib/utils/share.ts"
      provides: "Share utility with Web Share API fallback"
      exports: ["sharePost", "shareContent"]
    - path: "src/components/social/ShareButton.tsx"
      provides: "Share button component"
      exports: ["ShareButton"]
  key_links:
    - from: "src/components/social/BookmarkButton.tsx"
      to: "src/hooks/useBookmark.ts"
      via: "hook consumption"
      pattern: "useBookmark"
    - from: "src/hooks/useBookmark.ts"
      to: "/api/bookmarks"
      via: "fetch POST toggle"
      pattern: "fetch.*api/bookmarks"
    - from: "src/lib/utils/share.ts"
      to: "navigator.share"
      via: "Web Share API with clipboard fallback"
      pattern: "navigator\\.share"
---

<objective>
Create the bookmark system (API, folders, hook, button), share utility (Web Share API + clipboard fallback), and share button.

Purpose: Bookmarks let users save content for later. Folders provide organization. Sharing extends reach beyond the platform. These are engagement features that appear on every PostCard.
Output: 2 API route files, 1 hook, 2 components, 1 utility.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-02-SUMMARY.md

@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bookmark API and folder API</name>
  <files>
    src/app/api/bookmarks/route.ts
    src/app/api/bookmarks/folders/route.ts
  </files>
  <action>
    **src/app/api/bookmarks/route.ts:**

    GET: withAuth. Query params: folder_id (optional, filter by folder), type ('post' | 'daily' | 'all', default 'all'), cursor, limit (default 20). Fetch user's bookmarks with cursor pagination. Include Post (with author) for post bookmarks, include DailyContent for daily content bookmarks. Order by created_at DESC. Return { bookmarks, next_cursor, has_more }.

    POST: withAuth. Body: { post_id?: number, daily_content_id?: number, folder_id?: number | null }. Exactly one of post_id or daily_content_id must be provided (validate). Toggle: if bookmark exists for (user_id, post_id) or (user_id, daily_content_id), destroy it (unbookmark). If not, create it (bookmark). If folder_id provided, assign to folder. Return { action: 'bookmarked' | 'unbookmarked' }.

    PUT: withAuth. Body: { bookmark_id: number, folder_id: number | null }. Move bookmark to a different folder (or remove from folder with null). Only owner can move. Return updated bookmark.

    **src/app/api/bookmarks/folders/route.ts:**

    GET: withAuth. Return all bookmark folders for current user, ordered by sort_order. Include bookmark count per folder.

    POST: withAuth. Body: { name: string (1-100) }. Limit to 20 folders per user. Create folder with next sort_order. Return created folder.

    PUT: withAuth. Body: { id: number, name?: string, sort_order?: number }. Update folder name or sort order. Only owner.

    DELETE: withAuth. Body: { id: number }. Delete folder. Set folder_id = null on all bookmarks in that folder (don't delete bookmarks). Only owner.
  </action>
  <verify>
    1. POST /api/bookmarks with { post_id: 1 } — toggles bookmark
    2. GET /api/bookmarks — returns bookmarked content
    3. POST /api/bookmarks/folders with { name: "Favorites" } — creates folder
    4. PUT /api/bookmarks with { bookmark_id: 1, folder_id: 1 } — moves to folder
  </verify>
  <done>Bookmark toggle works for both posts and daily content. Folder CRUD works with bookmark reorganization.</done>
</task>

<task type="auto">
  <name>Task 2: Create useBookmark hook, BookmarkButton, share utility, and ShareButton</name>
  <files>
    src/hooks/useBookmark.ts
    src/components/social/BookmarkButton.tsx
    src/components/social/ShareButton.tsx
    src/lib/utils/share.ts
  </files>
  <action>
    **src/hooks/useBookmark.ts:**
    Hook takes contentId and contentType ('post' | 'daily'), plus optional initialIsBookmarked. Manages isBookmarked state. Exposes toggle() with optimistic update: flip state, POST to /api/bookmarks, rollback on error. Also exposes loading state.

    **src/components/social/BookmarkButton.tsx:**
    Button showing Bookmark icon (from lucide-react). When bookmarked, icon is filled. On tap, toggles via useBookmark. Props: postId or dailyContentId, initialIsBookmarked. Compact design for PostCard use.

    **src/lib/utils/share.ts:**
    Export `sharePost(post: { id: number; body: string }): Promise<boolean>` — builds URL as `${window.location.origin}/post/${post.id}`, truncates body to 100 chars for text. Tries navigator.share() first. On failure or absence, falls back to navigator.clipboard.writeText(url). Returns true on success, false on cancel/error.

    Export `shareContent(url: string, title: string, text: string): Promise<boolean>` — generic share function for any content type (daily content, prayer request).

    **src/components/social/ShareButton.tsx:**
    Button showing Share2 icon (lucide-react). On tap, calls sharePost or shareContent. Shows brief toast on successful copy. Props: postId, postBody (for share text). Uses useToast for feedback. Compact design for PostCard.
  </action>
  <verify>
    npm run build — no TypeScript errors.
    BookmarkButton toggles bookmark icon fill state.
    ShareButton triggers share or copies link.
  </verify>
  <done>Bookmark toggle with optimistic UI. Share utility uses Web Share API with clipboard fallback. Both buttons render compactly for PostCard integration.</done>
</task>

</tasks>

<verification>
1. Bookmark toggle creates/destroys bookmark records
2. Bookmark list returns with post/daily content details
3. Folder CRUD works (create, rename, delete, reorder)
4. Moving bookmarks between folders updates correctly
5. Share utility tries Web Share API, falls back to clipboard
6. BookmarkButton shows filled/unfilled state correctly
7. ShareButton provides feedback via toast
</verification>

<success_criteria>
- Bookmark toggle works for both posts and daily content
- Bookmark folders provide organizational capability (max 20)
- Folder deletion preserves bookmarks (just nulls folder_id)
- Share uses progressive enhancement (native API -> clipboard)
- Both buttons are compact and ready for PostCard integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-08-SUMMARY.md`
</output>
