---
phase: 02-core-social
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/models/Post.ts
  - src/lib/db/models/PostReaction.ts
  - src/lib/db/models/PostComment.ts
  - src/lib/db/models/Follow.ts
  - src/lib/db/models/Bookmark.ts
  - src/lib/db/models/BookmarkFolder.ts
  - src/lib/db/models/PrayerRequest.ts
  - src/lib/db/models/PrayerSupport.ts
  - src/lib/db/models/Report.ts
  - src/lib/db/models/Block.ts
  - src/lib/db/models/index.ts
  - src/lib/db/migrations/016-create-posts.cjs
  - src/lib/db/migrations/017-create-post-reactions.cjs
  - src/lib/db/migrations/018-create-post-comments.cjs
  - src/lib/db/migrations/019-create-follows.cjs
  - src/lib/db/migrations/020-create-bookmarks.cjs
  - src/lib/db/migrations/021-create-bookmark-folders.cjs
  - src/lib/db/migrations/022-create-prayer-requests.cjs
  - src/lib/db/migrations/023-create-prayer-supports.cjs
  - src/lib/db/migrations/024-create-reports.cjs
  - src/lib/db/migrations/025-create-blocks.cjs
  - src/lib/db/migrations/026-add-profile-fields-to-users.cjs
  - package.json
autonomous: true

must_haves:
  truths:
    - "All 11 new database tables exist with correct columns, indexes, and foreign keys"
    - "All 11 new Sequelize models load without import errors"
    - "Model associations are registered (Post->User, Follow->User, etc.)"
    - "New user profile columns (denomination, church, testimony, profile_privacy) exist"
    - "obscenity and react-intersection-observer packages are installed"
  artifacts:
    - path: "src/lib/db/models/Post.ts"
      provides: "Post model with paranoid soft-delete"
      contains: "class Post"
    - path: "src/lib/db/models/Follow.ts"
      provides: "Follow model for social graph"
      contains: "class Follow"
    - path: "src/lib/db/models/Block.ts"
      provides: "Block model for user blocking"
      contains: "class Block"
    - path: "src/lib/db/models/index.ts"
      provides: "All models registered with associations"
      contains: "Post"
  key_links:
    - from: "src/lib/db/models/Post.ts"
      to: "src/lib/db/models/index.ts"
      via: "import and association registration"
      pattern: "Post\\.belongsTo\\(User"
    - from: "src/lib/db/migrations/016-create-posts.cjs"
      to: "database"
      via: "sequelize db:migrate"
      pattern: "createTable.*posts"
---

<objective>
Install new npm dependencies and create all database infrastructure for Phase 2: 11 new tables via Sequelize CLI migrations, 10 new Sequelize models with TypeScript interfaces, model association registration, and user profile field additions.

Purpose: Every other Phase 2 plan depends on these models and tables existing. This is the foundation layer.
Output: 11 migration files, 10 model files, updated model index, 2 new npm packages installed.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md

@src/lib/db/models/index.ts
@src/lib/db/models/User.ts
@src/lib/db/models/DailyReaction.ts
@src/lib/db/models/DailyComment.ts
@src/lib/db/models/Category.ts
@src/lib/db/migrations/014-create-daily-reactions.cjs
@src/lib/db/migrations/015-create-daily-comments.cjs
@src/lib/db/config.cjs
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create all 11 migrations</name>
  <files>
    package.json
    src/lib/db/migrations/016-create-posts.cjs
    src/lib/db/migrations/017-create-post-reactions.cjs
    src/lib/db/migrations/018-create-post-comments.cjs
    src/lib/db/migrations/019-create-follows.cjs
    src/lib/db/migrations/020-create-bookmarks.cjs
    src/lib/db/migrations/021-create-bookmark-folders.cjs
    src/lib/db/migrations/022-create-prayer-requests.cjs
    src/lib/db/migrations/023-create-prayer-supports.cjs
    src/lib/db/migrations/024-create-reports.cjs
    src/lib/db/migrations/025-create-blocks.cjs
    src/lib/db/migrations/026-add-profile-fields-to-users.cjs
  </files>
  <action>
    1. Run `npm install obscenity react-intersection-observer` to add new dependencies.

    2. Create 11 migration files (.cjs extension for ESM compatibility) following the exact pattern from 014-create-daily-reactions.cjs and 015-create-daily-comments.cjs. Use `module.exports = { async up(queryInterface, Sequelize) {...}, async down(queryInterface) {...} }` pattern.

    **016-create-posts.cjs:** Create `posts` table with columns: id (INT PK AUTO_INCREMENT), user_id (INT NOT NULL FK users.id CASCADE), body (TEXT NOT NULL), image_url (VARCHAR(500) NULL), category_id (INT NULL FK categories.id SET NULL), post_type (ENUM('text','bible_verse','prayer_request') DEFAULT 'text'), bible_reference (VARCHAR(100) NULL), bible_translation (VARCHAR(10) NULL), bible_text (TEXT NULL), visibility (ENUM('public','followers') DEFAULT 'public'), edited (BOOLEAN DEFAULT false), edit_deadline (DATETIME NULL), deleted_at (DATETIME NULL), created_at (DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP), updated_at (DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP). Indexes: (user_id), (category_id), (post_type), (created_at DESC, id DESC), (user_id, created_at DESC).

    **017-create-post-reactions.cjs:** Mirror 014-create-daily-reactions.cjs exactly but for posts. Columns: id, user_id (FK users CASCADE), post_id (FK posts CASCADE), reaction_type (ENUM 'like','love','haha','wow','sad','pray'), created_at, updated_at. Indexes: UNIQUE(user_id, post_id), (post_id, reaction_type).

    **018-create-post-comments.cjs:** Mirror 015-create-daily-comments.cjs but for posts. Columns: id, user_id (FK users CASCADE), post_id (FK posts CASCADE), parent_id (INT NULL self-ref FK post_comments SET NULL), body (TEXT NOT NULL), edited (BOOLEAN DEFAULT false), edit_deadline (DATETIME NULL), created_at, updated_at. Indexes: (post_id, parent_id), (user_id).

    **019-create-follows.cjs:** Columns: id, follower_id (FK users CASCADE), following_id (FK users CASCADE), created_at, updated_at. Indexes: UNIQUE(follower_id, following_id), (following_id).

    **020-create-bookmarks.cjs:** Note: Create bookmark_folders FIRST (021) or handle FK. Actually, make bookmarks reference folders as nullable. Columns: id, user_id (FK users CASCADE), post_id (INT NULL FK posts CASCADE), daily_content_id (INT NULL FK daily_content CASCADE), folder_id (INT NULL -- FK added after 021), created_at, updated_at. Indexes: UNIQUE(user_id, post_id) where post_id is not null (use conditional unique or handle in app), UNIQUE(user_id, daily_content_id) where not null, (folder_id). IMPORTANT: Since folder_id FK requires bookmark_folders table, either: (a) swap order so 021 runs before 020, or (b) leave folder_id as plain INT NULL and add FK in 021 migration. Choose option (b): create bookmarks without folder_id FK, add FK in 021 after bookmark_folders exists. Actually simpler: reorder to 020-create-bookmark-folders, 021-create-bookmarks. Use this reorder.

    **REORDER: 020-create-bookmark-folders.cjs:** Columns: id, user_id (FK users CASCADE), name (VARCHAR(100) NOT NULL), sort_order (INT DEFAULT 0), created_at, updated_at. Index: (user_id).

    **021-create-bookmarks.cjs (was 020):** Columns: id, user_id (FK users CASCADE), post_id (INT NULL FK posts CASCADE), daily_content_id (INT NULL FK daily_content CASCADE), folder_id (INT NULL FK bookmark_folders SET NULL), created_at, updated_at. Indexes: unique index on (user_id, post_id) named bookmarks_user_post_unique, unique index on (user_id, daily_content_id) named bookmarks_user_daily_unique, (folder_id).

    **022-create-prayer-requests.cjs:** Columns: id, post_id (INT NOT NULL FK posts CASCADE, UNIQUE), privacy (ENUM('public','followers','private') DEFAULT 'public'), status (ENUM('active','answered') DEFAULT 'active'), answered_at (DATETIME NULL), answered_testimony (TEXT NULL), pray_count (INT DEFAULT 0), created_at, updated_at. Indexes: (status), (post_id) already unique.

    **023-create-prayer-supports.cjs:** Columns: id, user_id (FK users CASCADE), prayer_request_id (FK prayer_requests CASCADE), created_at, updated_at. Indexes: UNIQUE(user_id, prayer_request_id), (prayer_request_id).

    **024-create-reports.cjs:** Columns: id, reporter_id (FK users CASCADE), post_id (INT NULL FK posts SET NULL), comment_id (INT NULL), content_type (ENUM('post','comment') NOT NULL), reason (ENUM('spam','harassment','hate_speech','inappropriate','misinformation','other') NOT NULL), details (TEXT NULL), status (ENUM('pending','reviewed','actioned','dismissed') DEFAULT 'pending'), created_at, updated_at. Indexes: (status), (reporter_id).

    **025-create-blocks.cjs:** Columns: id, blocker_id (FK users CASCADE), blocked_id (FK users CASCADE), created_at, updated_at. Indexes: UNIQUE(blocker_id, blocked_id), (blocked_id).

    **026-add-profile-fields-to-users.cjs:** Add columns to users table: denomination (VARCHAR(100) NULL), church (VARCHAR(200) NULL), testimony (TEXT NULL), profile_privacy (ENUM('public','followers','private') DEFAULT 'public'). Down removes these columns.

    3. Run `npx sequelize-cli db:migrate` to execute all migrations.
  </action>
  <verify>
    Run `npx sequelize-cli db:migrate:status` and confirm all 26 migrations show "up".
    Run `mysql -u root -p"Luma!2026#R9vK3pT7xQ2mZ5sN8cH1yW4" freeluma_dev -e "SHOW TABLES"` and verify all new tables exist.
  </verify>
  <done>All 11 new tables exist in the database with correct columns, indexes, and foreign keys. Both new npm packages installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create all 10 new Sequelize models and update model index</name>
  <files>
    src/lib/db/models/Post.ts
    src/lib/db/models/PostReaction.ts
    src/lib/db/models/PostComment.ts
    src/lib/db/models/Follow.ts
    src/lib/db/models/Bookmark.ts
    src/lib/db/models/BookmarkFolder.ts
    src/lib/db/models/PrayerRequest.ts
    src/lib/db/models/PrayerSupport.ts
    src/lib/db/models/Report.ts
    src/lib/db/models/Block.ts
    src/lib/db/models/index.ts
  </files>
  <action>
    Create 10 new Sequelize model files following the exact same TypeScript pattern as DailyReaction.ts and DailyComment.ts (use Model.init() with explicit DataTypes, tableName, timestamps, underscored: false). Each model should export the class and a TypeScript interface for the attributes.

    **Post.ts:** Model with paranoid: true (soft delete via deleted_at). Fields match the migration. Include PostAttributes and PostCreationAttributes interfaces. Use `paranoid: true` in model options.

    **PostReaction.ts:** Mirror DailyReaction.ts but with post_id instead of daily_content_id.

    **PostComment.ts:** Mirror DailyComment.ts but with post_id instead of daily_content_id. Include parent_id for threading, edited, edit_deadline.

    **Follow.ts:** Simple model with follower_id, following_id.

    **Bookmark.ts:** Model with user_id, post_id (nullable), daily_content_id (nullable), folder_id (nullable).

    **BookmarkFolder.ts:** Model with user_id, name, sort_order.

    **PrayerRequest.ts:** Model with post_id, privacy, status, answered_at, answered_testimony, pray_count.

    **PrayerSupport.ts:** Model with user_id, prayer_request_id.

    **Report.ts:** Model with reporter_id, post_id, comment_id, content_type, reason, details, status.

    **Block.ts:** Model with blocker_id, blocked_id.

    **Update index.ts:** Import all 10 new models. Register ALL associations:
    - User hasMany Post (as 'posts'), Post belongsTo User (as 'author')
    - Category hasMany Post, Post belongsTo Category (as 'category')
    - User hasMany PostReaction, PostReaction belongsTo User
    - Post hasMany PostReaction (as 'reactions'), PostReaction belongsTo Post
    - User hasMany PostComment, PostComment belongsTo User
    - Post hasMany PostComment (as 'comments'), PostComment belongsTo Post
    - PostComment hasMany PostComment (self-ref parent_id, as 'replies'), PostComment belongsTo PostComment (as 'parent')
    - User hasMany Follow (as follower, foreignKey 'follower_id'), User hasMany Follow (as following, foreignKey 'following_id')
    - Follow belongsTo User (as 'follower', FK follower_id), Follow belongsTo User (as 'following', FK following_id)
    - User hasMany Bookmark, Bookmark belongsTo User
    - Post hasMany Bookmark, Bookmark belongsTo Post
    - DailyContent hasMany Bookmark, Bookmark belongsTo DailyContent
    - BookmarkFolder hasMany Bookmark, Bookmark belongsTo BookmarkFolder
    - User hasMany BookmarkFolder, BookmarkFolder belongsTo User
    - Post hasOne PrayerRequest, PrayerRequest belongsTo Post
    - User hasMany PrayerSupport, PrayerSupport belongsTo User
    - PrayerRequest hasMany PrayerSupport, PrayerSupport belongsTo PrayerRequest
    - User hasMany Report (as reporter, FK reporter_id), Report belongsTo User
    - Post hasMany Report, Report belongsTo Post
    - User hasMany Block (as 'blockedUsers', FK blocker_id), User hasMany Block (as 'blockedBy', FK blocked_id)
    - Block belongsTo User (as 'blocker', FK blocker_id), Block belongsTo User (as 'blocked', FK blocked_id)

    Export ALL new models from index.ts.
  </action>
  <verify>
    Run `npx tsx -e "import { Post, Follow, Block, Bookmark, PrayerRequest } from './src/lib/db/models/index.ts'; console.log('Models loaded:', !!Post, !!Follow, !!Block, !!Bookmark, !!PrayerRequest)"` from project root.
    Verify output shows all true. Also run `npm run build` (or `npx next build`) to confirm no TypeScript errors in models.
  </verify>
  <done>All 10 new models load without errors, associations are registered, and TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx sequelize-cli db:migrate:status` shows all 26 migrations as "up"
2. All new models import successfully in a test script
3. `npm run build` passes with no TypeScript errors related to models
4. `npm ls obscenity react-intersection-observer` shows both packages installed
</verification>

<success_criteria>
- 11 new database tables exist with correct schemas, indexes, and FK constraints
- 10 new Sequelize models with TypeScript interfaces compile cleanly
- All model associations registered in index.ts
- Users table has 4 new profile columns
- obscenity and react-intersection-observer are in package.json dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-01-SUMMARY.md`
</output>
