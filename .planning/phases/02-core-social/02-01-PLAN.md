---
phase: 02-core-social
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/db/migrations/016-create-posts.cjs
  - src/lib/db/migrations/017-create-post-media.cjs
  - src/lib/db/migrations/018-create-post-reactions.cjs
  - src/lib/db/migrations/019-create-post-comments.cjs
  - src/lib/db/migrations/020-create-follows.cjs
  - src/lib/db/migrations/021-create-bookmarks.cjs
  - src/lib/db/migrations/022-create-prayer-requests.cjs
  - src/lib/db/migrations/023-create-prayer-supports.cjs
  - src/lib/db/migrations/024-create-reports.cjs
  - src/lib/db/migrations/025-create-blocks.cjs
  - src/lib/db/migrations/026-create-reposts.cjs
  - src/lib/db/migrations/027-create-post-comment-reactions.cjs
  - src/lib/db/migrations/028-create-platform-settings.cjs
  - src/lib/db/migrations/029-create-drafts.cjs
  - src/lib/db/migrations/030-add-profile-fields-to-users.cjs
  - src/lib/db/models/Post.ts
  - src/lib/db/models/PostMedia.ts
  - src/lib/db/models/PostReaction.ts
  - src/lib/db/models/PostComment.ts
  - src/lib/db/models/PostCommentReaction.ts
  - src/lib/db/models/Follow.ts
  - src/lib/db/models/Bookmark.ts
  - src/lib/db/models/PrayerRequest.ts
  - src/lib/db/models/PrayerSupport.ts
  - src/lib/db/models/Report.ts
  - src/lib/db/models/Block.ts
  - src/lib/db/models/Repost.ts
  - src/lib/db/models/PlatformSetting.ts
  - src/lib/db/models/Draft.ts
  - src/lib/db/models/index.ts
autonomous: true

must_haves:
  truths:
    - "All 15 new database tables exist after running migrations"
    - "All 14 new Sequelize models are defined with correct TypeScript interfaces"
    - "Model associations (hasMany, belongsTo, hasOne) are registered in index.ts"
    - "obscenity and react-intersection-observer npm packages are installed"
    - "Users table has new profile fields (denomination, church, testimony, profile_privacy, location, website, date_of_birth)"
  artifacts:
    - path: "src/lib/db/models/Post.ts"
      provides: "Post model with paranoid soft-delete"
      exports: ["Post"]
    - path: "src/lib/db/models/PostMedia.ts"
      provides: "PostMedia model for multi-media carousel (up to 10 items)"
      exports: ["PostMedia"]
    - path: "src/lib/db/models/Follow.ts"
      provides: "Follow model with status for follow requests"
      exports: ["Follow"]
    - path: "src/lib/db/models/PrayerRequest.ts"
      provides: "PrayerRequest model extending posts with prayer-specific fields"
      exports: ["PrayerRequest"]
    - path: "src/lib/db/models/Block.ts"
      provides: "Block model for user blocking"
      exports: ["Block"]
    - path: "src/lib/db/models/index.ts"
      provides: "Updated model registry with all Phase 2 models and associations"
      exports: ["Post", "PostMedia", "PostReaction", "PostComment", "PostCommentReaction", "Follow", "Bookmark", "PrayerRequest", "PrayerSupport", "Report", "Block", "Repost", "PlatformSetting", "Draft"]
  key_links:
    - from: "src/lib/db/models/Post.ts"
      to: "src/lib/db/models/User.ts"
      via: "belongsTo User as author"
      pattern: "belongsTo.*User"
    - from: "src/lib/db/models/PrayerRequest.ts"
      to: "src/lib/db/models/Post.ts"
      via: "belongsTo Post (one-to-one extension)"
      pattern: "belongsTo.*Post"
---

<objective>
Create the complete database foundation for Phase 2: Core Social. This plan installs new npm dependencies (obscenity, react-intersection-observer), creates 15 new database tables via Sequelize CLI migrations, defines 14 new TypeScript models, and registers all associations in the model index.

Purpose: Every subsequent Phase 2 plan depends on these tables and models existing. This is the foundation that unblocks all social features.
Output: 15 migration files, 14 model files, updated models/index.ts, updated package.json.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-RESEARCH.md
@src/lib/db/models/index.ts
@src/lib/db/models/DailyReaction.ts
@src/lib/db/models/DailyComment.ts
@src/lib/db/migrations/014-create-daily-reactions.cjs
@src/lib/db/migrations/015-create-daily-comments.cjs
@src/lib/db/models/User.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies and create all 15 migrations</name>
  <files>
    package.json
    src/lib/db/migrations/016-create-posts.cjs
    src/lib/db/migrations/017-create-post-media.cjs
    src/lib/db/migrations/018-create-post-reactions.cjs
    src/lib/db/migrations/019-create-post-comments.cjs
    src/lib/db/migrations/020-create-follows.cjs
    src/lib/db/migrations/021-create-bookmarks.cjs
    src/lib/db/migrations/022-create-prayer-requests.cjs
    src/lib/db/migrations/023-create-prayer-supports.cjs
    src/lib/db/migrations/024-create-reports.cjs
    src/lib/db/migrations/025-create-blocks.cjs
    src/lib/db/migrations/026-create-reposts.cjs
    src/lib/db/migrations/027-create-post-comment-reactions.cjs
    src/lib/db/migrations/028-create-platform-settings.cjs
    src/lib/db/migrations/029-create-drafts.cjs
    src/lib/db/migrations/030-add-profile-fields-to-users.cjs
  </files>
  <action>
    **Step 1:** Run `npm install obscenity react-intersection-observer` in the project root.

    **Step 2:** Create all 15 migration files using .cjs extension (required for ESM package). Follow the exact pattern from 014-create-daily-reactions.cjs and 015-create-daily-comments.cjs.

    **Migration schemas:**

    **016-create-posts.cjs:**
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - body: TEXT NOT NULL
    - post_type: ENUM('text','prayer_request') DEFAULT 'text' — NOTE: No 'bible_verse' type per CONTEXT decisions
    - visibility: ENUM('public','followers') DEFAULT 'public'
    - mode: ENUM('bible','positivity') NOT NULL — for mode isolation filtering
    - edited: BOOLEAN DEFAULT false
    - is_anonymous: BOOLEAN DEFAULT false — for anonymous prayer posts
    - flagged: BOOLEAN DEFAULT false — profanity filter flagged for admin review
    - deleted_at: DATETIME NULL — soft delete (paranoid)
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (user_id), (post_type), (mode), (created_at DESC, id DESC), (user_id, created_at DESC), (flagged)

    **017-create-post-media.cjs:**
    - id: INT PK AUTO_INCREMENT
    - post_id: INT NOT NULL FK(posts.id) CASCADE
    - media_type: ENUM('image','video') NOT NULL
    - url: VARCHAR(500) NOT NULL — B2 public URL
    - thumbnail_url: VARCHAR(500) NULL — for video thumbnails
    - width: INT NULL
    - height: INT NULL
    - duration: INT NULL — video duration in seconds (max 300 = 5 min)
    - sort_order: INT DEFAULT 0
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (post_id, sort_order)

    **018-create-post-reactions.cjs:** (mirror daily_reactions exactly)
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - post_id: INT NOT NULL FK(posts.id) CASCADE
    - reaction_type: ENUM('like','love','haha','wow','sad','pray')
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: UNIQUE(user_id, post_id), (post_id, reaction_type)

    **019-create-post-comments.cjs:** (mirror daily_comments)
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - post_id: INT NOT NULL FK(posts.id) CASCADE
    - parent_id: INT NULL SELF-FK(post_comments.id) SET NULL
    - body: TEXT NOT NULL
    - edited: BOOLEAN DEFAULT false
    - flagged: BOOLEAN DEFAULT false
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (post_id, parent_id), (user_id)

    **020-create-follows.cjs:**
    - id: INT PK AUTO_INCREMENT
    - follower_id: INT NOT NULL FK(users.id) CASCADE
    - following_id: INT NOT NULL FK(users.id) CASCADE
    - status: ENUM('active','pending') DEFAULT 'active' — pending = follow request for private profiles
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: UNIQUE(follower_id, following_id), (following_id), (status)

    **021-create-bookmarks.cjs:**
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - post_id: INT NULL FK(posts.id) CASCADE
    - daily_content_id: INT NULL FK(daily_content.id) CASCADE
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: UNIQUE(user_id, post_id) with WHERE post_id IS NOT NULL, UNIQUE(user_id, daily_content_id) with WHERE daily_content_id IS NOT NULL. Use addIndex with unique:true and name. NOTE: MySQL does not support partial unique indexes, so create composite unique indexes that include both columns as a pair — the uniqueness constraint should be enforced at the application level for the polymorphic pattern, OR use two separate unique indexes: one on (user_id, post_id) and one on (user_id, daily_content_id). Since NULL values are not considered equal in MySQL unique indexes, this naturally works.

    **022-create-prayer-requests.cjs:**
    - id: INT PK AUTO_INCREMENT
    - post_id: INT NOT NULL FK(posts.id) CASCADE UNIQUE
    - privacy: ENUM('public','followers','private') DEFAULT 'public'
    - status: ENUM('active','answered') DEFAULT 'active'
    - answered_at: DATETIME NULL
    - answered_testimony: TEXT NULL
    - pray_count: INT DEFAULT 0
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (status), (post_id) UNIQUE

    **023-create-prayer-supports.cjs:**
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - prayer_request_id: INT NOT NULL FK(prayer_requests.id) CASCADE
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: UNIQUE(user_id, prayer_request_id), (prayer_request_id)

    **024-create-reports.cjs:**
    - id: INT PK AUTO_INCREMENT
    - reporter_id: INT NOT NULL FK(users.id) CASCADE
    - post_id: INT NULL FK(posts.id) SET NULL
    - comment_id: INT NULL — generic comment ID (could be post_comments or daily_comments)
    - content_type: ENUM('post','comment') NOT NULL
    - reason: ENUM('spam','harassment','hate_speech','inappropriate','self_harm','other') NOT NULL
    - details: TEXT NULL
    - status: ENUM('pending','reviewed','actioned','dismissed') DEFAULT 'pending'
    - admin_notes: TEXT NULL
    - reviewed_by: INT NULL FK(users.id) SET NULL
    - reviewed_at: DATETIME NULL
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (status), (reporter_id), (post_id)

    **025-create-blocks.cjs:**
    - id: INT PK AUTO_INCREMENT
    - blocker_id: INT NOT NULL FK(users.id) CASCADE
    - blocked_id: INT NOT NULL FK(users.id) CASCADE
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: UNIQUE(blocker_id, blocked_id), (blocked_id)

    **026-create-reposts.cjs:**
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - post_id: INT NOT NULL FK(posts.id) CASCADE — the original post being reposted
    - quote_post_id: INT NOT NULL FK(posts.id) CASCADE UNIQUE — the new post that quotes the original
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (user_id), (post_id), UNIQUE(quote_post_id)

    **027-create-post-comment-reactions.cjs:**
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - comment_id: INT NOT NULL FK(post_comments.id) CASCADE
    - reaction_type: ENUM('like','love','haha','wow','sad','pray')
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: UNIQUE(user_id, comment_id), (comment_id, reaction_type)

    **028-create-platform-settings.cjs:**
    - id: INT PK AUTO_INCREMENT
    - key: VARCHAR(100) NOT NULL UNIQUE
    - value: TEXT NOT NULL
    - description: VARCHAR(500) NULL
    - created_at, updated_at: DATETIME NOT NULL
    - Seed default rows in the up() method:
      - feed_style: 'tiktok' (description: 'Feed display style: tiktok or instagram')
      - mode_isolation_social: 'true' (description: 'Isolate social feed by user mode')
      - mode_isolation_prayer: 'true' (description: 'Isolate prayer wall by user mode')
      - registration_mode: 'invite' (description: 'Registration mode: open or invite')
      - maintenance_mode: 'false' (description: 'Enable maintenance mode')
      - profanity_filter_enabled: 'true' (description: 'Enable profanity filter on content')
      - ai_moderation_enabled: 'false' (description: 'Enable AI content moderation')

    **029-create-drafts.cjs:**
    - id: INT PK AUTO_INCREMENT
    - user_id: INT NOT NULL FK(users.id) CASCADE
    - draft_type: ENUM('post','prayer_request') DEFAULT 'post'
    - body: TEXT NULL
    - media_keys: JSON NULL — array of B2 keys for uploaded media not yet attached to post
    - metadata: JSON NULL — any other draft state (category, visibility, etc.)
    - created_at, updated_at: DATETIME NOT NULL
    - Indexes: (user_id, draft_type)

    **030-add-profile-fields-to-users.cjs:**
    - Add columns to users table: denomination VARCHAR(100) NULL, church VARCHAR(200) NULL, testimony TEXT NULL, profile_privacy ENUM('public','private') DEFAULT 'public', location VARCHAR(200) NULL, website VARCHAR(500) NULL
    - Do NOT add date_of_birth (already exists from Phase 1)

    **Step 3:** Run migrations: `npx sequelize-cli db:migrate`
  </action>
  <verify>
    - `npm ls obscenity react-intersection-observer` shows both installed
    - `npx sequelize-cli db:migrate:status` shows all 30 migrations as "up"
    - Verify tables exist: run `mysql -u root -p"Luma!2026#R9vK3pT7xQ2mZ5sN8cH1yW4" freeluma_dev -e "SHOW TABLES"` and confirm posts, post_media, post_reactions, post_comments, follows, bookmarks, prayer_requests, prayer_supports, reports, blocks, reposts, post_comment_reactions, platform_settings, drafts tables exist
  </verify>
  <done>All 15 new tables exist in the database with correct columns, indexes, and foreign keys. npm dependencies installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create all 14 new Sequelize models and update model index with associations</name>
  <files>
    src/lib/db/models/Post.ts
    src/lib/db/models/PostMedia.ts
    src/lib/db/models/PostReaction.ts
    src/lib/db/models/PostComment.ts
    src/lib/db/models/PostCommentReaction.ts
    src/lib/db/models/Follow.ts
    src/lib/db/models/Bookmark.ts
    src/lib/db/models/PrayerRequest.ts
    src/lib/db/models/PrayerSupport.ts
    src/lib/db/models/Report.ts
    src/lib/db/models/Block.ts
    src/lib/db/models/Repost.ts
    src/lib/db/models/PlatformSetting.ts
    src/lib/db/models/Draft.ts
    src/lib/db/models/index.ts
  </files>
  <action>
    Create 14 new model files following the exact TypeScript pattern from DailyReaction.ts and DailyComment.ts (using Model.init() with sequelize instance, DataTypes, underscored: true, timestamps: true).

    **Model specifics:**

    **Post.ts:** Include `paranoid: true` for soft delete (deleted_at). Fields: id, user_id, body, post_type, visibility, mode, edited, is_anonymous, flagged, deleted_at. Add `tableName: 'posts'`. Include TypeScript interface with all field types.

    **PostMedia.ts:** Fields: id, post_id, media_type, url, thumbnail_url, width, height, duration, sort_order. tableName: 'post_media'.

    **PostReaction.ts:** Mirror DailyReaction exactly but reference post_id instead of daily_content_id. tableName: 'post_reactions'.

    **PostComment.ts:** Mirror DailyComment exactly but reference post_id instead of daily_content_id. Add flagged boolean. tableName: 'post_comments'.

    **PostCommentReaction.ts:** Same as PostReaction but references comment_id (post_comments). tableName: 'post_comment_reactions'.

    **Follow.ts:** Fields: id, follower_id, following_id, status. tableName: 'follows'.

    **Bookmark.ts:** Fields: id, user_id, post_id (nullable), daily_content_id (nullable). tableName: 'bookmarks'.

    **PrayerRequest.ts:** Fields: id, post_id, privacy, status, answered_at, answered_testimony, pray_count. tableName: 'prayer_requests'.

    **PrayerSupport.ts:** Fields: id, user_id, prayer_request_id. tableName: 'prayer_supports'.

    **Report.ts:** Fields: id, reporter_id, post_id, comment_id, content_type, reason, details, status, admin_notes, reviewed_by, reviewed_at. tableName: 'reports'.

    **Block.ts:** Fields: id, blocker_id, blocked_id. tableName: 'blocks'.

    **Repost.ts:** Fields: id, user_id, post_id, quote_post_id. tableName: 'reposts'.

    **PlatformSetting.ts:** Fields: id, key, value, description. tableName: 'platform_settings'. Add a static helper: `static async get(key: string): Promise<string | null>` and `static async set(key: string, value: string): Promise<void>`.

    **Draft.ts:** Fields: id, user_id, draft_type, body, media_keys, metadata. tableName: 'drafts'.

    **Update src/lib/db/models/index.ts:**
    - Import all 14 new models
    - Add ALL associations:
      - User hasMany Post (as 'posts'), Post belongsTo User (as 'author')
      - Post hasMany PostMedia (as 'media'), PostMedia belongsTo Post
      - Post hasMany PostReaction (as 'reactions'), PostReaction belongsTo Post, PostReaction belongsTo User
      - Post hasMany PostComment (as 'comments'), PostComment belongsTo Post, PostComment belongsTo User (as 'author')
      - PostComment hasMany PostComment (self-ref, as 'replies', parent_id)
      - PostComment belongsTo PostComment (as 'parent')
      - PostComment hasMany PostCommentReaction (as 'reactions'), PostCommentReaction belongsTo PostComment, PostCommentReaction belongsTo User
      - User hasMany Follow (as follower: 'following', foreignKey: 'follower_id'), User hasMany Follow (as followed: 'followers', foreignKey: 'following_id')
      - Follow belongsTo User (as 'follower', foreignKey: 'follower_id'), Follow belongsTo User (as 'following', foreignKey: 'following_id')
      - User hasMany Bookmark, Bookmark belongsTo User, Bookmark belongsTo Post, Bookmark belongsTo DailyContent
      - Post hasOne PrayerRequest, PrayerRequest belongsTo Post
      - PrayerRequest hasMany PrayerSupport, PrayerSupport belongsTo PrayerRequest, PrayerSupport belongsTo User
      - User hasMany Report (as 'reporter', foreignKey: 'reporter_id'), Report belongsTo User (as 'reporter')
      - Report belongsTo Post
      - User hasMany Block (as blocker: foreignKey 'blocker_id'), User hasMany Block (as blocked: foreignKey 'blocked_id')
      - Block belongsTo User (as 'blocker'), Block belongsTo User (as 'blockedUser')
      - User hasMany Repost, Repost belongsTo User, Repost belongsTo Post (as 'originalPost'), Repost belongsTo Post (as 'quotePost')
      - User hasMany Draft, Draft belongsTo User
      - Post hasMany Bookmark (for cascade), Post hasMany Repost (as 'reposts')
    - Export all 14 new models alongside existing ones

    **Also update User.ts:** Add the new profile fields (denomination, church, testimony, profile_privacy, location, website) to the User model's init() attributes AND TypeScript interface. Do NOT remove any existing fields.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors (or `npm run build` succeeds)
    - Spot-check: Read src/lib/db/models/index.ts and confirm all 14 new models are imported, associated, and exported
    - Spot-check: Read src/lib/db/models/Post.ts and confirm paranoid:true and all fields present
  </verify>
  <done>All 14 new models exist with correct TypeScript interfaces, associations registered in index.ts, User model updated with new profile fields. Build passes.</done>
</task>

</tasks>

<verification>
- `npm ls obscenity react-intersection-observer` — both packages installed
- `npx sequelize-cli db:migrate:status` — all 30 migrations show "up"
- `npx tsc --noEmit` or `npm run build` — no TypeScript errors
- Database has all new tables with correct schema
</verification>

<success_criteria>
- 15 new database tables created and accessible
- 14 new Sequelize models defined with TypeScript interfaces
- All model associations registered
- User model extended with profile fields
- npm dependencies installed
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-01-SUMMARY.md`
</output>
