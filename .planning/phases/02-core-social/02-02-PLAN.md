---
phase: 02-core-social
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/lib/moderation/profanity.ts
  - src/lib/utils/blocks.ts
  - src/app/api/posts/route.ts
  - src/app/api/posts/[id]/route.ts
  - src/app/api/blocks/route.ts
autonomous: true

must_haves:
  truths:
    - "User can create a text post with optional image and category tag"
    - "User can create a Bible verse post with reference, translation, and verse text"
    - "User can edit their own post within 15-minute window"
    - "User can delete (soft-delete) their own post"
    - "User can view a single post by ID"
    - "Posts with profanity are rejected with a user-friendly error"
    - "User can block/unblock another user"
    - "Blocked user IDs are retrievable for query filtering"
  artifacts:
    - path: "src/app/api/posts/route.ts"
      provides: "POST /api/posts — create post"
      exports: ["POST"]
    - path: "src/app/api/posts/[id]/route.ts"
      provides: "GET/PUT/DELETE single post"
      exports: ["GET", "PUT", "DELETE"]
    - path: "src/lib/moderation/profanity.ts"
      provides: "Profanity detection utility"
      exports: ["containsProfanity", "censorText"]
    - path: "src/lib/utils/blocks.ts"
      provides: "Block ID lookup utility"
      exports: ["getBlockedUserIds"]
    - path: "src/app/api/blocks/route.ts"
      provides: "Block toggle and list API"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/api/posts/route.ts"
      to: "src/lib/moderation/profanity.ts"
      via: "containsProfanity check before create"
      pattern: "containsProfanity"
    - from: "src/app/api/posts/[id]/route.ts"
      to: "Post model"
      via: "Sequelize findByPk + update/destroy"
      pattern: "Post\\.findByPk"
---

<objective>
Create the profanity filter utility, block system utility, block API, and post CRUD API routes (create, read single, edit, delete).

Purpose: Posts are the core content unit of Phase 2. Every other social feature (reactions, comments, feed, prayer, bookmarks) depends on posts existing. The profanity filter and block utility are shared by many subsequent plans.
Output: 2 utility modules, 3 API route files, block management endpoint.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-01-SUMMARY.md

@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/app/api/daily-comments/route.ts
@src/app/api/daily-reactions/route.ts
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profanity filter utility and block utility</name>
  <files>
    src/lib/moderation/profanity.ts
    src/lib/utils/blocks.ts
  </files>
  <action>
    **src/lib/moderation/profanity.ts:**
    Import RegExpMatcher, TextCensor, englishDataset, englishRecommendedTransformers from 'obscenity'. Create matcher instance with `{ ...englishDataset.build(), ...englishRecommendedTransformers }`. Create censor instance. Export:
    - `containsProfanity(text: string): boolean` — returns matcher.hasMatch(text)
    - `censorText(text: string): string` — gets all matches and applies censor

    **src/lib/utils/blocks.ts:**
    Import Block model and Op from sequelize. Export:
    - `getBlockedUserIds(userId: number): Promise<Set<number>>` — Queries Block table for rows where blocker_id = userId OR blocked_id = userId. Returns a Set of all user IDs that should be excluded (if user is blocker, add blocked_id; if user is blocked, add blocker_id). This function is called by every feed/search query to exclude blocked users.
  </action>
  <verify>Run `npx tsx -e "import { containsProfanity } from './src/lib/moderation/profanity.ts'; console.log(containsProfanity('hello'));"` — should print false.</verify>
  <done>Profanity filter correctly detects profanity. Block utility returns Set of blocked user IDs in both directions.</done>
</task>

<task type="auto">
  <name>Task 2: Create post CRUD API and block API</name>
  <files>
    src/app/api/posts/route.ts
    src/app/api/posts/[id]/route.ts
    src/app/api/blocks/route.ts
  </files>
  <action>
    **src/app/api/posts/route.ts (POST handler only — GET feed added in 02-06):**
    Use withAuth middleware. Zod schema for create: body (string 1-5000), category_id (number nullable optional), post_type (enum text/bible_verse/prayer_request, default text), image_key (string nullable optional — the B2 object key from presigned upload), bible_reference (string max 100 nullable optional), bible_translation (string max 10 nullable optional), bible_text (string max 5000 nullable optional), visibility (enum public/followers default public), prayer_privacy (enum public/followers/private optional).

    Flow: Parse body with Zod safeParse. Check profanity with containsProfanity(body). Reject with 400 if profane. Compute edit_deadline = new Date(Date.now() + 15 * 60 * 1000). Create Post record. If post_type === 'prayer_request', also create PrayerRequest extension row with post_id and prayer_privacy. For image_key, convert to full public URL using the B2/CDN URL pattern from existing upload flow. Return 201 with post JSON.

    **src/app/api/posts/[id]/route.ts (GET, PUT, DELETE):**

    GET: withAuth. Fetch post by ID with includes: author (User, select id/username/display_name/avatar_url), category (Category, select id/name/slug). If post_type is prayer_request, include PrayerRequest association. Add subquery attributes for reaction_count and comment_count. Check if requesting user has reacted (subquery or separate query). Check if requesting user has bookmarked. Return 404 if not found or soft-deleted.

    PUT: withAuth. Only post author can edit. Check edit_deadline — if current time > edit_deadline, return 403 "Edit window has expired". Zod schema for update: body (string 1-5000 optional), category_id (number nullable optional), visibility (enum optional). Check profanity on new body if provided. Update post, set edited = true. Return updated post.

    DELETE: withAuth. Only post author (or admin via withAdmin check) can delete. Use post.destroy() which with paranoid: true sets deleted_at. Return 200 with success message.

    **src/app/api/blocks/route.ts (GET and POST):**

    GET: withAuth. Return list of blocked users with user details (id, username, display_name, avatar_url) for the current user. Query Block where blocker_id = userId, include User as 'blocked'.

    POST: withAuth. Body: { user_id: number }. Validate user_id exists and is not self. Toggle: if block exists, destroy it (unblock); if not, create it (block). Also remove any Follow records between the two users (in both directions) when blocking. Return { action: 'blocked' | 'unblocked' }.

    Use the standard successResponse/errorResponse/serverError pattern from src/lib/utils/api.ts. Use withAuth from src/lib/auth/middleware.ts.
  </action>
  <verify>
    Start dev server with `npm run dev`. Test with curl:
    1. `curl -X POST http://localhost:3000/api/posts -H "Content-Type: application/json" -H "Cookie: token=<valid_jwt>" -d '{"body":"Test post"}'` — should return 201
    2. `curl http://localhost:3000/api/posts/<id> -H "Cookie: token=<valid_jwt>"` — should return post with counts
    3. `curl -X PUT http://localhost:3000/api/posts/<id> -H "Content-Type: application/json" -H "Cookie: token=<valid_jwt>" -d '{"body":"Edited"}'` — should return updated post with edited=true
    4. `curl -X DELETE http://localhost:3000/api/posts/<id> -H "Cookie: token=<valid_jwt>"` — should return success
  </verify>
  <done>Post CRUD works: create with profanity check, read with counts/author, edit within window, soft-delete. Block toggle works with follow cleanup.</done>
</task>

</tasks>

<verification>
1. POST /api/posts creates a post and returns 201
2. POST /api/posts with profanity returns 400
3. GET /api/posts/:id returns post with reaction_count, comment_count, author
4. PUT /api/posts/:id within 15 min updates and sets edited=true
5. PUT /api/posts/:id after 15 min returns 403
6. DELETE /api/posts/:id soft-deletes (deleted_at set)
7. POST /api/blocks toggles block status and removes follows
8. containsProfanity correctly flags inappropriate text
</verification>

<success_criteria>
- Post CRUD fully functional with profanity check, edit window, soft delete
- Block toggle removes follows between users
- getBlockedUserIds utility returns correct bidirectional block set
- All routes use withAuth and return proper error responses
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-02-SUMMARY.md`
</output>
