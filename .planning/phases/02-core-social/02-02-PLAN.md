---
phase: 02-core-social
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/moderation/profanity.ts
  - src/lib/utils/blocks.ts
  - src/lib/utils/cursor.ts
  - src/lib/utils/mentions.ts
  - src/app/api/posts/route.ts
  - src/app/api/posts/[id]/route.ts
  - src/app/api/upload/post-media/route.ts
autonomous: true

must_haves:
  truths:
    - "User can create a text post via POST /api/posts"
    - "User can create a post with up to 10 media items (images/videos)"
    - "User can edit their own post body via PUT /api/posts/[id]"
    - "User can soft-delete their own post via DELETE /api/posts/[id]"
    - "Posts with profanity are created but flagged for admin review"
    - "Post body supports @mentions and #hashtags parsed to structured data"
    - "Blocked users' content is excluded from post detail queries"
  artifacts:
    - path: "src/lib/moderation/profanity.ts"
      provides: "Profanity detection utility using obscenity package"
      exports: ["containsProfanity", "censorText", "checkAndFlag"]
    - path: "src/lib/utils/blocks.ts"
      provides: "Shared utility to get blocked user IDs for current user (both directions)"
      exports: ["getBlockedUserIds"]
    - path: "src/lib/utils/cursor.ts"
      provides: "Cursor encoding/decoding for pagination"
      exports: ["encodeCursor", "decodeCursor"]
    - path: "src/app/api/posts/route.ts"
      provides: "POST create post endpoint"
      exports: ["POST"]
    - path: "src/app/api/posts/[id]/route.ts"
      provides: "GET detail, PUT edit, DELETE soft-delete"
      exports: ["GET", "PUT", "DELETE"]
  key_links:
    - from: "src/app/api/posts/route.ts"
      to: "src/lib/moderation/profanity.ts"
      via: "checkAndFlag on post body"
      pattern: "checkAndFlag|containsProfanity"
    - from: "src/app/api/posts/route.ts"
      to: "src/lib/db/models/Post.ts"
      via: "Post.create()"
      pattern: "Post\\.create"
    - from: "src/app/api/posts/[id]/route.ts"
      to: "src/lib/utils/blocks.ts"
      via: "getBlockedUserIds for access check"
      pattern: "getBlockedUserIds"
---

<objective>
Build the core utilities (profanity filter, block helper, cursor pagination, mention/hashtag parsing) and the Post CRUD API with multi-media upload support.

Purpose: These utilities are shared across all Phase 2 APIs. The Post CRUD is the foundational content creation endpoint that feed, prayer wall, and all interaction features depend on.
Output: 4 utility modules + 3 API route files + presigned upload endpoint for post media.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-01-SUMMARY.md
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/app/api/daily-reactions/route.ts
@src/app/api/upload/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared utility modules (profanity, blocks, cursor, mentions)</name>
  <files>
    src/lib/moderation/profanity.ts
    src/lib/utils/blocks.ts
    src/lib/utils/cursor.ts
    src/lib/utils/mentions.ts
  </files>
  <action>
    **src/lib/moderation/profanity.ts:**
    - Import RegExpMatcher, TextCensor, englishDataset, englishRecommendedTransformers from 'obscenity'
    - Create matcher instance with englishDataset.build() and englishRecommendedTransformers
    - Export `containsProfanity(text: string): boolean` — returns matcher.hasMatch(text)
    - Export `censorText(text: string): string` — applies TextCensor to matched positions
    - Export `checkAndFlag(text: string): { flagged: boolean; censored: string }` — returns both the flag status and censored version. Per CONTEXT: profanity does NOT block posting, it flags for admin review.

    **src/lib/utils/blocks.ts:**
    - Import Block model and Op from sequelize
    - Export `getBlockedUserIds(userId: number): Promise<Set<number>>` — queries blocks table where blocker_id = userId OR blocked_id = userId, returns Set of all user IDs that should be hidden (both directions)
    - This function is called by EVERY feed/content query to exclude blocked users

    **src/lib/utils/cursor.ts:**
    - Export `encodeCursor(record: { created_at: Date | string; id: number }): string` — base64url-encode JSON of { created_at, id }
    - Export `decodeCursor(cursor: string): { created_at: string; id: number } | null` — parse base64url JSON, return null on any error
    - Use Buffer.from().toString('base64url') for encoding

    **src/lib/utils/mentions.ts:**
    - Export `parseMentions(text: string): string[]` — extract @username mentions using regex /@([a-zA-Z0-9_]+)/g, return array of usernames
    - Export `parseHashtags(text: string): string[]` — extract #hashtag using regex /#([a-zA-Z0-9_]+)/g, return array of tags
    - These are parsed for display formatting on the client side; hashtags are styled but not tappable (per CONTEXT deferred decisions)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Manually test: `node -e "import('./src/lib/moderation/profanity.ts')"` doesn't error (or verify via build)
  </verify>
  <done>Four utility modules exist with correct exports. Profanity detection works with obscenity. Block helper queries both directions. Cursor encoding/decoding is base64url JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Create Post CRUD API routes and media upload endpoint</name>
  <files>
    src/app/api/posts/route.ts
    src/app/api/posts/[id]/route.ts
    src/app/api/upload/post-media/route.ts
  </files>
  <action>
    **src/app/api/posts/route.ts — POST (create post):**
    - Use withAuth HOF pattern from existing routes
    - Zod v4 validation schema:
      - body: z.string().min(1).max(5000)
      - post_type: z.enum(['text','prayer_request']).optional().default('text')
      - visibility: z.enum(['public','followers']).optional().default('public')
      - media_keys: z.array(z.string()).max(10).optional() — array of B2 object keys from presigned uploads
      - is_anonymous: z.boolean().optional().default(false) — only valid for prayer_request type
      - prayer_privacy: z.enum(['public','followers','private']).optional() — only for prayer_request type
    - Run checkAndFlag(body) from profanity.ts — set post.flagged = result.flagged. Do NOT reject the post.
    - Get user's mode from the authenticated user record and set post.mode = user.mode
    - Create Post row with Post.create()
    - If media_keys provided: bulk-create PostMedia rows with incremental sort_order. Construct full URLs from B2 keys using the getPublicUrl pattern from existing upload route.
    - If post_type === 'prayer_request': create PrayerRequest extension row with privacy field
    - Return 201 with the created post (include media array)

    **src/app/api/posts/[id]/route.ts — GET (post detail):**
    - Use withAuth
    - Fetch post by ID with includes: author (User, attributes: id, username, display_name, avatar_url), media (PostMedia, ordered by sort_order), PrayerRequest (if exists)
    - Check block list: if post author is blocked by or blocks the requesting user, return 404
    - Check visibility: if 'followers' visibility, verify requesting user follows the author (or IS the author)
    - Include reaction counts as subquery attributes: total count per reaction_type
    - Include comment count as subquery attribute
    - Include requesting user's own reaction (if any) and bookmark status
    - Return post with all enriched data

    **src/app/api/posts/[id]/route.ts — PUT (edit post):**
    - Use withAuth
    - Verify requesting user owns the post (user_id match)
    - Per CONTEXT: No time limit on edit/delete — users can edit or delete their posts anytime. Do NOT check edit_deadline.
    - Zod schema: body (optional string 1-5000), visibility (optional enum)
    - If body changed: re-run profanity check, update flagged status
    - Set edited = true
    - Return updated post

    **src/app/api/posts/[id]/route.ts — DELETE (soft delete):**
    - Use withAuth
    - Verify requesting user owns the post OR is admin (check withAdmin pattern)
    - Per CONTEXT: No time limit on delete
    - Call post.destroy() — paranoid mode automatically sets deleted_at instead of hard delete
    - Return 200 { success: true }

    **src/app/api/upload/post-media/route.ts — GET (presigned URL for post media):**
    - Follow exact pattern from existing src/app/api/upload/route.ts
    - Use withAuth
    - Accept query params: content_type, file_name
    - Validate content_type is image/* or video/*
    - For video: validate no size limit per CONTEXT (server-side compression after upload)
    - Generate presigned PUT URL with key format: posts/{userId}/{timestamp}-{random}.{ext}
    - Return { upload_url, key, public_url }
  </action>
  <verify>
    - `npm run build` passes
    - `curl -X POST http://localhost:3000/api/posts -H "Cookie: auth_token=..." -H "Content-Type: application/json" -d '{"body":"Test post"}' ` returns 201 with post object
    - `curl http://localhost:3000/api/posts/1 -H "Cookie: auth_token=..."` returns post detail with author and counts
  </verify>
  <done>Post CRUD API works: create with profanity flagging, get detail with enriched data (author, counts, media), edit with re-flagging, soft-delete. Media upload presigned URL endpoint generates valid B2 URLs.</done>
</task>

</tasks>

<verification>
- All 4 utility modules importable and TypeScript-valid
- POST /api/posts creates a post and returns it
- GET /api/posts/[id] returns enriched post detail
- PUT /api/posts/[id] edits post and sets edited=true
- DELETE /api/posts/[id] soft-deletes (sets deleted_at, not hard delete)
- Profanity flagging works (flagged=true for profane content, post still created)
- Block filtering prevents viewing blocked users' posts
</verification>

<success_criteria>
- Post CRUD fully functional
- Profanity filter flags but doesn't block
- Block utility returns correct bidirectional block set
- Cursor utility encodes/decodes correctly
- Media upload presigned URLs work
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-02-SUMMARY.md`
</output>
