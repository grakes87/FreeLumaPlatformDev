---
phase: 02-core-social
plan: 12
type: execute
wave: 4
depends_on: ["02-03", "02-06"]
files_modified:
  - src/app/(app)/profile/page.tsx
  - src/app/(app)/profile/[username]/page.tsx
  - src/app/(app)/profile/edit/page.tsx
  - src/app/api/users/[username]/profile/route.ts
  - src/components/profile/ProfileHeader.tsx
  - src/components/profile/ProfileTabs.tsx
  - src/components/profile/ProfileStats.tsx
  - src/components/profile/FollowList.tsx
  - src/components/profile/EditProfileForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their own profile with stats (posts, followers, following)"
    - "User can view another user's public profile"
    - "Private profiles hide posts/tabs for non-followers (show only name, avatar, bio, counts)"
    - "Profile has three tabs: Posts, Reposts, Saved (Saved only on own profile)"
    - "User can view follower and following lists (privacy-gated)"
    - "User can edit their profile (display name, username, bio, avatar, privacy, DOB, location, website, mode)"
    - "Follow button appears on other users' profiles"
    - "Profile stats show post count, follower count, following count"
  artifacts:
    - path: "src/app/(app)/profile/[username]/page.tsx"
      provides: "Public profile page for any user"
      exports: ["default"]
    - path: "src/app/(app)/profile/edit/page.tsx"
      provides: "Edit profile page"
      exports: ["default"]
    - path: "src/app/api/users/[username]/profile/route.ts"
      provides: "GET public profile data with stats"
      exports: ["GET"]
    - path: "src/components/profile/ProfileHeader.tsx"
      provides: "Instagram-style profile header with avatar, name, bio, stats, follow button"
      exports: ["ProfileHeader"]
  key_links:
    - from: "src/app/(app)/profile/[username]/page.tsx"
      to: "src/app/api/users/[username]/profile/route.ts"
      via: "Fetch profile data"
      pattern: "api/users/.*/profile"
    - from: "src/components/profile/ProfileHeader.tsx"
      to: "src/components/social/FollowButton.tsx"
      via: "FollowButton on other user's profile"
      pattern: "FollowButton"
---

<objective>
Build the profile system — own profile page, public profile viewing, edit profile page, profile API, and all profile components (header, tabs, stats, follow lists).

Purpose: Profiles are the identity surface of the social platform. Users view their own stats, others browse profiles to decide who to follow, and privacy settings control what non-followers can see.
Output: 3 pages, 1 API route, 5 components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-03-SUMMARY.md
@.planning/phases/02-core-social/02-06-SUMMARY.md
@src/app/(app)/profile/page.tsx
@src/components/profile/
@src/hooks/useAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile API and profile page components</name>
  <files>
    src/app/api/users/[username]/profile/route.ts
    src/components/profile/ProfileHeader.tsx
    src/components/profile/ProfileTabs.tsx
    src/components/profile/ProfileStats.tsx
    src/components/profile/FollowList.tsx
  </files>
  <action>
    **src/app/api/users/[username]/profile/route.ts — GET:**
    - withAuth
    - Resolve user by username (case-insensitive lookup)
    - If not found: return 404
    - Block check: if blocked/blocking, return 404
    - Compute stats:
      - post_count: COUNT posts WHERE user_id AND deleted_at IS NULL
      - follower_count: COUNT follows WHERE following_id AND status='active'
      - following_count: COUNT follows WHERE follower_id AND status='active'
    - Include: id, username, display_name, bio, avatar_url, profile_privacy, mode, denomination, church, location, website, date_of_birth (only if own profile), created_at
    - Determine relationship: 'self' | 'following' | 'pending' | 'none' | 'follows_you' (check both directions)
    - Privacy gate: if profile_privacy = 'private' AND not self AND not following AND not admin:
      - Return limited data: id, username, display_name, avatar_url, bio, profile_privacy, follower_count, following_count, relationship
      - DO NOT include posts tab data
    - If public or authorized: include recent posts (first page, 20 items) with cursor for pagination
    - Return { user: {...}, stats: {...}, relationship, posts (if authorized) }

    **src/components/profile/ProfileHeader.tsx:**
    - Props: user, stats, relationship, isOwnProfile, onEditProfile
    - Instagram-style layout:
      - Row 1: Large avatar (80px circle) + stats row (Posts / Followers / Following) with counts
      - Row 2: Display name (bold) + @username
      - Row 3: Bio text (if present)
      - Row 4: Location (if present), Website link (if present)
      - Row 5 (other user): FollowButton + Message button (disabled, for Phase 3)
      - Row 5 (own profile): "Edit Profile" button
    - Stats are tappable: followers/following tap opens FollowList modal
    - cn() for styling, dark mode

    **src/components/profile/ProfileTabs.tsx:**
    - Props: activeTab ('posts' | 'reposts' | 'saved'), onTabChange, isOwnProfile
    - Three tabs: Posts, Reposts, Saved
    - Saved tab only visible if isOwnProfile
    - Grid icon for Posts (Grid3X3), Repeat2 for Reposts, Bookmark for Saved
    - Active tab underline indicator

    **src/components/profile/ProfileStats.tsx:**
    - Props: postCount, followerCount, followingCount, onFollowersTap, onFollowingTap
    - Renders three columns: Posts / Followers / Following
    - Each shows count (bold) + label
    - Followers and Following are tappable (trigger onFollowersTap/onFollowingTap)

    **src/components/profile/FollowList.tsx:**
    - Props: userId, type ('followers' | 'following'), isOpen, onClose
    - Modal/bottom sheet showing the list
    - Fetches from GET /api/users/[id]/followers or /api/users/[id]/following
    - Each row: avatar + display_name + @username + FollowButton
    - Cursor-based pagination with "Load more"
    - Empty state: "No followers yet" / "Not following anyone yet"
    - Search bar at top to filter the list
    - cn() for styling, dark mode
  </action>
  <verify>
    - `npm run build` passes
    - Profile API returns correct stats and privacy-gated data
    - ProfileHeader renders with avatar, stats, follow button
    - FollowList displays paginated followers/following
  </verify>
  <done>Profile API with stats, privacy gating, and relationship detection. ProfileHeader with Instagram-style layout. ProfileTabs with Posts/Reposts/Saved. ProfileStats with tappable counts. FollowList modal with search and pagination.</done>
</task>

<task type="auto">
  <name>Task 2: Build profile pages (own, public, edit)</name>
  <files>
    src/app/(app)/profile/page.tsx
    src/app/(app)/profile/[username]/page.tsx
    src/app/(app)/profile/edit/page.tsx
    src/components/profile/EditProfileForm.tsx
  </files>
  <action>
    **src/app/(app)/profile/page.tsx (own profile):**
    - Replace existing placeholder
    - Uses useAuth to get current user
    - Redirects to /profile/[username] with own username
    - OR renders own profile directly (preferred: render directly to avoid redirect)
    - Fetches own profile data from API (or use auth context + separate stats fetch)
    - Layout: ProfileHeader + ProfileTabs + tab content
    - Posts tab: list of user's posts (fetch from /api/feed with user filter, or dedicated /api/users/me/posts endpoint)
    - Reposts tab: list of user's reposts (fetch reposts where user_id = me)
    - Saved tab: list of bookmarks (fetch from /api/bookmarks)
    - Infinite scroll on each tab
    - "Edit Profile" button in header

    **src/app/(app)/profile/[username]/page.tsx (public profile):**
    - Dynamic route for viewing any user's profile
    - Fetches GET /api/users/[username]/profile
    - If self: show full own profile experience (same as /profile)
    - If other user, public: show ProfileHeader with FollowButton + tabs (Posts, Reposts)
    - If other user, private and not following: show limited ProfileHeader + "This account is private" message + FollowButton
    - Posts tab: user's posts from profile API response, paginate with cursor
    - Reposts tab: user's reposts
    - No Saved tab (per CONTEXT: saved only visible on own profile)
    - Block check: if blocked, show "User not found" (API returns 404)

    **src/components/profile/EditProfileForm.tsx:**
    - Full edit form with all fields per CONTEXT:
      - Display name (text input)
      - Username (text input with debounced availability check — reuse pattern from onboarding)
      - Bio (textarea, max 160 chars with counter)
      - Avatar (tap to change, reuse existing avatar crop flow from Phase 1)
      - Privacy: Public / Private (segmented control)
      - Date of birth (date picker)
      - Location (text input)
      - Website (URL input with validation)
      - Account mode: Bible / Positivity (with confirmation dialog per existing pattern)
      - Denomination (text input, optional)
      - Church (text input, optional)
    - Save button calls PUT /api/settings (merge with existing settings endpoint) or PUT /api/users/me/profile
    - Success toast on save
    - Cancel/back navigation

    **src/app/(app)/profile/edit/page.tsx:**
    - Renders EditProfileForm
    - Fetches current profile data
    - On save success: navigate back to profile
  </action>
  <verify>
    - `npm run build` passes
    - Own profile shows stats, tabs, posts
    - Public profile shows other user's content with follow button
    - Private profile hides posts for non-followers
    - Edit profile saves changes and reflects immediately
  </verify>
  <done>Profile pages complete: own profile with Posts/Reposts/Saved tabs, public profile with privacy gating, edit profile with all fields. Instagram-style header with follow button and stats.</done>
</task>

</tasks>

<verification>
- Own profile shows correct post/follower/following counts
- Public profile shows other user's data with follow button
- Private profile gates content for non-followers
- Profile tabs switch correctly (Posts, Reposts, Saved)
- Edit profile saves and reflects changes
- Follower/following lists paginate and show follow buttons
- Block check returns 404 for blocked users
</verification>

<success_criteria>
- Complete profile system (own, public, edit)
- Privacy gating for private profiles
- Instagram-style header with stats
- Three tabs (Posts, Reposts, Saved)
- Follower/following list modals
- Edit profile with all CONTEXT-specified fields
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-12-SUMMARY.md`
</output>
