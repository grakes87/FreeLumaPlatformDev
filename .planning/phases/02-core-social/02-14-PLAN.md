---
phase: 02-core-social
plan: 14
type: execute
wave: 5
depends_on: ["02-09", "02-10", "02-11", "02-12", "02-13"]
files_modified:
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/admin/page.tsx
  - src/app/(admin)/admin/moderation/page.tsx
  - src/app/(admin)/admin/settings/page.tsx
  - src/app/(admin)/admin/analytics/page.tsx
  - src/app/api/admin/moderation/route.ts
  - src/app/api/admin/moderation/[id]/route.ts
  - src/app/api/admin/analytics/route.ts
  - src/app/api/admin/flagged/route.ts
  - src/components/admin/ModerationQueue.tsx
  - src/components/admin/AdminSettings.tsx
  - src/components/admin/AnalyticsDashboard.tsx
  - src/components/admin/AdminNav.tsx
  - src/components/onboarding/FollowSuggestions.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can view moderation queue with reported and flagged content"
    - "Admin can approve or remove flagged/reported content with reason"
    - "Admin can toggle feed style (TikTok/Instagram) from settings"
    - "Admin can toggle mode isolation (social feed cross-mode visibility)"
    - "Admin can toggle registration mode (open/invite)"
    - "Admin can view analytics: user growth, engagement trends, content volume"
    - "Onboarding FollowSuggestions now uses real follow API and user data"
    - "Non-admin users get 403 on all admin routes"
  artifacts:
    - path: "src/app/(admin)/admin/page.tsx"
      provides: "Admin dashboard home page"
      exports: ["default"]
    - path: "src/app/(admin)/admin/moderation/page.tsx"
      provides: "Moderation queue page"
      exports: ["default"]
    - path: "src/app/(admin)/admin/settings/page.tsx"
      provides: "Platform settings page"
      exports: ["default"]
    - path: "src/app/api/admin/moderation/route.ts"
      provides: "GET moderation queue, POST action on report"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/route.ts"
      provides: "GET analytics data"
      exports: ["GET"]
  key_links:
    - from: "src/app/(admin)/admin/settings/page.tsx"
      to: "src/app/api/platform-settings/route.ts"
      via: "Read/write platform settings"
      pattern: "api/platform-settings"
    - from: "src/app/api/admin/moderation/route.ts"
      to: "src/lib/db/models/Report.ts"
      via: "Query reports with status filters"
      pattern: "Report\\.findAll"
    - from: "src/components/onboarding/FollowSuggestions.tsx"
      to: "src/app/api/follows/suggestions/route.ts"
      via: "Real follow suggestions API"
      pattern: "api/follows/suggestions"
---

<objective>
Build the admin dashboard (analytics, moderation queue, platform settings) and update the onboarding FollowSuggestions component to use real user data and the follow API.

Purpose: The admin dashboard provides content moderation, platform configuration (feed style, mode isolation, registration mode), and analytics. The FollowSuggestions update closes a Phase 1 placeholder that needs real data now that the follow system exists.
Output: 4 pages (admin route group), 4 API routes, 4 components, 1 updated component.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-09-SUMMARY.md
@.planning/phases/02-core-social/02-10-SUMMARY.md
@.planning/phases/02-core-social/02-11-SUMMARY.md
@.planning/phases/02-core-social/02-12-SUMMARY.md
@.planning/phases/02-core-social/02-13-SUMMARY.md
@src/lib/auth/middleware.ts
@src/app/api/admin/
@src/components/onboarding/FollowSuggestions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin dashboard API routes (moderation, analytics, flagged content)</name>
  <files>
    src/app/api/admin/moderation/route.ts
    src/app/api/admin/moderation/[id]/route.ts
    src/app/api/admin/analytics/route.ts
    src/app/api/admin/flagged/route.ts
  </files>
  <action>
    **src/app/api/admin/moderation/route.ts — GET (moderation queue):**
    - withAdmin
    - Query params: status ('pending' | 'reviewed' | 'actioned' | 'dismissed' | 'all', default 'pending'), cursor, limit (default 20), type ('report' | 'flagged' | 'all', default 'all')
    - If type includes 'report': fetch Reports with status filter, include reporter (User), reported post/comment with author
    - If type includes 'flagged': fetch Posts WHERE flagged=true AND not already actioned, and PostComments WHERE flagged=true
    - Combine and sort by created_at DESC
    - Cursor pagination
    - Return { items: [...], next_cursor, has_more, counts: { pending: N, reviewed: N, actioned: N } }

    **src/app/api/admin/moderation/[id]/route.ts — PUT (action on report/flagged item):**
    - withAdmin
    - Zod: { action: enum('approve', 'remove', 'dismiss'), admin_notes?: string, item_type: 'report' | 'flagged_post' | 'flagged_comment' }
    - If item_type='report':
      - Find Report by ID
      - If action='approve': set Report status='reviewed', no content change
      - If action='remove': set Report status='actioned', soft-delete the reported post/comment, set admin_notes
      - If action='dismiss': set Report status='dismissed', set admin_notes
      - Set reviewed_by = admin user id, reviewed_at = NOW()
    - If item_type='flagged_post':
      - If action='approve': set Post flagged=false (clear flag)
      - If action='remove': soft-delete the Post
    - If item_type='flagged_comment':
      - If action='approve': set PostComment flagged=false
      - If action='remove': hard-delete the comment
    - Return { success: true, action }

    **src/app/api/admin/analytics/route.ts — GET:**
    - withAdmin
    - Query param: period ('7d' | '30d' | '90d', default '30d')
    - Calculate:
      - User growth: COUNT users grouped by DATE(created_at) for the period
      - Post volume: COUNT posts grouped by DATE(created_at) for the period
      - Prayer requests: COUNT posts WHERE type='prayer_request' grouped by date
      - Engagement: SUM(reactions + comments) grouped by date
      - Active users: COUNT(DISTINCT user_id) from posts/reactions/comments per day
      - Top content: top 5 posts by engagement (reaction_count + comment_count)
      - Totals: total users, total posts, total prayers, total reactions
    - Return { user_growth: [...], post_volume: [...], engagement: [...], active_users: [...], top_content: [...], totals: {...} }

    **src/app/api/admin/flagged/route.ts — GET (flagged content summary):**
    - withAdmin
    - Returns counts: { flagged_posts: N, flagged_comments: N, pending_reports: N }
    - Quick summary for the admin dashboard home page
  </action>
  <verify>
    - `npm run build` passes
    - Admin moderation queue returns pending reports
    - Admin can approve/remove/dismiss reports
    - Analytics returns date-grouped data
    - Non-admin gets 403 on all endpoints
  </verify>
  <done>Admin API routes complete: moderation queue with action handling (approve/remove/dismiss), analytics with user growth and engagement trends, flagged content summary.</done>
</task>

<task type="auto">
  <name>Task 2: Build admin dashboard pages and update FollowSuggestions</name>
  <files>
    src/app/(admin)/layout.tsx
    src/app/(admin)/admin/page.tsx
    src/app/(admin)/admin/moderation/page.tsx
    src/app/(admin)/admin/settings/page.tsx
    src/app/(admin)/admin/analytics/page.tsx
    src/components/admin/ModerationQueue.tsx
    src/components/admin/AdminSettings.tsx
    src/components/admin/AnalyticsDashboard.tsx
    src/components/admin/AdminNav.tsx
    src/components/onboarding/FollowSuggestions.tsx
  </files>
  <action>
    **src/app/(admin)/layout.tsx:**
    - Admin route group layout
    - Import and use AdminNav sidebar/header
    - Protected: redirect to /feed if not admin (check via useAuth or server-side)
    - Standard admin layout with sidebar navigation + main content area

    **src/components/admin/AdminNav.tsx:**
    - Sidebar navigation for admin:
      - Dashboard (home)
      - Moderation Queue (with pending count badge)
      - Platform Settings
      - Analytics
      - Back to App (link to /feed)
    - Active route highlighting
    - cn() for styling

    **src/app/(admin)/admin/page.tsx (dashboard home):**
    - Overview cards:
      - Total Users (with growth indicator vs last period)
      - Total Posts
      - Pending Reports (red badge if > 0, links to moderation)
      - Flagged Content count
      - Active Users (last 7 days)
    - Quick actions: "Review Reports", "Platform Settings"
    - Mini chart: user growth last 7 days (simple sparkline or bar chart)
    - Fetch from /api/admin/analytics?period=7d and /api/admin/flagged

    **src/app/(admin)/admin/moderation/page.tsx:**
    - Uses ModerationQueue component
    - Page title: "Content Moderation"

    **src/components/admin/ModerationQueue.tsx:**
    - Fetches GET /api/admin/moderation
    - Status filter tabs: Pending | Reviewed | Actioned | Dismissed
    - Type filter: All | Reports | Flagged Content
    - Queue list: each item shows:
      - Content preview (post body or comment text, first 200 chars)
      - Author name + avatar
      - If report: reporter name, reason, details
      - If flagged: "Auto-flagged by profanity filter" label
      - Timestamp
      - Action buttons: Approve (check), Remove (trash), Dismiss (X)
      - Admin notes input (shown on action click)
    - Bulk actions: "Dismiss all reviewed"
    - Pagination with cursor

    **src/app/(admin)/admin/settings/page.tsx:**
    - Uses AdminSettings component

    **src/components/admin/AdminSettings.tsx:**
    - Fetches GET /api/platform-settings
    - Settings groups:
      - **Feed & Display:**
        - Feed Style: TikTok / Instagram toggle (visual toggle with preview images)
        - Search: enabled/disabled toggle
      - **Content & Moderation:**
        - Profanity Filter: enabled/disabled toggle
        - AI Moderation: enabled/disabled toggle
        - Default User Mode: bible / positivity selector
      - **Registration:**
        - Registration Mode: Open / Invite Only toggle
        - Maintenance Mode: on/off toggle (with warning)
      - **Mode Isolation:**
        - Social Feed Mode Isolation: on/off toggle
        - Prayer Wall Mode Isolation: on/off toggle
    - Each toggle calls PUT /api/platform-settings with the key/value
    - Toast confirmation on each change
    - Description text under each setting explaining its effect

    **src/app/(admin)/admin/analytics/page.tsx:**
    - Uses AnalyticsDashboard component

    **src/components/admin/AnalyticsDashboard.tsx:**
    - Period selector: 7 days / 30 days / 90 days
    - Charts (use simple approach — CSS-based bar charts or install lightweight chart lib like recharts if needed, but prefer CSS-only to avoid new deps):
      - User Growth: bar chart (new users per day)
      - Post Volume: line chart (posts per day)
      - Engagement: bar chart (reactions + comments per day)
      - Active Users: line chart (daily active users)
    - Summary cards: totals for the period
    - Top Content section: 5 most-engaged posts with title, author, engagement count
    - Data from /api/admin/analytics

    **src/components/onboarding/FollowSuggestions.tsx — UPDATE:**
    - Replace hardcoded placeholder accounts with real data
    - Fetch GET /api/follows/suggestions on mount
    - Show real user avatars, display names, usernames
    - Each suggestion has a FollowButton (from 02-03)
    - Handle loading state with skeletons
    - Handle empty state: "No suggestions available right now"
    - Keep the same visual layout from Phase 1 but with real data
  </action>
  <verify>
    - `npm run build` passes
    - Admin dashboard shows overview cards with real data
    - Moderation queue displays reports and flagged content
    - Admin can approve/remove/dismiss from moderation queue
    - Platform settings toggles persist changes
    - Analytics charts display date-grouped data
    - FollowSuggestions shows real users (not placeholders)
    - Non-admin users cannot access admin pages
  </verify>
  <done>Admin dashboard complete: overview with stats, moderation queue with action handling, platform settings with all toggles (feed style, mode isolation, registration mode, moderation), analytics with charts. Onboarding FollowSuggestions updated to use real follow API.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2: Core Social — feed with dual display modes (TikTok/Instagram), prayer wall, follow system, reactions, comments, bookmarks, reposts, blocks, reports, profile pages, admin dashboard, and create flow with bottom nav '+' button</what-built>
  <how-to-verify>
    1. Navigate to http://localhost:3000 and log in
    2. **Feed:** Go to /feed — verify FYP/Following tabs, post cards display, infinite scroll, user search bar
    3. **Create:** Tap center '+' button — verify picker shows Feed Post / Prayer Request options. Create a test post with text.
    4. **Reactions:** Long-press on a post — verify 6-emoji reaction picker appears. Select a reaction. Verify count updates.
    5. **Comments:** Tap comment icon on a post — verify bottom sheet opens. Add a comment. Verify it appears.
    6. **Prayer Wall:** Go to /prayer-wall — verify tabs (Others/My Prayers), liquid glass card styling. Create a prayer request.
    7. **Pray:** Tap "Praying for you" on a prayer — verify count increments.
    8. **Profile:** Go to /profile — verify stats, tabs (Posts/Reposts/Saved). Visit another user's profile.
    9. **Follow:** Follow a user from their profile. Verify follower count updates.
    10. **Admin:** Go to /admin — verify dashboard, moderation queue, settings (toggle feed style), analytics.
    11. **Bookmarks:** Bookmark a post, go to /bookmarks, verify it appears.
    12. **Block:** Block a user, verify their content disappears from feed.
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly, or describe any issues to address</resume-signal>
</task>

</tasks>

<verification>
- Admin dashboard accessible only to admin users
- Moderation queue shows pending reports and flagged content
- Admin actions (approve/remove/dismiss) work
- Platform settings persist (feed style, mode isolation, registration mode)
- Analytics display meaningful data
- FollowSuggestions shows real users
- Complete Phase 2 functional end-to-end
</verification>

<success_criteria>
- Admin dashboard with moderation queue, settings, and analytics
- Platform settings control feed style, mode isolation, registration
- Moderation actions work on reports and flagged content
- Onboarding FollowSuggestions uses real data
- Phase 2 passes human verification of all social features
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-14-SUMMARY.md`
</output>
