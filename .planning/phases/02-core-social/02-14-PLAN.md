---
phase: 02-core-social
plan: 14
type: execute
wave: 4
depends_on: [02-03, 02-06, 02-08, 02-10]
files_modified:
  - src/app/(app)/search/page.tsx
  - src/app/(app)/bookmarks/page.tsx
  - src/app/(app)/post/[id]/page.tsx
  - src/components/onboarding/FollowSuggestions.tsx
  - src/app/api/upload/post-image/route.ts
autonomous: false

must_haves:
  truths:
    - "User can search for other users by name or username"
    - "Search results show avatar, name, bio, and follow button"
    - "User can view their bookmarked content page"
    - "User can view post detail page with full comment thread"
    - "Onboarding follow suggestions use real user data"
    - "Post images are optimized via sharp before storage"
  artifacts:
    - path: "src/app/(app)/search/page.tsx"
      provides: "User search page"
      min_lines: 20
    - path: "src/app/(app)/bookmarks/page.tsx"
      provides: "Bookmarks page"
      min_lines: 20
    - path: "src/app/(app)/post/[id]/page.tsx"
      provides: "Post detail page with full comments"
      min_lines: 30
    - path: "src/app/api/upload/post-image/route.ts"
      provides: "Post image presigned URL with sharp optimization"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/(app)/search/page.tsx"
      to: "src/hooks/useUserSearch.ts"
      via: "search hook consumption"
      pattern: "useUserSearch"
    - from: "src/app/(app)/bookmarks/page.tsx"
      to: "/api/bookmarks"
      via: "fetch GET bookmarks"
      pattern: "fetch.*api/bookmarks"
    - from: "src/app/(app)/post/[id]/page.tsx"
      to: "src/components/social/CommentSection.tsx"
      via: "full comment thread display"
      pattern: "CommentSection"
---

<objective>
Build the search page, bookmarks page, post detail page, update onboarding follow suggestions to use real data, and create the post image upload/optimization endpoint.

Purpose: These are remaining pages and integrations that complete the Phase 2 feature set. Search enables friend discovery. Bookmarks provide saved content access. Post detail gives a full view with comments. Image optimization fulfills FEED-11. Updating follow suggestions fixes the Phase 1 placeholder (Pitfall 8 from research).
Output: 3 pages, 1 API route, 1 component update.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-03-SUMMARY.md
@.planning/phases/02-core-social/02-06-SUMMARY.md
@.planning/phases/02-core-social/02-08-SUMMARY.md
@.planning/phases/02-core-social/02-10-SUMMARY.md

@src/hooks/useUserSearch.ts
@src/components/social/UserSearchResult.tsx
@src/components/social/CommentSection.tsx
@src/components/feed/PostCard.tsx
@src/components/onboarding/FollowSuggestions.tsx
@src/app/api/upload/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search page, bookmarks page, and post detail page</name>
  <files>
    src/app/(app)/search/page.tsx
    src/app/(app)/bookmarks/page.tsx
    src/app/(app)/post/[id]/page.tsx
  </files>
  <action>
    **src/app/(app)/search/page.tsx:**
    'use client'. User search page. Layout:
    - Search input at top (text input with search icon, auto-focus)
    - Uses useUserSearch hook
    - Results area below: UserSearchResult cards
    - Loading indicator during search
    - Empty state: "Search for users by name or username"
    - No results state: "No users found for '[query]'"
    - Minimum 2 characters to search (show hint)

    **src/app/(app)/bookmarks/page.tsx:**
    'use client'. Bookmarks page. Layout:
    - Page header: "Bookmarks"
    - Folder tabs/sidebar: "All" + user's folders (fetch from /api/bookmarks/folders). Clicking a folder filters bookmarks.
    - Bookmark list: fetch from GET /api/bookmarks with optional folder_id filter. Display bookmarked posts as PostCards (for post bookmarks) and daily content cards (for daily bookmarks — simpler display with date and title).
    - Uses cursor pagination + useInfiniteScroll
    - Empty state: "No bookmarks yet. Tap the bookmark icon on posts to save them here."
    - "Manage Folders" button: opens modal to create/rename/delete folders

    **src/app/(app)/post/[id]/page.tsx:**
    'use client'. Post detail page. Full view of a single post with complete comment thread.
    - Fetches post from GET /api/posts/[id]
    - Renders PostCard (expanded view, not card-in-card)
    - Full CommentSection below (showing all comments, not collapsed)
    - Back button to feed
    - Loading skeleton during fetch
    - 404 state if post not found
    - This is the page linked to from share URLs and post clicks in feed
  </action>
  <verify>
    Navigate to /search — search input works, results appear.
    Navigate to /bookmarks — shows bookmarked content with folders.
    Navigate to /post/1 — shows post detail with comments.
  </verify>
  <done>Search, bookmarks, and post detail pages are functional with proper navigation and data loading.</done>
</task>

<task type="auto">
  <name>Task 2: Update follow suggestions and create post image upload endpoint</name>
  <files>
    src/components/onboarding/FollowSuggestions.tsx
    src/app/api/upload/post-image/route.ts
  </files>
  <action>
    **Update src/components/onboarding/FollowSuggestions.tsx:**
    Replace the placeholder/hardcoded accounts with real data. On mount: fetch from GET /api/follows/suggestions. Display real users with their actual avatars, display names, and bios. Use UserSearchResult or a similar card layout. Each suggestion has a FollowButton. If no suggestions available (e.g., user already follows everyone), show a friendly message. Keep the component usable in both onboarding context and EmptyFeedState.

    **src/app/api/upload/post-image/route.ts:**
    Extend the existing presigned upload pattern from src/app/api/upload/route.ts.

    GET: withAuth. Generate presigned PUT URL for post image upload. Key format: `posts/{userId}/{timestamp}-{random}.{ext}`. Allowed content types: image/jpeg, image/png, image/webp, image/gif. Max file size: 5MB (enforced in presigned URL conditions). Return { url, key, expires_in }.

    POST: withAuth. Confirm upload endpoint. Body: { key: string }. After upload is confirmed: (1) Download the file from B2. (2) Use sharp to resize to max 1200px wide (maintain aspect ratio), convert to WebP at 85% quality. (3) Upload optimized version back to B2 (overwrite or new key). (4) Return the public CDN URL for the optimized image.

    If sharp processing fails (e.g., invalid image), return error. This endpoint is called by PostComposer before post creation — the returned URL is passed as image_key to the create post API.
  </action>
  <verify>
    1. FollowSuggestions shows real users (not placeholders) in onboarding or empty feed
    2. GET /api/upload/post-image — returns presigned URL
    3. POST /api/upload/post-image with key — processes image and returns CDN URL
  </verify>
  <done>Follow suggestions use real users. Post images are optimized to WebP via sharp and served from CDN.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Search page, bookmarks page with folders, post detail page, real follow suggestions, and post image optimization pipeline</what-built>
  <how-to-verify>
    1. Navigate to http://localhost:3000/search — type a username, verify results appear with follow buttons
    2. Navigate to http://localhost:3000/bookmarks — verify bookmarked posts appear, folder switching works
    3. Click a post in the feed — verify /post/[id] shows post detail with full comment thread
    4. Create a post with an image — verify image appears optimized
    5. Start fresh onboarding (or check EmptyFeedState) — verify follow suggestions show real users
    6. Share a post — verify the shared URL /post/[id] is publicly accessible
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. /search shows search input and results with follow actions
2. /bookmarks shows bookmarked content with folder organization
3. /post/[id] shows full post with complete comment thread
4. Follow suggestions show real users from database
5. Post image upload optimizes to WebP with sharp
6. All pages handle loading and empty states
</verification>

<success_criteria>
- User search page enables friend discovery
- Bookmarks page provides organized saved content access
- Post detail page serves as shareable post URL
- Onboarding follow suggestions replaced with real data (Pitfall 8 resolved)
- Post images optimized (max 1200px, WebP 85%) before CDN delivery
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-14-SUMMARY.md`
</output>
