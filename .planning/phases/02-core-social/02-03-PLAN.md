---
phase: 02-core-social
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/api/follows/route.ts
  - src/app/api/follows/suggestions/route.ts
  - src/app/api/users/search/route.ts
  - src/hooks/useFollow.ts
  - src/hooks/useUserSearch.ts
  - src/components/social/FollowButton.tsx
  - src/components/social/UserSearchResult.tsx
autonomous: true

must_haves:
  truths:
    - "User can follow another user"
    - "User can unfollow a followed user"
    - "User can view list of their followers"
    - "User can view list of users they follow"
    - "User can search for users by name or username"
    - "Search results show avatar, display name, username, and bio preview"
    - "Follow suggestions show real users (not placeholder accounts)"
  artifacts:
    - path: "src/app/api/follows/route.ts"
      provides: "Follow/unfollow toggle and follower/following lists"
      exports: ["GET", "POST"]
    - path: "src/hooks/useFollow.ts"
      provides: "Follow state management with optimistic updates"
      exports: ["useFollow"]
    - path: "src/components/social/FollowButton.tsx"
      provides: "Follow/unfollow toggle button component"
      exports: ["FollowButton"]
    - path: "src/app/api/users/search/route.ts"
      provides: "User search by name/username"
      exports: ["GET"]
    - path: "src/hooks/useUserSearch.ts"
      provides: "Debounced user search hook"
      exports: ["useUserSearch"]
  key_links:
    - from: "src/components/social/FollowButton.tsx"
      to: "src/hooks/useFollow.ts"
      via: "hook consumption"
      pattern: "useFollow"
    - from: "src/hooks/useFollow.ts"
      to: "/api/follows"
      via: "fetch POST toggle"
      pattern: "fetch.*api/follows"
    - from: "src/hooks/useUserSearch.ts"
      to: "/api/users/search"
      via: "debounced fetch"
      pattern: "fetch.*api/users/search"
---

<objective>
Create the follow system (API + hook + button), user search (API + hook + result component), and follow suggestions endpoint.

Purpose: The follow system defines the social graph that feeds are built on. User search enables friend discovery. Follow suggestions replace Phase 1 placeholder accounts. These are needed before the feed can be assembled.
Output: 3 API routes, 2 hooks, 2 UI components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-01-SUMMARY.md

@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/hooks/useReactions.ts
@src/lib/db/models/index.ts
@src/components/onboarding/FollowSuggestions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create follow API and user search API</name>
  <files>
    src/app/api/follows/route.ts
    src/app/api/follows/suggestions/route.ts
    src/app/api/users/search/route.ts
  </files>
  <action>
    **src/app/api/follows/route.ts:**

    GET: withAuth. Query params: type ('followers' | 'following', default 'following'), user_id (optional, defaults to current user), cursor (optional), limit (default 20, max 50). If type=followers, query Follow where following_id = target user, include follower User (id, username, display_name, avatar_url, bio). If type=following, query Follow where follower_id = target user, include following User. Use cursor-based pagination on (created_at, id). Also return: is_following boolean for each user (whether current user follows them), follower_count and following_count for the target user.

    POST: withAuth. Body: { user_id: number }. Validate target user exists and is not self. Toggle: if Follow exists (follower_id=currentUser, following_id=target), destroy (unfollow); if not, create (follow). Return { action: 'followed' | 'unfollowed', follower_count, following_count }.

    **src/app/api/follows/suggestions/route.ts:**

    GET: withAuth. Return up to 10 suggested users to follow. Query users WHERE id NOT IN (already followed user IDs) AND id != current user AND is_active = true. Order by most recently created (newest users) or random. Include id, username, display_name, avatar_url, bio. Exclude blocked users using getBlockedUserIds utility.

    **src/app/api/users/search/route.ts:**

    GET: withAuth. Query param: q (search string, min 2 chars). Search User where username LIKE '%q%' OR display_name LIKE '%q%', exclude current user, exclude blocked users. Return up to 20 results: id, username, display_name, avatar_url, bio, is_following (whether current user follows them). Use Op.like for case-insensitive search on MySQL/MariaDB.
  </action>
  <verify>
    Test with curl:
    1. POST /api/follows with { user_id: 2 } — should toggle follow
    2. GET /api/follows?type=following — should list followed users
    3. GET /api/follows/suggestions — should return non-followed users
    4. GET /api/users/search?q=admin — should return matching users
  </verify>
  <done>Follow toggle works, follower/following lists paginate correctly, suggestions exclude already-followed and blocked users, search returns matching users with follow status.</done>
</task>

<task type="auto">
  <name>Task 2: Create useFollow hook, useUserSearch hook, FollowButton, and UserSearchResult components</name>
  <files>
    src/hooks/useFollow.ts
    src/hooks/useUserSearch.ts
    src/components/social/FollowButton.tsx
    src/components/social/UserSearchResult.tsx
  </files>
  <action>
    **src/hooks/useFollow.ts:**
    Hook that takes targetUserId. Manages isFollowing state. On mount, optionally accept initial isFollowing value. Exposes toggle() function that: (1) optimistically flips isFollowing, (2) POSTs to /api/follows with { user_id: targetUserId }, (3) on error, rolls back. Also exposes loading state. Follow the same optimistic update pattern as useReactions.ts.

    **src/hooks/useUserSearch.ts:**
    Hook with 400ms debounced search. Exposes: query, results (array of user objects), loading, search(q: string). Pattern matches the debounced username check from onboarding. Uses ref for timeout to clear on new input. Returns empty results for queries under 2 chars.

    **src/components/social/FollowButton.tsx:**
    Button component that takes userId, initialIsFollowing, size ('sm' | 'md'). Uses useFollow hook. Shows "Follow" (primary style) when not following, "Following" (outline/muted style) when following. On hover when following, text changes to "Unfollow" with red tint. Disabled during loading. Use cn() for class merging. Use Button from UI library.

    **src/components/social/UserSearchResult.tsx:**
    Card component showing user avatar (or InitialsAvatar fallback), display_name, @username, bio (truncated to ~80 chars), and FollowButton. Takes user object prop. Links to /profile/[username] on click (the card itself is a link, button stops propagation).
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compilation.
    Verify FollowButton renders in browser by temporarily importing in an existing page.
  </verify>
  <done>useFollow provides optimistic follow/unfollow toggle. useUserSearch provides debounced search. FollowButton shows correct state. UserSearchResult displays user info with follow action.</done>
</task>

</tasks>

<verification>
1. Follow/unfollow toggles correctly via API
2. Follower and following lists return with cursor pagination
3. Follow suggestions exclude followed users and blocked users
4. User search returns matching results with is_following status
5. FollowButton optimistically updates on click
6. UserSearchResult displays avatar, name, username, bio, follow button
</verification>

<success_criteria>
- Follow system fully functional (toggle, lists, counts)
- User search returns relevant results excluding blocks
- Follow suggestions use real user data (not placeholders)
- Components compile and render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-03-SUMMARY.md`
</output>
