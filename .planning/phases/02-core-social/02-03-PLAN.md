---
phase: 02-core-social
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/follows/route.ts
  - src/app/api/follows/[userId]/route.ts
  - src/app/api/follows/requests/route.ts
  - src/app/api/follows/suggestions/route.ts
  - src/app/api/users/search/route.ts
  - src/app/api/users/[id]/followers/route.ts
  - src/app/api/users/[id]/following/route.ts
  - src/hooks/useFollow.ts
  - src/hooks/useUserSearch.ts
  - src/components/social/FollowButton.tsx
  - src/components/social/UserSearchResult.tsx
autonomous: true

must_haves:
  truths:
    - "User can follow another user via POST /api/follows/[userId]"
    - "User can unfollow a user via DELETE /api/follows/[userId]"
    - "Private profile follow creates 'pending' request; public profile creates 'active' follow"
    - "User can accept/reject pending follow requests"
    - "User can search for other users by name or username"
    - "Search results show avatar, display_name, username, and follow status"
    - "Search respects mode isolation when enabled"
    - "Follow suggestions return mix of popular + interest-based + new users"
    - "Block filtering: blocked users excluded from search and follow lists"
  artifacts:
    - path: "src/app/api/follows/[userId]/route.ts"
      provides: "POST follow, DELETE unfollow"
      exports: ["POST", "DELETE"]
    - path: "src/app/api/users/search/route.ts"
      provides: "GET user search with debounced query"
      exports: ["GET"]
    - path: "src/hooks/useFollow.ts"
      provides: "Optimistic follow/unfollow toggle hook"
      exports: ["useFollow"]
    - path: "src/components/social/FollowButton.tsx"
      provides: "Follow/Unfollow/Requested button component"
      exports: ["FollowButton"]
  key_links:
    - from: "src/components/social/FollowButton.tsx"
      to: "src/hooks/useFollow.ts"
      via: "useFollow hook for state management"
      pattern: "useFollow"
    - from: "src/app/api/follows/[userId]/route.ts"
      to: "src/lib/db/models/Follow.ts"
      via: "Follow.create() / Follow.destroy()"
      pattern: "Follow\\.(create|destroy|findOne)"
    - from: "src/app/api/users/search/route.ts"
      to: "src/lib/utils/blocks.ts"
      via: "Exclude blocked users from search results"
      pattern: "getBlockedUserIds"
---

<objective>
Build the complete follow system (follow/unfollow/request/accept/reject, follower/following lists) and user search functionality with hooks and UI components.

Purpose: The follow system is required for the "Following" feed tab (02-06) and profile follower/following lists (02-12). User search is a core discovery feature placed at the top of the feed page.
Output: 7 API route files, 2 hooks, 2 components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-01-SUMMARY.md
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
@src/hooks/useReactions.ts
@src/components/onboarding/FollowSuggestions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create follow system API routes (follow/unfollow, requests, suggestions, follower lists)</name>
  <files>
    src/app/api/follows/[userId]/route.ts
    src/app/api/follows/requests/route.ts
    src/app/api/follows/suggestions/route.ts
    src/app/api/users/[id]/followers/route.ts
    src/app/api/users/[id]/following/route.ts
  </files>
  <action>
    **src/app/api/follows/[userId]/route.ts:**

    **POST (follow):**
    - withAuth
    - Prevent self-follow (return 400)
    - Check block list — if target is blocked or blocks the user, return 404 ("User not found")
    - Check if already following — if yes, return 409 ("Already following")
    - Check target user's profile_privacy:
      - 'public': Create Follow with status='active'
      - 'private': Create Follow with status='pending'
    - Auto-unfollow if there was a previous rejected/removed follow (delete old row first, then create new)
    - Check mode isolation: query PlatformSetting.get('mode_isolation_social'). If 'true', verify both users have the same mode. If different modes and isolation is on, return 403 ("Cannot follow users in different mode")
    - Return { status: 'active' | 'pending', following_id: userId }

    **DELETE (unfollow / cancel request):**
    - withAuth
    - Find Follow where follower_id = me AND following_id = target
    - If not found, return 404
    - Delete the follow row
    - Return { success: true }

    **src/app/api/follows/requests/route.ts:**

    **GET (list pending follow requests for current user):**
    - withAuth
    - Query Follow where following_id = me AND status = 'pending'
    - Include follower User (id, username, display_name, avatar_url)
    - Return paginated list

    **PUT (accept/reject follow request):**
    - withAuth
    - Body: { follower_id: number, action: 'accept' | 'reject' }
    - Find Follow where follower_id AND following_id = me AND status = 'pending'
    - If accept: update status to 'active'
    - If reject: delete the row
    - Return { success: true, action }

    **src/app/api/follows/suggestions/route.ts:**
    **GET (follow suggestions):**
    - withAuth
    - Mixed algorithm:
      1. Popular users: top 10 by follower count (not already followed, not blocked)
      2. Interest-based: users who share categories from onboarding (query user_categories overlap)
      3. New users: recently joined (last 30 days)
    - Combine, deduplicate, exclude already-followed and blocked users
    - Apply mode isolation if enabled
    - Return up to 20 suggestions with: id, username, display_name, avatar_url, bio, mutual_followers_count (optional: skip if complex)

    **src/app/api/users/[id]/followers/route.ts — GET:**
    - withAuth
    - Check profile privacy: if target profile is private and requesting user doesn't follow them, return 403
    - Query Follow where following_id = target AND status = 'active'
    - Include follower User details
    - Exclude blocked users
    - Cursor-based pagination
    - Return list with follow status relative to requesting user

    **src/app/api/users/[id]/following/route.ts — GET:**
    - Same pattern as followers but query follower_id = target
    - Same privacy and block checks
  </action>
  <verify>
    - `npm run build` passes
    - Test follow flow: POST follow -> GET followers shows the new follow -> DELETE unfollow -> GET shows removed
    - Test private profile: follow creates 'pending', accept changes to 'active'
  </verify>
  <done>Follow system API complete: follow/unfollow with public/private handling, pending request management (accept/reject), follower/following lists with privacy checks, follow suggestions with mixed algorithm.</done>
</task>

<task type="auto">
  <name>Task 2: Create user search API, useFollow hook, useUserSearch hook, FollowButton, UserSearchResult</name>
  <files>
    src/app/api/users/search/route.ts
    src/hooks/useFollow.ts
    src/hooks/useUserSearch.ts
    src/components/social/FollowButton.tsx
    src/components/social/UserSearchResult.tsx
  </files>
  <action>
    **src/app/api/users/search/route.ts — GET:**
    - withAuth
    - Query param: q (search string, min 2 chars)
    - Search users WHERE (username LIKE '%q%' OR display_name LIKE '%q%') — case insensitive
    - Exclude: blocked users (both directions), the requesting user themselves
    - Apply mode isolation: if PlatformSetting 'mode_isolation_social' is 'true', only return users with same mode as requesting user
    - Limit to 20 results
    - For each result, include: id, username, display_name, avatar_url, bio (first 100 chars)
    - Also include follow_status for each result relative to the requesting user: 'following' | 'pending' | 'none'
    - Return { users: [...] }

    **src/hooks/useFollow.ts:**
    - Hook: `useFollow(targetUserId: number, initialStatus: 'following' | 'pending' | 'none')`
    - State: followStatus, loading
    - `toggle()`: Optimistic update. If 'following' or 'pending' -> call DELETE, set to 'none'. If 'none' -> call POST, set to response status ('active'->='following' or 'pending')
    - On error: rollback to previous state
    - Return { followStatus, loading, toggle }

    **src/hooks/useUserSearch.ts:**
    - Follow the debounced search pattern from 02-RESEARCH.md
    - 400ms debounce with timeoutRef
    - Min 2 characters to trigger search
    - Clear results if query < 2 chars
    - Return { query, results, loading, search, clear }

    **src/components/social/FollowButton.tsx:**
    - Props: userId, initialStatus, size ('sm' | 'md')
    - Uses useFollow hook
    - Renders button:
      - 'following': outline button "Following" -> on click shows confirm "Unfollow?"
      - 'pending': outline button "Requested" -> on click cancels request
      - 'none': filled primary button "Follow" -> on click follows
    - Disabled while loading
    - Use cn() for Tailwind classes, dark mode support

    **src/components/social/UserSearchResult.tsx:**
    - Props: user (id, username, display_name, avatar_url, bio, follow_status)
    - Renders: avatar (or initials fallback), display_name, @username, truncated bio
    - Includes FollowButton on the right side
    - Entire card is clickable (links to /profile/[username])
    - Use cn() for styling, dark mode
  </action>
  <verify>
    - `npm run build` passes
    - Search API returns results with follow status
    - FollowButton renders in all three states
  </verify>
  <done>User search API with mode isolation and block filtering. useFollow hook with optimistic updates. useUserSearch with 400ms debounce. FollowButton with following/pending/none states. UserSearchResult card component.</done>
</task>

</tasks>

<verification>
- Follow/unfollow cycle works end-to-end
- Private profile follow creates pending request
- Accept/reject request works
- Search returns users with follow status
- Mode isolation filters search results when enabled
- Blocked users excluded from all queries
- FollowButton shows correct state and toggles
</verification>

<success_criteria>
- Complete follow system with public/private profile handling
- User search with mode isolation and block filtering
- Reusable FollowButton and UserSearchResult components
- Follow suggestions algorithm
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-03-SUMMARY.md`
</output>
