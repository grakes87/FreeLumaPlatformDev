---
phase: 02-core-social
plan: 05
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/post-comments/route.ts
  - src/app/api/post-comments/[id]/route.ts
  - src/hooks/usePostComments.ts
  - src/components/social/PostCommentSheet.tsx
  - src/components/social/PostCommentThread.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a comment on a post"
    - "User can reply to a comment (2 levels deep: comment -> reply -> flat after that)"
    - "User can edit their own comments (no time limit per CONTEXT)"
    - "User can delete their own comments"
    - "Comments are paginated with cursor-based pagination"
    - "Comments with profanity are created but flagged for admin review"
    - "Comments from blocked users are excluded"
    - "Comments display in a bottom sheet UI (slide-up over feed)"
  artifacts:
    - path: "src/app/api/post-comments/route.ts"
      provides: "GET paginated comments, POST create comment"
      exports: ["GET", "POST"]
    - path: "src/app/api/post-comments/[id]/route.ts"
      provides: "PUT edit comment, DELETE comment"
      exports: ["PUT", "DELETE"]
    - path: "src/hooks/usePostComments.ts"
      provides: "Paginated comment loading with create/edit/delete"
      exports: ["usePostComments"]
    - path: "src/components/social/PostCommentSheet.tsx"
      provides: "Bottom sheet comment panel for posts"
      exports: ["PostCommentSheet"]
  key_links:
    - from: "src/components/social/PostCommentSheet.tsx"
      to: "src/hooks/usePostComments.ts"
      via: "usePostComments hook"
      pattern: "usePostComments"
    - from: "src/app/api/post-comments/route.ts"
      to: "src/lib/moderation/profanity.ts"
      via: "checkAndFlag on comment body"
      pattern: "checkAndFlag|containsProfanity"
---

<objective>
Build the threaded comment system for posts — API routes with pagination, profanity filtering, and block exclusion, plus the client-side hook and bottom sheet UI.

Purpose: Comments are the primary engagement mechanism on posts. They appear in a bottom sheet overlay (per CONTEXT) with threaded replies limited to 2 levels.
Output: 2 API route files, 1 hook, 2 components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-CONTEXT.md
@.planning/phases/02-core-social/02-01-SUMMARY.md
@src/app/api/daily-comments/route.ts
@src/app/api/daily-comments/[id]/route.ts
@src/hooks/useComments.ts
@src/components/daily/CommentBottomSheet.tsx
@src/components/daily/CommentThread.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post comments API routes (CRUD with threading and profanity)</name>
  <files>
    src/app/api/post-comments/route.ts
    src/app/api/post-comments/[id]/route.ts
  </files>
  <action>
    **src/app/api/post-comments/route.ts — Mirror daily-comments/route.ts pattern:**

    **GET (paginated comments for a post):**
    - withAuth
    - Query params: post_id (required), cursor (optional), limit (default 20, max 50), parent_id (optional — if null/absent, fetch root comments only)
    - Get blocked user IDs via getBlockedUserIds(userId)
    - Fetch comments WHERE post_id AND parent_id IS NULL (root) or parent_id = specified
    - Exclude comments from blocked users
    - Include author (User: id, username, display_name, avatar_url)
    - For root comments, also include reply count as subquery: `(SELECT COUNT(*) FROM post_comments WHERE parent_id = PostComment.id)`
    - Include top 2 replies per root comment (using a separate query or subquery) with their authors
    - Cursor-based pagination using (created_at, id)
    - Return { comments: [...], next_cursor, has_more }

    **POST (create comment):**
    - withAuth
    - Zod schema: { post_id: number, body: string (1-2000), parent_id?: number | null }
    - Verify the post exists and is not deleted
    - If parent_id provided:
      - Verify parent comment exists on the same post
      - Enforce 2-level depth: if parent comment itself has a parent_id, redirect the reply to the parent's parent (flatten to 2 levels). That is, if replying to a reply, set parent_id to the root comment's id.
    - Run checkAndFlag(body) — set flagged = result.flagged (don't block)
    - Create PostComment
    - Return comment with author info

    **src/app/api/post-comments/[id]/route.ts:**

    **PUT (edit comment):**
    - withAuth
    - Verify user owns the comment
    - Per CONTEXT: no time limit on edit/delete
    - Zod: { body: string (1-2000) }
    - Re-run profanity check, update flagged
    - Set edited = true
    - Return updated comment

    **DELETE (delete comment):**
    - withAuth
    - Verify user owns the comment OR user is admin
    - Hard delete the comment (not soft delete for comments)
    - Also delete all replies (PostComment WHERE parent_id = comment.id) — cascade
    - Return { success: true }
  </action>
  <verify>
    - `npm run build` passes
    - Create comment -> edit -> delete flow works
    - Reply to a reply flattens to 2 levels (reply attaches to root)
    - Blocked users' comments excluded from GET
  </verify>
  <done>Post comments CRUD API complete: paginated fetch with threading (2 levels max), create with profanity flagging, edit with re-check, delete with cascade. Block filtering works.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePostComments hook and comment bottom sheet UI</name>
  <files>
    src/hooks/usePostComments.ts
    src/components/social/PostCommentSheet.tsx
    src/components/social/PostCommentThread.tsx
  </files>
  <action>
    **src/hooks/usePostComments.ts — Mirror useComments.ts pattern:**
    - Hook: `usePostComments(postId: number)`
    - State: comments (array), loading, hasMore, submitting
    - Fetch root comments on mount with cursor pagination
    - `loadMore()`: fetch next page using cursor
    - `loadReplies(commentId: number)`: fetch replies for a specific root comment
    - `addComment(body: string, parentId?: number)`: POST to API, prepend to list (or add as reply)
    - `editComment(commentId: number, body: string)`: PUT to API, update in-place
    - `deleteComment(commentId: number)`: DELETE to API, remove from list
    - Return { comments, loading, hasMore, submitting, loadMore, loadReplies, addComment, editComment, deleteComment, totalCount }

    **src/components/social/PostCommentSheet.tsx:**
    - Props: postId: number, isOpen: boolean, onClose: () => void
    - Uses usePostComments hook
    - Bottom sheet overlay (slide up from bottom, covers ~80% of screen height)
    - Liquid glass styling: bg-white/10 backdrop-blur-2xl (matching existing CommentBottomSheet from daily content)
    - Header: "Comments" title + close button + total count
    - Scrollable comment list area
    - Input bar at bottom: text input + send button (fixed to bottom of sheet)
    - "Load more" button at end of list (or auto-load with intersection observer)
    - Empty state: "No comments yet. Be the first to comment!"
    - Animate entrance: slide up with backdrop fade
    - Dark mode support

    **src/components/social/PostCommentThread.tsx:**
    - Props: comment (with author, replies, reply_count), onReply, onEdit, onDelete, currentUserId
    - Renders a single comment with:
      - Author avatar + display name + relative timestamp
      - Comment body text
      - Edited badge if edited=true
      - Reaction bar (using PostCommentReactions from 02-04)
      - Reply button (shows reply count if > 0)
      - "..." menu for own comments: Edit, Delete
    - Nested replies: rendered below with indent
    - "View X more replies" link if reply_count > loaded replies
    - Use cn() for styling, dark mode support
    - Liquid glass styling for comment bubbles
  </action>
  <verify>
    - `npm run build` passes
    - PostCommentSheet renders as bottom sheet overlay
    - Can create comment, reply, edit, delete through the UI
    - Threading displays correctly with 2-level depth
  </verify>
  <done>Comment system UI complete: bottom sheet with liquid glass styling, threaded comments (2 levels), create/edit/delete through UI, reply flattening, cursor-based pagination with load more.</done>
</task>

</tasks>

<verification>
- Comment CRUD: create, reply, edit, delete all work
- Threading: replies appear nested under parent; reply-to-reply flattens
- Profanity flagging: flagged comments still appear but are marked
- Block filtering: comments from blocked users hidden
- Bottom sheet UI: slides up, scrollable, input bar at bottom
- Pagination: load more works with cursor
</verification>

<success_criteria>
- Complete comment system for posts
- 2-level threading with automatic flattening
- Profanity flagging (not blocking)
- Bottom sheet UI matching liquid glass aesthetic
- Reusable for both feed posts and prayer requests
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-05-SUMMARY.md`
</output>
