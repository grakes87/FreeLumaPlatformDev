---
phase: 02-core-social
plan: 05
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/api/post-comments/route.ts
  - src/app/api/post-comments/[id]/route.ts
  - src/hooks/usePostComments.ts
  - src/components/social/CommentSection.tsx
autonomous: true

must_haves:
  truths:
    - "User can comment on a post"
    - "User can reply to a comment (one level of nesting)"
    - "User can edit their own comment within 15-minute window"
    - "User can delete their own comment"
    - "Comments display with author avatar, name, and relative time"
    - "Comments with profanity are rejected"
  artifacts:
    - path: "src/app/api/post-comments/route.ts"
      provides: "List and create post comments"
      exports: ["GET", "POST"]
    - path: "src/app/api/post-comments/[id]/route.ts"
      provides: "Edit and delete post comments"
      exports: ["PUT", "DELETE"]
    - path: "src/hooks/usePostComments.ts"
      provides: "Post comments state with pagination"
      exports: ["usePostComments"]
    - path: "src/components/social/CommentSection.tsx"
      provides: "Threaded comment display for posts"
      exports: ["CommentSection"]
  key_links:
    - from: "src/components/social/CommentSection.tsx"
      to: "src/hooks/usePostComments.ts"
      via: "hook consumption"
      pattern: "usePostComments"
    - from: "src/hooks/usePostComments.ts"
      to: "/api/post-comments"
      via: "fetch GET list + POST create"
      pattern: "fetch.*api/post-comments"
---

<objective>
Create the post comment system: API routes for listing, creating, editing, and deleting comments with threading support; a React hook for comment state management; and a CommentSection component.

Purpose: Comments are the primary engagement interaction on posts. This mirrors the existing daily comment system (useComments, daily-comments API, CommentBottomSheet) adapted for the post feed.
Output: 2 API route files, 1 hook, 1 component.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-01-SUMMARY.md

@src/app/api/daily-comments/route.ts
@src/app/api/daily-comments/[id]/route.ts
@src/hooks/useComments.ts
@src/components/daily/CommentBottomSheet.tsx
@src/components/daily/CommentThread.tsx
@src/lib/moderation/profanity.ts
@src/lib/auth/middleware.ts
@src/lib/utils/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post comments API routes</name>
  <files>
    src/app/api/post-comments/route.ts
    src/app/api/post-comments/[id]/route.ts
  </files>
  <action>
    Mirror the pattern from daily-comments API but for posts.

    **src/app/api/post-comments/route.ts:**

    GET: withAuth. Query params: post_id (required), cursor (optional), limit (default 20, max 50). Fetch root comments (parent_id IS NULL) for the post, ordered by created_at DESC with cursor pagination. For each root comment, eager-load replies (PostComment where parent_id = root.id, ordered by created_at ASC, limit 3 for preview). Include author User (id, username, display_name, avatar_url) for both comments and replies. Also return reply_count per root comment as a subquery attribute. Exclude comments from blocked users (use getBlockedUserIds). Return { comments, next_cursor, has_more, total_count }.

    POST: withAuth. Body: { post_id: number, body: string (1-2000), parent_id: number | null }. Check profanity with containsProfanity. If parent_id provided, verify parent comment exists and belongs to same post. Only allow 1 level of nesting: if parent comment itself has a parent_id, reject with "Cannot reply to a reply." Set edit_deadline = created_at + 15 minutes. Return created comment with author data.

    **src/app/api/post-comments/[id]/route.ts:**

    PUT: withAuth. Only comment author can edit. Check edit_deadline — if expired, return 403. Zod body: { body: string (1-2000) }. Check profanity. Update body, set edited = true. Return updated comment.

    DELETE: withAuth. Only comment author (or admin) can delete. Destroy the comment (hard delete, not soft). If comment has replies, delete replies too (CASCADE handles this via FK). Return success.
  </action>
  <verify>
    curl POST /api/post-comments -d '{"post_id":1,"body":"Great post!"}' — creates comment.
    curl GET /api/post-comments?post_id=1 — returns threaded comments.
    curl PUT /api/post-comments/1 -d '{"body":"Edited comment"}' — edits within window.
    curl DELETE /api/post-comments/1 — deletes comment.
  </verify>
  <done>Post comments CRUD works with threading (1 level), profanity check, edit window, and block exclusion.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePostComments hook and CommentSection component</name>
  <files>
    src/hooks/usePostComments.ts
    src/components/social/CommentSection.tsx
  </files>
  <action>
    **src/hooks/usePostComments.ts:**
    Mirror src/hooks/useComments.ts but for /api/post-comments with post_id param. Hook takes postId. Exposes: comments (array with nested replies), totalCount, hasMore, loading, addComment(body, parentId?), editComment(id, body), deleteComment(id), loadMore(). On addComment, optimistically prepend the new comment to the list. Manages cursor for pagination.

    **src/components/social/CommentSection.tsx:**
    Adapted from CommentBottomSheet/CommentThread patterns but designed for inline display on PostCard or post detail page (not a bottom sheet). Shows:
    - Comment input at top (textarea with submit button)
    - List of root comments, each showing: author avatar + name, body, relative time, edited badge, reply button, edit/delete buttons (if own comment within deadline)
    - Reply toggle: clicking "Reply" shows nested input under the comment
    - Replies indented under parent (max 1 level)
    - "Load more" button for pagination (or "View all N replies" for reply expansion)
    - Props: postId, initialCommentCount (for showing "N comments" header)
    - Use Tailwind styling consistent with the app's design system. Use cn() for classes.
    - Do NOT use liquid glass styling (that's only for daily content overlay). Use standard card/surface styling.
  </action>
  <verify>
    npm run build — no TypeScript errors.
    CommentSection renders comment input and comment list when given a valid postId.
  </verify>
  <done>usePostComments manages comment CRUD with pagination. CommentSection displays threaded comments with inline reply, edit, and delete functionality.</done>
</task>

</tasks>

<verification>
1. POST /api/post-comments creates comment with profanity check
2. GET /api/post-comments returns paginated threaded comments
3. Replies nest under parent (1 level max)
4. Edit within 15 min works, after 15 min returns 403
5. Delete removes comment and cascades to replies
6. Blocked user comments excluded from results
7. CommentSection renders inline with comment input and threaded list
</verification>

<success_criteria>
- Post comments API mirrors daily-comments pattern for posts
- One level of reply nesting enforced
- Edit deadline pattern (15 min) works for comments
- Profanity filter blocks inappropriate comments
- CommentSection provides full CRUD UI inline
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-05-SUMMARY.md`
</output>
