---
phase: 02-core-social
plan: 13
type: execute
wave: 4
depends_on: [02-03, 02-06]
files_modified:
  - src/app/(app)/profile/[username]/page.tsx
  - src/app/api/users/[id]/profile/route.ts
  - src/components/profile/ProfileStats.tsx
  - src/components/profile/ProfileTabs.tsx
  - src/components/profile/PublicProfileCard.tsx
  - src/components/profile/FollowList.tsx
  - src/components/profile/ProfilePrivacySettings.tsx
  - src/app/(app)/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view another user's public profile page"
    - "Profile page displays stats: posts count, followers, following"
    - "Profile page shows recent posts by that user"
    - "User can follow/unfollow from the profile page"
    - "User can view follower and following lists"
    - "User can set profile privacy (public, followers, private)"
    - "Own profile page shows enhanced stats and activity"
  artifacts:
    - path: "src/app/(app)/profile/[username]/page.tsx"
      provides: "Public profile page"
      min_lines: 30
    - path: "src/app/api/users/[id]/profile/route.ts"
      provides: "Public profile data API"
      exports: ["GET"]
    - path: "src/components/profile/ProfileStats.tsx"
      provides: "Stats display (posts, followers, following)"
      min_lines: 15
    - path: "src/components/profile/FollowList.tsx"
      provides: "Followers/following list component"
      min_lines: 20
  key_links:
    - from: "src/app/(app)/profile/[username]/page.tsx"
      to: "/api/users/[id]/profile"
      via: "fetch GET on mount"
      pattern: "fetch.*api/users.*profile"
    - from: "src/components/profile/ProfileStats.tsx"
      to: "/api/follows"
      via: "follower/following counts"
      pattern: "follower_count|following_count"
---

<objective>
Build the public profile view, enhanced own-profile page, profile stats, follower/following lists, and profile privacy settings.

Purpose: Profile pages complete the social graph visibility. Users need to view others' profiles, see their activity, and manage who can see their own content. This ties together the follow system and post feed for per-user views.
Output: 1 API route, 2 pages (new + enhance existing), 5 components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-social/02-RESEARCH.md
@.planning/phases/02-core-social/02-03-SUMMARY.md
@.planning/phases/02-core-social/02-06-SUMMARY.md

@src/app/(app)/profile/page.tsx
@src/hooks/useFeed.ts
@src/hooks/useFollow.ts
@src/components/social/FollowButton.tsx
@src/components/feed/PostCard.tsx
@src/lib/auth/middleware.ts
@src/lib/utils/blocks.ts
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create public profile API and profile components</name>
  <files>
    src/app/api/users/[id]/profile/route.ts
    src/components/profile/ProfileStats.tsx
    src/components/profile/PublicProfileCard.tsx
    src/components/profile/FollowList.tsx
    src/components/profile/ProfilePrivacySettings.tsx
  </files>
  <action>
    **src/app/api/users/[id]/profile/route.ts:**
    Note: [id] can be a numeric user ID or a username string. Detect which by checking if it's all digits.

    GET: withOptionalAuth (viewable by anyone, but auth provides follow status). Fetch user by id or username. If user not found, return 404. Check if viewing user has blocked or is blocked by target user — if so, return 403 "This profile is not available." Check privacy: if profile_privacy='private' and viewer is not the user, return limited data. If 'followers' and viewer doesn't follow, return limited data.

    Return (full data for public/authorized):
    - id, username, display_name, avatar_url, bio, denomination, church, date_of_birth (age only, not DOB), created_at (join date)
    - Stats: post_count (COUNT posts), follower_count, following_count
    - is_following (whether viewer follows this user)
    - is_own_profile (whether viewer is the user)
    - recent_posts: last 5 posts by this user (with reaction/comment counts)

    Return (limited data for restricted):
    - id, username, display_name, avatar_url
    - is_following, privacy_restricted: true

    **src/components/profile/ProfileStats.tsx:**
    Horizontal stat row. Props: postCount, followerCount, followingCount, onFollowersClick, onFollowingClick. Three columns: "N Posts", "N Followers" (clickable), "N Following" (clickable). Bold numbers above labels. Clicking followers/following opens FollowList modal.

    **src/components/profile/PublicProfileCard.tsx:**
    Header card for profile pages. Props: user data. Shows: large avatar, display_name, @username, bio, denomination/church if provided, join date ("Joined Feb 2026"), ProfileStats, FollowButton (if not own profile), block/report menu (three dots, if not own profile).

    **src/components/profile/FollowList.tsx:**
    Modal or sheet showing list of followers or following. Props: userId, type ('followers' | 'following'), isOpen, onClose. Fetches from GET /api/follows?type=X&user_id=Y with pagination. Renders UserSearchResult-style rows with FollowButton for each user. Infinite scroll within the modal.

    **src/components/profile/ProfilePrivacySettings.tsx:**
    Component for profile privacy settings. Props: currentPrivacy, onSave. Radio buttons: Public, Followers Only, Private. Save button. Updates via PUT to /api/settings or a dedicated profile update endpoint. Uses existing settings infrastructure.
  </action>
  <verify>
    curl GET /api/users/1/profile — returns profile data with stats.
    curl GET /api/users/admin/profile — returns profile by username.
    npm run build — components compile.
  </verify>
  <done>Profile API returns user data with stats and privacy enforcement. Profile components render stats, follow lists, and privacy settings.</done>
</task>

<task type="auto">
  <name>Task 2: Create public profile page and enhance own profile page</name>
  <files>
    src/app/(app)/profile/[username]/page.tsx
    src/app/(app)/profile/page.tsx
  </files>
  <action>
    **src/app/(app)/profile/[username]/page.tsx:**
    'use client'. Dynamic route for viewing any user's profile. On mount: fetch /api/users/[username]/profile. Renders:
    - PublicProfileCard header
    - ProfileTabs below (Posts tab with user's posts, Prayer Requests tab if they have prayer requests)
    - Posts tab: fetch posts filtered by this user (use useFeed with user filter, or fetch from profile API recent_posts + paginate). Show PostCards.
    - If privacy restricted: show limited profile with "This profile is private" message
    - If blocked: show "Profile not available"
    - FollowList modal (opened when clicking followers/following in stats)

    **Enhance src/app/(app)/profile/page.tsx (own profile):**
    Update the existing profile page to include:
    - ProfileStats (post count, followers, following)
    - ProfileTabs with: Posts, Prayer Requests, Bookmarks (link to /bookmarks)
    - Recent posts by current user (use PostCard)
    - Link to settings for editing profile info
    - FollowList modal for own followers/following
    - ProfilePrivacySettings section or link to it

    If a user visits /profile they see their own profile. If they visit /profile/[username] they see another user's (or redirect to /profile if it's their own username).
  </action>
  <verify>
    Navigate to /profile — see own profile with stats and posts.
    Navigate to /profile/admin — see admin user's public profile.
    Click followers count — see FollowList modal.
  </verify>
  <done>Public profile page shows user info, stats, and posts. Own profile page enhanced with stats, activity, and follow lists.</done>
</task>

</tasks>

<verification>
1. /profile/[username] shows public profile with stats and posts
2. Privacy enforcement: private profiles show limited data
3. Blocked users see "Profile not available"
4. ProfileStats shows correct counts
5. FollowList modal shows paginated followers/following
6. Own profile page enhanced with stats and recent activity
7. Follow/unfollow works from profile page
</verification>

<success_criteria>
- Public profiles display complete user information with privacy enforcement
- Stats (posts, followers, following) are accurate
- Follow lists are paginated and show follow status
- Block detection prevents viewing blocked user profiles
- Own profile page shows enhanced stats and activity
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-social/02-13-SUMMARY.md`
</output>
