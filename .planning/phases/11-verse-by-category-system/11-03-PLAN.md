---
phase: 11-verse-by-category-system
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/app/api/admin/verse-categories/route.ts
  - src/app/api/admin/verse-categories/[id]/verses/route.ts
  - src/app/api/admin/verse-categories/[id]/media/route.ts
  - src/app/api/admin/verse-generation/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create, edit, reorder, and toggle active status of verse categories"
    - "Admin can add, edit, and remove verses within a category"
    - "Admin can manage media per category (list, add via presigned URL, delete)"
    - "Admin can generate verse references via AI and review before saving"
    - "Manual verse entry auto-fetches text from bible.api for all translations"
  artifacts:
    - path: "src/app/api/admin/verse-categories/route.ts"
      provides: "GET all categories + POST create + PUT update (including reorder)"
      exports: ["GET", "POST", "PUT"]
    - path: "src/app/api/admin/verse-categories/[id]/verses/route.ts"
      provides: "GET verses in category + POST add verse + PUT edit + DELETE remove"
      exports: ["GET", "POST", "PUT", "DELETE"]
    - path: "src/app/api/admin/verse-categories/[id]/media/route.ts"
      provides: "GET media list + POST add media record + DELETE remove media"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/app/api/admin/verse-generation/route.ts"
      provides: "POST: AI-generated verse references via Anthropic Claude API"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/admin/verse-generation/route.ts"
      to: "@anthropic-ai/sdk"
      via: "Anthropic client with ANTHROPIC_API_KEY env var"
      pattern: "new Anthropic"
    - from: "src/app/api/admin/verse-categories/[id]/verses/route.ts"
      to: "src/lib/bible-api/index.ts"
      via: "fetchVerseFromBibleApi for auto-fetching translations"
      pattern: "fetchVerse"
---

<objective>
Create all admin API routes for managing verse categories, verses, media, and AI-assisted verse generation.

Purpose: Enables admin to manage the verse-by-category content: CRUD categories, add/edit/remove verses with auto-translation fetching, manage background media, and use AI to generate verse references.
Output: 4 admin API route files with full CRUD + AI generation.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-verse-by-category-system/11-RESEARCH.md
@.planning/phases/11-verse-by-category-system/11-01-SUMMARY.md

Clone patterns from:
@src/app/api/admin/daily-content/route.ts
@src/app/api/admin/workshops/route.ts
@src/lib/bible-api/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin verse category CRUD and verse management API routes</name>
  <files>
    src/app/api/admin/verse-categories/route.ts
    src/app/api/admin/verse-categories/[id]/verses/route.ts
  </files>
  <action>
    **GET/POST/PUT /api/admin/verse-categories** (withAdmin):
    - GET: List ALL categories (including inactive) ordered by sort_order, include verse_count via literal subquery and media_count via literal subquery
    - POST: Create category. Body: { name, description?, thumbnail_url? }. Auto-generate slug from name using slugify (lowercase, hyphenated). Set sort_order = max existing + 1. Validate name 1-100 chars.
    - PUT: Update category. Body: { id, name?, description?, thumbnail_url?, sort_order?, active? }. If name changes, update slug. Support reorder by accepting new sort_order value.

    **GET/POST/PUT/DELETE /api/admin/verse-categories/[id]/verses** (withAdmin):
    - GET: List all verses in category with their translations, paginated (limit/offset). Include reaction_count and comment_count via literal subqueries.
    - POST: Add verse to category. Body: { verse_reference, content_text?, auto_fetch?: boolean }.
      - If auto_fetch is true (default): Use fetchVerseFromBibleApi() from src/lib/bible-api/index.ts to fetch KJV text as content_text. Then fetch all other translations (NIV, NRSV, NAB, etc. from bible_translations table) and insert into verse_category_content_translations. Use cleanVerseText() for text cleanup.
      - If auto_fetch is false: Use provided content_text as-is (manual entry).
      - Check UNIQUE constraint (category_id, verse_reference) before insert -- return 409 if duplicate.
    - PUT: Edit verse. Body: { verse_id, verse_reference?, content_text? }. Does NOT re-fetch translations (admin edits are manual corrections).
    - DELETE: Remove verse by verse_id. CASCADE deletes translations, reactions, comments.

    For the auto-fetch flow, iterate through all translation codes from the bible_translations table. Use try/catch on each translation fetch so failures don't block others. Log failures to console with verse_reference + translation_code. Use the existing parseVerseReference() and fetchVerseFromBibleApi() functions.

    Apply cleanVerseText() to all fetched text: strips pilcrow marks, HTML tags, verse numbers, smart/curly quotes. Add curly quote normalization: `.replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"')` if not already in cleanVerseText().
  </action>
  <verify>
    Test via curl:
    - POST category: `curl -X POST -b "auth_token=..." -H "Content-Type: application/json" -d '{"name":"Test Category"}' http://localhost:3000/api/admin/verse-categories` returns created category with slug
    - GET categories: returns array with verse_count and media_count
    - POST verse with auto_fetch: `curl -X POST ... -d '{"verse_reference":"John 3:16","auto_fetch":true}' .../admin/verse-categories/1/verses` creates verse with KJV text + translations
    - DELETE verse: removes verse and cascaded data
  </verify>
  <done>Admin can fully manage categories (create, edit, reorder, activate/deactivate) and verses (add with auto-fetch, edit, remove). Auto-fetch correctly retrieves text from bible.api for all available translations.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin media management and AI verse generation API routes</name>
  <files>
    src/app/api/admin/verse-categories/[id]/media/route.ts
    src/app/api/admin/verse-generation/route.ts
  </files>
  <action>
    **GET/POST/DELETE /api/admin/verse-categories/[id]/media** (withAdmin):
    - GET: List all media for category (where category_id = id OR category_id IS NULL for shared). Include category name. Paginated (limit/offset).
    - POST: Add media record. Body: { media_url, media_key, shared?: boolean }. If shared=true, set category_id=NULL. Otherwise category_id=params.id. Validate media_url is a valid URL string.
    - DELETE: Remove media record. Query param: media_id. Delete the record (does NOT delete from B2 -- admin is responsible for storage cleanup). Return 404 if media not found.

    Note: Actual file upload to B2 uses the existing presigned URL flow (GET /api/upload/presigned-url with type=category-media). The POST here just records the DB entry after upload completes.

    **POST /api/admin/verse-generation** (withAdmin):
    - Body: { category_id, category_name, count (default 20, max 50) }
    - Import Anthropic from '@anthropic-ai/sdk'
    - Check process.env.ANTHROPIC_API_KEY exists, return 503 if not configured
    - Fetch existing verse references for the category to build exclusion list
    - Call Anthropic API:
      ```
      const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
      const message = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2048,
        messages: [{
          role: 'user',
          content: `Generate exactly ${count} Bible verse references related to the theme "${category_name}".
Return ONLY a valid JSON array of strings. Each string should be a verse reference like "John 3:16" or "Psalms 23:1-2".
Use standard book names (e.g., "Psalms" not "Psalm", "1 Corinthians" not "I Corinthians", "Genesis" not "Gen").
Do NOT include any of these existing verses: ${JSON.stringify(existingRefs.slice(0, 200))}
Return ONLY the JSON array, no other text.`
        }]
      });
      ```
    - Parse JSON array from response text. Wrap in try/catch -- if parsing fails, return 422 with raw response for debugging.
    - Filter out any references that match existing verses (case-insensitive)
    - Return: `{ suggestions: string[], existing_count: number, filtered_count: number }`
    - The admin UI will display these suggestions for review. Saving happens via the POST /verses endpoint (not here).
  </action>
  <verify>
    Test media endpoint via curl:
    - POST media: creates record linking to category
    - GET media: returns list for category + shared media
    - DELETE media: removes record

    For AI generation (requires ANTHROPIC_API_KEY in .env.local):
    - POST: `curl -X POST ... -d '{"category_id":1,"category_name":"Hope & Encouragement","count":5}' .../admin/verse-generation` returns JSON array of verse reference suggestions
    - Without API key: returns 503
  </verify>
  <done>Admin can manage media records per category, AI verse generation returns deduplicated suggestions that admin can review before saving.</done>
</task>

</tasks>

<verification>
- All 4 admin API routes respond correctly to their HTTP methods
- Category CRUD: create returns slug, edit updates, reorder works
- Verse auto-fetch: creates verse + translations from bible.api
- Media management: list includes shared (NULL category_id) media
- AI generation: returns JSON array of verse references, filters existing
- All routes protected by withAdmin middleware
- Non-admin users get 403
</verification>

<success_criteria>
- Full category lifecycle manageable via API
- Verse creation with auto_fetch fetches KJV + all translations
- Media CRUD works with shared media support
- AI verse generation returns valid, deduplicated suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/11-verse-by-category-system/11-03-SUMMARY.md`
</output>
