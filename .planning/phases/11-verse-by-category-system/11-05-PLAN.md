---
phase: 11-verse-by-category-system
plan: 05
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - src/hooks/useVerseByCategoryFeed.ts
  - src/hooks/useVerseCategoryReactions.ts
  - src/components/daily/VerseByCategorySlide.tsx
  - src/components/daily/CategorySelector.tsx
  - src/components/daily/VerseModeToggle.tsx
autonomous: true

must_haves:
  truths:
    - "useVerseByCategoryFeed hook fetches random verse and tracks recent IDs in localStorage"
    - "useVerseCategoryReactions hook toggles reactions with optimistic update"
    - "VerseByCategorySlide displays verse text over full-screen background image"
    - "CategorySelector shows Instagram Stories-style circle grid, collapses after selection"
    - "VerseModeToggle renders glass overlay segmented control"
  artifacts:
    - path: "src/hooks/useVerseByCategoryFeed.ts"
      provides: "Hook: fetches random verse, manages localStorage exclusion list, category switching"
    - path: "src/hooks/useVerseCategoryReactions.ts"
      provides: "Hook: reaction counts, toggle, user reaction state (mirrors useReactions)"
    - path: "src/components/daily/VerseByCategorySlide.tsx"
      provides: "Full-screen verse display with background image, reaction bar, comments, share"
    - path: "src/components/daily/CategorySelector.tsx"
      provides: "Collapsible circle-grid category overlay"
    - path: "src/components/daily/VerseModeToggle.tsx"
      provides: "Glass-overlay [Daily Post] [Verse by Category] segmented control"
  key_links:
    - from: "src/hooks/useVerseByCategoryFeed.ts"
      to: "/api/verse-by-category"
      via: "fetch with category_id and exclude params"
      pattern: "fetch.*verse-by-category"
    - from: "src/hooks/useVerseCategoryReactions.ts"
      to: "/api/verse-category-reactions"
      via: "fetch GET/POST"
      pattern: "fetch.*verse-category-reactions"
    - from: "src/components/daily/VerseByCategorySlide.tsx"
      to: "src/hooks/useVerseCategoryReactions.ts"
      via: "hook consumption for reaction display"
      pattern: "useVerseCategoryReactions"
    - from: "src/components/daily/CategorySelector.tsx"
      to: "src/hooks/useVerseByCategoryFeed.ts"
      via: "onSelect callback triggers category change"
      pattern: "onSelect"
---

<objective>
Create client-side hooks and UI components for the verse-by-category display experience.

Purpose: Builds the complete front-end for viewing random verses by category -- the feed hook, reaction hook, full-screen verse slide, category selector overlay, and mode toggle control. These components will be integrated into the daily tab in Plan 06.
Output: 2 hooks + 3 components in src/components/daily/.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-verse-by-category-system/11-RESEARCH.md
@.planning/phases/11-verse-by-category-system/11-01-SUMMARY.md
@.planning/phases/11-verse-by-category-system/11-02-SUMMARY.md

Clone patterns from:
@src/hooks/useDailyContent.ts
@src/hooks/useReactions.ts
@src/components/daily/DailyPostSlide.tsx
@src/components/daily/QuickReactionPicker.tsx
@src/components/daily/ShareButton.tsx
@src/components/daily/CommentBottomSheet.tsx
@src/components/daily/ReactionBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVerseByCategoryFeed and useVerseCategoryReactions hooks</name>
  <files>
    src/hooks/useVerseByCategoryFeed.ts
    src/hooks/useVerseCategoryReactions.ts
  </files>
  <action>
    **useVerseByCategoryFeed.ts:**
    'use client' hook that manages the verse-by-category display state.

    State:
    - verse: the current verse data (id, category_id, verse_reference, content_text, book, category: {id, name, slug}, translations: [...])
    - backgroundUrl: current background image URL
    - userReaction: user's existing reaction on this verse (or null)
    - categories: array of available categories (fetched from /api/verse-categories)
    - activeCategoryId: currently selected category (number | 'all')
    - loading: boolean
    - error: string | null

    localStorage tracking (avoid recent repeats):
    - STORAGE_KEY = 'verse_category_recent'
    - MAX_RECENT = 10
    - getRecentVerseIds(): reads and parses JSON array from localStorage
    - addRecentVerseId(id): prepends to array, dedupes, slices to MAX_RECENT

    Fetch logic:
    - fetchVerse(categoryId): calls GET /api/verse-by-category?category_id={categoryId}&exclude={recentIds.join(',')}
    - On success: set verse, backgroundUrl, userReaction, call addRecentVerseId(verse.id)
    - On error: set error state

    Category management:
    - fetchCategories(): calls GET /api/verse-categories, sets categories state
    - selectCategory(id): sets activeCategoryId, calls fetchVerse(id), persists to user settings via PATCH
    - Persist category selection: fire-and-forget PUT to /api/settings with { verse_category_id: id }

    Initial load (useEffect on mount):
    - Fetch categories
    - Fetch initial verse using user's saved category (from auth context user.verse_category_id) or 'all'

    Translation support:
    - getTranslatedText(translationCode): returns translation text from verse.translations array, falls back to content_text (KJV)

    Return: { verse, backgroundUrl, userReaction, categories, activeCategoryId, loading, error, selectCategory, getTranslatedText }

    **useVerseCategoryReactions.ts:**
    Clone useReactions hook, replacing:
    - API endpoint: /api/verse-category-reactions instead of /api/daily-reactions
    - Query param: verse_category_content_id instead of daily_content_id
    - Reaction types: 'like' | 'love' | 'wow' | 'sad' | 'pray' (no 'haha')
    - Same optimistic update pattern: toggle on POST, revert on error
    - Accept initial userReaction from props (passed from verse-by-category API response) to avoid extra GET on mount

    Return: { counts, total, userReaction, commentCount, toggleReaction, refetch } (same shape as useReactions)
  </action>
  <verify>Verify no TypeScript errors: `npx tsc --noEmit`. Check that both hooks export correctly and types match the API response shapes.</verify>
  <done>Both hooks created with correct TypeScript types, localStorage tracking, optimistic updates, and API integration.</done>
</task>

<task type="auto">
  <name>Task 2: Create VerseByCategorySlide, CategorySelector, and VerseModeToggle components</name>
  <files>
    src/components/daily/VerseByCategorySlide.tsx
    src/components/daily/CategorySelector.tsx
    src/components/daily/VerseModeToggle.tsx
  </files>
  <action>
    **VerseByCategorySlide.tsx:**
    Full-screen verse display component. Clone structure from DailyPostSlide but simplified:
    - NO video background -- use `<img>` for background instead (backgroundUrl prop)
    - NO Swiper/carousel -- single verse display (no swiping between verses)
    - NO date navigator -- show category name badge in the same position where date appears on DailyPostSlide
    - Background: full-screen `<img src={backgroundUrl} className="absolute inset-0 h-full w-full object-cover" />` with dark overlay gradient
    - Content overlay (centered): verse_reference as heading, verse text (translated based on active translation), book name
    - When category is "All": show source category name in the badge position (where date normally is)
    - Reactions: integrate useVerseCategoryReactions hook. Show ReactionBar (reuse existing), QuickReactionPicker with reactionTypes={DAILY_REACTION_TYPES} (excludes haha), heart icon + count
    - Comments: integrate CommentBottomSheet (reuse existing pattern) but pointed at /api/verse-category-comments endpoints
      - Pass verse_category_content_id instead of daily_content_id
      - The CommentBottomSheet needs to accept a configurable API base URL or content type prop. If it's too tightly coupled to daily-comments, create a VerseCategoryCommentSheet that wraps CommentBottomSheet pattern with verse-category-comments API calls.
    - Share: reuse ShareButton component, passing verse text + reference + background image
    - Props: { verse, backgroundUrl, userReaction, activeTranslation }

    **CategorySelector.tsx:**
    Instagram Stories-style circle grid overlay.
    - Props: { categories, activeCategoryId, onSelect, collapsed, onToggle }
    - Collapsed state (default): horizontal row showing active category circle (48x48) + abbreviated name + ChevronDown icon. Tap expands.
    - Expanded state: backdrop-blur container (rounded-2xl bg-black/40 backdrop-blur-xl p-4) with grid of category circles.
      - Grid: grid-cols-5 gap-3 (wraps to as many rows as needed for 11 items: 10 categories + "All")
      - Each circle: 56x56 rounded-full with thumbnail_url image (or gradient placeholder with first letter if no thumbnail)
      - Active category: ring-2 ring-blue-400 scale-110 opacity-100
      - Inactive: ring-1 ring-white/30 opacity-70
      - Category name below each circle: text-[10px] text-white/80 line-clamp-1
    - "All" entry: use a special gradient circle or icon (globe or sparkles from lucide-react)
    - On select: call onSelect(categoryId), which parent uses to trigger verse fetch + auto-collapse
    - Positioned: absolute top-16 left-0 right-0 z-20 px-4 (floats over verse display below TopBar)
    - Fade-in/out animation: transition-all duration-200 with opacity

    **VerseModeToggle.tsx:**
    Glass overlay segmented control.
    - Props: { mode: 'daily_verse' | 'verse_by_category', onChange: (mode) => void }
    - Container: flex rounded-full bg-white/10 p-1 backdrop-blur-2xl
    - Two buttons: "Daily Post" and "Verse by Category"
    - Active button: text-white with animated pill indicator behind it (bg-white/20 rounded-full)
    - Inactive button: text-white/60
    - Pill animation: transition-all duration-200, positioned with left/width calc based on active mode
    - Compact sizing: text-xs font-medium, px-4 py-1.5
  </action>
  <verify>
    Verify no TypeScript errors: `npx tsc --noEmit`.
    Verify all 3 components export correctly.
    Check VerseByCategorySlide imports and uses useVerseCategoryReactions.
    Check CategorySelector renders grid with correct number of items.
    Check VerseModeToggle has animated pill indicator.
  </verify>
  <done>All 3 components created: VerseByCategorySlide renders verse over background image with reactions/comments/share, CategorySelector shows collapsible circle grid, VerseModeToggle renders glass segmented control with animated pill.</done>
</task>

</tasks>

<verification>
- No TypeScript compilation errors
- useVerseByCategoryFeed: fetches verse from API, manages localStorage exclusion
- useVerseCategoryReactions: mirrors useReactions with verse-category endpoints
- VerseByCategorySlide: renders full-screen verse with background, reactions, comments
- CategorySelector: renders collapsible grid with 10 categories + "All"
- VerseModeToggle: renders segmented control with animated active indicator
- All components use cn() for Tailwind classes
</verification>

<success_criteria>
- All 5 files created without TypeScript errors
- Components follow established patterns (glass overlay, lucide icons, cn() utility)
- Hooks correctly call verse-by-category API endpoints
- CategorySelector has collapsed/expanded states with auto-collapse
</success_criteria>

<output>
After completion, create `.planning/phases/11-verse-by-category-system/11-05-SUMMARY.md`
</output>
