---
phase: 11-verse-by-category-system
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/app/api/verse-categories/route.ts
  - src/app/api/verse-by-category/route.ts
  - src/app/api/verse-category-reactions/route.ts
  - src/app/api/verse-category-comments/route.ts
  - src/app/api/verse-category-comments/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated users can list active verse categories"
    - "Bible-mode users in verse-by-category mode can get a random verse for a category"
    - "Random verse excludes recently-shown IDs passed via query param"
    - "Users can toggle reactions on verse category content (5 types, no haha)"
    - "Users can create, edit, delete threaded comments on verse category content"
  artifacts:
    - path: "src/app/api/verse-categories/route.ts"
      provides: "GET: list active categories with verse counts"
      exports: ["GET"]
    - path: "src/app/api/verse-by-category/route.ts"
      provides: "GET: random verse with translation + background image"
      exports: ["GET"]
    - path: "src/app/api/verse-category-reactions/route.ts"
      provides: "GET reaction counts + POST toggle reaction"
      exports: ["GET", "POST"]
    - path: "src/app/api/verse-category-comments/route.ts"
      provides: "GET paginated comments + POST create comment"
      exports: ["GET", "POST"]
    - path: "src/app/api/verse-category-comments/[id]/route.ts"
      provides: "PUT edit + DELETE comment"
      exports: ["PUT", "DELETE"]
  key_links:
    - from: "src/app/api/verse-by-category/route.ts"
      to: "VerseCategoryContent model"
      via: "sequelize.random() ORDER BY RAND()"
      pattern: "sequelize\\.random\\(\\)"
    - from: "src/app/api/verse-category-reactions/route.ts"
      to: "VerseCategoryReaction model"
      via: "toggle pattern (findOne, create/destroy/update)"
      pattern: "VerseCategoryReaction\\.(findOne|create|destroy)"
---

<objective>
Create all user-facing API routes for the verse-by-category system: category listing, random verse fetching, reactions, and comments.

Purpose: Provides the server-side endpoints that client hooks will consume for displaying random verses, handling reactions, and managing threaded comments.
Output: 5 API route files mirroring daily-reactions and daily-comments patterns.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-verse-by-category-system/11-RESEARCH.md
@.planning/phases/11-verse-by-category-system/11-01-SUMMARY.md

Clone patterns from:
@src/app/api/daily-reactions/route.ts
@src/app/api/daily-comments/route.ts
@src/app/api/daily-comments/[id]/route.ts
@src/app/api/daily-posts/feed/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verse-categories list and random verse API routes</name>
  <files>
    src/app/api/verse-categories/route.ts
    src/app/api/verse-by-category/route.ts
  </files>
  <action>
    **GET /api/verse-categories** (withAuth):
    - Fetch all active verse categories ordered by sort_order ASC
    - Include verse count per category via Sequelize literal subquery: `[sequelize.literal('(SELECT COUNT(*) FROM verse_category_content WHERE verse_category_content.category_id = VerseCategory.id)'), 'verse_count']`
    - Return array: `{ id, name, slug, description, thumbnail_url, sort_order, verse_count }`
    - Prepend an "All" virtual entry: `{ id: 'all', name: 'All', slug: 'all', thumbnail_url: null, verse_count: totalAcrossAll }`

    **GET /api/verse-by-category** (withAuth):
    - Query params: `category_id` (number or 'all'), `exclude` (comma-separated IDs, max 10), `translation` (optional translation code)
    - Validate user.mode === 'bible' (return 403 if positivity mode)
    - Build WHERE clause:
      - If category_id present and not 'all': `{ category_id: Number(category_id) }`
      - If 'all' or not present: no category filter
      - If exclude IDs: `{ id: { [Op.notIn]: excludeIds } }`
    - Fetch one random verse: `VerseCategoryContent.findOne({ where, include: [translations, category], order: sequelize.random() })`
    - Fallback: if no verse found with exclusion, retry without exclusion
    - Fetch random background image: `VerseCategoryMedia.findOne({ where: { [Op.or]: [{ category_id: verse.category_id }, { category_id: null }] }, order: sequelize.random() })`
    - Also fetch user's existing reaction on this verse: `VerseCategoryReaction.findOne({ where: { user_id, verse_category_content_id: verse.id } })`
    - Return: `{ verse: { id, category_id, verse_reference, content_text, book, category: { id, name, slug }, translations: [...] }, background_url, user_reaction: reaction_type | null }`
    - Fire-and-forget trackActivity() for 'verse_category_view' (using dynamic import pattern from existing codebase)
  </action>
  <verify>
    Use curl to test:
    - `curl -b "auth_token=..." http://localhost:3000/api/verse-categories` returns JSON array with categories
    - `curl -b "auth_token=..." "http://localhost:3000/api/verse-by-category?category_id=1"` returns a verse with translations and background_url
    - Calling the verse endpoint multiple times with `exclude=ID` returns different verses
  </verify>
  <done>Both endpoints return correct JSON, random verse selection works with exclusion fallback, background image included, user reaction returned.</done>
</task>

<task type="auto">
  <name>Task 2: Create verse-category-reactions and verse-category-comments API routes</name>
  <files>
    src/app/api/verse-category-reactions/route.ts
    src/app/api/verse-category-comments/route.ts
    src/app/api/verse-category-comments/[id]/route.ts
  </files>
  <action>
    **GET/POST /api/verse-category-reactions** -- Clone daily-reactions/route.ts exactly, replacing:
    - `daily_content_id` -> `verse_category_content_id` (query param and DB column)
    - `DailyReaction` -> `VerseCategoryReaction`
    - Reaction ENUM validation: only allow 'like', 'love', 'wow', 'sad', 'pray' (use DAILY_REACTION_TYPES constant which already excludes 'haha')
    - Toggle logic: if same type exists -> remove; if different type exists -> update; if none -> create
    - GET returns: `{ counts: { like: N, love: N, ... }, total: N, user_reaction: type | null }`
    - POST body: `{ verse_category_content_id, reaction_type }`
    - POST returns updated counts (same format as GET)
    - Fire-and-forget trackActivity() on reaction create

    **GET/POST /api/verse-category-comments** -- Clone daily-comments/route.ts exactly, replacing:
    - `daily_content_id` -> `verse_category_content_id`
    - `DailyComment` -> `VerseCategoryComment`
    - GET: cursor-based pagination (id > cursor), includes User (username, avatar_url), includes top 2 replies with their users, includes comment reaction count
    - POST: create comment with body, optional parent_id (flatten reply-to-reply to root), max body length 1000 chars
    - Fire-and-forget trackActivity() on comment create

    **PUT/DELETE /api/verse-category-comments/[id]** -- Clone daily-comments/[id]/route.ts:
    - PUT: edit own comment (set edited=true), validate body length
    - DELETE: delete own comment (hard delete, CASCADE removes replies and comment reactions)
    - Both require ownership check (comment.user_id === user.id)
  </action>
  <verify>
    Use curl to test:
    - POST reaction: `curl -X POST -b "auth_token=..." -H "Content-Type: application/json" -d '{"verse_category_content_id":1,"reaction_type":"love"}' http://localhost:3000/api/verse-category-reactions` returns counts
    - GET reactions: returns counts with user_reaction
    - POST comment: creates comment, returns with user info
    - PUT comment: edits, sets edited=true
    - DELETE comment: removes comment
    - POST with parent_id: creates threaded reply
  </verify>
  <done>Reaction toggle works (create/switch/remove), comment CRUD works with threading (2-level), comment reactions work, all endpoints return correct JSON matching daily content patterns.</done>
</task>

</tasks>

<verification>
- All 5 API routes respond to correct HTTP methods
- Reaction toggle: POST same type removes, POST different type switches, GET returns counts
- Comments: GET returns paginated with users and top 2 replies, POST creates, PUT edits, DELETE removes
- verse-by-category returns random verse with translations and background URL
- Positivity-mode users get 403 from verse-by-category endpoint
- No TypeScript compilation errors
</verification>

<success_criteria>
- GET /api/verse-categories returns active categories with verse counts
- GET /api/verse-by-category returns random verse with exclusion support
- Reaction and comment APIs mirror daily content patterns exactly
- Activity streak tracking fires on verse view, reaction, and comment
</success_criteria>

<output>
After completion, create `.planning/phases/11-verse-by-category-system/11-02-SUMMARY.md`
</output>
