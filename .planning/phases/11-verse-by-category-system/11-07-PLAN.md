---
phase: 11-verse-by-category-system
plan: 07
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - src/app/(admin)/admin/verse-categories/page.tsx
  - src/app/(admin)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view all verse categories with verse counts and media counts"
    - "Admin can create new categories"
    - "Admin can edit category name, description, toggle active status, reorder"
    - "Admin can view and manage verses within each category"
    - "Admin can add verses manually or via AI generation"
    - "Admin can manage background media per category"
  artifacts:
    - path: "src/app/(admin)/admin/verse-categories/page.tsx"
      provides: "Full admin page: categories list, verse management, media management, AI generation"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin nav updated with Verse Categories link"
  key_links:
    - from: "src/app/(admin)/admin/verse-categories/page.tsx"
      to: "/api/admin/verse-categories"
      via: "fetch for CRUD operations"
      pattern: "fetch.*admin/verse-categories"
    - from: "src/app/(admin)/admin/verse-categories/page.tsx"
      to: "/api/admin/verse-generation"
      via: "fetch for AI verse generation"
      pattern: "fetch.*admin/verse-generation"
---

<objective>
Create the admin UI for managing verse categories, verses, media, and AI-assisted verse generation.

Purpose: Gives admins a dashboard to manage all verse-by-category content: create/edit categories, add/remove verses (manually or via AI), and manage background images.
Output: Admin verse categories page + admin nav link.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-verse-by-category-system/11-RESEARCH.md
@.planning/phases/11-verse-by-category-system/11-03-SUMMARY.md

Clone patterns from:
@src/app/(admin)/admin/activation-codes/page.tsx
@src/app/(admin)/admin/workshops/page.tsx
@src/app/(admin)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin verse categories page with tabbed management UI</name>
  <files>src/app/(admin)/admin/verse-categories/page.tsx</files>
  <action>
    Create a comprehensive admin page following activation-codes and workshops admin page patterns. Use lazy-loaded tab sections via React.lazy + Suspense.

    **Page structure:**
    'use client' page with 3 tabs: Categories, Verses, Media

    **Tab 1: Categories**
    - List all categories in a table: Name, Slug, Verses (count), Media (count), Active (toggle), Sort Order, Actions
    - Fetch from GET /api/admin/verse-categories on mount
    - "Add Category" button at top: opens inline form (name + description inputs)
    - Each row has:
      - Active toggle (calls PUT with { id, active: !current })
      - Edit button: inline edit for name and description
      - Reorder: up/down arrow buttons that swap sort_order values (PUT both categories)
    - Table sorted by sort_order

    **Tab 2: Verses** (shown after selecting a category from Tab 1)
    - Category selector dropdown at top to pick which category to manage
    - List verses in selected category: Reference, Book, Text (truncated), Translations (count), Reactions, Comments, Actions
    - Fetch from GET /api/admin/verse-categories/{id}/verses?limit=50&offset=0
    - "Add Verse" section with two options:
      1. Manual: text input for verse_reference + "Add & Auto-Fetch" button (calls POST with auto_fetch=true)
      2. AI Generate: button opens inline form with count input (default 20). Calls POST /api/admin/verse-generation. Shows returned suggestions as a checklist. "Save Selected" button calls POST /api/admin/verse-categories/{id}/verses for each selected reference with auto_fetch=true. Show progress as each verse is saved.
    - Each verse row has:
      - Edit button: inline edit for verse_reference and content_text
      - Delete button: confirmation dialog, then DELETE
    - Pagination: "Load More" button for offset-based pagination

    **Tab 3: Media**
    - Category filter dropdown (same as Verses tab) + "Shared (All)" option
    - Grid display of existing media: thumbnail image + media_key + delete button
    - Fetch from GET /api/admin/verse-categories/{id}/media
    - "Upload Images" section:
      - File input (accept image/*) for single or multiple files
      - Upload flow: for each file, GET presigned URL from /api/upload/presigned-url?type=category-media&filename={name}&contentType={type}, PUT file to B2, POST /api/admin/verse-categories/{id}/media with { media_url, media_key }
      - "Shared" checkbox: if checked, media is shared across all categories (category_id=NULL)
      - Progress indicator during upload
    - Delete: confirmation, then DELETE /api/admin/verse-categories/{id}/media?media_id={id}

    **UI styling:**
    - Follow admin page patterns: white bg cards, shadow, rounded-lg, consistent with other admin pages
    - Tab bar: same style as admin moderation page tabs
    - Toast feedback for all create/update/delete operations
    - Loading skeletons during data fetches
    - Use Skeleton component from src/components/ui/Skeleton.tsx

    **AI Generation flow detail:**
    1. Admin clicks "AI Generate" button
    2. Form appears: count input (1-50, default 20)
    3. Admin clicks "Generate"
    4. Loading spinner while API call in progress
    5. Results displayed as checkboxes with verse references
    6. Admin checks/unchecks suggestions
    7. "Save Selected (N)" button
    8. Progress bar as each verse is created (sequential API calls with progress)
    9. Success toast with count of saved verses
    10. Verse list refreshes
  </action>
  <verify>
    - Navigate to /admin/verse-categories
    - Categories tab: shows all 10 categories with counts
    - Create a new category: appears in list
    - Toggle active status: persists on refresh
    - Switch to Verses tab, select a category: verses listed
    - Add a verse manually: auto-fetches translations, appears in list
    - Delete a verse: removed from list
    - Switch to Media tab: shows uploaded images
    - No TypeScript errors
  </verify>
  <done>Admin verse categories page fully functional with categories CRUD, verse management (manual + AI generation), and media management (upload + delete).</done>
</task>

<task type="auto">
  <name>Task 2: Add Verse Categories link to admin navigation</name>
  <files>src/app/(admin)/layout.tsx</files>
  <action>
    Read the existing admin layout.tsx and find the navigation links section.
    Add a new nav link for "Verse Categories" pointing to /admin/verse-categories.
    Use the BookOpen icon from lucide-react (or similar Bible/book-related icon).
    Place it after the existing admin nav items (Workshops, Videos, etc.) in a logical position.
    Follow the exact same NavLink component pattern used by other admin nav items.
  </action>
  <verify>Navigate to any admin page and confirm "Verse Categories" appears in the sidebar/nav. Click it and navigate to /admin/verse-categories.</verify>
  <done>Admin navigation includes "Verse Categories" link with appropriate icon, navigating to the verse categories management page.</done>
</task>

</tasks>

<verification>
- Admin page loads without errors at /admin/verse-categories
- All 3 tabs (Categories, Verses, Media) function correctly
- Category CRUD: create, edit, reorder, toggle active
- Verse management: manual add (auto-fetch), edit, delete
- AI verse generation: generate, review, save selected
- Media management: upload to B2, view grid, delete
- Admin nav has Verse Categories link
- Non-admin users cannot access the page (redirected/403)
</verification>

<success_criteria>
- Complete admin interface for verse-by-category content management
- AI generation workflow: generate -> review -> save
- Media upload works via presigned URL flow
- Admin nav updated
</success_criteria>

<output>
After completion, create `.planning/phases/11-verse-by-category-system/11-07-SUMMARY.md`
</output>
