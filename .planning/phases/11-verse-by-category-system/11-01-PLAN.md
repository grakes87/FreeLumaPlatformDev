---
phase: 11-verse-by-category-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/078-create-verse-categories.cjs
  - src/lib/db/migrations/079-create-verse-category-media.cjs
  - src/lib/db/migrations/080-create-verse-category-content.cjs
  - src/lib/db/migrations/081-create-verse-category-content-translations.cjs
  - src/lib/db/migrations/082-create-verse-category-reactions.cjs
  - src/lib/db/migrations/083-create-verse-category-comments.cjs
  - src/lib/db/migrations/084-create-verse-category-comment-reactions.cjs
  - src/lib/db/migrations/085-add-verse-mode-to-users.cjs
  - src/lib/db/models/VerseCategory.ts
  - src/lib/db/models/VerseCategoryMedia.ts
  - src/lib/db/models/VerseCategoryContent.ts
  - src/lib/db/models/VerseCategoryContentTranslation.ts
  - src/lib/db/models/VerseCategoryReaction.ts
  - src/lib/db/models/VerseCategoryComment.ts
  - src/lib/db/models/VerseCategoryCommentReaction.ts
  - src/lib/db/models/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "7 new database tables exist and can be queried"
    - "Users table has verse_mode and verse_category_id columns"
    - "All foreign key relationships are correct"
    - "Reaction type ENUM excludes haha (only like, love, wow, sad, pray)"
  artifacts:
    - path: "src/lib/db/models/VerseCategory.ts"
      provides: "Category model with name, slug, thumbnail_url, sort_order, active"
    - path: "src/lib/db/models/VerseCategoryContent.ts"
      provides: "Verse content model with category_id FK, verse_reference, content_text, book"
    - path: "src/lib/db/models/VerseCategoryContentTranslation.ts"
      provides: "Translation model with translation_code, translated_text, source enum"
    - path: "src/lib/db/models/VerseCategoryMedia.ts"
      provides: "Media model with nullable category_id, media_url, media_key"
    - path: "src/lib/db/models/VerseCategoryReaction.ts"
      provides: "Reaction model mirroring DailyReaction without haha"
    - path: "src/lib/db/models/VerseCategoryComment.ts"
      provides: "Comment model with 2-level threading (parent_id)"
    - path: "src/lib/db/models/VerseCategoryCommentReaction.ts"
      provides: "Comment reaction model (heart/like on comments)"
    - path: "src/lib/db/models/index.ts"
      provides: "All 7 models registered with associations"
  key_links:
    - from: "src/lib/db/models/VerseCategoryContent.ts"
      to: "src/lib/db/models/VerseCategory.ts"
      via: "category_id FK with ON DELETE CASCADE"
      pattern: "references.*verse_categories"
    - from: "src/lib/db/models/VerseCategoryContentTranslation.ts"
      to: "src/lib/db/models/VerseCategoryContent.ts"
      via: "verse_category_content_id FK with ON DELETE CASCADE"
      pattern: "references.*verse_category_content"
    - from: "src/lib/db/models/index.ts"
      to: "All 7 verse category models"
      via: "import + associations + export"
      pattern: "VerseCategory"
---

<objective>
Create all database tables, Sequelize models, and associations for the verse-by-category system.

Purpose: Establishes the data foundation for verse categories, content, translations, media, reactions, comments, and user settings. All subsequent plans depend on these models existing.
Output: 8 migration files, 7 model files, updated model index with associations, @anthropic-ai/sdk and adm-zip installed.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-verse-by-category-system/11-RESEARCH.md

Key pattern files to clone from:
@src/lib/db/models/DailyContent.ts
@src/lib/db/models/DailyContentTranslation.ts
@src/lib/db/models/DailyReaction.ts
@src/lib/db/models/DailyComment.ts
@src/lib/db/migrations/005-create-daily-content.cjs
@src/lib/db/migrations/014-create-daily-reactions.cjs
@src/lib/db/migrations/015-create-daily-comments.cjs
@src/lib/db/migrations/070-create-daily-comment-reactions.cjs
@src/lib/db/models/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 8 migration files for all verse-by-category tables + user columns</name>
  <files>
    src/lib/db/migrations/078-create-verse-categories.cjs
    src/lib/db/migrations/079-create-verse-category-media.cjs
    src/lib/db/migrations/080-create-verse-category-content.cjs
    src/lib/db/migrations/081-create-verse-category-content-translations.cjs
    src/lib/db/migrations/082-create-verse-category-reactions.cjs
    src/lib/db/migrations/083-create-verse-category-comments.cjs
    src/lib/db/migrations/084-create-verse-category-comment-reactions.cjs
    src/lib/db/migrations/085-add-verse-mode-to-users.cjs
  </files>
  <action>
    Create 8 migration files following established .cjs pattern (see 057-create-workshop-categories.cjs for reference):

    **078-create-verse-categories.cjs:** Table `verse_categories` with columns:
    - id (INT, PK, auto_increment)
    - name (VARCHAR(100), NOT NULL)
    - slug (VARCHAR(100), NOT NULL, UNIQUE)
    - description (TEXT, nullable)
    - thumbnail_url (VARCHAR(500), nullable)
    - sort_order (INT, NOT NULL, default 0)
    - active (BOOLEAN, NOT NULL, default true)
    - created_at, updated_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)

    **079-create-verse-category-media.cjs:** Table `verse_category_media` with columns:
    - id (INT, PK, auto_increment)
    - category_id (INT, nullable, FK -> verse_categories.id, ON DELETE SET NULL)
    - media_url (VARCHAR(500), NOT NULL)
    - media_key (VARCHAR(255), NOT NULL)
    - created_at, updated_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)
    - INDEX on category_id

    **080-create-verse-category-content.cjs:** Table `verse_category_content` with columns:
    - id (INT, PK, auto_increment)
    - category_id (INT, NOT NULL, FK -> verse_categories.id, ON DELETE CASCADE)
    - verse_reference (VARCHAR(255), NOT NULL) -- e.g. "John 3:16"
    - content_text (TEXT, NOT NULL) -- KJV base text
    - book (VARCHAR(100), NOT NULL)
    - created_at, updated_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)
    - UNIQUE INDEX on (category_id, verse_reference)

    **081-create-verse-category-content-translations.cjs:** Table `verse_category_content_translations` with columns:
    - id (INT, PK, auto_increment)
    - verse_category_content_id (INT, NOT NULL, FK -> verse_category_content.id, ON DELETE CASCADE)
    - translation_code (VARCHAR(10), NOT NULL)
    - translated_text (TEXT, NOT NULL)
    - source (ENUM('database','api'), NOT NULL, default 'database')
    - created_at, updated_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)
    - UNIQUE INDEX on (verse_category_content_id, translation_code)

    **082-create-verse-category-reactions.cjs:** Table `verse_category_reactions` with columns:
    - id (INT, PK, auto_increment)
    - user_id (INT, NOT NULL, FK -> users.id, ON DELETE CASCADE)
    - verse_category_content_id (INT, NOT NULL, FK -> verse_category_content.id, ON DELETE CASCADE)
    - reaction_type (ENUM('like','love','wow','sad','pray'), NOT NULL) -- NO 'haha'
    - created_at, updated_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)
    - UNIQUE INDEX on (user_id, verse_category_content_id)

    **083-create-verse-category-comments.cjs:** Table `verse_category_comments` with columns:
    - id (INT, PK, auto_increment)
    - user_id (INT, NOT NULL, FK -> users.id, ON DELETE CASCADE)
    - verse_category_content_id (INT, NOT NULL, FK -> verse_category_content.id, ON DELETE CASCADE)
    - parent_id (INT, nullable, self-FK -> verse_category_comments.id, ON DELETE CASCADE)
    - body (TEXT, NOT NULL)
    - edited (BOOLEAN, NOT NULL, default false)
    - created_at, updated_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)
    - INDEX on verse_category_content_id
    - INDEX on parent_id

    **084-create-verse-category-comment-reactions.cjs:** Table `verse_category_comment_reactions` with columns:
    - id (INT, PK, auto_increment)
    - comment_id (INT, NOT NULL, FK -> verse_category_comments.id, ON DELETE CASCADE)
    - user_id (INT, NOT NULL, FK -> users.id, ON DELETE CASCADE)
    - created_at (DATE, NOT NULL, default CURRENT_TIMESTAMP)
    - updated_at: false (append-only, same as daily_comment_reactions pattern)
    - UNIQUE INDEX on (comment_id, user_id)

    **085-add-verse-mode-to-users.cjs:** ALTER users table:
    - Add verse_mode ENUM('daily_verse','verse_by_category') DEFAULT 'daily_verse'
    - Add verse_category_id INT DEFAULT NULL with FK -> verse_categories.id ON DELETE SET NULL
    - Down: remove both columns
  </action>
  <verify>Run `npx sequelize-cli db:migrate` and confirm all 8 migrations complete without error. Then run `npx sequelize-cli db:migrate:undo:all --to 078-create-verse-categories.cjs` and `npx sequelize-cli db:migrate` to verify up/down idempotency.</verify>
  <done>All 8 tables created in MySQL with correct columns, types, indexes, and foreign keys. Users table has verse_mode and verse_category_id columns.</done>
</task>

<task type="auto">
  <name>Task 2: Create 7 Sequelize model files and register in model index</name>
  <files>
    src/lib/db/models/VerseCategory.ts
    src/lib/db/models/VerseCategoryMedia.ts
    src/lib/db/models/VerseCategoryContent.ts
    src/lib/db/models/VerseCategoryContentTranslation.ts
    src/lib/db/models/VerseCategoryReaction.ts
    src/lib/db/models/VerseCategoryComment.ts
    src/lib/db/models/VerseCategoryCommentReaction.ts
    src/lib/db/models/index.ts
  </files>
  <action>
    Create 7 model files mirroring established patterns:

    **VerseCategory.ts:** Clone from WorkshopCategory pattern. Fields: id, name, slug, description, thumbnail_url, sort_order, active. Export VerseCategoryAttributes and VerseCategoryCreationAttributes interfaces.

    **VerseCategoryMedia.ts:** Fields: id, category_id (nullable), media_url, media_key. FK reference to verse_categories.

    **VerseCategoryContent.ts:** Clone from DailyContent pattern. Fields: id, category_id, verse_reference, content_text, book. UNIQUE index on (category_id, verse_reference).

    **VerseCategoryContentTranslation.ts:** Clone from DailyContentTranslation. Fields: id, verse_category_content_id, translation_code, translated_text, source (ENUM 'database'|'api'). UNIQUE index on (verse_category_content_id, translation_code).

    **VerseCategoryReaction.ts:** Clone from DailyReaction. Fields: id, user_id, verse_category_content_id, reaction_type (ENUM 'like'|'love'|'wow'|'sad'|'pray' -- NO 'haha'). UNIQUE index on (user_id, verse_category_content_id).

    **VerseCategoryComment.ts:** Clone from DailyComment. Fields: id, user_id, verse_category_content_id, parent_id (nullable self-FK), body, edited. Indexes on verse_category_content_id and parent_id.

    **VerseCategoryCommentReaction.ts:** Clone from daily_comment_reactions pattern (see 070-create-daily-comment-reactions.cjs). Fields: id, comment_id (FK -> verse_category_comments), user_id. updatedAt: false (append-only). UNIQUE index on (comment_id, user_id).

    **Update index.ts:** Add all 7 imports and define associations:
    - VerseCategory.hasMany(VerseCategoryMedia, { foreignKey: 'category_id', as: 'media' })
    - VerseCategory.hasMany(VerseCategoryContent, { foreignKey: 'category_id', as: 'verses' })
    - VerseCategoryContent.belongsTo(VerseCategory, { foreignKey: 'category_id', as: 'category' })
    - VerseCategoryContent.hasMany(VerseCategoryContentTranslation, { foreignKey: 'verse_category_content_id', as: 'translations' })
    - VerseCategoryContent.hasMany(VerseCategoryReaction, { foreignKey: 'verse_category_content_id', as: 'reactions' })
    - VerseCategoryContent.hasMany(VerseCategoryComment, { foreignKey: 'verse_category_content_id', as: 'verseComments' })
    - VerseCategoryComment.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
    - VerseCategoryComment.hasMany(VerseCategoryComment, { foreignKey: 'parent_id', as: 'replies' })
    - VerseCategoryComment.belongsTo(VerseCategoryComment, { foreignKey: 'parent_id', as: 'parent' })
    - VerseCategoryComment.hasMany(VerseCategoryCommentReaction, { foreignKey: 'comment_id', as: 'commentReactions' })
    - VerseCategoryCommentReaction.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
    - VerseCategoryReaction.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
    - VerseCategoryMedia.belongsTo(VerseCategory, { foreignKey: 'category_id', as: 'category' })
    - User.hasMany(VerseCategoryReaction, { foreignKey: 'user_id' })
    - User.hasMany(VerseCategoryComment, { foreignKey: 'user_id' })

    Also add verse_mode and verse_category_id fields to the User model init (add to the existing User.init() call in User.ts):
    - verse_mode: { type: DataTypes.ENUM('daily_verse', 'verse_by_category'), defaultValue: 'daily_verse' }
    - verse_category_id: { type: DataTypes.INTEGER, allowNull: true, references: { model: 'verse_categories', key: 'id' } }

    Add these to UserAttributes and UserCreationAttributes interfaces too.

    Export all 7 new models from index.ts.

    Install new dependencies: `npm install @anthropic-ai/sdk && npm install --save-dev adm-zip`
  </action>
  <verify>Run `npx tsc --noEmit` on the models directory (or full project build) to verify no TypeScript errors. Check that all 7 models are exported from index.ts. Verify User model has verse_mode and verse_category_id fields.</verify>
  <done>All 7 model files created with correct TypeScript interfaces, associations defined in index.ts, User model extended with verse_mode + verse_category_id, all models exported, @anthropic-ai/sdk and adm-zip installed.</done>
</task>

</tasks>

<verification>
- `npx sequelize-cli db:migrate` completes successfully
- All 7 tables + 2 user columns exist in MySQL: `SHOW TABLES LIKE 'verse_%'` returns 7 rows
- `DESCRIBE users` shows verse_mode ENUM and verse_category_id INT columns
- No TypeScript compilation errors from model files
- All 7 models importable: `import { VerseCategory, VerseCategoryContent, ... } from '@/lib/db/models'`
</verification>

<success_criteria>
- 8 migration files exist and run cleanly (up and down)
- 7 model files exist with correct TypeScript types
- Model index exports all 7 new models with associations
- User model has verse_mode and verse_category_id
- @anthropic-ai/sdk and adm-zip are installed
</success_criteria>

<output>
After completion, create `.planning/phases/11-verse-by-category-system/11-01-SUMMARY.md`
</output>
