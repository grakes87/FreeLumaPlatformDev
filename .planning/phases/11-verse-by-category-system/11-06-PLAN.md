---
phase: 11-verse-by-category-system
plan: 06
type: execute
wave: 4
depends_on: ["11-05"]
files_modified:
  - src/components/daily/DailyFeed.tsx
  - src/app/(app)/settings/page.tsx
  - src/app/api/settings/route.ts
  - src/context/AuthContext.tsx
autonomous: true

must_haves:
  truths:
    - "Bible-mode users see VerseModeToggle at top of daily tab"
    - "Positivity-mode users do NOT see VerseModeToggle"
    - "Switching to 'Verse by Category' replaces daily feed with VerseByCategorySlide + CategorySelector"
    - "Verse mode setting persists across page refreshes (stored in user profile)"
    - "Profile settings show verse mode selector and category dropdown for bible-mode users"
    - "Changing settings syncs immediately to daily tab behavior"
    - "Bible translation selector works for verse-by-category content"
  artifacts:
    - path: "src/components/daily/DailyFeed.tsx"
      provides: "Conditional rendering: DailyFeed (daily_verse mode) OR VerseByCategorySlide (verse_by_category mode)"
    - path: "src/app/(app)/settings/page.tsx"
      provides: "Verse mode segmented control + category dropdown in settings"
    - path: "src/app/api/settings/route.ts"
      provides: "GET/PUT handles verse_mode and verse_category_id fields"
    - path: "src/context/AuthContext.tsx"
      provides: "UserData includes verse_mode and verse_category_id"
  key_links:
    - from: "src/components/daily/DailyFeed.tsx"
      to: "src/components/daily/VerseByCategorySlide.tsx"
      via: "conditional render based on user.verse_mode"
      pattern: "verse_mode.*verse_by_category"
    - from: "src/app/(app)/settings/page.tsx"
      to: "/api/settings"
      via: "PUT to update verse_mode and verse_category_id"
      pattern: "verse_mode"
    - from: "src/context/AuthContext.tsx"
      to: "UserData type"
      via: "verse_mode and verse_category_id fields"
      pattern: "verse_mode"
---

<objective>
Integrate the verse-by-category system into the daily tab and profile settings.

Purpose: Wires up the mode toggle to the daily tab so bible-mode users can switch between Daily Post and Verse by Category views. Also adds verse mode controls to profile settings.
Output: Updated DailyFeed with conditional rendering, settings page with verse mode controls, auth context with new fields.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-verse-by-category-system/11-CONTEXT.md
@.planning/phases/11-verse-by-category-system/11-05-SUMMARY.md

Key files to modify:
@src/components/daily/DailyFeed.tsx
@src/app/(app)/settings/page.tsx
@src/app/api/settings/route.ts
@src/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AuthContext and settings API to support verse mode fields</name>
  <files>
    src/context/AuthContext.tsx
    src/app/api/settings/route.ts
  </files>
  <action>
    **AuthContext.tsx:**
    - Add `verse_mode: 'daily_verse' | 'verse_by_category'` and `verse_category_id: number | null` to the UserData interface
    - These fields are already returned by GET /api/auth/me (since User model now has them)
    - Ensure updateUser function includes these fields in the type
    - No other changes needed -- fetchUser already spreads all user fields

    **settings/route.ts (GET handler):**
    - Read the existing merged settings endpoint. It already reads from User + UserSetting.
    - Add verse_mode and verse_category_id to the User fields returned in GET response
    - These should already be included if the GET handler uses User.findByPk with attributes that include them. Verify and add if missing.

    **settings/route.ts (PUT handler):**
    - Add verse_mode and verse_category_id to the allowed User table fields in the PUT handler
    - Validate verse_mode: must be 'daily_verse' or 'verse_by_category' (or omitted)
    - Validate verse_category_id: must be a positive integer or null (or omitted)
    - When verse_mode is set to 'daily_verse', auto-clear verse_category_id to null
    - When verse_category_id is set, validate the category exists and is active via VerseCategory.findByPk
    - Update User record with new fields
  </action>
  <verify>
    curl tests:
    - GET /api/settings returns verse_mode and verse_category_id in response
    - PUT /api/settings with `{"verse_mode":"verse_by_category","verse_category_id":1}` updates user
    - PUT /api/settings with `{"verse_mode":"daily_verse"}` clears verse_category_id
    - No TypeScript errors in AuthContext or settings route
  </verify>
  <done>AuthContext UserData type includes verse_mode and verse_category_id. Settings API GET returns these fields and PUT accepts/validates them.</done>
</task>

<task type="auto">
  <name>Task 2: Update DailyFeed to conditionally render verse-by-category mode and add verse mode to settings page</name>
  <files>
    src/components/daily/DailyFeed.tsx
    src/app/(app)/settings/page.tsx
  </files>
  <action>
    **DailyFeed.tsx:**
    - Import useAuth, VerseModeToggle, VerseByCategorySlide, CategorySelector, useVerseByCategoryFeed
    - Get user from useAuth()
    - Add verse mode state: `const [verseMode, setVerseMode] = useState(user?.verse_mode || 'daily_verse')`
    - Show VerseModeToggle only if user.mode === 'bible' (hidden for positivity):
      - Position: fixed at top of daily tab area, centered, z-30, below TopBar
      - `<VerseModeToggle mode={verseMode} onChange={handleModeChange} />`
    - handleModeChange: update local state + fire-and-forget PUT /api/settings { verse_mode: newMode }. Also update auth context user.
    - Conditional rendering:
      - If verseMode === 'daily_verse': render existing DailyFeed content (the scroll container with DailyPostCarousel)
      - If verseMode === 'verse_by_category': render the verse-by-category view:
        - Use useVerseByCategoryFeed hook
        - Render CategorySelector (floating at top, below VerseModeToggle)
        - Render VerseByCategorySlide (full-screen, below CategorySelector)
        - CategorySelector starts collapsed
        - On category select: call selectCategory, auto-collapse selector
    - Fade transition between modes: wrap both views in divs with `transition-opacity duration-300` and conditional opacity-0/opacity-100
    - When switching to verse-by-category: scroll container should be hidden (no vertical snap scrolling for verse-by-category -- single verse display)
    - Translation: pass activeTranslation from DailyTranslationContext to VerseByCategorySlide. The existing TopBar translation switcher should work for verse-by-category too (it switches the displayed translation).

    **settings/page.tsx:**
    - Find the existing "Content Mode" or mode selector section
    - Below the mode selector (bible/positivity), add a new section visible ONLY for bible-mode users:
      - Label: "Verse Display Mode"
      - Segmented control: [Daily Verse] [Verse by Category] -- use same glass style as VerseModeToggle but with settings theme (match other settings controls -- likely not glass, but solid bg with active indicator)
      - When "Verse by Category" selected: show a category dropdown below it
        - Fetch categories from /api/verse-categories
        - Render as a select/dropdown with category names
        - Default: user's current verse_category_id or "All"
        - On change: debounced auto-save to PUT /api/settings { verse_category_id: selectedId }
      - When "Daily Verse" selected: hide category dropdown
    - Changes trigger the existing debounced settings save pattern (500ms debounce)
    - Toast feedback on save: "Verse mode updated" via existing toast pattern
  </action>
  <verify>
    - Navigate to daily tab as bible-mode user: VerseModeToggle visible at top
    - Switch to "Verse by Category": verse slide appears with category selector
    - Select a category: verse loads, selector collapses
    - Refresh page: mode persists (still on verse-by-category)
    - Navigate to settings: verse mode controls visible for bible-mode users
    - Log in as positivity-mode user: VerseModeToggle NOT visible, settings section NOT visible
    - Translation switcher in TopBar works for verse-by-category text
    - No TypeScript errors
  </verify>
  <done>DailyFeed conditionally renders verse-by-category mode for bible-mode users. Settings page shows verse mode selector with category dropdown. Mode persists via API. Translation switching works.</done>
</task>

</tasks>

<verification>
- Bible-mode user sees VerseModeToggle on daily tab
- Positivity-mode user does NOT see VerseModeToggle
- Switching modes shows/hides verse-by-category view with fade transition
- CategorySelector floats over verse display, collapses after selection
- VerseByCategorySlide shows random verse with background image
- Settings page has verse mode + category controls for bible-mode users
- Mode and category persist across page refreshes
- Translation switcher works for both modes
- No TypeScript compilation errors
</verification>

<success_criteria>
- Complete integration: daily tab shows correct view based on verse_mode
- Settings controls work with debounced auto-save
- Mode persists via user profile (not just session state)
- Positivity-mode users never see verse-by-category features
</success_criteria>

<output>
After completion, create `.planning/phases/11-verse-by-category-system/11-06-SUMMARY.md`
</output>
