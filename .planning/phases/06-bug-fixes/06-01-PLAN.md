---
phase: 06-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/audit-log/route.ts
  - src/app/(app)/layout.tsx
  - src/app/api/upload/post-media/route.ts
autonomous: true

must_haves:
  truths:
    - "`npx next build` completes with zero TypeScript errors"
    - "Guest (unauthenticated) users see daily content with vertical scroll snap between days"
    - "Media uploads to B2 include Cache-Control headers for CDN caching"
  artifacts:
    - path: "src/app/api/admin/audit-log/route.ts"
      provides: "Build-passing audit log route"
      contains: "as unknown as Record"
    - path: "src/app/(app)/layout.tsx"
      provides: "Guest scroll snap wrapper"
      contains: "scrollSnapType"
    - path: "src/app/api/upload/post-media/route.ts"
      provides: "CacheControl on B2 uploads"
      contains: "CacheControl"
  key_links:
    - from: "src/app/(app)/layout.tsx"
      to: "GuestDailyWrapper"
      via: "scroll-snap-type: y mandatory on guest container"
      pattern: "scrollSnapType.*mandatory"
---

<objective>
Fix the single build-blocking TypeScript error, restore guest scroll snap on daily content, and add Cache-Control headers to B2 media uploads.

Purpose: Unblock deployment (build error), fix guest UX (scroll snap), and improve media performance (caching headers).
Output: Three independent one-line-to-small fixes across unrelated files.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-bug-fixes/06-RESEARCH.md

Key research findings:
- Build error: `src/app/api/admin/audit-log/route.ts:92` — `entry.toJSON() as Record<string, unknown>` fails. Fix: double-cast via `as unknown as Record<string, unknown>`.
- Guest scroll: `GuestDailyWrapper` in `src/app/(app)/layout.tsx` lacks `scrollSnapType: 'y mandatory'` and `overscrollBehaviorY: 'contain'` that `AppShellInner` has on its `<main>` element.
- Media caching: `PutObjectCommand` in upload route has no `CacheControl` parameter. Add `CacheControl: 'public, max-age=31536000, immutable'` for immutable uploads.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TypeScript build error in audit-log route</name>
  <files>src/app/api/admin/audit-log/route.ts</files>
  <action>
  Find the line where `entry.toJSON()` is cast as `Record<string, unknown>` (around line 92). Change the cast from:
  ```typescript
  const json = entry.toJSON() as Record<string, unknown>;
  ```
  to:
  ```typescript
  const json = entry.toJSON() as unknown as Record<string, unknown>;
  ```
  This double-cast is needed because Sequelize model types don't have an index signature compatible with `Record<string, unknown>`.
  </action>
  <verify>Run `npx next build` and confirm zero TypeScript errors.</verify>
  <done>Build completes successfully with no type errors.</done>
</task>

<task type="auto">
  <name>Task 2: Restore guest scroll snap on daily content</name>
  <files>src/app/(app)/layout.tsx</files>
  <action>
  Find the `GuestDailyWrapper` component in the layout file. Its `<main>` element currently uses `className="flex-1"` (or similar) without scroll snap properties.

  Update the guest wrapper to match the authenticated `AppShellInner`'s scroll behavior:
  1. Add `id="immersive-scroll"` to the `<main>` element
  2. Add inline styles: `style={{ scrollSnapType: 'y mandatory', overscrollBehaviorY: 'contain' }}`
  3. Ensure the container has `overflow-y: auto` and full height (`h-full` or equivalent)
  4. The wrapper's outer div should be `fixed inset-0 overflow-hidden bg-black` to contain the scrollable area

  The children (DailyPostSlide components) already have `scroll-snap-align: start` set, so adding the container properties is all that's needed.

  Do NOT change the AppShellInner (authenticated wrapper) — only fix GuestDailyWrapper.
  </action>
  <verify>Load the app as an unauthenticated guest. Scroll through daily content and verify it snaps between days. Compare with authenticated behavior — both should snap identically.</verify>
  <done>Guest daily content scrolls with vertical snap between days, matching authenticated user behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Add Cache-Control headers to B2 media uploads</name>
  <files>src/app/api/upload/post-media/route.ts</files>
  <action>
  Find the `PutObjectCommand` in the upload route (around line 134-141). It currently sets `Bucket`, `Key`, `Body`, and `ContentType` but no `CacheControl`.

  Add `CacheControl: 'public, max-age=31536000, immutable'` to the PutObjectCommand parameters. This tells Cloudflare CDN (and browsers) to cache media files for 1 year, which is correct for immutable content-addressed uploads.

  Example:
  ```typescript
  new PutObjectCommand({
    Bucket: ...,
    Key: ...,
    Body: ...,
    ContentType: ...,
    CacheControl: 'public, max-age=31536000, immutable',
  })
  ```

  Also check if there are other upload routes (e.g., `upload/chat-media`, `upload/daily-content`) and add the same CacheControl header to those as well if they use PutObjectCommand without it. Use the same immutable cache policy for all media uploads since file keys are content-addressed (timestamp + random).
  </action>
  <verify>Read the upload route(s) and confirm CacheControl is present in all PutObjectCommand calls.</verify>
  <done>All B2 media uploads include `CacheControl: 'public, max-age=31536000, immutable'` header.</done>
</task>

</tasks>

<verification>
1. `npx next build` completes with zero errors
2. Guest scroll snap works on daily content (scroll between days snaps)
3. Upload routes include CacheControl in PutObjectCommand
</verification>

<success_criteria>
- Build passes cleanly
- Guest and authenticated scroll snap behavior match
- B2 uploads include proper cache headers
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes/06-01-SUMMARY.md`
</output>
