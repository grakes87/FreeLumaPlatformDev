---
phase: 06-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/feed/PostCardTikTok.tsx
  - src/app/api/feed/fyp/route.ts
autonomous: true

must_haves:
  truths:
    - "Media carousel in TikTok feed mode allows horizontal swiping between images/videos"
    - "Tapping video in TikTok feed toggles play/pause"
    - "Repost posts in FYP feed show verified badge on original author"
  artifacts:
    - path: "src/components/feed/PostCardTikTok.tsx"
      provides: "Fixed TikTok card with carousel swipe, tap-to-pause, and pointer-events fix"
      contains: "touch-action"
    - path: "src/app/api/feed/fyp/route.ts"
      provides: "FYP API with user_reposted field"
      contains: "user_reposted"
  key_links:
    - from: "src/components/feed/PostCardTikTok.tsx"
      to: "video element"
      via: "pointer-events-none on overlay + tap-to-toggle button"
      pattern: "pointer-events-none"
    - from: "src/app/api/feed/fyp/route.ts"
      to: "src/components/feed/PostCardTikTok.tsx"
      via: "user_reposted field in API response"
      pattern: "user_reposted"
---

<objective>
Fix three feed/TikTok mode bugs: horizontal carousel swipe blocked by vertical scroll snap, video tap-to-pause not working due to overlay blocking clicks, and repost verified badge display via missing FYP API field.

Purpose: Make TikTok-mode feed fully interactive — users can swipe carousels, tap videos, and see verified badges on reposts.
Output: Fixed PostCardTikTok component and FYP API route.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-bug-fixes/06-RESEARCH.md

Key research findings:
- Bug #2 (Carousel swipe): The media carousel (overflow-x-auto snap-x) is inside vertical #immersive-scroll (scrollSnapType: 'y mandatory'). Touch gestures get captured by vertical scroller. Fix: add `touch-action: pan-x` style to horizontal carousel container.
- Bug #3 (Tap-to-pause): Content overlay div at z-10 covers entire card, blocking clicks from reaching video at z-0. Video has `onClick={togglePlayPause}` but never receives the event. Fix: use `pointer-events-none` on overlay container, `pointer-events-auto` on interactive children, and add a dedicated tap-to-toggle button behind the overlay.
- Bug #4 (Repost badges): Frontend code renders verified badges correctly. The FYP API route is missing `user_reposted` field that the Following route includes. Add it to ensure repost display logic works correctly in FYP tab.

File references:
- PostCardTikTok.tsx: lines 241-278 (media carousel), line 299 (content overlay), line 476 (author info conditional)
- FYP route: line 376 (missing user_reposted)
- Following route: includes user_reposted (use as reference pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix media carousel horizontal swipe and video tap-to-pause</name>
  <files>src/components/feed/PostCardTikTok.tsx</files>
  <action>
  **Fix 1 — Carousel swipe (Bug #2):**
  Find the media carousel container div (around line 241-278, the div with `overflow-x-auto snap-x snap-mandatory` classes). Add `style={{ touchAction: 'pan-x' }}` to this element. This tells the browser that this element only handles horizontal touch gestures, allowing the parent vertical scroll snap to handle vertical gestures without conflict.

  Also check if the carousel uses a `<div>` wrapper or Swiper component. If it's a plain div with overflow-x, the `touchAction: 'pan-x'` style is the fix. If it wraps Swiper, the fix may need to go on the Swiper container.

  **Fix 2 — Tap-to-pause (Bug #3):**
  Find the content overlay div (around line 299, the `<div className="absolute inset-x-0 top-0 z-10" ...>` that covers the full card). This overlay blocks click events from reaching the video below.

  Apply the pointer-events fix:
  1. Add `pointer-events-none` to the overlay container's className
  2. Find all interactive children inside the overlay (action buttons, author info, text, etc.) and add `pointer-events-auto` to each interactive child wrapper
  3. Add a dedicated tap-to-toggle button layer between the video (z-0) and the overlay (z-10):
     ```tsx
     {/* Tap-to-toggle layer */}
     <button
       type="button"
       onClick={togglePlayPause}
       className="absolute inset-0 z-[5]"
       aria-label="Toggle play/pause"
     />
     ```
     This button sits at z-5, behind the overlay but above the video, catching taps that aren't on interactive overlay elements.

  Alternatively, if the component already has a `togglePlayPause` function, wire it to the new button. If not, find the existing play/pause toggle logic (likely in the video element's onClick) and use the same function.

  Make sure the tap-to-toggle button is only rendered when the active media item is a video (not for image-only posts).
  </action>
  <verify>
  Read the modified PostCardTikTok.tsx and verify:
  1. Media carousel div has `touchAction: 'pan-x'` style
  2. Content overlay has `pointer-events-none` class
  3. Interactive children have `pointer-events-auto`
  4. Tap-to-toggle button exists at z-5 for video posts
  </verify>
  <done>Carousel allows horizontal swipe without triggering vertical scroll snap. Video tap-to-pause works through the overlay.</done>
</task>

<task type="auto">
  <name>Task 2: Add user_reposted to FYP API response</name>
  <files>src/app/api/feed/fyp/route.ts</files>
  <action>
  Compare the FYP route (`src/app/api/feed/fyp/route.ts`) with the Following feed route (`src/app/api/feed/route.ts`) to find how `user_reposted` is included.

  In the Following feed route, `user_reposted` is a boolean indicating whether the current user has reposted a given post. The FYP route omits this field (around line 376 in the response mapping).

  Add `user_reposted` to the FYP response, matching the pattern from the Following route. This typically involves:
  1. Looking up the user's reposts for the batch of post IDs (similar to how reactions/bookmarks are batch-looked-up)
  2. Adding `user_reposted: repostedPostIds.has(post.id)` (or equivalent) to the response object

  If the Following route uses a Set of reposted post IDs built from a Repost query, replicate the same query in the FYP route.
  </action>
  <verify>Read the modified FYP route and confirm `user_reposted` field is present in the post response objects. Compare the field mapping with the Following route to ensure consistency.</verify>
  <done>FYP API response includes `user_reposted` boolean for each post, matching the Following feed format.</done>
</task>

</tasks>

<verification>
1. PostCardTikTok has touch-action fix on carousel and pointer-events fix on overlay
2. FYP route returns user_reposted field
3. `npx next build` still passes (no new TypeScript errors introduced)
</verification>

<success_criteria>
- Horizontal carousel swipe works in TikTok feed without triggering vertical scroll
- Tapping video area toggles play/pause in TikTok feed
- Repost posts in FYP show complete author information including verified badges
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes/06-02-SUMMARY.md`
</output>
