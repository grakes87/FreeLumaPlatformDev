---
phase: 06-bug-fixes
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils/generateVideoThumbnail.ts
  - src/components/feed/PostComposer.tsx
  - src/components/prayer/PrayerComposer.tsx
autonomous: true

must_haves:
  truths:
    - "When uploading a video in the feed post composer, a thumbnail preview is visible after upload"
    - "When uploading a video in the prayer request composer, a thumbnail preview is visible after upload"
    - "Video thumbnail is generated client-side from the video file before/during upload"
  artifacts:
    - path: "src/lib/utils/generateVideoThumbnail.ts"
      provides: "Client-side video thumbnail generator using canvas API"
      exports: ["generateVideoThumbnail"]
    - path: "src/components/feed/PostComposer.tsx"
      provides: "Feed composer with video thumbnail generation on upload"
      contains: "generateVideoThumbnail"
    - path: "src/components/prayer/PrayerComposer.tsx"
      provides: "Prayer composer with video thumbnail preview"
      contains: "generateVideoThumbnail"
  key_links:
    - from: "src/lib/utils/generateVideoThumbnail.ts"
      to: "src/components/feed/PostComposer.tsx"
      via: "import and call during video upload"
      pattern: "generateVideoThumbnail"
    - from: "src/lib/utils/generateVideoThumbnail.ts"
      to: "src/components/prayer/PrayerComposer.tsx"
      via: "import and call for video preview"
      pattern: "generateVideoThumbnail"
---

<objective>
Create a shared client-side video thumbnail generator utility and integrate it into both the feed PostComposer and prayer PrayerComposer for video upload preview thumbnails.

Purpose: Fix the "no thumbnail" problem for video uploads across both composers — users see a meaningful preview frame instead of a black rectangle.
Output: New shared utility + integration into two composer components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-bug-fixes/06-RESEARCH.md

Key research findings:
- Bug #5 & #13 (Video upload no thumbnail): Both PostComposer and PrayerComposer create video previews using `URL.createObjectURL(file)` or `<video preload="metadata">` which doesn't reliably show a frame on mobile browsers.
- Fix approach: Client-side canvas capture — load video, seek to 0.5s, draw to canvas, export as JPEG blob. Use this blob as poster/thumbnail.
- PostComposer: The upload flow creates `MediaItem` objects. After video upload completes, `thumbnail_url` is not set. The video in MediaStrip (line 268) uses `<video src={item.url} preload="metadata">`.
- PrayerComposer: Video preview (line 425-439) uses `<video src={m.previewUrl} preload="metadata">`.
- The thumbnail blob should be uploaded alongside the video to B2, and the `thumbnail_url` set on the media record.

Pattern from research:
```typescript
async function generateVideoThumbnail(file: File): Promise<Blob | null> {
  return new Promise((resolve) => {
    const video = document.createElement('video');
    video.preload = 'auto';
    video.muted = true;
    video.playsInline = true;
    const url = URL.createObjectURL(file);
    video.src = url;
    video.onloadeddata = () => { video.currentTime = 0.5; };
    video.onseeked = () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      if (!ctx) { resolve(null); return; }
      ctx.drawImage(video, 0, 0);
      canvas.toBlob((blob) => {
        URL.revokeObjectURL(url);
        resolve(blob);
      }, 'image/jpeg', 0.7);
    };
    video.onerror = () => { URL.revokeObjectURL(url); resolve(null); };
  });
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared video thumbnail generator utility</name>
  <files>src/lib/utils/generateVideoThumbnail.ts</files>
  <action>
  Create a new utility file `src/lib/utils/generateVideoThumbnail.ts` that exports a function to generate a JPEG thumbnail blob from a video File:

  ```typescript
  /**
   * Generate a JPEG thumbnail from a video file by capturing a frame at 0.5s.
   * Returns a Blob (image/jpeg) or null if generation fails.
   */
  export async function generateVideoThumbnail(file: File): Promise<Blob | null> {
    return new Promise((resolve) => {
      const video = document.createElement('video');
      video.preload = 'auto';
      video.muted = true;
      video.playsInline = true;

      const url = URL.createObjectURL(file);
      video.src = url;

      // Timeout after 10 seconds to prevent hanging
      const timeout = setTimeout(() => {
        URL.revokeObjectURL(url);
        resolve(null);
      }, 10000);

      video.onloadeddata = () => {
        video.currentTime = 0.5;
      };

      video.onseeked = () => {
        clearTimeout(timeout);
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 360;
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          URL.revokeObjectURL(url);
          resolve(null);
          return;
        }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(
          (blob) => {
            URL.revokeObjectURL(url);
            resolve(blob);
          },
          'image/jpeg',
          0.7
        );
      };

      video.onerror = () => {
        clearTimeout(timeout);
        URL.revokeObjectURL(url);
        resolve(null);
      };
    });
  }

  /**
   * Convert a thumbnail Blob to a data URL for local preview.
   */
  export function blobToDataUrl(blob: Blob): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result as string);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }
  ```

  Include:
  - 10-second timeout to prevent hanging on corrupt videos
  - Fallback dimensions (640x360) if video dimensions aren't available
  - Helper `blobToDataUrl` for converting the blob to a data URL for `<img>` or `<video poster>` display
  </action>
  <verify>File exists at `src/lib/utils/generateVideoThumbnail.ts` and exports both functions with proper types.</verify>
  <done>Shared video thumbnail utility created with canvas-based frame capture and blob-to-data-url helper.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate thumbnail generation into PostComposer</name>
  <files>src/components/feed/PostComposer.tsx</files>
  <action>
  **Step 1 — Import utility:**
  Add import at top of file:
  ```typescript
  import { generateVideoThumbnail, blobToDataUrl } from '@/lib/utils/generateVideoThumbnail';
  ```

  **Step 2 — Generate thumbnail during video upload:**
  Find the `uploadFile` function (around line 472-558) where media items are created. When the file is a video (`file.type.startsWith('video/')`):

  1. After the file is selected (before or during upload), call `generateVideoThumbnail(file)` to get a thumbnail blob
  2. Convert the blob to a data URL using `blobToDataUrl(blob)` for local preview
  3. Set the data URL as a `posterUrl` or `thumbnailUrl` on the MediaItem state object
  4. Upload the thumbnail blob to B2 alongside the video (using a presigned URL with key prefix like `posts/{userId}/thumb-{timestamp}.jpg`)
  5. After thumbnail upload completes, set the `thumbnail_url` on the media record in the API confirm call

  If the full B2 thumbnail upload adds too much complexity, at minimum:
  - Generate the thumbnail blob client-side
  - Convert to data URL
  - Use it as the `poster` attribute on the `<video>` element in the media strip preview

  **Step 3 — Display thumbnail in preview:**
  Find where videos are displayed in the media strip (around line 268). If the video element uses `<video src={item.url} preload="metadata">`, add a `poster` attribute:
  ```tsx
  <video
    src={item.url}
    poster={item.thumbnailUrl || undefined}
    preload="metadata"
    ...
  />
  ```

  The thumbnail generation should be fire-and-forget (non-blocking). If thumbnail generation fails (returns null), the video preview falls back to `preload="metadata"` behavior.
  </action>
  <verify>Read the modified PostComposer.tsx. Confirm generateVideoThumbnail is imported and called for video files, and the video preview element has a poster attribute.</verify>
  <done>Feed PostComposer generates a client-side thumbnail for uploaded videos and displays it as the video preview poster.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate thumbnail generation into PrayerComposer</name>
  <files>src/components/prayer/PrayerComposer.tsx</files>
  <action>
  **Step 1 — Import utility:**
  Add import at top of file:
  ```typescript
  import { generateVideoThumbnail, blobToDataUrl } from '@/lib/utils/generateVideoThumbnail';
  ```

  **Step 2 — Generate thumbnail on video selection:**
  Find where video files are added to the media state (the `handleFilesSelected` or equivalent function). When a video file is selected:

  1. Call `generateVideoThumbnail(file)` to get a thumbnail blob
  2. Convert to data URL via `blobToDataUrl(blob)`
  3. Store the data URL as `thumbnailUrl` on the media item in state

  **Step 3 — Display thumbnail in preview:**
  Find where video media items are rendered in the preview area (around line 425-439, `<video src={m.previewUrl} preload="metadata">`). Add the `poster` attribute:
  ```tsx
  <video
    src={m.previewUrl}
    poster={m.thumbnailUrl || undefined}
    preload="metadata"
    playsInline
    muted
    className="..."
  />
  ```

  Or alternatively, if a thumbnail data URL is available, show an `<img>` with a play icon overlay instead of a `<video>` element for the preview (which is more reliable on mobile):
  ```tsx
  {m.thumbnailUrl ? (
    <div className="relative">
      <img src={m.thumbnailUrl} alt="Video preview" className="w-full h-full object-cover" />
      <div className="absolute inset-0 flex items-center justify-center">
        <Play className="h-8 w-8 text-white/80" />
      </div>
    </div>
  ) : (
    <video src={m.previewUrl} preload="metadata" ... />
  )}
  ```

  Make thumbnail generation non-blocking — use `.then()` pattern to update state when ready, don't block the file selection UX.
  </action>
  <verify>Read the modified PrayerComposer.tsx. Confirm generateVideoThumbnail is imported and called, and video previews use thumbnail poster/image.</verify>
  <done>Prayer composer generates client-side thumbnails for video uploads and displays them as preview posters.</done>
</task>

</tasks>

<verification>
1. `src/lib/utils/generateVideoThumbnail.ts` exists and exports `generateVideoThumbnail` + `blobToDataUrl`
2. PostComposer imports and uses thumbnail generator for video files
3. PrayerComposer imports and uses thumbnail generator for video previews
4. Video previews show a captured frame instead of black rectangle
5. `npx next build` still passes
</verification>

<success_criteria>
- Video uploads in both composers show a thumbnail preview after selection
- Thumbnail generation is non-blocking (UI doesn't freeze)
- Fallback to preload="metadata" if thumbnail generation fails
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes/06-05-SUMMARY.md`
</output>
