---
phase: 12-content-production-platform
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/content-pipeline/verse-selection.ts
  - src/lib/content-pipeline/bible-verse-index.ts
autonomous: true

must_haves:
  truths:
    - "npm install succeeds for @elevenlabs/elevenlabs-js"
    - "Bible verse index contains all 31,102 KJV verse references"
    - "Verse selection picks a random unused verse and records it in used_bible_verses"
  artifacts:
    - path: "src/lib/content-pipeline/verse-selection.ts"
      provides: "selectRandomUnusedVerse() function"
      exports: ["selectRandomUnusedVerse"]
    - path: "src/lib/content-pipeline/bible-verse-index.ts"
      provides: "Complete KJV verse reference index by book/chapter/verse"
      exports: ["ALL_KJV_VERSES", "KJV_VERSE_COUNT"]
  key_links:
    - from: "src/lib/content-pipeline/verse-selection.ts"
      to: "src/lib/db/models/UsedBibleVerse.ts"
      via: "records selected verse to prevent repetition"
      pattern: "UsedBibleVerse\\.create"
---

<objective>
Install npm dependencies and create the Bible verse selection module -- the first step of the content generation pipeline.

Purpose: The verse selection module selects random unused KJV verses from a complete 31,102-verse index, tracks used verses to prevent repetition, and provides the foundational verse data for all downstream pipeline steps.
Output: New npm deps installed, complete KJV verse index data file, verse selection function.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
@src/lib/bible-api/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies for Phase 12</name>
  <files>package.json</files>
  <action>
Run `npm install @elevenlabs/elevenlabs-js` to add the ElevenLabs TTS SDK.

Note: Do NOT install `murf` npm package. Per RESEARCH.md, Murf SDK availability on npm is uncertain. The pipeline will use direct REST API calls for Murf (Spanish TTS). This avoids a potential install failure.

Verify the package installed correctly by checking package.json and node_modules.
  </action>
  <verify>`npm ls @elevenlabs/elevenlabs-js` shows the package installed without errors.</verify>
  <done>@elevenlabs/elevenlabs-js installed and listed in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create KJV verse index and verse selection module</name>
  <files>
    src/lib/content-pipeline/bible-verse-index.ts
    src/lib/content-pipeline/verse-selection.ts
  </files>
  <action>
**bible-verse-index.ts** -- Complete KJV verse reference data:
Generate a static array of ALL 31,102 KJV verse references. Structure each entry as `{ book: string, chapter: number, verse: number, reference: string }` where reference is the human-readable form like "Genesis 1:1".

Use the known KJV verse counts per book (66 books, 1,189 chapters). The standard KJV structure:
- Genesis: 50 chapters (31,25,24,26,32,22,24,22,29,32,32,20,18,24,21,16,27,33,38,18,34,24,20,67,34,35,46,22,35,43,55,32,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,22,33,26)
- Exodus: 40 chapters (22,25,22,31,23,30,25,32,35,29,10,51,22,31,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38)
- ... (continue for all 66 books)

Since generating the complete verse count per chapter for all 66 books would be extremely large inline, use a more efficient approach: store only the chapter-verse-count data (66 books, each with array of verse counts per chapter), then generate the full index at module load time.

Export:
- `ALL_KJV_VERSES`: Array of { book, chapter, verse, reference } -- lazy-generated on first access
- `KJV_VERSE_COUNT`: 31102 (constant for validation)

The verse counts per chapter for all 66 books of the KJV can be sourced from the well-known KJV structure. Use a compact representation: `{ [bookName]: number[] }` where each number[] is the verse count per chapter.

**verse-selection.ts** -- Random unused verse selection:

```typescript
import { ALL_KJV_VERSES } from './bible-verse-index';

export async function selectRandomUnusedVerse(): Promise<{
  book: string;
  chapter: number;
  verse: number;
  reference: string;
}>
```

Algorithm:
1. Lazy-import UsedBibleVerse model (dynamic import pattern)
2. Fetch all used verse references: `UsedBibleVerse.findAll({ attributes: ['book', 'chapter', 'verse'], raw: true })`
3. Build a Set of used keys: `${book}:${chapter}:${verse}`
4. Filter ALL_KJV_VERSES to exclude used verses
5. If no unused verses remain, throw Error('All 31,102 KJV verses have been used')
6. Pick a random element from the filtered array
7. Return the selected verse object (do NOT write to used_bible_verses here -- the pipeline runner handles that after successful content creation)

This separation ensures idempotency: the verse is only marked "used" after the full content row is successfully created.
  </action>
  <verify>
Create a simple test: import `ALL_KJV_VERSES` and `KJV_VERSE_COUNT` and verify `ALL_KJV_VERSES.length === 31102`. Verify the first verse is Genesis 1:1 and the last is Revelation 22:21. Run `npx tsx -e "import { ALL_KJV_VERSES, KJV_VERSE_COUNT } from './src/lib/content-pipeline/bible-verse-index'; console.log(ALL_KJV_VERSES.length, KJV_VERSE_COUNT, ALL_KJV_VERSES[0].reference, ALL_KJV_VERSES[ALL_KJV_VERSES.length-1].reference)"`.
  </verify>
  <done>Bible verse index contains exactly 31,102 entries. selectRandomUnusedVerse() returns a random verse not in the used_bible_verses table. Verse is NOT recorded until pipeline runner confirms content creation.</done>
</task>

</tasks>

<verification>
- `npm ls @elevenlabs/elevenlabs-js` succeeds
- `ALL_KJV_VERSES.length === 31102`
- First verse: Genesis 1:1, last verse: Revelation 22:21
- selectRandomUnusedVerse imports cleanly (no TypeScript errors)
</verification>

<success_criteria>
- ElevenLabs SDK installed
- Complete KJV verse index generated with all 31,102 verses
- Verse selection function created that excludes already-used verses
- No TypeScript errors in new modules
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-02-SUMMARY.md`
</output>
