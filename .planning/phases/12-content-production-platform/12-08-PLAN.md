---
phase: 12-content-production-platform
plan: 08
type: execute
wave: 3
depends_on: ["12-01"]
files_modified:
  - src/lib/heygen/index.ts
  - src/app/api/admin/content-production/heygen/route.ts
  - src/app/api/webhooks/heygen/route.ts
autonomous: true

must_haves:
  truths:
    - "HeyGen API client can create portrait AI videos from script text"
    - "Admin can trigger bulk HeyGen generation for a month's AI creator content"
    - "Webhook receives HeyGen completion callbacks and updates content status"
  artifacts:
    - path: "src/lib/heygen/index.ts"
      provides: "HeyGen REST API client (create video, check status)"
      exports: ["createHeygenVideo", "checkHeygenStatus"]
    - path: "src/app/api/admin/content-production/heygen/route.ts"
      provides: "POST trigger bulk HeyGen generation"
      exports: ["POST"]
    - path: "src/app/api/webhooks/heygen/route.ts"
      provides: "POST HeyGen completion webhook"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/admin/content-production/heygen/route.ts"
      to: "src/lib/heygen/index.ts"
      via: "creates HeyGen videos for AI creators"
      pattern: "createHeygenVideo"
    - from: "src/app/api/webhooks/heygen/route.ts"
      to: "src/lib/db/models/DailyContent.ts"
      via: "updates creator_video_url on completion"
      pattern: "creator_video_url"
---

<objective>
Build HeyGen AI video integration: REST API client library, admin bulk trigger route, and webhook for completion notifications.

Purpose: HeyGen generates AI avatar videos for non-English AI creators. Admin triggers generation for a month, HeyGen processes asynchronously, and a webhook updates the content when videos are ready.
Output: HeyGen client library, admin trigger route, webhook handler.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HeyGen client library</name>
  <files>src/lib/heygen/index.ts</files>
  <action>
**HeyGen REST API client:**

Export `createHeygenVideo(params: { avatarId: string; scriptText: string; apiKey: string; callbackUrl?: string }): Promise<string>`:
- POST to `https://api.heygen.com/v2/video/generate`
- Headers: `X-API-KEY: apiKey`, `Content-Type: application/json`
- Body per RESEARCH.md:
  ```json
  {
    "video_inputs": [{
      "character": { "type": "avatar", "avatar_id": avatarId, "avatar_style": "normal" },
      "voice": { "type": "text", "input_text": scriptText },
      "background": { "type": "color", "value": "#000000" }
    }],
    "dimension": { "width": 1080, "height": 1920 },
    "callback_url": callbackUrl
  }
  ```
- On success: return data.data.video_id (string)
- On error: throw with status code and error message

Export `checkHeygenStatus(videoId: string, apiKey: string): Promise<{ status: 'pending' | 'processing' | 'completed' | 'failed'; video_url?: string; error?: string }>`:
- GET `https://api.heygen.com/v1/video_status.get?video_id=${videoId}`
- Headers: `X-API-KEY: apiKey`
- Return normalized status object

Export `HeygenError` class extending Error for typed error handling.
  </action>
  <verify>Run `npx tsc --noEmit src/lib/heygen/index.ts` for TypeScript check.</verify>
  <done>HeyGen client library provides createHeygenVideo (creates portrait AI video) and checkHeygenStatus (polls for completion). Direct REST API calls with typed responses.</done>
</task>

<task type="auto">
  <name>Task 2: Create HeyGen admin trigger route and webhook handler</name>
  <files>
    src/app/api/admin/content-production/heygen/route.ts
    src/app/api/webhooks/heygen/route.ts
  </files>
  <action>
**heygen/route.ts -- POST trigger bulk HeyGen generation:**
Wrapped with withAdmin.

Body: { month: string (YYYY-MM), mode: 'bible' | 'positivity' }

1. Get HeyGen API key from PlatformSetting.get('heygen_api_key'). Return 503 if not configured.
2. Query LumaShortCreator where is_ai=true AND active=true
3. For each AI creator:
   - Query DailyContent where month range, mode matches, creator_id=this AI creator, status='assigned', creator_video_url IS NULL (no video yet)
   - For each such day:
     - Get camera_script text from DailyContent
     - Get creator's heygen_avatar_id
     - Determine webhook URL: `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/heygen`
     - Call createHeygenVideo({ avatarId, scriptText: camera_script, apiKey, callbackUrl })
     - Store video_id on a tracking mechanism. Options:
       a) Store in PlatformSetting as JSON map of videoId -> dailyContentId (simple)
       b) Add a heygen_video_id column to daily_content (cleaner but requires migration)
       Use option (a) for simplicity -- store as PlatformSetting key 'heygen_pending_videos' with JSON value `{ [videoId]: dailyContentId }`.
     - Add 1s delay between HeyGen API calls
4. Return: { triggered: number, ai_creators: number }

**webhooks/heygen/route.ts -- POST HeyGen completion webhook:**
NO auth middleware (webhook from external service).

1. Parse request body (HeyGen sends event_type and event_data)
2. Extract video_id from the callback
3. Look up dailyContentId from PlatformSetting 'heygen_pending_videos' JSON map
4. If not found, return 200 (idempotent -- maybe already processed)
5. If status is 'completed':
   - Get video_url from callback data
   - Update DailyContent: creator_video_url = video_url, status = 'submitted'
   - Remove this entry from pending map
   - Create notification for admin: "HeyGen video ready for [date]" via createNotification (fire-and-forget)
6. If status is 'failed':
   - Log error
   - Remove from pending map (admin can retry manually)
   - Create notification for admin: "HeyGen video failed for [date]"
7. Always return 200 (per RESEARCH: prevent retry loops)

Also add a GET handler to this route (or a separate polling route) so admin can manually check status of pending HeyGen videos if webhooks fail.
  </action>
  <verify>Run `npx tsc --noEmit src/app/api/admin/content-production/heygen/route.ts src/app/api/webhooks/heygen/route.ts` for TypeScript check.</verify>
  <done>Admin can trigger bulk HeyGen video generation for AI creators. Webhook receives completion callbacks and updates content. PlatformSetting tracks pending video IDs. Always returns 200 to prevent retry loops.</done>
</task>

</tasks>

<verification>
- HeyGen client compiles and exports createHeygenVideo + checkHeygenStatus
- Admin trigger route queries AI creators and dispatches HeyGen requests
- Webhook always returns 200
- Pending videos tracked via PlatformSetting JSON map
</verification>

<success_criteria>
- HeyGen client sends correct API requests with portrait dimensions (1080x1920)
- Admin trigger route processes all AI creator assignments for a month
- Webhook updates DailyContent with video URL on completion
- Failed videos logged and admin notified
- Rate limiting (1s delay) between HeyGen API calls
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-08-SUMMARY.md`
</output>
