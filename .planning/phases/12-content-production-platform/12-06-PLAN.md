---
phase: 12-content-production-platform
plan: 06
type: execute
wave: 3
depends_on: ["12-04", "12-05"]
files_modified:
  - src/app/api/admin/content-production/route.ts
  - src/app/api/admin/content-production/generate/route.ts
  - src/app/api/admin/content-production/regenerate/route.ts
  - src/app/api/admin/content-production/assign/route.ts
  - src/app/api/admin/content-production/review/route.ts
  - src/app/api/admin/content-production/background-video/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view month overview with stats (total, generated, assigned, submitted, approved, missing)"
    - "Admin can trigger month generation via SSE streaming endpoint with real-time progress"
    - "Admin can regenerate individual fields on a day's content"
    - "Admin can auto-assign or reassign creators"
    - "Admin can approve, reject, or revert content"
    - "Admin can upload background videos matched to calendar dates"
  artifacts:
    - path: "src/app/api/admin/content-production/route.ts"
      provides: "GET month overview API"
      exports: ["GET"]
    - path: "src/app/api/admin/content-production/generate/route.ts"
      provides: "POST SSE generation endpoint"
      exports: ["POST"]
    - path: "src/app/api/admin/content-production/assign/route.ts"
      provides: "POST auto-assign and reassign endpoints"
      exports: ["POST"]
    - path: "src/app/api/admin/content-production/review/route.ts"
      provides: "POST approve/reject/revert endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/admin/content-production/generate/route.ts"
      to: "src/lib/content-pipeline/pipeline-runner.ts"
      via: "SSE streams pipeline progress to client"
      pattern: "generateMonthContent|generateDayContent"
    - from: "src/app/api/admin/content-production/assign/route.ts"
      to: "src/lib/content-pipeline/assignment.ts"
      via: "auto-assign and reassign functions"
      pattern: "autoAssignMonth|reassignDay"
---

<objective>
Create all admin content production API routes: month overview, SSE generation, field regeneration, assignment, review (approve/reject/revert), and background video upload.

Purpose: These endpoints power the admin content management UI. The SSE generation endpoint is the key innovation -- streaming real-time progress for long-running month generation.
Output: 6 API route files covering the complete admin content production workflow.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
@src/lib/utils/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create month overview, SSE generation, and field regeneration routes</name>
  <files>
    src/app/api/admin/content-production/route.ts
    src/app/api/admin/content-production/generate/route.ts
    src/app/api/admin/content-production/regenerate/route.ts
  </files>
  <action>
**route.ts -- GET month overview:**
Wrapped with withAdmin.

Query params: ?month=YYYY-MM&mode=bible|positivity (both required, validate with Zod).

1. Parse month to get date range (YYYY-MM-01 to YYYY-MM-{lastDay})
2. Query DailyContent for the month/mode with associated creator (LumaShortCreator include) and translations (DailyContentTranslation include)
3. Compute stats:
   - total_days: number of days in month
   - generated: count where status != 'empty'
   - assigned: count where creator_id IS NOT NULL
   - submitted: count where status = 'submitted'
   - approved: count where status = 'approved'
   - rejected: count where status = 'rejected'
   - missing: total_days - generated
4. Return: `{ stats: {...}, days: [...] }` where each day includes: id, post_date, status, creator (name + avatar from user), title, verse_reference, has_camera_script (boolean), has_devotional (boolean), has_meditation (boolean), has_background_prompt (boolean), has_creator_video (boolean), translations (array with: translation_code, has_audio, has_srt, has_chapter_text)

**generate/route.ts -- POST SSE streaming generation:**
Wrapped with withAdmin but SPECIAL: since SSE returns a streaming Response, the withAdmin check must happen BEFORE creating the stream. Pattern:
1. Validate admin auth manually (import auth check, don't use withAdmin HOF)
2. Parse body: { month: string (YYYY-MM), mode: 'bible' | 'positivity', day?: number (optional, single day) }
3. Create ReadableStream with async start() callback
4. Return Response immediately with headers: Content-Type: text/event-stream, Cache-Control: no-cache, Connection: keep-alive
5. Inside start(): call generateMonthContent (or generateDayContent for single day) with progress callback that enqueues SSE data
6. On complete, enqueue final summary event and close controller

SSE format: `data: ${JSON.stringify(event)}\n\n` for each progress event.

For single-day generation (day param provided), call generateDayContent directly.

**regenerate/route.ts -- POST regenerate specific field:**
Wrapped with withAdmin.

Body: { daily_content_id: number, field: 'camera_script' | 'devotional_reflection' | 'meditation_script' | 'background_prompt' | 'tts' | 'srt', translation_code?: string (required for tts/srt) }

1. Find DailyContent by id with translations (404 if not found)
2. Based on field:
   - Text fields (camera_script, devotional_reflection, meditation_script, background_prompt): call appropriate text-generation function, update DailyContent column
   - 'tts': regenerate TTS for specified translation_code. Get text from chapter_text, call appropriate TTS provider, upload to B2, update audio_url
   - 'srt': regenerate SRT from existing audio timing data (re-run TTS to get timing, or if stored). Since timing data isn't stored separately, regenerating SRT requires re-running TTS for that translation. So 'srt' effectively re-does TTS+SRT together.
3. Return updated content
  </action>
  <verify>
Run `npx tsc --noEmit src/app/api/admin/content-production/route.ts src/app/api/admin/content-production/generate/route.ts src/app/api/admin/content-production/regenerate/route.ts` for TypeScript check.
  </verify>
  <done>Month overview returns day-by-day content status with stats. SSE generation streams real-time progress. Regeneration allows per-field re-generation including TTS/SRT.</done>
</task>

<task type="auto">
  <name>Task 2: Create assignment, review, and background video routes</name>
  <files>
    src/app/api/admin/content-production/assign/route.ts
    src/app/api/admin/content-production/review/route.ts
    src/app/api/admin/content-production/background-video/route.ts
  </files>
  <action>
**assign/route.ts -- POST assignment operations:**
Wrapped with withAdmin.

Body: { action: 'auto_assign' | 'reassign', month?: string, mode?: string, daily_content_id?: number, creator_id?: number }

- auto_assign: requires month (YYYY-MM) and mode. Calls autoAssignMonth(month, mode). Returns { assigned, skipped }.
- reassign: requires daily_content_id and creator_id. Calls reassignDay(dailyContentId, creatorId). Returns { success: true }.

Validate with Zod discriminated union on action field.

**review/route.ts -- POST approve/reject/revert:**
Wrapped with withAdmin.

Body: { daily_content_id: number, action: 'approve' | 'reject' | 'revert', rejection_note?: string (required for reject) }

1. Find DailyContent by id (404 if not found)
2. Validate status transitions:
   - approve: only from 'submitted'. Sets status='approved'.
   - reject: only from 'submitted'. Sets status='rejected', rejection_note = provided note. Trigger email notification to creator (non-blocking, fire-and-forget import of email function).
   - revert: only from 'approved'. Sets status='submitted'. (Admin un-approves to swap content)
3. Update and return updated content

For reject, also send email notification to creator if creator has a linked user with email. Use existing SendGrid pattern (dynamic import, fire-and-forget).

**background-video/route.ts -- POST upload background videos:**
Wrapped with withAdmin.

This route receives metadata about uploaded background videos (the actual file upload goes through presigned URL to B2).

Body: { uploads: Array<{ date: string (YYYY-MM-DD), video_url: string }> }

For each upload:
1. Find DailyContent by post_date (both bible and positivity modes -- background video is shared)
2. If found, update video_background_url = video_url
3. If not found, log warning (content for that date doesn't exist yet)

Return: { updated: number, not_found: string[] }

Note: The actual file upload is handled client-side via presigned URL. This endpoint just links the uploaded video URL to the calendar date.
  </action>
  <verify>
Run `npx tsc --noEmit src/app/api/admin/content-production/assign/route.ts src/app/api/admin/content-production/review/route.ts src/app/api/admin/content-production/background-video/route.ts` for TypeScript check.
  </verify>
  <done>Assignment route supports auto-assign (round-robin) and reassign (individual). Review route handles approve/reject/revert with status transition validation. Background video route links uploaded videos to calendar dates.</done>
</task>

</tasks>

<verification>
- All 6 API routes compile without TypeScript errors
- SSE generation returns proper Content-Type: text/event-stream
- Status transitions are validated (reject only from submitted, etc.)
- Assignment uses the round-robin module
</verification>

<success_criteria>
- GET /admin/content-production returns month overview with stats and per-day detail
- POST /admin/content-production/generate streams SSE progress events
- POST /admin/content-production/regenerate re-generates individual fields
- POST /admin/content-production/assign handles auto-assign and reassign
- POST /admin/content-production/review validates status transitions for approve/reject/revert
- POST /admin/content-production/background-video links video URLs to dates
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-06-SUMMARY.md`
</output>
