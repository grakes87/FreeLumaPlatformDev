---
phase: 12-content-production-platform
plan: 12
type: execute
wave: 5
depends_on: ["12-07", "12-11"]
files_modified:
  - src/app/(app)/creator/record/[id]/page.tsx
  - src/components/creator/Teleprompter.tsx
  - src/components/creator/RecordingControls.tsx
  - src/hooks/useMediaRecorder.ts
autonomous: true

must_haves:
  truths:
    - "Creator can open teleprompter with camera preview and semi-transparent script overlay"
    - "Script auto-scrolls at adjustable speed with 45-second countdown timer"
    - "Creator can record portrait video via front-facing camera"
    - "After recording: preview, re-record, or submit"
    - "Video upload uses presigned URL to B2"
  artifacts:
    - path: "src/app/(app)/creator/record/[id]/page.tsx"
      provides: "Teleprompter recording page route"
      exports: ["default"]
    - path: "src/components/creator/Teleprompter.tsx"
      provides: "Camera preview with script overlay and auto-scroll"
      min_lines: 100
    - path: "src/components/creator/RecordingControls.tsx"
      provides: "Record/stop/preview/submit controls"
      min_lines: 60
    - path: "src/hooks/useMediaRecorder.ts"
      provides: "MediaRecorder hook for video capture"
      exports: ["useMediaRecorder"]
  key_links:
    - from: "src/hooks/useMediaRecorder.ts"
      to: "navigator.mediaDevices.getUserMedia"
      via: "accesses front-facing camera in portrait mode"
      pattern: "getUserMedia.*facingMode.*user"
    - from: "src/components/creator/RecordingControls.tsx"
      to: "/api/creator/upload"
      via: "submits recorded video"
      pattern: "fetch.*creator/upload"
---

<objective>
Build the teleprompter recording experience: camera preview with script overlay, auto-scrolling script, 45-second countdown timer, video recording via MediaRecorder, and submit flow.

Purpose: This is the creator's primary tool -- they read the camera script while recording a portrait video. The teleprompter overlay, countdown timer, and adjustable scroll speed make recording smooth.
Output: Recording page, teleprompter component, recording controls, and MediaRecorder hook.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useMediaRecorder hook and Teleprompter component</name>
  <files>
    src/hooks/useMediaRecorder.ts
    src/components/creator/Teleprompter.tsx
  </files>
  <action>
**useMediaRecorder.ts** -- Custom hook for video recording:

```typescript
export function useMediaRecorder(): {
  stream: MediaStream | null;
  isRecording: boolean;
  recordedBlob: Blob | null;
  recordedUrl: string | null;
  error: string | null;
  startCamera: () => Promise<void>;
  startRecording: () => void;
  stopRecording: () => void;
  resetRecording: () => void;
  stopCamera: () => void;
}
```

Implementation:
- `startCamera()`: calls `navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 1080 }, height: { ideal: 1920 } }, audio: true })`. Stores stream in ref. Sets videoRef.srcObject if provided.
- MIME type detection: try 'video/mp4; codecs=avc1' (Safari), then 'video/webm; codecs=vp9,opus', then 'video/webm' (per RESEARCH)
- `startRecording()`: creates MediaRecorder with detected MIME type. Collects chunks via ondataavailable. Sets isRecording=true.
- `stopRecording()`: stops MediaRecorder. Combines chunks into Blob. Creates object URL. Sets isRecording=false, recordedBlob, recordedUrl.
- `resetRecording()`: revokes object URL, clears recordedBlob/recordedUrl. Does NOT stop camera (allows re-recording).
- `stopCamera()`: stops all tracks on stream. Clears stream.
- Cleanup on unmount: stop camera and revoke URLs.
- Error handling: catch getUserMedia permission denied, not-supported, etc.

**Teleprompter.tsx** -- Camera preview with script overlay:
- Props: script (string), videoRef (React ref for camera preview), isRecording (boolean)
- Full-screen portrait layout (fixed inset-0)
- Camera preview: `<video ref={videoRef} autoPlay muted playsInline className="object-cover w-full h-full -scale-x-100" />` (mirrored for selfie)
- Script overlay: semi-transparent dark background (bg-black/40) overlaid on bottom 40% of screen
  - Script text in white, readable font size (text-lg)
  - Auto-scroll: uses ref + setInterval to scroll the container down at adjustable speed
  - Speed control: 3 speed settings (slow/medium/fast). Default medium. Small toggle buttons at bottom edge.
  - Auto-scroll starts when recording starts, pauses when not recording
- **45-second countdown timer:**
  - Positioned top-right of screen
  - Starts when recording starts
  - Shows MM:SS format counting down from 0:45
  - At 0:10 remaining: timer text changes to amber (warning)
  - At 0:05 remaining: timer text changes to red (urgent)
  - At 0:00: timer shows "TIME" in red (but recording continues -- doesn't auto-stop)
  - Timer also shows elapsed time after 0:45 as +0:XX in red
- Recording indicator: red dot in top-left when recording (pulsing animation)
  </action>
  <verify>Run `npx tsc --noEmit src/hooks/useMediaRecorder.ts src/components/creator/Teleprompter.tsx` for TypeScript check.</verify>
  <done>useMediaRecorder handles camera access, video recording with MIME type detection, and blob management. Teleprompter shows mirrored camera preview with semi-transparent script overlay, auto-scroll at 3 speeds, and 45-second countdown with color-coded warnings.</done>
</task>

<task type="auto">
  <name>Task 2: Create recording page and RecordingControls</name>
  <files>
    src/app/(app)/creator/record/[id]/page.tsx
    src/components/creator/RecordingControls.tsx
  </files>
  <action>
**RecordingControls.tsx:**
- Props: isRecording, recordedBlob, recordedUrl, onStartRecording, onStopRecording, onReRecord, onSubmit, isSubmitting
- **Pre-recording state (no recording yet):**
  - Large circular "Record" button (red) at bottom center
  - Camera preview is live
- **Recording state:**
  - Large circular "Stop" button (white with red outline) at bottom center
  - Recording duration display
- **Post-recording state (has recorded blob):**
  - Preview: video element playing the recorded blob URL
  - Two buttons at bottom: "Re-record" (outline) and "Submit" (solid green)
  - Re-record: calls onReRecord (clears recording, returns to pre-recording state)
  - Submit: calls onSubmit (triggers upload)
- **Submitting state:**
  - Upload progress bar
  - "Submitting..." text
  - Buttons disabled

**page.tsx** -- Recording page:
`'use client'` with dynamic import for camera components (SSR incompatible).

1. Parse [id] from params
2. Fetch assignment content: GET /api/creator/content/{id}
3. Verify status allows recording (assigned or rejected). If submitted/approved, redirect back.
4. Initialize useMediaRecorder hook
5. On mount: startCamera()
6. Render:
   - Teleprompter component with camera script text and video ref
   - RecordingControls overlay at bottom

7. **Submit flow:**
   - Get presigned URL for B2: fetch GET /api/upload/presigned-url?type=creator_video&extension={mp4|webm}
   - Upload blob to presigned URL via PUT with progress tracking
   - After upload, trigger server-side video processing if needed:
     - Call POST /api/creator/upload with { daily_content_id: id, video_url: b2Url, thumbnail_url: '' }
   - On success: redirect to /creator with success toast
   - On error: show error, allow retry

8. **Cleanup:** stopCamera on unmount

Use next/dynamic with ssr: false for all camera-dependent components.
  </action>
  <verify>Run `npx tsc --noEmit src/app/\\(app\\)/creator/record/\\[id\\]/page.tsx src/components/creator/RecordingControls.tsx` for TypeScript check.</verify>
  <done>Recording page initializes camera, shows teleprompter with script, and provides record/stop/preview/submit flow. Video uploaded via presigned URL to B2 then registered via creator upload API.</done>
</task>

</tasks>

<verification>
- Recording page compiles with dynamic imports (no SSR)
- useMediaRecorder handles camera lifecycle correctly
- Teleprompter shows script overlay with auto-scroll
- Recording controls transition through all states
- Submit flow uses presigned URL upload to B2
</verification>

<success_criteria>
- /creator/record/[id] opens camera in portrait mode
- Teleprompter displays camera script semi-transparently over camera preview
- Auto-scroll at adjustable speed starts with recording
- 45-second countdown with color-coded warnings
- After recording: preview video, then re-record or submit
- Submit uploads to B2 via presigned URL and updates status to submitted
- Camera cleaned up on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-12-SUMMARY.md`
</output>
