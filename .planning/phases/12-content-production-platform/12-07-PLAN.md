---
phase: 12-content-production-platform
plan: 07
type: execute
wave: 3
depends_on: ["12-01", "12-04"]
files_modified:
  - src/app/api/creator/assignments/route.ts
  - src/app/api/creator/stats/route.ts
  - src/app/api/creator/content/[id]/route.ts
  - src/app/api/creator/upload/route.ts
autonomous: true

must_haves:
  truths:
    - "Creator can view their assigned content list for a given month"
    - "Creator can view full content details for any assigned day"
    - "Creator can submit a recorded video for their assignment"
    - "Creator can view personal stats (completed, pending, upcoming)"
  artifacts:
    - path: "src/app/api/creator/assignments/route.ts"
      provides: "GET creator assignments list"
      exports: ["GET"]
    - path: "src/app/api/creator/stats/route.ts"
      provides: "GET creator personal stats"
      exports: ["GET"]
    - path: "src/app/api/creator/content/[id]/route.ts"
      provides: "GET full content details for assigned day"
      exports: ["GET"]
    - path: "src/app/api/creator/upload/route.ts"
      provides: "POST submit recorded video"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/creator/assignments/route.ts"
      to: "src/lib/auth/middleware.ts"
      via: "withCreator middleware gates access"
      pattern: "withCreator"
    - from: "src/app/api/creator/upload/route.ts"
      to: "src/lib/db/models/DailyContent.ts"
      via: "updates creator_video_url and status to submitted"
      pattern: "status.*submitted"
---

<objective>
Create the creator portal API routes: assignment list, full content details, video submission, and personal stats.

Purpose: Creators need to see their assigned scripts, view generated content (verse, translations, camera script), submit recorded videos, and track their progress.
Output: 4 API routes for the creator portal.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
@src/lib/auth/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create creator assignments and stats API routes</name>
  <files>
    src/app/api/creator/assignments/route.ts
    src/app/api/creator/stats/route.ts
  </files>
  <action>
**assignments/route.ts -- GET creator's assigned content:**
Wrapped with withCreator.

Query params: ?month=YYYY-MM (optional, defaults to current month)

1. Parse month to get date range
2. Query DailyContent where creator_id = context.creator.id AND post_date in range
3. Include DailyContentTranslation for audio/SRT status
4. Order by post_date ASC
5. Return: `{ assignments: Array<{ id, post_date, mode, status, title, verse_reference, has_camera_script, has_creator_video, due_date: '15th of month' }> }`

Each assignment includes enough info for the list view. Full content comes from the [id] route.

**stats/route.ts -- GET creator personal stats:**
Wrapped with withCreator.

1. Query DailyContent where creator_id = context.creator.id
2. Compute:
   - total_assigned: count all
   - completed: count where status IN ('submitted', 'approved')
   - pending: count where status IN ('assigned', 'rejected')
   - approved: count where status = 'approved'
   - rejected: count where status = 'rejected'
3. For viewer engagement (optional, simple metric): sum of listen_logs for content IDs where this creator's video was used. If too complex, skip for now and return 0.
4. Current month stats (separate): filter by current month date range
5. Return: `{ total: { assigned, completed, pending, approved, rejected }, current_month: { assigned, completed, pending } }`
  </action>
  <verify>
Run `npx tsc --noEmit src/app/api/creator/assignments/route.ts src/app/api/creator/stats/route.ts` for TypeScript check.
  </verify>
  <done>Creator assignments endpoint returns monthly assignment list with status. Creator stats endpoint returns lifetime and current-month completion metrics.</done>
</task>

<task type="auto">
  <name>Task 2: Create creator content detail and video upload routes</name>
  <files>
    src/app/api/creator/content/[id]/route.ts
    src/app/api/creator/upload/route.ts
  </files>
  <action>
**content/[id]/route.ts -- GET full content for assigned day:**
Wrapped with withCreator.

1. Parse id from params
2. Find DailyContent by id with all translations included
3. Verify creator_id === context.creator.id (403 if not assigned to this creator)
4. Return full content object:
   - id, post_date, mode, status, title, content_text, verse_reference
   - camera_script, devotional_reflection, meditation_script, background_prompt
   - rejection_note (if rejected, so creator sees feedback)
   - creator_video_url, creator_video_thumbnail
   - translations: Array<{ translation_code, translated_text, chapter_text, audio_url, audio_srt_url }>

This gives the creator everything they need for the teleprompter: the camera script to read, the verse/quote context, and all generated content for reference.

**upload/route.ts -- POST submit recorded video:**
Wrapped with withCreator.

Body: { daily_content_id: number, video_url: string, thumbnail_url: string }

The actual video file is uploaded to B2 via presigned URL (client-side). This endpoint records the URLs and updates status.

1. Find DailyContent by id (404 if not found)
2. Verify creator_id === context.creator.id (403)
3. Verify status is 'assigned' or 'rejected' (can re-record after rejection). Return 400 if status is 'submitted' or 'approved' (must be reverted first).
4. If existing creator_video_url, the old video should be replaced. Optionally delete old B2 object (fire-and-forget, non-blocking).
5. Update DailyContent:
   - creator_video_url = video_url
   - creator_video_thumbnail = thumbnail_url
   - status = 'submitted'
   - rejection_note = null (clear previous rejection if re-recording)
6. Return updated content with status 'submitted'

Server-side video processing (FFmpeg compression + thumbnail) is triggered here:
- After updating the URL, queue server-side processing. Since the existing video processing pattern uses FFmpeg (from Phase 4), import and call the processing function (or just let the raw video be used directly -- per CONTEXT, "Upload raw video -- server-side processing for mobile stability"). The processing should:
  - Download raw video from B2 URL
  - Compress with FFmpeg (H.264, reasonable bitrate for portrait 1080x1920)
  - Generate thumbnail if not provided
  - Re-upload compressed video, update URL
  - This is fire-and-forget (non-blocking). Creator sees "submitted" immediately.
- If FFmpeg processing is too complex for this task, defer it and just store the raw video URL. The admin can view the raw video for approval.
  </action>
  <verify>
Run `npx tsc --noEmit src/app/api/creator/content/\\[id\\]/route.ts src/app/api/creator/upload/route.ts` for TypeScript check.
  </verify>
  <done>Content detail endpoint returns all generated content for creator reference. Upload endpoint accepts video URL, updates status to submitted, and optionally triggers server-side compression.</done>
</task>

</tasks>

<verification>
- All 4 creator API routes compile without errors
- withCreator middleware correctly gates all routes
- Creator can only access their own assignments (creator_id check)
- Status transitions validated (can't submit already-approved content)
</verification>

<success_criteria>
- Creator assignments list filtered by month with status indicators
- Full content detail includes camera script, verse, translations, rejection feedback
- Video upload updates status to 'submitted' and clears rejection note
- Personal stats track completed/pending/approved counts
- All routes gated by withCreator middleware
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-07-SUMMARY.md`
</output>
