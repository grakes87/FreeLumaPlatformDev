---
phase: 12-content-production-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/migrations/088-create-used-bible-verses.cjs
  - src/lib/db/migrations/089-create-luma-short-creators.cjs
  - src/lib/db/migrations/090-extend-daily-content-for-production.cjs
  - src/lib/db/models/UsedBibleVerse.ts
  - src/lib/db/models/LumaShortCreator.ts
  - src/lib/db/models/DailyContent.ts
  - src/lib/db/models/index.ts
autonomous: true

must_haves:
  truths:
    - "UsedBibleVerse table exists with unique (book, chapter, verse) constraint"
    - "LumaShortCreator table exists with user_id FK, languages JSON, capacity, mode flags, AI flag"
    - "DailyContent table has status, creator_id, camera_script, devotional_reflection, meditation_script, background_prompt, rejection_note, creator_video_url, creator_video_thumbnail columns"
  artifacts:
    - path: "src/lib/db/models/UsedBibleVerse.ts"
      provides: "UsedBibleVerse Sequelize model"
      exports: ["UsedBibleVerse"]
    - path: "src/lib/db/models/LumaShortCreator.ts"
      provides: "LumaShortCreator Sequelize model with user association"
      exports: ["LumaShortCreator"]
    - path: "src/lib/db/models/DailyContent.ts"
      provides: "Extended DailyContent model with production columns"
      exports: ["DailyContent"]
  key_links:
    - from: "src/lib/db/models/LumaShortCreator.ts"
      to: "src/lib/db/models/User.ts"
      via: "user_id FK with ON DELETE RESTRICT"
      pattern: "references.*users.*id"
    - from: "src/lib/db/models/DailyContent.ts"
      to: "src/lib/db/models/LumaShortCreator.ts"
      via: "creator_id FK with ON DELETE SET NULL"
      pattern: "references.*luma_short_creators.*id"
---

<objective>
Create the database foundation for Phase 12: used_bible_verses table, luma_short_creators table, and extend daily_content with production pipeline columns.

Purpose: All Phase 12 features (generation pipeline, creator management, admin UI, creator portal) depend on these schema changes.
Output: 3 migrations, 2 new models, 1 extended model, updated models index with associations.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
@src/lib/db/models/DailyContent.ts
@src/lib/db/models/index.ts
@src/lib/db/migrations/087-add-video-min-age.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrations for used_bible_verses, luma_short_creators, and daily_content extensions</name>
  <files>
    src/lib/db/migrations/088-create-used-bible-verses.cjs
    src/lib/db/migrations/089-create-luma-short-creators.cjs
    src/lib/db/migrations/090-extend-daily-content-for-production.cjs
  </files>
  <action>
Create three .cjs migration files following the established Sequelize CLI pattern (module.exports = { async up(queryInterface, Sequelize) {}, async down() {} }).

**Migration 088 - used_bible_verses:**
- id: INTEGER PRIMARY KEY AUTO_INCREMENT
- book: VARCHAR(50) NOT NULL (e.g., "John")
- chapter: INTEGER NOT NULL
- verse: INTEGER NOT NULL
- verse_reference: VARCHAR(100) NOT NULL (e.g., "John 3:16" human-readable format)
- used_date: DATEONLY NOT NULL (the content date this verse was assigned to)
- daily_content_id: INTEGER NOT NULL, FK to daily_content(id) ON DELETE CASCADE
- created_at: DATE
- UNIQUE constraint on (book, chapter, verse) named 'unique_verse_usage'
- INDEX on used_date named 'idx_used_date'

**Migration 089 - luma_short_creators:**
- id: INTEGER PRIMARY KEY AUTO_INCREMENT
- user_id: INTEGER NOT NULL, FK to users(id) ON DELETE RESTRICT
- name: VARCHAR(255) NOT NULL
- bio: TEXT nullable
- link_1: VARCHAR(500) nullable
- link_2: VARCHAR(500) nullable
- link_3: VARCHAR(500) nullable
- languages: JSON NOT NULL DEFAULT '["en"]'
- monthly_capacity: INTEGER NOT NULL DEFAULT 15
- can_bible: BOOLEAN NOT NULL DEFAULT true
- can_positivity: BOOLEAN NOT NULL DEFAULT true
- is_ai: BOOLEAN NOT NULL DEFAULT false
- heygen_avatar_id: VARCHAR(255) nullable (only for AI creators)
- active: BOOLEAN NOT NULL DEFAULT true
- created_at: DATE
- updated_at: DATE
- INDEX on (active, can_bible, can_positivity) named 'idx_active_mode'

**Migration 090 - extend daily_content:**
Add columns via queryInterface.addColumn (one at a time, not transaction-wrapped since MySQL DDL is auto-commit):
- status: ENUM('empty','generated','assigned','submitted','rejected','approved') NOT NULL DEFAULT 'empty'
- creator_id: INTEGER nullable, FK to luma_short_creators(id) ON DELETE SET NULL
- camera_script: TEXT nullable
- devotional_reflection: TEXT nullable
- meditation_script: TEXT nullable
- background_prompt: TEXT nullable
- rejection_note: TEXT nullable
- creator_video_url: VARCHAR(500) nullable
- creator_video_thumbnail: VARCHAR(500) nullable
- Add composite INDEX on (status, mode, post_date) named 'idx_status_mode_date'

Down migration: DROP TABLE for 088/089, removeColumn for each 090 column.
  </action>
  <verify>
Run `cd /Applications/XAMPP/xamppfiles/htdocs/FreeLumaPlatform && npx sequelize-cli db:migrate` and confirm all 3 migrations run without errors. Then verify with: `npx sequelize-cli db:migrate:status` shows 088, 089, 090 as "up".
  </verify>
  <done>All three migrations applied. used_bible_verses and luma_short_creators tables exist. daily_content has 9 new columns including status ENUM and creator_id FK.</done>
</task>

<task type="auto">
  <name>Task 2: Create UsedBibleVerse and LumaShortCreator models, extend DailyContent model, update models index</name>
  <files>
    src/lib/db/models/UsedBibleVerse.ts
    src/lib/db/models/LumaShortCreator.ts
    src/lib/db/models/DailyContent.ts
    src/lib/db/models/index.ts
  </files>
  <action>
**UsedBibleVerse model** (src/lib/db/models/UsedBibleVerse.ts):
- Follow the exact pattern of existing models (import DataTypes, Model, Optional from sequelize; import sequelize from '../index')
- Attributes: id, book (string), chapter (number), verse (number), verse_reference (string), used_date (string for DATEONLY), daily_content_id (number), created_at (Date)
- timestamps: true with updatedAt: false (append-only record -- once a verse is marked used, it never changes)
- tableName: 'used_bible_verses', underscored: true

**LumaShortCreator model** (src/lib/db/models/LumaShortCreator.ts):
- Attributes: id, user_id (number), name (string), bio (string|null), link_1/link_2/link_3 (string|null), languages (string[] -- JSON column stored as string[]), monthly_capacity (number), can_bible (boolean), can_positivity (boolean), is_ai (boolean), heygen_avatar_id (string|null), active (boolean), created_at/updated_at (Date)
- timestamps: true, underscored: true, tableName: 'luma_short_creators'
- The languages field is DataTypes.JSON in Sequelize

**Extend DailyContent model** (src/lib/db/models/DailyContent.ts):
- Add to DailyContentAttributes interface: status ('empty'|'generated'|'assigned'|'submitted'|'rejected'|'approved'), creator_id (number|null), camera_script (string|null), devotional_reflection (string|null), meditation_script (string|null), background_prompt (string|null), rejection_note (string|null), creator_video_url (string|null), creator_video_thumbnail (string|null)
- Add all new fields to Optional creation attributes
- Add declare statements for new fields on class
- Add column definitions in init() -- status as ENUM with defaultValue 'empty', creator_id as INTEGER nullable with references to luma_short_creators(id), rest as TEXT/VARCHAR nullable

**Update models index** (src/lib/db/models/index.ts):
- Import UsedBibleVerse and LumaShortCreator
- Add associations:
  - User.hasMany(LumaShortCreator, { foreignKey: 'user_id', as: 'creatorProfiles' })
  - LumaShortCreator.belongsTo(User, { foreignKey: 'user_id', as: 'user' })
  - LumaShortCreator.hasMany(DailyContent, { foreignKey: 'creator_id', as: 'assignments' })
  - DailyContent.belongsTo(LumaShortCreator, { foreignKey: 'creator_id', as: 'creator' })
  - DailyContent.hasMany(UsedBibleVerse, { foreignKey: 'daily_content_id', as: 'usedVerses' })
  - UsedBibleVerse.belongsTo(DailyContent, { foreignKey: 'daily_content_id', as: 'dailyContent' })
- Export UsedBibleVerse and LumaShortCreator from the module

Place the Phase 12 association block after the Phase 11 block with a clear comment "// ---- Phase 12: Content Production Platform Associations ----".
  </action>
  <verify>
Run `cd /Applications/XAMPP/xamppfiles/htdocs/FreeLumaPlatform && npx next build 2>&1 | head -30` to verify no TypeScript errors in the models. Also verify the models index exports both new models by checking the export block.
  </verify>
  <done>UsedBibleVerse and LumaShortCreator models created with correct types. DailyContent model extended with 9 new production columns. Models index updated with imports, associations, and exports. Build passes.</done>
</task>

</tasks>

<verification>
- `npx sequelize-cli db:migrate:status` shows migrations 088-090 as "up"
- MySQL table inspection confirms: `DESCRIBE used_bible_verses`, `DESCRIBE luma_short_creators`, `SHOW COLUMNS FROM daily_content WHERE Field IN ('status','creator_id','camera_script')`
- TypeScript compilation succeeds with no errors in model files
</verification>

<success_criteria>
- used_bible_verses table exists with unique verse constraint
- luma_short_creators table exists with all fields including JSON languages
- daily_content table has status ENUM, creator_id FK, and all 7 text/URL columns
- All Sequelize models properly typed and exported
- Associations registered (Creator->User, DailyContent->Creator, DailyContent->UsedBibleVerse)
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-01-SUMMARY.md`
</output>
