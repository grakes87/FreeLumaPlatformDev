---
phase: 12-content-production-platform
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/lib/auth/middleware.ts
  - src/app/api/admin/content-production/creators/route.ts
  - src/app/api/admin/content-production/creators/[id]/route.ts
  - src/lib/content-pipeline/assignment.ts
autonomous: true

must_haves:
  truths:
    - "Admin can list, create, update, and deactivate LumaShortCreator records"
    - "withCreator middleware authenticates creator portal routes"
    - "Round-robin assignment distributes content to creators by mode, language, and capacity"
  artifacts:
    - path: "src/app/api/admin/content-production/creators/route.ts"
      provides: "GET list + POST create creator endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/content-production/creators/[id]/route.ts"
      provides: "PUT update + DELETE deactivate creator endpoints"
      exports: ["PUT", "DELETE"]
    - path: "src/lib/content-pipeline/assignment.ts"
      provides: "Round-robin auto-assign and manual reassign functions"
      exports: ["autoAssignMonth", "reassignDay"]
    - path: "src/lib/auth/middleware.ts"
      provides: "withCreator HOF middleware"
      exports: ["withCreator"]
  key_links:
    - from: "src/lib/auth/middleware.ts"
      to: "src/lib/db/models/LumaShortCreator.ts"
      via: "withCreator checks user has active creator profile"
      pattern: "LumaShortCreator\\.findOne"
    - from: "src/lib/content-pipeline/assignment.ts"
      to: "src/lib/db/models/LumaShortCreator.ts"
      via: "queries eligible creators for round-robin"
      pattern: "LumaShortCreator\\.findAll"
---

<objective>
Create creator management (CRUD API + withCreator middleware) and round-robin assignment logic.

Purpose: Creators are the people (and AI avatars) who record daily content videos. Admin needs to manage them, and the auto-assign algorithm distributes work evenly.
Output: Creator CRUD API, withCreator middleware, assignment module.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
@src/lib/auth/middleware.ts
@src/app/api/admin/verse-categories/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create withCreator middleware and Creator CRUD API</name>
  <files>
    src/lib/auth/middleware.ts
    src/app/api/admin/content-production/creators/route.ts
    src/app/api/admin/content-production/creators/[id]/route.ts
  </files>
  <action>
**Add withCreator to middleware.ts:**
Follow the existing withAdmin pattern. Add a `CreatorContext` interface extending AuthContext with `creator` field (the LumaShortCreator instance). Export `withCreator` HOF that:
1. Wraps withAuth
2. Lazy-imports LumaShortCreator model
3. Finds active creator by user_id
4. If no active creator found, returns 403 "Creator profile not found"
5. Passes { ...authContext, creator } to handler

**Creator CRUD API -- route.ts (GET + POST):**
Both wrapped with `withAdmin`.

GET /api/admin/content-production/creators:
- Query params: ?active=true|false (optional, defaults to all)
- Returns all creators with associated user data (username, avatar_url) via include User
- Order by name ASC
- Return: { creators: [...] }

POST /api/admin/content-production/creators:
- Zod validation: { user_id: number, name: string(1-255), bio?: string, link_1?: string, link_2?: string, link_3?: string, languages: string[] (min 1 item), monthly_capacity: number(1-100), can_bible: boolean, can_positivity: boolean, is_ai: boolean, heygen_avatar_id?: string }
- Verify user_id exists in users table
- Verify no existing active creator for that user_id (409 "User already has an active creator profile")
- Create LumaShortCreator record
- Return 201 with created creator

**Creator CRUD API -- [id]/route.ts (PUT + DELETE):**
Both wrapped with `withAdmin`.

PUT /api/admin/content-production/creators/[id]:
- Zod validation: partial of creation fields (all optional)
- Find creator by id (404 if not found)
- Update fields
- Return updated creator

DELETE /api/admin/content-production/creators/[id]:
- Soft-deactivate: set active=false
- Find all DailyContent assigned to this creator with status in ('generated','assigned') -- set creator_id=null, status='generated' (unassign pending work)
- Already-completed/submitted/approved content keeps creator_id (per CONTEXT decision)
- Return 200 with { deactivated: true, unassigned_count: N }
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/auth/middleware.ts src/app/api/admin/content-production/creators/route.ts src/app/api/admin/content-production/creators/\\[id\\]/route.ts` for TypeScript check. Manually test: start dev server and `curl -X GET http://localhost:3000/api/admin/content-production/creators -H "Cookie: auth_token=..."` returns 200 with empty creators array.
  </verify>
  <done>withCreator middleware created. Creator CRUD API supports list (with user data), create (with user validation), update, and soft-deactivate with pending work unassignment.</done>
</task>

<task type="auto">
  <name>Task 2: Create round-robin assignment module</name>
  <files>
    src/lib/content-pipeline/assignment.ts
  </files>
  <action>
**assignment.ts** -- Creator assignment logic:

Export `autoAssignMonth(month: string, mode: 'bible' | 'positivity'): Promise<{ assigned: number; skipped: number }>`:
1. Parse month string (YYYY-MM format) to get year, monthNum, daysInMonth
2. Query eligible creators: LumaShortCreator.findAll where active=true AND (can_bible=true if mode='bible', can_positivity=true if mode='positivity'), order by id ASC for deterministic round-robin
3. If no eligible creators, return { assigned: 0, skipped: 0 }
4. Count existing assignments this month per creator: DailyContent.findAll where post_date BETWEEN month-01 and month-{lastDay}, mode matches, creator_id IS NOT NULL. Build Map<creatorId, count>.
5. Query unassigned content: DailyContent.findAll where post_date in range, mode matches, creator_id IS NULL, status='generated' (only generated content can be assigned). Order by post_date ASC.
6. Round-robin loop:
   - Start with creatorIndex=0
   - For each unassigned day, find next creator with capacity (count < monthly_capacity)
   - Cycle through creators array, skip those at capacity
   - On assignment: update day.creator_id and day.status='assigned'
   - Increment creatorIndex to next position after each assignment
   - Break if all creators are at capacity
7. Return { assigned, skipped: unassigned.length - assigned }

Export `reassignDay(dailyContentId: number, newCreatorId: number): Promise<void>`:
1. Find DailyContent by id (throw if not found)
2. Find LumaShortCreator by newCreatorId (throw if not found or not active)
3. Verify mode compatibility (if content is bible, creator must can_bible; same for positivity)
4. Update daily_content: creator_id = newCreatorId
5. If status was 'generated', update to 'assigned'
6. If status was already 'assigned'/'submitted'/'rejected', keep current status (just change creator)
7. Do NOT allow reassigning 'approved' content (throw error)
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/content-pipeline/assignment.ts` for TypeScript check. The logic is self-contained and uses only Sequelize queries.
  </verify>
  <done>autoAssignMonth distributes content round-robin among eligible creators respecting monthly capacity. reassignDay allows admin to change creator for any non-approved content.</done>
</task>

</tasks>

<verification>
- withCreator middleware follows withAuth/withAdmin pattern exactly
- Creator CRUD handles all 4 operations with proper validation
- Round-robin assignment respects mode flags and capacity limits
- Soft-deactivation correctly unassigns pending but preserves completed work
</verification>

<success_criteria>
- Admin can create, list, update, and deactivate creators via API
- withCreator middleware gates creator portal routes
- Auto-assign distributes evenly by round-robin with capacity tracking
- Reassign allows admin to move content between creators
- Deactivated creators' pending assignments properly unassigned
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-04-SUMMARY.md`
</output>
