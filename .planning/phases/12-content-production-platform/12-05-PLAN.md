---
phase: 12-content-production-platform
plan: 05
type: execute
wave: 3
depends_on: ["12-02", "12-03"]
files_modified:
  - src/lib/content-pipeline/pipeline-runner.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline runner generates a full day of bible content: verse selection, translations, devotional, camera script, background prompt, TTS audio, SRT subtitles"
    - "Pipeline runner generates a full day of positivity content: AI quote, meditation script, camera script, background prompt, TTS audio, SRT subtitles"
    - "Pipeline is idempotent: skips existing data, only fills gaps"
    - "Pipeline emits per-step progress events via callback"
  artifacts:
    - path: "src/lib/content-pipeline/pipeline-runner.ts"
      provides: "generateDayContent() and generateMonthContent() orchestrators"
      exports: ["generateDayContent", "generateMonthContent"]
  key_links:
    - from: "src/lib/content-pipeline/pipeline-runner.ts"
      to: "src/lib/content-pipeline/verse-selection.ts"
      via: "selects random unused verse for bible mode"
      pattern: "selectRandomUnusedVerse"
    - from: "src/lib/content-pipeline/pipeline-runner.ts"
      to: "src/lib/content-pipeline/text-generation.ts"
      via: "generates all AI text content"
      pattern: "generate(Positivity|Devotional|Camera|Meditation|Background)"
    - from: "src/lib/content-pipeline/pipeline-runner.ts"
      to: "src/lib/content-pipeline/tts-elevenlabs.ts"
      via: "generates English TTS audio"
      pattern: "generateTtsElevenLabs"
    - from: "src/lib/content-pipeline/pipeline-runner.ts"
      to: "src/lib/content-pipeline/tts-murf.ts"
      via: "generates Spanish TTS audio"
      pattern: "generateTtsMurf"
---

<objective>
Build the pipeline runner that orchestrates all content generation modules into a complete day/month generation flow with idempotent gap-fill logic and progress callbacks.

Purpose: This is the central orchestrator that admin triggers. It calls verse selection, AI text generation, TTS, and SRT modules in the correct order, creates/updates DailyContent + DailyContentTranslation rows, uploads audio/SRT files to B2, and reports progress.
Output: pipeline-runner.ts with generateDayContent() and generateMonthContent() functions.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-production-platform/12-CONTEXT.md
@.planning/phases/12-content-production-platform/12-RESEARCH.md
@src/lib/storage/presign.ts
@src/lib/bible-api/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline runner with generateDayContent and generateMonthContent</name>
  <files>
    src/lib/content-pipeline/pipeline-runner.ts
  </files>
  <action>
**Types and interfaces:**

```typescript
type ProgressCallback = (event: ProgressEvent) => void;
interface ProgressEvent {
  type: 'progress' | 'error' | 'complete';
  day?: number;
  total?: number;
  step?: string;
  message?: string;
  error?: string;
}
```

**generateDayContent(date: string, mode: 'bible' | 'positivity', onProgress: ProgressCallback): Promise&lt;{ success: boolean; error?: string }&gt;**

The core single-day pipeline. Steps:

1. **Check existing content:** Find DailyContent row for (date, mode, language='en'). If exists, check what fields are populated. If row doesn't exist, create it with status='empty'.

2. **Bible mode -- verse selection (if no verse_reference yet):**
   - Call selectRandomUnusedVerse()
   - Set content_text = verse text (KJV), verse_reference = reference, title = verse reference
   - onProgress({ type: 'progress', step: 'verse_selection' })

3. **Bible mode -- fetch all translations (if missing):**
   - Query BibleTranslation.findAll({ where: { active: true } })
   - For each translation, check if DailyContentTranslation row exists with chapter_text populated
   - For missing translations: call fetchPassage(verseReference, translationCode, 'verse') from bible-api
   - ESV: add 200ms delay between calls (rate limiting per RESEARCH)
   - Create/update DailyContentTranslation rows with translated_text and chapter_text
   - onProgress for each translation fetched

4. **Positivity mode -- generate quote (if no content_text yet):**
   - Call generatePositivityQuote()
   - Set content_text = quote, title = first 100 chars of quote
   - onProgress({ type: 'progress', step: 'positivity_quote' })

5. **Generate AI text (if missing fields):**
   - If bible mode and !devotional_reflection: call generateDevotionalReflection()
   - If !camera_script: call generateCameraScript(mode, content)
   - If positivity mode and !meditation_script: call generateMeditationScript(mode, content)
   - If !background_prompt: call generateBackgroundPrompt(mode, content)
   - Update DailyContent row with generated text fields
   - onProgress for each generation step

6. **TTS audio (if missing audio_url on translations):**
   - Get ElevenLabs config: PlatformSetting.get('elevenlabs_api_key'), PlatformSetting.get('elevenlabs_voice_id')
   - Get Murf config: PlatformSetting.get('murf_api_key'), PlatformSetting.get('murf_voice_id')
   - For each DailyContentTranslation with chapter_text but no audio_url:
     - Determine TTS provider: English translations -> ElevenLabs, Spanish/other -> Murf
     - Generate TTS with timing data
     - Upload audio buffer to B2 via presigned URL (key: `daily-content-audio/{date}/{translationCode}.mp3`)
     - Generate SRT from timing data using srt-generator
     - Upload SRT string as file to B2 (key: `daily-content-audio/{date}/{translationCode}.srt`)
     - Update DailyContentTranslation: audio_url, audio_srt_url
     - Add 500ms delay between TTS calls to respect rate limits
   - If positivity mode, also generate TTS for meditation_script:
     - Same process but key: `daily-content-audio/{date}/meditation-{lang}.mp3` and `.srt`
     - Store meditation audio/SRT on the English DailyContentTranslation as separate fields? No -- per CONTEXT, TTS scope is chapter_text + meditation. Store meditation audio URL on a new `meditation_audio_url` and `meditation_srt_url` on DailyContentTranslation. WAIT -- these columns don't exist on translations table. Instead, since meditation is generated once (not per translation), store on DailyContent itself. But DailyContent doesn't have audio columns... The simplest approach: For meditation, generate TTS per language (English ElevenLabs, Spanish Murf), and store as additional DailyContentTranslation rows with a special translation_code like 'MEDITATION_EN' and 'MEDITATION_ES'. Actually, this is overly complex. Better: just use the existing chapter_text flow -- for positivity mode, the chapter_text IS the meditation script, so TTS of chapter_text covers both verse audio (bible) and meditation audio (positivity). Per CONTEXT: "TTS scope: chapter_text (verse per translation) + meditation script (positivity mode)". So for positivity, the chapter_text on translations should contain the meditation script text, and TTS of chapter_text covers both modes. This means: for positivity mode, populate chapter_text on each translation with the meditation script text, then TTS generation on chapter_text handles everything uniformly.
   - onProgress for each TTS generation

7. **Record used verse (bible mode only):**
   - If we selected a new verse in step 2, create UsedBibleVerse record NOW (after successful content creation)
   - This ensures idempotency: verse only marked used after content is fully created

8. **Update status:**
   - Set status = 'generated' if still 'empty'
   - Do NOT change status if already 'assigned' or later (gap-fill shouldn't reset status)

9. **Return { success: true }** or on any failure: log error, onProgress({ type: 'error' }), return { success: false, error: message }

**Error handling:** Each step is wrapped in try/catch. On step failure, log the error, emit error progress event, and return failure. The month runner skips failed days.

**generateMonthContent(month: string, mode: 'bible' | 'positivity', onProgress: ProgressCallback): Promise&lt;{ generated: number; failed: number; skipped: number; failedDays: string[] }&gt;**

1. Parse month (YYYY-MM) to get daysInMonth
2. Loop day 1 to daysInMonth:
   - Format date as YYYY-MM-DD
   - onProgress({ type: 'progress', day, total: daysInMonth, step: 'starting' })
   - Call generateDayContent(date, mode, dayProgress)
   - Track success/failure counts
3. onProgress({ type: 'complete', generated, failed })
4. Return summary

**B2 upload helper:**
Create a private helper `uploadBufferToB2(buffer: Buffer, key: string, contentType: string): Promise<string>` that:
- Gets B2 presigned URL for the key
- PUTs the buffer to the presigned URL
- Returns the CDN URL for the uploaded file
- Uses existing B2 client pattern from storage/presign.ts

Similarly `uploadStringToB2(content: string, key: string, contentType: string): Promise<string>` for SRT files.
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/content-pipeline/pipeline-runner.ts` to verify TypeScript compilation. The pipeline depends on external API keys being configured, so full integration testing happens at admin UI level.
  </verify>
  <done>Pipeline runner orchestrates all generation modules. generateDayContent handles a single day with idempotent gap-fill. generateMonthContent loops all days with progress callbacks. Audio and SRT files uploaded to B2. Used verses tracked only after successful creation.</done>
</task>

</tasks>

<verification>
- TypeScript compilation passes
- Pipeline runner imports all generation modules correctly
- Gap-fill logic checks each field individually before generating
- Progress callback called at each step
- B2 upload helpers follow existing presigned URL pattern
</verification>

<success_criteria>
- generateDayContent creates complete daily content (text, audio, SRT) for both bible and positivity modes
- generateMonthContent loops all days in a month with skip-on-failure
- Idempotent: re-running only fills missing fields, never overwrites
- Progress events emitted at each step for real-time UI feedback
- Used verses recorded only after successful creation
- Rate limiting delays between API calls (ESV 200ms, TTS 500ms)
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-production-platform/12-05-SUMMARY.md`
</output>
